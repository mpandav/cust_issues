"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),__decorate=this&&this.__decorate||function(e,t,i,a){var n,s=arguments.length,r=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,a);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);return s>3&&r&&Object.defineProperty(t,i,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),wi_contrib_2=require("wi-studio/app/contrib/wi-contrib"),connectinMap={},consumerHandler=function(e){function t(t,i,a){var n=e.call(this,t,i,a)||this;return n.injector=t,n.http=i,n.contribModelService=a,n.value=function(e,t){if("kafkaConnection"===e)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_2.WiContributionUtils.getConnections(n.http,"Kafka","tibco-kafka").subscribe(function(i){i.forEach(function(e){for(var i,a,n,s,r,o,l=0;l<e.settings.length;l++)if("name"===e.settings[l].name)i=wi_contrib_2.WiContributionUtils.getUniqueId(e),a=e.settings[l].value,t.push({unique_id:i,name:a});else if("useSchmaRegistry"===e.settings[l].name)n=e.settings[l].value;else if("url"===e.settings[l].name)o=e.settings[l].value;else if("userName_schemaRegistry"===e.settings[l].name)s=e.settings[l].value;else if("password_schemaRegistry"===e.settings[l].name){r=e.settings[l].value,connectinMap[i]={url:o,flagValue:n,username:s,password:r};break}}),console.log("Printing connection maps"),console.log(connectinMap),e.next(t)})});if("initialOffset"===e)return!0===t.getField("customPartition").value?["Newest","Oldest","Seek By Offset","Seek By Timestamp"]:["Newest","Oldest"];if("Avro"===t.getField("valueType").value){var i=t.getField("kafkaConnection").value;if(connectinMap[i].flagValue){var a=t.getField("kafkaConnection").value,s=connectinMap[a].url;if(0===(s=s.concat("/subjects")).toString().indexOf("https")){console.log("I am https");var r=connectinMap[a].username,o=connectinMap[a].password;if(null!==r&&0!==r.toString().trim().length&&null!==o&&0!==o.toString().trim().length){var l=connectinMap[a].username,c=connectinMap[a].password,u=l.concat(":",c),d="Basic ".concat(btoa(u));if("subjects"===e)return Observable_1.Observable.create(function(e){wi_contrib_1.WiProxyCORSUtils.createSSLRequest(n.http,s).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",d).send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})});if("versions"===e){var b=t.getField("subjects").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",b,"/versions");wi_contrib_1.WiProxyCORSUtils.createSSLRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",d).send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})})}if("avroData"===e){var v=t.getField("subjects").value,f=t.getField("versions").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",v,"/versions/",f);wi_contrib_1.WiProxyCORSUtils.createSSLRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",d).send().subscribe(function(t){200===t.status?e.next(t.json().schema):e.next(t)})})}}else{if("subjects"===e)return Observable_1.Observable.create(function(e){wi_contrib_1.WiProxyCORSUtils.createSSLRequest(n.http,s).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})});if("versions"===e){var _=t.getField("subjects").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",_,"/versions");wi_contrib_1.WiProxyCORSUtils.createSSLRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})})}if("avroData"===e){var p=t.getField("subjects").value,w=t.getField("versions").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",p,"/versions/",w);wi_contrib_1.WiProxyCORSUtils.createSSLRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){200===t.status?e.next(t.json().schema):e.next(t)})})}}}else{r=connectinMap[a].username,o=connectinMap[a].password;if(console.log("I am http"),null!==r&&0!==r.toString().trim().length&&null!==o&&0!==o.toString().trim().length){u=r.concat(":",o);var g="Basic ".concat(btoa(u));if("subjects"===e)return Observable_1.Observable.create(function(e){wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,s).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",g).send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})});if("versions"===e){var R=t.getField("subjects").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",R,"/versions");wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",g).send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})})}if("avroData"===e){var V=t.getField("subjects").value,m=t.getField("versions").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",V,"/versions/",m);wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",g).send().subscribe(function(t){200===t.status?e.next(t.json().schema):e.next(t)})})}}else{if("subjects"===e)return Observable_1.Observable.create(function(e){wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,s).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})});if("versions"===e){var h=t.getField("subjects").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",h,"/versions");wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){200===t.status?e.next(t.json()):e.next(t)})})}if("avroData"===e){var O=t.getField("subjects").value,j=t.getField("versions").value;return Observable_1.Observable.create(function(e){var t=s.concat("/",O,"/versions/",j);wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,t).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){200===t.status?e.next(t.json().schema):e.next(t)})})}}}}}return null},n.validate=function(e,t){if("stringValue"===e)return"String"===t.getField("valueType").value?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1);if("jsonValue"===e)return"JSON"===t.getField("valueType").value?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1);if("avroData"===e){if("Avro"===t.getField("valueType").value){var i=t.getField("kafkaConnection").value;return connectinMap[i].flagValue?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0).setReadOnly(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0).setReadOnly(!1)}return wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1)}if("subjects"===e){if("Avro"===t.getField("valueType").value){i=t.getField("kafkaConnection").value;return connectinMap[i].flagValue?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1)}return wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1)}if("versions"===e){if("Avro"===t.getField("valueType").value){i=t.getField("kafkaConnection").value;return connectinMap[i].flagValue?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1)}return wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1)}if("ackTimeout"===e)return"All"===t.getField("ackMode").value?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1);if("headers"===e)return n.validateParametersByName(e,t);if("partitionId"===e)return!0===t.getField("customPartition").value?t.getField("partitionId").value<0?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0).setError("Kafka-1004","Partition ID must be a non-negative integer"):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1);if("timeStamp"===e)return"Seek By Timestamp"===t.getField("initialOffset").value?n.validateTimestampField(e,t):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1);if("seekOffset"===e)return"Seek By Offset"===t.getField("initialOffset").value?t.getField("seekOffset").value<0?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0).setError("Kafka-1003","Offset must be a non-negative integer"):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1);if("consumerGroup"===e)return!0===t.getField("customPartition").value?wi_contrib_2.ValidationResult.newValidationResult().setVisible(!1):wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0);if("customPartition"===e){var a=t.getField("customPartition"),s=t.getField("initialOffset"),r=!0===a.value||"true"===a.value;return s.allowed=[],s.allowed=r?["Newest","Oldest","Seek By Offset","Seek By Timestamp"]:["Newest","Oldest"],wi_contrib_2.ValidationResult.newValidationResult().setVisible(!0)}return null},n.action=function(e,t){var i=n.getModelService(),a=wi_contrib_2.CreateFlowActionResult.newActionResult(),s=t.getField("kafkaConnection");if(s&&s.value){var r=i.createTriggerElement("Kafka/tibco-kafka-consumer-trigger");if(r&&r.settings){var o=r.getField("kafkaConnection");o.value=s.value,o.allowed=s.allowed;var l=i.createFlow(t.getFlowName(),t.getFlowDescription());a=a.addTriggerFlowMapping(lodash.cloneDeep(r),lodash.cloneDeep(l))}}return wi_contrib_2.ActionResult.newActionResult().setSuccess(!0).setResult(a)},n}return __extends(t,e),t.prototype.validateParametersByName=function(e,t){return Observable_1.Observable.create(function(i){var a=wi_contrib_2.ValidationResult.newValidationResult(),n=t.getField(e),s=[],r="",o={};try{o=JSON.parse(n.value)}catch(e){}for(var l=0,c=o;l<c.length;l++){var u=c[l];if(!u.parameterName){r="Parameter Name should not be empty",a.setError("Kafka-1001",r),a.setValid(!1);break}for(var d=0,b=s;d<b.length;d++){if(b[d]===u.parameterName){r="Parameter Name '"+u.parameterName+"' already exists",a.setError("Kafka-1001",r),a.setValid(!1);break}}s.push(u.parameterName)}i.next(a),i.complete()})},t.prototype.validateTimestampField=function(e,t){return Observable_1.Observable.create(function(i){var a=wi_contrib_2.ValidationResult.newValidationResult();isValidRFC3339(t.getField(e).value)||(a.setError("Kafka-1002","Invalid timestamp. Please provide timestamp in RFC3339 format"),a.setValid(!1)),i.next(a),i.complete()})},t}(wi_contrib_2.WiServiceHandlerContribution);consumerHandler=__decorate([wi_contrib_2.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_2.WiContribModelService])],consumerHandler),exports.consumerHandler=consumerHandler;var rfc3339Regex=/^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])T([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](\.[0-9]+)?(Z|[+-][01][0-9]:[0-5][0-9])$/;function isValidRFC3339(e){return rfc3339Regex.test(e)}
//# sourceMappingURL=consumerHandler.js.map
