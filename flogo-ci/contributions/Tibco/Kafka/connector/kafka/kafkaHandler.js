"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__decorate=this&&this.__decorate||function(e,t,i,n){var o,a=arguments.length,l=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,i,n);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(l=(a<3?o(l):a>3?o(t,i,l):o(t,i))||l);return a>3&&l&&Object.defineProperty(t,i,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),Observable_1=require("rxjs/Observable"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),wi_contrib_2=require("wi-studio/app/contrib/wi-contrib"),kafkaHandler=function(e){function t(t,i){var n=e.call(this,t,i)||this;return n.injector=t,n.http=i,n.value=function(e,t){var i;return"userName"===e||"password"===e?!(i=t.getField("authMode")).value||"SASL/PLAIN"!==i.value&&"SASL/SCRAM-SHA-256"!==i.value&&"SASL/SCRAM-SHA-512"!==i.value?"":null:"clientCert"!==e&&"clientKey"!==e&&"caCert"!==e||!(i=t.getField("authMode")).value||"None"!==i.value?null:""},n.validate=function(e,t){if("url"===e||"userName_schemaRegistry"===e||"password_schemaRegistry"===e){var i=wi_contrib_1.ValidationResult.newValidationResult(),n=t.getField("useSchmaRegistry");return n&&n.value&&!0===n.value?i.setVisible(!0):i.setVisible(!1),i}if("Save"===e){var o=t.getField("name"),a=t.getField("brokers");if(o.value&&o.value.toString().trim().length>0&&a.value&&a.value.toString().trim().length>0){if((s=t.getField("authMode")).value&&("SASL/PLAIN"===s.value||"SASL/SCRAM-SHA-256"===s.value||"SASL/SCRAM-SHA-512"===s.value)){var l=t.getField("userName"),r=t.getField("password");if(null===l.value||0===l.value.toString().trim().length||null===r.value||0===r.value.toString().trim().length)return wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0)}return wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1)}return wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0)}if("userName"===e||"password"===e)return!(s=t.getField("authMode")).value||"SASL/PLAIN"!==s.value&&"SASL/SCRAM-SHA-256"!==s.value&&"SASL/SCRAM-SHA-512"!==s.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0);if("securityProtocol"===e)return(s=t.getField("authMode")).value&&"SASL/PLAIN"===s.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("clientCert"===e||"clientKey"===e||"caCert"===e){var s;if("SSL"===(s=t.getField("authMode")).value||"SASL/SCRAM-SHA-256"===s.value||"SASL/SCRAM-SHA-512"===s.value||"SASL/OAUTHBEARER"===s.value)return wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0);if("SASL/PLAIN"===s.value){var c=t.getField("securityProtocol");return c&&c.value?"SASL_SSL"===c.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)}return wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}return"clientID"===e||"clientSecret"===e||"tokenURL"===e||"scope"===e?(s=t.getField("authMode")).value&&"SASL/OAUTHBEARER"===s.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):null},n.action=function(e,t){return Observable_1.Observable.create(function(e){var i=t.getField("name"),o=!1;wi_contrib_1.WiContributionUtils.getConnections(n.http,"Kafka").subscribe(function(a){for(var l=0,r=a;l<r.length;l++)for(var s=r[l],c=0;c<s.settings.length;c++){if("name"===s.settings[c].name)if(s.settings[c].value===i.value&&wi_contrib_1.WiContributionUtils.getUniqueId(s)!==wi_contrib_1.WiContributionUtils.getUniqueId(t)){o=!0;break}}if(o)e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-001","Connection name already exists")));else{var u={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}},d=t.getField("useSchmaRegistry");if(d&&d.value&&!0===d.value){var _="Error connecting Schema registry, Check Schema Registry configuration",R=t.getField("url").value;if(null!==R&&0!==R.toString().trim().length)if(0===(R=R.concat("/subjects")).toString().indexOf("https")){console.log("I am https");var b=t.getField("userName_schemaRegistry").value,w=t.getField("password_schemaRegistry").value;if(null!==b&&0!==b.toString().trim().length&&null!==w&&0!==w.toString().trim().length){var S=b.concat(":",w),A="Basic ".concat(btoa(S));console.log("I am basic auth https"),wi_contrib_2.WiProxyCORSUtils.createSSLRequest(n.http,R).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",A).send().subscribe(function(t){console.log("Status (Secured Connection): ",t.status),200===t.status?e.next(wi_contrib_1.ActionResult.newActionResult().setResult(u)):e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))},function(t){console.log("Callback error (Secured Connection)"),e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))})}else console.log("I am simple https"),wi_contrib_2.WiProxyCORSUtils.createSSLRequest(n.http,R).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){console.log("Status (Secured Connection): ",t.status),200===t.status?e.next(wi_contrib_1.ActionResult.newActionResult().setResult(u)):e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))},function(t){console.log("Callback error (Secured Connection)"),e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))})}else{console.log("I am http");b=t.getField("userName_schemaRegistry").value,w=t.getField("password_schemaRegistry").value;if(null!==b&&0!==b.toString().trim().length&&null!==w&&0!==w.toString().trim().length){S=b.concat(":",w),A="Basic ".concat(btoa(S));console.log("I am basic auth http"),wi_contrib_2.WiProxyCORSUtils.createRequest(n.http,R).addMethod("GET").addHeader("accept","application/json").addHeader("Authorization",A).send().subscribe(function(t){console.log("Status (Secured Connection): ",t.status),200===t.status?e.next(wi_contrib_1.ActionResult.newActionResult().setResult(u)):e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))},function(t){console.log("Callback error (Secured Connection)"),e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))})}else console.log("I am simple http"),wi_contrib_2.WiProxyCORSUtils.createRequest(n.http,R).addMethod("GET").addHeader("accept","application/json").send().subscribe(function(t){console.log("Status (Secured Connection): ",t.status),200===t.status?e.next(wi_contrib_1.ActionResult.newActionResult().setResult(u)):e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))},function(t){console.log("Callback error (Secured Connection)"),e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("KAFKA-CONNECTOR-002",_)))})}}else console.log("Saving the connection"),e.next(wi_contrib_1.ActionResult.newActionResult().setResult(u))}})})},n}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);kafkaHandler=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http])],kafkaHandler),exports.kafkaHandler=kafkaHandler;
//# sourceMappingURL=kafkaHandler.js.map
