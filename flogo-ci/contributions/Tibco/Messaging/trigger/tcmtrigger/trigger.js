"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TCMTriggerService=void 0;var http_1=require("@angular/http"),core_1=require("@angular/core"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),TCMTriggerService=function(e){function t(t,n,r){var i=e.call(this,t,n,r)||this;return i.injector=t,i.http=n,i.contribModelService=r,i.value=function(e,t){if("tcmConnection"===e)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(i.http,"Messaging").subscribe(function(n){n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})});if("metadata"===e){var n={messageId:0,deliveryAttempt:0};return JSON.stringify(n)}return null},i.validate=function(e,t){if("durableName"===e||"durableType"===e||"ackMode"===e){var n=t.getField("durableSub");return!n||"true"!==n.value&&!0!==n.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)}return null},i.action=function(e,t){var n=i.getModelService(),r=wi_contrib_1.CreateFlowActionResult.newActionResult();if(t.handler&&t.handler.settings&&t.handler.settings.length>0){var a=t.getField("tcmConnection"),o=t.getField("durableSub"),s=t.getField("durableName"),l=t.getField("durableType"),u=t.getField("ackMode"),c=t.getField("processingMode"),d=t.getField("destination"),g=t.getField("matcher"),p=t.getField("message");if(a&&a.value){var v=n.createTriggerElement("Messaging/tibco-messaging-tcm-trigger");if(v&&v.handler&&v.handler.settings&&v.handler.settings.length>0)for(var h=0;h<v.handler.settings.length;h++)a&&a.value&&"tcmConnection"===v.handler.settings[h].name?v.handler.settings[h].value=a.value:o&&o.value&&"durableSub"===v.handler.settings[h].name?v.handler.settings[h].value=o.value:s&&s.value&&"durableName"===v.handler.settings[h].name?v.handler.settings[h].value=s.value:l&&l.value&&"durableType"===v.handler.settings[h].name?v.handler.settings[h].value=l.value:u&&u.value&&"ackMode"===v.handler.settings[h].name?v.handler.settings[h].value=u.value:d&&d.value&&"destination"===v.handler.settings[h].name?v.handler.settings[h].value=d.value:c&&c.value&&"processingMode"===v.handler.settings[h].name?v.handler.settings[h].value=c.value:g&&g.value&&"matcher"===v.handler.settings[h].name&&(v.handler.settings[h].value=g.value);if(v&&v.outputs&&v.outputs.length>0)for(h=0;h<v.outputs.length;h++)if(p&&p.value&&"message"===v.outputs[h].name){v.outputs[h].value=p.value;break}i.doTriggerMapping(v);var b=n.createFlow(t.getFlowName(),t.getFlowDescription());r=r.addTriggerFlowMapping(lodash.cloneDeep(v),lodash.cloneDeep(b))}}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(r)},i}return __extends(t,e),t.prototype.doTriggerMapping=function(e){var t=this.contribModelService.createMapping();t.addMapping("$INPUT['message']",this.contribModelService.createMapExpression().setExpression("$trigger.message")),t.addMapping("$INPUT['metadata']",this.contribModelService.createMapExpression().setExpression("$trigger.metadata")),e.inputMappings=t},t=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.TCMTriggerService=TCMTriggerService;
//# sourceMappingURL=trigger.js.map
