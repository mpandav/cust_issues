"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AzDatafactoryTriggerActivityContribution=void 0;var Observable_1=require("rxjs/Observable"),http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),common_1=require("./common"),AzDatafactoryTriggerActivityContribution=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.http=n,r.value=function(e,t){var n=t.getField("Connection"),i=n.value?n.value:"",o=t.getField("operation"),a=o.value?o.value:"",c=t.getField("subscriptionId"),s=c.value?c.value:"",l=t.getField("resourceGroup"),u=l.value?l.value:"",p=t.getField("dataFactories"),b=p.value?p.value:"",f=t.getField("dfPipeline"),_=f.value?f.value:"";switch(r.validations[t.title]&&r.validations[t.title][e]&&delete r.validations[t.title][e],r.validations[t.title]||(r.validations[t.title]={}),console.log(e),e){case"Connection":return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(r.http,"AzureAD").subscribe(function(n){n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})});case"operation":if(""!==i)return wi_contrib_1.WiContributionUtils.getConnection(r.http,i).switchMap(function(e){return common_1.Connection.getConnection(e)}).switchMap(function(e){return e.getOperations("pipeline",r.method)});case"subscriptionId":if(""!==i)return wi_contrib_1.WiContributionUtils.getConnection(r.http,i).switchMap(function(e){return common_1.Connection.getConnection(e)}).switchMap(function(e){return e.getSubscriptions(r,e)}).catch(function(n){return console.log("Error occurred fetching subscriptions: "+n),r.validations[t.title][e]=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("ADF-TRI-MSG-1000",n)),Observable_1.Observable.of(null)});case"resourceGroup":return""!==i&&""!==s?wi_contrib_1.WiContributionUtils.getConnection(r.http,i).switchMap(function(e){return common_1.Connection.getConnection(e)}).switchMap(function(e){return e.getResourceGroups(r,e,s)}).catch(function(n){return console.log("Error occurred fetching resourceGroup: "+n),r.validations[t.title][e]=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("ADF-TRI-MSG-1000",n)),Observable_1.Observable.of(null)}):Observable_1.Observable.of(null);case"dataFactories":return""!==i&&""!==s?wi_contrib_1.WiContributionUtils.getConnection(r.http,i).switchMap(function(e){return common_1.Connection.getConnection(e)}).switchMap(function(e){return e.getDatafactories(r,e,s,u)}).catch(function(n){return console.log("Error occurred fetching dataFactories: "+n),r.validations[t.title][e]=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("ADF-TRI-MSG-1000",n)),Observable_1.Observable.of(null)}):Observable_1.Observable.of(null);case"dfPipeline":return""!==i&&""!==s&&""!==u&&""!==b?wi_contrib_1.WiContributionUtils.getConnection(r.http,i).switchMap(function(e){return common_1.Connection.getConnection(e)}).switchMap(function(e){return e.getPipelines(r,e,s,u,b)}).catch(function(n){return console.log("Error occurred fetching pipelines: "+n),r.validations[t.title][e]=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("ADF-TRI-MSG-1000",n)),Observable_1.Observable.of(null)}):Observable_1.Observable.of(null);case"input":if(""!==i&&""!==a)return wi_contrib_1.WiContributionUtils.getConnection(r.http,i).switchMap(function(e){return common_1.Connection.getConnection(e)}).switchMap(function(e){return e.getSchemaForOperation(a,r.method).map(function(t){return{schema:t,connection:e}})}).switchMap(function(e){var n,o=e.schema,c=e.connection;if(!o.parameters||!o.output)throw new Error("No body or output schema retrieved for method "+r.method);return r.messaging.emit(t.title+i+"output",o.output),r.messaging.emit(t.title+i+"path",o.path),"Run Once"===a&&""!==_&&(n=c.getPipelineMetadata(r,c,s,u,b,_)),(n||Observable_1.Observable.of(!1)).map(function(e){return!1!==e&&(o=getModifiedSchema(o,e,_)),JSON.stringify({$schema:"http://json-schema.org/draft-04/schema#",type:"object",definitions:{},properties:{parameters:o.parameters}})})}).catch(function(n){return console.log("Error occurred fetching input metadata: "+n),r.validations[t.title][e]=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("SFP-QRY-MSG-1000",n)),Observable_1.Observable.of("")});case"output":return""!==i&&""!==a?Observable_1.Observable.create(function(e){r.messaging.on(t.title+i+"output",function(n){null!=n&&(r.messaging.off(t.title+i+"output"),e.next(n))})}).map(function(e){return JSON.stringify({$schema:"http://json-schema.org/draft-04/schema#",type:"object",definitions:{},properties:e.properties})}):null}},r.validate=function(e,t){var n=t.getField("operation");return"dfPipeline"===e?"Cancel Run"===n.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):null},r.validations={},r.messaging=new wi_contrib_1.WiContribMessaging,r.method="post",r}return __extends(t,e),t=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],t)}(wi_contrib_1.WiServiceHandlerContribution);function getModifiedSchema(e,t,n){if(t.properties&&t.properties.parameters){delete e.parameters.properties.pipelineParameters;var r=t.properties.parameters,i={};for(var o in r)i[o]={type:convertDataTypes(r[o].type),description:"",required:!1};e.parameters.properties.pipelineParameters?e.parameters.properties.pipelineParameters.properties=i:e.parameters.properties.pipelineParameters={type:"object",description:"",required:!1,properties:i}}else console.log("Pipeline ",n," does not accept any paramaters"),delete e.parameters.properties.pipelineParameters;return e}function convertDataTypes(e){switch(e){case"float":return"number";case"securestring":return"string"}return e}exports.AzDatafactoryTriggerActivityContribution=AzDatafactoryTriggerActivityContribution;
//# sourceMappingURL=activity.js.map
