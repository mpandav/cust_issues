"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(i,r){t(i,r,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),http_1=require("@angular/http"),core_1=require("@angular/core"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),messageHeaderSchema={$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{destination:{type:"string"},replyTo:{type:"string"},deliveryMode:{type:"string"},messageID:{type:"string"},timestamp:{type:"integer"},expiration:{type:"integer"},reDelivered:{type:"boolean"},priority:{type:"integer"},correlationID:{type:"string"}}},messagePropertiesSchema={$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{property:{type:"array",items:{type:"object",properties:{name:{type:"string"},value:{type:"string"},type:{type:"string"}},required:["name","value"]}}}},RecvMsgTriggerContribution=function(e){function t(t,i,r){var n=e.call(this,t,i,r)||this;return n.http=i,n.contribModelService=r,n.value=function(e,t){switch(e){case"connection":return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(n.http,"EMS","tibco-ems-connector").subscribe(function(i){i.forEach(function(e){for(var i=0;i<e.settings.length;i++)if("name"===e.settings[i].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[i].value});break}}),e.next(t)})});case"headers":return JSON.stringify(messageHeaderSchema);case"messageProperties":return JSON.stringify(messagePropertiesSchema)}},n.validate=function(e,t){if("durableSubscriber"===e)return"Topic"===(i=t.getField("destinationType")).value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("sharedDurableSubscriber"===e){var i=t.getField("destinationType"),r=t.getField("durableSubscriber");return"Topic"===i.value&&!0===r.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}if("subscriptionName"===e){i=t.getField("destinationType"),r=t.getField("durableSubscriber");if("Topic"===i.value&&!0===r.value){var n=t.getField("subscriptionName");return n.value&&0!==n.value.trim().length?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0).setError("EMS-1001","Subscription name is required for durable subscribers")}return wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}return null},n.action=function(e,t){var i=n.getModelService(),r=wi_contrib_1.CreateFlowActionResult.newActionResult(),s=i.createTriggerElement("EMS/receivemessage"),a=t.getField("processingMode"),o=t.getField("destinationType"),l=t.getField("destination"),c=t.getField("ackMode"),u=t.getField("durableSubscriber"),d=t.getField("sharedDurableSubscriber"),g=t.getField("subscriptionName");if(t.settings&&t.settings.length>0){var p=t.getField("connection");if(p&&p.value){if(s&&s.settings&&s.settings.length>0)for(var b=0;b<s.settings.length;b++)"connection"===s.settings[b].name&&(s.settings[b].value=p.value);if(s&&s.handler&&s.handler.settings&&s.handler.settings.length>0)for(b=0;b<s.handler.settings.length;b++)"destinationType"===s.handler.settings[b].name&&o&&o.value?s.handler.settings[b].value=o.value:"destination"===s.handler.settings[b].name&&l&&l.value?s.handler.settings[b].value=l.value:"ackMode"===s.handler.settings[b].name&&c&&c.value?s.handler.settings[b].value=c.value:"processingMode"===s.handler.settings[b].name&&a&&a.value?s.handler.settings[b].value=a.value:"durableSubscriber"===s.handler.settings[b].name&&u?s.handler.settings[b].value=u.value:"sharedDurableSubscriber"===s.handler.settings[b].name&&d?s.handler.settings[b].value=d.value:"subscriptionName"===s.handler.settings[b].name&&g&&(s.handler.settings[b].value=g.value)}for(var _=n.contribModelService.createMapping(),h=0;h<s.outputs.length;h++)"message"===s.outputs[h].name&&_.addMapping("$INPUT['message']",n.contribModelService.createMapExpression().setExpression("$trigger.message")),"headers"===s.outputs[h].name&&_.addMapping("$INPUT['headers']",n.contribModelService.createMapExpression().setExpression("$trigger.headers")),"messageProperties"===s.outputs[h].name&&_.addMapping("$INPUT['messageProperties']",n.contribModelService.createMapExpression().setExpression("$trigger.messageProperties"));s.inputMappings=_;var v=i.createFlow(t.getFlowName(),t.getFlowDescription());r=r.addTriggerFlowMapping(lodash.cloneDeep(s),lodash.cloneDeep(v))}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(r)},n}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);RecvMsgTriggerContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http,wi_contrib_1.WiContribModelService])],RecvMsgTriggerContribution),exports.RecvMsgTriggerContribution=RecvMsgTriggerContribution;
//# sourceMappingURL=trigger.js.map
