"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var r,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(o=(a<3?r(o):a>3?r(t,n,o):r(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),AWS=require("aws-sdk"),SendMsgActivityContribution=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.value=function(e,t){if("awsConnection"===e)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(i.http,"AWS").subscribe(function(n){n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})});if("MessageAttributes"===e){var n=t.getField("MessageAttributeNames");if(n.value){for(var r={},a=JSON.parse(n.value),o=0;o<a.length;o++)"String"===a[o].Type?r[a[o].Name]="abc":"Number"===a[o].Type&&(r[a[o].Name]=0);return JSON.stringify(r)}return"{}"}if("queueUrl"===e){var s=t.getField("awsConnection");if(s.value)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnection(i.http,s.value).map(function(e){return e}).subscribe(function(n){for(var i,r,a,o,s,l,u,c,d,f=0,_=n.settings;f<_.length;f++){var b=_[f];"accessKey"===b.name?i=b:"secretKey"===b.name?r=b:"region"===b.name?a=b:"assumeRole"===b.name?o=b:"roleArn"===b.name?s=b:"roleSessionName"===b.name?l=b:"externalId"===b.name?u=b:"expirationDuration"===b.name?c=b:"sessionToken"===b.name&&(d=b)}if(!0===o.value){var v=new AWS.STS({credentials:new AWS.Credentials(i.value,r.value,d.value),region:a.value}),g={RoleArn:s.value,RoleSessionName:l.value,DurationSeconds:c.value};""!==u.value&&(g.ExternalId=u.value),v.assumeRole(g,function(n,i){if(n)console.log("Invalid Assume Role");else{new AWS.SQS({credentials:new AWS.Credentials(i.Credentials.AccessKeyId,i.Credentials.SecretAccessKey,i.Credentials.SessionToken),region:a.value}).listQueues({},function(n,i){n?e.next(t):e.next(i.QueueUrls)})}})}else{new AWS.SQS({credentials:new AWS.Credentials(i.value,r.value,d.value),region:a.value}).listQueues({},function(n,i){n?e.next(t):e.next(i.QueueUrls)})}})})}else if("output"===e){var l={MessageId:""},u=t.getField("queueUrl"),c=u.value;return void 0!==u.value&&"fifo"===c.substr(c.lastIndexOf(".")+1)&&(l.SequenceNumber=""),JSON.stringify(l)}return null},i.validate=function(e,t){if("awsConnection"===e){if(null===t.getField("awsConnection").value)return wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-SEND-MSG-1000","AWS Connection must be configured")}else if("queueUrl"===e){if(null===(r=t.getField("queueUrl")).value)return wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-SEND-MSG-1001","Queue URL must be configured")}else if("DelaySeconds"===e){var n=(r=t.getField("queueUrl")).value,i=t.getField("DelaySeconds").value;if(void 0!==r.value)return"fifo"===n.substr(n.lastIndexOf(".")+1)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):i<0||i>900?wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-SEND-MSG-1002","Delay Seconds should be betweem 0 and 900").setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)}else{if("MessageDeduplicationId"===e){n=(r=t.getField("queueUrl")).value;return void 0!==r.value&&"fifo"===n.substr(n.lastIndexOf(".")+1)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}if("MessageGroupId"===e){var r;n=(r=t.getField("queueUrl")).value;return void 0!==r.value&&"fifo"===n.substr(n.lastIndexOf(".")+1)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}}return null},i}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);SendMsgActivityContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],SendMsgActivityContribution),exports.SendMsgActivityContribution=SendMsgActivityContribution;
//# sourceMappingURL=activity.js.map
