"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__decorate=this&&this.__decorate||function(e,t,i,n){var r,a=arguments.length,s=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(s=(a<3?r(s):a>3?r(t,i,s):r(t,i))||s);return a>3&&s&&Object.defineProperty(t,i,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),http_1=require("@angular/http"),core_1=require("@angular/core"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),AWS=require("aws-sdk"),RecvMsgTriggerContribution=function(e){function t(t,i){var n=e.call(this,t,i)||this;return n.http=i,n.value=function(e,t){if("awsConnection"===e)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(n.http,"AWS").subscribe(function(i){i.forEach(function(e){for(var i=0;i<e.settings.length;i++)if("name"===e.settings[i].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[i].value});break}}),e.next(t)})});if("Message"===e){var i={MessageAttributes:{}},r=t.getField("MessageAttributeNames");if(r.value){for(var a={},s=JSON.parse(r.value),o=0;o<s.length;o++)"String"===s[o].Type?a[s[o].Name]="abc":"Number"===s[o].Type&&(a[s[o].Name]=0);i.MessageAttributes=a}return i.Body="",i.MD5OfBody="",i.MD5OfMessageAttributes="",i.MessageId="",i.ReceiptHandle="","["+JSON.stringify(i)+"]"}if("queueUrl"===e){var l=t.getField("awsConnection");if(l.value)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnection(n.http,l.value).map(function(e){return e}).subscribe(function(i){for(var n,r,a,s,o,l,u,c,d,f=0,g=i.settings;f<g.length;f++){var b=g[f];"accessKey"===b.name?n=b:"secretKey"===b.name?r=b:"region"===b.name?a=b:"assumeRole"===b.name?s=b:"roleArn"===b.name?o=b:"roleSessionName"===b.name?l=b:"externalId"===b.name?u=b:"expirationDuration"===b.name?c=b:"sessionToken"===b.name&&(d=b)}if(!0===s.value){var _=new AWS.STS({credentials:new AWS.Credentials(n.value,r.value,d.value),region:a.value}),v={RoleArn:o.value,RoleSessionName:l.value,DurationSeconds:c.value};""!==u.value&&(v.ExternalId=u.value),_.assumeRole(v,function(i,n){if(i)console.log("Invalid Assume Role");else{new AWS.SQS({credentials:new AWS.Credentials(n.Credentials.AccessKeyId,n.Credentials.SecretAccessKey,n.Credentials.SessionToken),region:a.value}).listQueues({},function(i,n){i?e.next(t):e.next(n.QueueUrls)})}})}else{new AWS.SQS({credentials:new AWS.Credentials(n.value,r.value,d.value),region:a.value}).listQueues({},function(i,n){i?e.next(t):e.next(n.QueueUrls)})}})})}return null},n.validate=function(e,t){if("awsConnection"===e){if(null===t.getField("awsConnection").value)return wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-RECV-MSG-1000","AWS Connection must be configured")}else if("queueUrl"===e){if(null===(i=t.getField("queueUrl")).value)return wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-RECV-MSG-1001","Queue URL must be configured")}else{if("ReceiveRequestAttemptId"===e){var i,n=(i=t.getField("queueUrl")).value;return void 0!==i.value&&"fifo"===n.substr(n.lastIndexOf(".")+1)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}if("WaitTimeSeconds"===e){if(t.getField("WaitTimeSeconds").value<0)return wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-RECV-MSG-1002","WaitTime should be greater than zero")}else if("VisibilityTimeout"===e){if(t.getField("VisibilityTimeout").value<0)return wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-RECV-MSG-1002","Visibility Timeout should be greater than zero")}else if("MaxNumberOfMessages"===e){var r=t.getField("MaxNumberOfMessages").value;if(r<=0||r>10)return wi_contrib_1.ValidationResult.newValidationResult().setError("AWS-RECV-MSG-1002","Max Number Of Messages should be between 1 to 10")}}return null},n.action=function(e,t){var i=n.getModelService(),r=wi_contrib_1.CreateFlowActionResult.newActionResult();if(t.settings&&t.settings.length>0){var a=t.getField("awsConnection");if(a&&a.value){var s=i.createTriggerElement("AWSSQS/sqsreceivemessage");if(s&&s.settings&&s.settings.length>0)for(var o=0;o<s.settings.length;o++)"awsConnection"===s.settings[o].name&&(s.settings[o].value=a.value);var l=i.createFlow(t.getFlowName(),t.getFlowDescription());r=r.addTriggerFlowMapping(lodash.cloneDeep(s),lodash.cloneDeep(l))}}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(r)},n}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);RecvMsgTriggerContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],RecvMsgTriggerContribution),exports.RecvMsgTriggerContribution=RecvMsgTriggerContribution;
//# sourceMappingURL=trigger.js.map
