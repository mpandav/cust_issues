"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,n,r){var o,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(i<3?o(a):i>3?o(t,n,a):o(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TibcoAzServiceBusConnectorContribution=exports.Connection=void 0;var http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions");require("wi-studio/common/rxjs-extensions");var validation_1=require("wi-studio/common/models/validation");require("rxjs/add/observable/zip");var cryptos=require("crypto-js"),schemadoc_1=require("./schemadoc"),Result=function(){return function(e,t,n){}}(),Connection=function(){function e(e){var t=this;this.http=e,this.oAuthProperties=function(){return rxjs_extensions_1.Observable.zip(rxjs_extensions_1.Observable.of(t.authorizationRuleName),rxjs_extensions_1.Observable.of(t.primarysecondaryKey),function(e,t){return{authorizationRuleName:e,primarysecondaryKey:t}})}}return e.getConnection=function(t,n){var r=new e(n);return rxjs_extensions_1.Observable.from(t).reduce(function(e,t){return e[t.name]=t.value,e},r)},e.dateRegx=/^\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[1-2]\d|3[0-1])T(?:[0-1]\d|2[0-3]):[0-5]\d:[0-5]\dZ/,e}();exports.Connection=Connection;var TibcoAzServiceBusConnectorContribution=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.http=n,r.value=function(e,t){return r.validations[t.title]&&r.validations[t.title][e]&&delete r.validations[t.title][e],r.validations[t.title]||(r.validations[t.title]={}),null},r.validate=function(e,t){if("Oauth2"===t.getField("authMode").value){if("authorizationRuleName"===e||"primarysecondaryKey"===e)return validation_1.ValidationResult.newValidationResult().setVisible(!1);if("tenantID"===e||"clientID"===e||"clientSecret"===e)return validation_1.ValidationResult.newValidationResult().setVisible(!0)}else{if("authorizationRuleName"===e||"primarysecondaryKey"===e)return validation_1.ValidationResult.newValidationResult().setVisible(!0);if("tenantID"===e||"clientID"===e||"clientSecret"===e)return validation_1.ValidationResult.newValidationResult().setVisible(!1)}return null},r.connection=function(e){var t=new Connection(r.http);return rxjs_extensions_1.Observable.from(e).reduce(function(e,t){return e[t.name]=t.value,e},t)},r.isDuplicate=function(e,t){return wi_contrib_1.WiContributionUtils.getConnections(r.http,r.category).mergeMap(function(e){return e}).map(function(e){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(e),ction:r.connection(e.settings)}}).filter(function(e){return e.id!==t}).mergeMap(function(e){return e.ction}).filter(function(t){return t.name===e.name}).reduce(function(e,t){return e.push(t),e},[]).map(function(e){return e.length>0})},r.defaultResult=function(e){var t={context:e,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(t))},r.action=function(e,t){var n,o=t.getField("authMode");if("Login"===e)return r.connection(t.settings).switchMap(function(e){return r.isDuplicate(e,wi_contrib_1.WiContributionUtils.getUniqueId(t)).map(function(t){if(t)throw new Error("Connection with name "+e.name+" already exists");return e})}).switchMap(function(e){if(!(null!==e.name&&e.name.trim().length>0))throw new Error("Please enter the Connection Name!");if("Oauth2"===o.value){for(var i=0;i<t.settings.length;i++)"DocsMetadata"===t.settings[i].name&&(t.settings[i].value=schemadoc_1.JsonSchema.Types.schemaDoc());var a={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(a))}if(""===e.resourceURI)throw new Error("Please enter the resource URI");var s="";if(s=e.resourceURI.includes("https")?e.resourceURI:"https://"+e.resourceURI+".servicebus.windows.net",""===e.authorizationRuleName)throw new Error("Please enter the Authorization Rule Name!");if(""===e.primarysecondaryKey)throw new Error("Please enter the primary/secondaryKey!");var c="";c=null!==s&&s.trim().length>0?c+s:"errorMsg";var u,l,d,_=String((new Date).getTime()/1e3+86400);if((c=encodeURIComponent(c)+"\n"+_).includes("errorMsg"))throw new Error("errorMsg");if(!(null!==e.authorizationRuleName&&e.authorizationRuleName.trim().length>0))throw new Error("errorMsg");var f=e.primarysecondaryKey;return u=cryptos.HmacSHA256(c,f),l=cryptos.enc.Base64.stringify(u),l=encodeURIComponent(l),d=encodeURIComponent(s),e.primarysecondaryKey="",n="SharedAccessSignature sr="+d+"&sig="+l+"&se="+_+"&skn="+e.authorizationRuleName,wi_contrib_1.WiProxyCORSUtils.createRequest(r.http,s+"/messages"+_).addHeader("Content-Type","application/atom+xml;type=entry;charset=utf-8").addHeader("Authorization",n).addHeader("If-Match","*").addMethod("PUT").addBody('<entry xmlns="http://www.w3.org/2005/Atom"><content type="application/xml"><QueueDescription xmlns="http://schemas.microsoft.com/netservices/2010/10/servicebus/connect"><MaxDeliveryCount>10</MaxDeliveryCount></QueueDescription></content></entry>').send().switchMap(function(e){if(e.status>=500||401===e.status)return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZSERVICEBUSCONN-1002","Connection Authentication error: "+e.statusText+": Check your connection parameters")));for(var n=0;n<t.settings.length;n++)"DocsMetadata"===t.settings[n].name&&(t.settings[n].value=schemadoc_1.JsonSchema.Types.schemaDoc());var r={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(r))})}).catch(function(e){if(e instanceof http_1.Response){if(e.status){if(e.status>=500||401===e.status)return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZSERVICEBUSCONN-1002","Connection Authentication error: "+e.statusText+": Check your connection parameters")));for(var n=0;n<t.settings.length;n++)"DocsMetadata"===t.settings[n].name&&(t.settings[n].value=schemadoc_1.JsonSchema.Types.schemaDoc());var r={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(r))}return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZSERVICEBUSCONN-1002","Connection Authentication error: "+e.statusText+": Check your connection parameters")))}if(e instanceof Error)return console.log("AuthenticationFailed: "+e),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZSERVICEBUSCONN-1005","Connection Authentication error: "+e.message)))})},r.validations={},r.category="AzureServiceBus",r}return __extends(t,e),t=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.TibcoAzServiceBusConnectorContribution=TibcoAzServiceBusConnectorContribution;
//# sourceMappingURL=connector.js.map
