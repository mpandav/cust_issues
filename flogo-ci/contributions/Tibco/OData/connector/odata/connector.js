"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var r,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(o=(a<3?r(o):a>3?r(t,n,o):r(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ODataConnectorService=void 0;var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),validation_1=require("wi-studio/common/models/validation"),contrib_1=require("wi-studio/common/models/contrib"),Observable_1=require("rxjs/Observable"),ODataConnectorService=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.value=function(e,t){if("name"===e||"description"===e)return null;if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e&&"Client Credentials"===t.getField("grantType").value){for(var n=0,r=t.settings;n<r.length;n++){var a=r[n];if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===a.name)return i.isBase64(a.value)?a.value:btoa(a.value)}return null}return null},i.validate=function(e,t){var n=t.getField("type"),i=validation_1.ValidationResult.newValidationResult();if("userName"===e||"password"===e)return"Basic"===n.value?i.setVisible(!0):i.setVisible(!1),i;if("grantType"===e||"accessTokenURL"===e||"clientId"===e||"clientSecret"===e||"scope"===e||"clientAuthentication"===e||"token"===e)return"OAuth2"===n.value?i.setVisible(!0):i.setVisible(!1),i;if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e){var r=t.getField("type");if(r&&"OAuth2"!==r.value)return i.setVisible(!1),i;if("Client Credentials"===t.getField("grantType").value)return null}else{if("Save"===e)return"None"===n.value||"Basic"===n.value?(i.setVisible(!0),i):(i.setVisible(!1),i);if("Login"===e)return"OAuth2"===n.value?(i.setVisible(!0),i):(i.setVisible(!1),i)}return null},i.action=function(e,t){if("Login"===e||"Save"===e)return Observable_1.Observable.create(function(e){for(var n="",r="",a="Basic",o=0;o<t.settings.length;o++)"name"===t.settings[o].name&&(n=t.settings[o].value),"grantType"===t.settings[o].name&&(r=t.settings[o].value),"type"===t.settings[o].name&&(a=t.settings[o].value);var s=!1;wi_contrib_1.WiContributionUtils.getConnections(i.http,"OData").subscribe(function(o){for(var c=0,u=o;c<u.length;c++)for(var l=u[c],d=0;d<l.settings.length;d++){if("name"===l.settings[d].name)if(l.settings[d].value===n&&wi_contrib_1.WiContributionUtils.getUniqueId(l)!==wi_contrib_1.WiContributionUtils.getUniqueId(t)){s=!0;break}}if(s)e.next(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("OData-1001","Connection name already exist !!!"))),e.complete();else{if("None"===a||"Basic"===a){var _={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return e.next(contrib_1.ActionResult.newActionResult().setResult(_)),void e.complete()}if("Client Credentials"===r){var p="",f="",v="",b="",g="";for(d=0;d<t.settings.length;d++)"accessTokenURL"===t.settings[d].name&&(p=t.settings[d].value),"clientId"===t.settings[d].name&&(v=t.settings[d].value),"clientSecret"===t.settings[d].name&&(b=t.settings[d].value),"clientAuthentication"===t.settings[d].name&&(f=t.settings[d].value),"scope"===t.settings[d].name&&(g=t.settings[d].value);return void i.createAuthReuqest(f,p,"client_credentials",v,b,"","",g).excludeHeaders(["origin"]).send().subscribe(function(n){for(var i=n.json(),r=0;r<t.settings.length;r++)if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.settings[r].name){t.settings[r].value=JSON.stringify(i);break}var a={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};e.next(contrib_1.ActionResult.newActionResult().setResult(a)),e.complete()},function(t){e.next(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("MAKETO-1001","Invalid credentials !!!"))),e.complete()},function(){})}}})})},i}return __extends(t,e),t.prototype.createAuthReuqest=function(e,t,n,i,r,a,o,s){if("Query"===e){var c=wi_contrib_1.WiProxyCORSUtils.createRequest(this.http,t).addMethod("GET").addQueryParams("grant_type",n).addQueryParams("client_id",i).addQueryParams("client_secret",r);return""!==o&&c.addQueryParams("code",decodeURIComponent(o)),""!==s&&c.addQueryParams("scope",s),""!==a&&c.addQueryParams("redirect_uri",a),c}if("Body"===e){c=wi_contrib_1.WiProxyCORSUtils.createRequest(this.http,t).addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded");return(u=new http_1.URLSearchParams).set("grant_type",n),""!==s&&u.set("scope",s),u.set("client_id",i),u.set("client_secret",r),""!==a&&u.set("redirect_uri",a),c.addBody(u.toString()),c}var u;if("Header"===e)return(u=new http_1.URLSearchParams).set("grant_type",n),""!==o&&u.set("code",decodeURIComponent(o)),""!==s&&u.set("scope",s),""!==a&&u.set("redirect_uri",a),(c=wi_contrib_1.WiProxyCORSUtils.createRequest(this.http,t).addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded")).addBody(u.toString()),c},t.prototype.isBase64=function(e){try{return btoa(atob(e))===e}catch(e){return!1}},t=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.ODataConnectorService=ODataConnectorService;
//# sourceMappingURL=connector.js.map
