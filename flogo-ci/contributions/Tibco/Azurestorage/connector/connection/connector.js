"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TibcoAzureStorageConnectorContribution=exports.Connection=void 0;var http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions");require("wi-studio/common/rxjs-extensions");var validation_1=require("wi-studio/common/models/validation");require("rxjs/add/observable/zip");var cryptos=require("crypto-js"),schemadoc_1=require("./schemadoc"),Result=function(){return function(e,t,n){}}(),Connection=function(){function e(t){var n=this;this.http=t,this.connectionProps=function(){return rxjs_extensions_1.Observable.zip(rxjs_extensions_1.Observable.of(n.accountName),rxjs_extensions_1.Observable.of(n.expiryDate),rxjs_extensions_1.Observable.of(n.accessKey),rxjs_extensions_1.Observable.of(n.sas),rxjs_extensions_1.Observable.of(n.regenerateTime),rxjs_extensions_1.Observable.of(n.regenerateFlag),function(e,t,n,i,o,a,s){return{accountName:e,connectionType:t,expiryDate:n,accessKey:i,sas:o,regenerateTime:a,regenerateFlag:s}})},this.getSASCode=function(t){return e.getConnection(t.settings,n.http).switchMap(function(i){var o="",a="";if(i.name&&i.name.trim().length>0&&i.accountName&&i.accountName.trim().length>0&&i.connectionType)if("Generate SAS"===i.connectionType){if(i.expiryDate&&i.accessKey){var s="";if(s=s+i.accountName+"\nrwdlacup\nbfqt\nsco\n",s=null!==i.expiryDate&&i.expiryDate.trim().length>0?s+"\n"+i.expiryDate:"expDateErrorMsg",s+="\n",s+="\nhttps\n2017-11-09\n",!e.dateRegx.test(i.expiryDate))throw new Error("Please enter date in UTC format YYYY-MM-DDThh:mm:ssZ.");var r,c=void 0,l=i.accessKey,u=cryptos.enc.Base64.parse(l);r=cryptos.HmacSHA256(s,u),c=cryptos.enc.Base64.stringify(r),c=encodeURIComponent(c),o="sv=2017-11-09&ss=bfqt&srt=sco&sp=rwdlacup&se="+i.expiryDate+"&spr=https&sig="+c,a="https://"+i.accountName+".file.core.windows.net/?comp=list&maxresults=1&"+o}}else if("Enter SAS"===i.connectionType){if(!i.sas)throw new Error("Invalid SAS token or service URL.");if(i.sas.includes("ss=")&&!i.sas.startsWith("http")){(o=i.sas).startsWith("?")&&(o=i.sas.substring(1,i.sas.length));var d=o.split("ss=")[1];if(d)switch(d.split("&")[0].charAt(0)){case"f":a="https://"+i.accountName+".file.core.windows.net/?comp=list&maxresults=1&"+o;break;case"t":a="https://"+i.accountName+".table.core.windows.net/Tables/?"+o;break;case"b":a="https://"+i.accountName+".blob.core.windows.net/?comp=list&maxresults=1&"+o;break;case"q":a="https://"+i.accountName+".queue.core.windows.net/?comp=list&maxresults=1&"+o;break;default:throw new Error("Invalid SAS token.")}}else(a=i.sas+"&maxresults=1").includes("comp")||(a+="&comp=list"),a.includes("restype")||(a+="&restype=container")}if(""===a)throw new Error("Please Enter Mandatory Field.");return wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,a).addHeader("Accept","application/json").addMethod("GET").send().switchMap(function(e){if(e.ok){for(var n=0;n<t.settings.length;n++)"WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.settings[n].name?"Generate SAS"===i.connectionType?t.settings[n].value='{"account_name":"'+i.accountName+'","access_key":"'+i.accessKey+'","expiry_date":"'+i.expiryDate+'","conn_type":"'+i.connectionType+'","sas_token":"?'+o+'"}':"Enter SAS"===i.connectionType&&(t.settings[n].value='{"account_name":"'+i.accountName+'","sas_token":"'+i.sas+'","conn_type":"'+i.connectionType+'"}'):"DocsMetadata"===t.settings[n].name&&(t.settings[n].value=schemadoc_1.JsonSchema.Types.schemaDoc());var a={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(a))}throw new Error("AuthenticationFailed, Make sure the value of Connection parammeters are correct.")}).catch(function(e){throw console.log("AuthenticationFailed: "+e),new Error("AuthenticationFailed, Make sure the value of Connection parameters are correct.")})})}}return e.getConnection=function(t,n){var i=new e(n);return rxjs_extensions_1.Observable.from(t).reduce(function(e,t){return e[t.name]=t.value,e},i)},e.dateRegx=/^\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[1-2]\d|3[0-1])T(?:[0-1]\d|2[0-3]):[0-5]\d:[0-5]\dZ/,e.regenerateTimeRegx=new RegExp("^([0-9]+[s,m,h])+$"),e}();exports.Connection=Connection;var TibcoAzureStorageConnectorContribution=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.NO_CHANGE=null,i.value=function(e,t){return i.validations[t.title]&&i.validations[t.title][e]&&delete i.validations[t.title][e],i.validations[t.title]||(i.validations[t.title]={}),null},i.validate=function(e,t){for(var n,i,o,a=0;a<t.settings.length;a++)"connectionType"===t.settings[a].name&&(n=t.settings[a].value),"regenerateFlag"===t.settings[a].name&&(i=t.settings[a].value),"authMode"===t.settings[a].name&&(o=t.settings[a].value);return"connectionType"===e?"SAS Token"===o?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"expiryDate"===e?"Generate SAS"===n&&"SAS Token"===o?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"accessKey"===e?"SAS Token"!==o||"Generate SAS"!==n&&!i?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0):"sas"===e?"SAS Token"===o&&"Enter SAS"===n?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"regenerateTime"===e?"SAS Token"===o&&i?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"regenerateFlag"===e?"SAS Token"===o?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"tenantID"===e?"OAuth2"===o?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"clientID"===e?"OAuth2"===o?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"clientSecret"===e?"OAuth2"===o?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):null},i.connection=function(e){var t=new Connection(i.http);return rxjs_extensions_1.Observable.from(e).reduce(function(e,t){return e[t.name]=t.value,e},t)},i.isDuplicate=function(e,t){return wi_contrib_1.WiContributionUtils.getConnections(i.http,i.category).mergeMap(function(e){return e}).map(function(e){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(e),ction:i.connection(e.settings)}}).filter(function(e){return e.id!==t}).mergeMap(function(e){return e.ction}).filter(function(t){return t.name===e.name}).reduce(function(e,t){return e.push(t),e},[]).map(function(e){return e.length>0})},i.validateRegenerateTime=function(e){return rxjs_extensions_1.Observable.of(Connection.regenerateTimeRegx.test(e.regenerateTime))},i.validateAccountName=function(e){if("Enter SAS"===e.connectionType&&e.sas.startsWith("http"))return new URL(e.sas).hostname.split(".")[0]===e.accountName?rxjs_extensions_1.Observable.of(!0):rxjs_extensions_1.Observable.of(!1);return rxjs_extensions_1.Observable.of(!0)},i.defaultResult=function(e){var t={context:e,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(t))},i.action=function(e,t){for(var n,o=0;o<t.settings.length;o++)"authMode"===t.settings[o].name?n=t.settings[o].value:"DocsMetadata"===t.settings[o].name&&(t.settings[o].value=schemadoc_1.JsonSchema.Types.schemaDoc());if("Login"===e)return i.connection(t.settings).switchMap(function(e){return i.isDuplicate(e,wi_contrib_1.WiContributionUtils.getUniqueId(t)).map(function(t){if(t)throw new Error("Connection with name "+e.name+" already exists");return e})}).switchMap(function(e){return i.validateRegenerateTime(e).map(function(t){if(!t&&e.regenerateFlag&&"SAS Token"==n)throw new Error("Please enter token validity in '01h01m01s' format");return e})}).switchMap(function(e){return i.validateAccountName(e).map(function(t){if(!t)throw new Error("Please enter valid account name and SAS token");return e})}).switchMap(function(e){return"SAS Token"===n?e.getSASCode(t):rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult({context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}}))}).catch(function(e){return console.log("Connection validation: "+e),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZSTORAGE-1001","Connection validation: "+e)))})},i.validations={},i.category="Azurestorage",i}return __extends(t,e),t=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.TibcoAzureStorageConnectorContribution=TibcoAzureStorageConnectorContribution;
//# sourceMappingURL=connector.js.map
