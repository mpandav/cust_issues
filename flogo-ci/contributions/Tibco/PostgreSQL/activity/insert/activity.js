"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var r,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(a=(o<3?r(a):o>3?r(t,n,a):r(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var Rx_1=require("rxjs/Rx"),http_1=require("@angular/http"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),connection_1=require("./connection"),PostgresInsertActivityContribution=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.dbserviceURL="/dbservicego/api/v2/schema",i.tablesColsServiceURL="/dbservicego/dbservice/tablesandcolumns",i.schemaListURL="/dbservicego/dbservice/schemas",i.dbDriver=function(e){return"PostgreSQL"===e?"postgres":"Redshift"===e?"redshift":"Greenplum"===e?"greenplum":void 0},i.getSSLMode=function(e){return"VerifyCA"===e?"verify-ca":"VerifyFull"===e?"verify-full":""},i.getSSLData=function(e,t){var n={};if("postgres"===t||"greenplum"===t){null!=(o=e.cacert.content)&&""!==o&&(n.sslrootcert={type:"file",extension:"pem",value:o});var i=e.clientcert.content;null!=i&&""!==i&&(n.sslcert={type:"file",extension:"pem",value:i});var r=e.clientkey.content;null!=r&&""!==r&&(n.sslkey={type:"file",extension:"pem",value:r})}else if("redshift"===t){var o;null!=(o=e.cacert.content)&&""!==o&&(n.TrustStore={type:"file",extension:"crt",value:o})}return JSON.stringify(n)},i.getConnectionString=function(e){var t,n,r,o,a,c,s,u,l="",d=i.dbDriver(e.databaseType);return t=btoa(d),n=btoa(e.host),r=btoa(e.port.toString()),o=btoa(e.databaseName),a=btoa(e.user),c=btoa(e.password),s=e.tlsconfig?btoa(i.getSSLMode(e.tlsparam)):btoa("disable"),u=btoa(e.name),null!=e.tlsconfig&&!0===e.tlsconfig&&(l=btoa(i.getSSLData(e,d))),"Driver="+t+"&Server="+n+"&Port="+r+"&Database="+o+"&Uid="+a+"&Pwd="+c+"&SSLMode="+s+"&ConnectionID="+u+"&SSLData="+l},i.fetchTableColMetaData=function(e,t){var n=i.getConnectionString(e)+"&schema="+t;return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(i.http,i.tablesColsServiceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===e.onprem?"false":e.onprem.toString()).addHeader("DatabaseType",i.dbDriver(e.databaseType)).addBody(n).send().map(function(e){try{return e.json()}catch(e){throw{message:"connection failed; unable to access dbservice"}}})},i.metadata=function(e,t){var n=i.getContextVar(t,"Connection"),r=wi_contrib_1.WiContributionUtils.getUniqueId(t),o=i.getContextVar(t,"Schema");return""===n?Rx_1.Observable.of(null):Rx_1.Observable.of({cname:n,uid:r}).switchMap(function(e){return wi_contrib_1.WiContributionUtils.getConnection(i.http,e.cname)}).switchMap(function(e){return connection_1.Connection.getConnection(e.settings)}).switchMap(function(e){return i.fetchTableColMetaData(e,o)}).map(function(e){try{return e}catch(e){throw{message:"fetching metadata failed;"}}})},i.fetchSchemaList=function(e){var t=i.getConnectionString(e);return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(i.http,i.schemaListURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===e.onprem?"false":e.onprem.toString()).addHeader("DatabaseType",i.dbDriver(e.databaseType)).addBody(t).send().map(function(e){try{return JSON.parse(JSON.stringify(e.json().data.sort()))}catch(e){throw{message:"connection failed: unable to access dbservice"}}})},i.value=function(e,t){var n=function(e){return!!e&&e.trim().length>0},r=function(e){return n(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")},o=i.getContextVar(t,"Connection"),a=i.getContextVar(t,"State"),c=i.getContextVar(t,"Query"),s=i.getContextVarBool(t,"manualmode"),u=i.getContextFetchData(t,"Fields"),l=wi_contrib_1.WiContributionUtils.getUniqueId(t),d=s?u:c;s&&n(d)&&!d.endsWith(";")&&(d+=";");var f=l+d,p=l+o;switch(i.validations[l]||(i.validations[l]={}),e){case"Connection":return wi_contrib_1.WiContributionUtils.getConnections(i.http,i.category).mergeMap(function(e){return e}).mergeMap(function(e){return Rx_1.Observable.from(e.settings).filter(function(e){return"name"===e.name}).map(function(t){return{unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:t.value}})}).reduce(function(e,t){return e.push(t),e},[]);case"Schema":return""===o?Rx_1.Observable.of(null):Rx_1.Observable.of({cname:o,uid:l}).switchMap(function(e){return wi_contrib_1.WiContributionUtils.getConnection(i.http,e.cname)}).switchMap(function(e){return connection_1.Connection.getConnection(e.settings)}).switchMap(function(e){return i.fetchSchemaList(e)}).map(function(e){try{return e}catch(e){throw{message:"fetching schemas failed; unable to access dbservice"}}});case"Fields":return Rx_1.Observable.of(f).switchMap(function(e){return e!==a&&""!==o&&r(d)?Rx_1.Observable.of(d):i.handleIncomplete(l,s)}).map(function(e){return{query:d,cname:o,uid:l}}).switchMap(function(n){return f!==a&&r(d)?i.fetchQueryMetadata(n,s,i.getContextVar(t,e)):i.getFields(n.query,i.getContextVar(t,e),s)}).map(function(e){return i.messaging.emit(p+"output",e),i.messaging.emit(p+"input",e),t.isQuery?{isSuccess:e.ok,error:e.message,value:e.ok?JSON.stringify(e.fields):null}:e.ok?JSON.stringify(e.fields):null});case"manualmode":return i.validations[l].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!s).setFetchUI(s)),null;case"input":return""===o?Rx_1.Observable.of(null):Rx_1.Observable.create(function(e){i.messaging.on(p+"input",function(t){null!==t&&(i.messaging.off(p+"input"),e.next(t))})}).switchMap(function(e){return e.ok?connection_1.Connection.getInsertInputSchema(e.fields).map(function(e){return JSON.stringify(e)}):Rx_1.Observable.of(null)});case"Output":return""===o?Rx_1.Observable.of(null):Rx_1.Observable.create(function(e){i.messaging.on(p+"output",function(t){null!==t&&(i.messaging.off(p+"output"),e.next(t))})}).switchMap(function(e){return e.ok?connection_1.Connection.getOutputSchema(e.fields).map(function(e){return JSON.stringify(e)}):Rx_1.Observable.of(null)});case"State":return Rx_1.Observable.of(f);case"QueryName":default:return null}},i.getFields=function(e,t,n){return connection_1.Connection.createFields(e,""===t?JSON.parse("[]"):JSON.parse(t),n,null).map(function(e){return""===t&&(e.ok=!1),e})},i.fetchQueryMetadata=function(e,t,n){return Rx_1.Observable.of(e).switchMap(function(e){return wi_contrib_1.WiContributionUtils.getConnection(i.http,e.cname)}).switchMap(function(e){return connection_1.Connection.getConnection(e.settings)}).switchMap(function(r){return r.fetchQueryMetadata(e.query,i.dbserviceURL,i.getSchema,t,n)}).map(function(t){return i.validations[e.uid].Query=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),i.validations[e.uid].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),t}).catch(function(n){var r=n instanceof http_1.Response?n.json().error.message:n.message;t?i.validations[e.uid].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("PSQL-QRY-MSG-1200",r)):i.validations[e.uid].Query=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("PSQL-QRY-MSG-1200",r));var o=r.includes("Param connection_id is required")?"Connection not added in settings":r;return i.validations[e.uid].Query=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("PSQL-QRY-MSG-1000",o)),Rx_1.Observable.of({ok:!1,message:r,query:e.qdata})})},i.handleIncomplete=function(e,t){return i.validations[e].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0).setReadOnly(!t).setFetchUI(t)),Rx_1.Observable.of(null)},i.validate=function(e,t){var n=wi_contrib_1.WiContributionUtils.getUniqueId(t);return i.validations[n]||(i.validations[n]={}),i.validations[n][e]},i.getSchema=function(e,t){t.queryString=t.queryString.replace(/%/g,"%25"),t.queryString=t.queryString.replace(/(\n)/g," "),t.queryString=t.queryString.replace(/(GROUP_CONCAT *\()(.*?)(SEPARATOR *[\'‘’].*?[\'‘’])/gi,"$1$2");var n=encodeURIComponent(t.queryString),r=i.getConnectionString(t.connection)+"&query="+n;return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(i.http,i.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===t.connection.onprem?"false":t.connection.onprem.toString()).addHeader("DatabaseType",i.dbDriver(t.connection.databaseType)).addBody(r).send().map(function(e){try{return e.json()}catch(e){throw{message:"connection failed; unable to access dbservice"}}})},i.messaging=new wi_contrib_1.WiContribMessaging,i.validations={},i.category="PostgreSQL",i}return __extends(t,e),t.prototype.getContextVar=function(e,t){var n=e.getField(t);return n&&n.value?n.value:""},t.prototype.getContextVarBool=function(e,t){var n=e.getField(t);return!(!n||!n.value)&&n.value},t.prototype.getContextFetchData=function(e,t){var n=e.getField(t);if(null!=n){var i=n.display.fetchQuery;if(i&&""!==i)return i}return""},t}(wi_contrib_1.WiServiceHandlerContribution);PostgresInsertActivityContribution=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],PostgresInsertActivityContribution),exports.PostgresInsertActivityContribution=PostgresInsertActivityContribution;var SQLQueryEncoder=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.encodeKey=function(e){return encodeURIComponent(e)},t.prototype.encodeValue=function(e){return encodeURIComponent(e)},t}(http_1.QueryEncoder);
//# sourceMappingURL=activity.js.map
