"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__decorate=this&&this.__decorate||function(e,t,n,o){var i,a=arguments.length,r=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(r=(a<3?i(r):a>3?i(t,n,r):i(t,n))||r);return a>3&&r&&Object.defineProperty(t,n,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),Observable_1=require("rxjs/Observable"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),Connection=function(){return function(){}}();exports.Connection=Connection;var connectionHandler=function(e){function t(t,n){var o=e.call(this,t,n)||this;return o.injector=t,o.http=n,o.value=function(e,t){var n=o.getConnection(t.settings);return"accessToken"===e?n.accessToken.trim().length>0&&n.authCode!==n.codeCheck?Observable_1.Observable.of(""):Observable_1.Observable.of(n.accessToken):"accessTokenExpiry"===e?n.accessTokenExpiry>0&&n.authCode!==n.codeCheck?Observable_1.Observable.of(0):Observable_1.Observable.of(n.accessTokenExpiry):"refreshToken"===e?n.refreshToken.trim().length>0&&n.authCode!==n.codeCheck?Observable_1.Observable.of(""):Observable_1.Observable.of(n.refreshToken):"refreshTokenExpiry"===e?n.refreshTokenExpiry>0&&n.authCode!==n.codeCheck?Observable_1.Observable.of(0):Observable_1.Observable.of(n.refreshTokenExpiry):"oktaAccessToken"===e?n.oktaAccessToken.trim().length>0&&n.authCode!==n.codeCheck?Observable_1.Observable.of(""):Observable_1.Observable.of(n.oktaAccessToken):"oktaAccessTokenExpiry"===e?n.oktaAccessTokenExpiry>0&&n.authCode!==n.codeCheck?Observable_1.Observable.of(0):Observable_1.Observable.of(n.oktaAccessTokenExpiry):"oktaRefreshToken"===e?n.oktaRefreshToken.trim().length>0&&n.authCode!==n.codeCheck?Observable_1.Observable.of(""):Observable_1.Observable.of(n.oktaRefreshToken):"codeCheck"===e?Observable_1.Observable.of(n.authCode):null},o.validate=function(e,t){var n;if("Connect"===e)switch((n=o.getConnection(t.settings)).authType){case"Basic Authentication":return n.name&&n.account&&n.warehouse&&n.database&&n.schema&&n.user&&n.password&&n.loginTimeout?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1):wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0);case"OAuth":switch(n.provider){case"Snowflake":return n.name&&n.account&&n.warehouse&&n.database&&n.schema&&n.clientId&&n.clientSecret&&n.authCode&&n.redirectURI&&n.accessToken.trim().length>0&&n.authCode===n.codeCheck?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1):wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0);case"Okta with PKCE":return n.name&&n.account&&n.warehouse&&n.database&&n.schema&&n.clientId&&n.oktaTokenEndpoint&&n.authCode&&n.redirectURI&&n.oktaCodeChallenge&&n.oktaCodeVerifier&&n.oktaAccessToken.trim().length>0&&n.authCode===n.codeCheck?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1):wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0)}default:return wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0)}if("Generate Access Token"===e)switch((n=o.getConnection(t.settings)).authType){case"OAuth":return"Snowflake"===n.provider?n.name&&n.account&&n.warehouse&&n.database&&n.schema&&n.clientId&&n.clientSecret&&n.authCode&&n.redirectURI&&(0===n.accessToken.trim().length||n.authCode!==n.codeCheck)?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1):wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0):n.name&&n.account&&n.warehouse&&n.database&&n.schema&&n.clientId&&n.authCode&&n.redirectURI&&n.oktaTokenEndpoint&&n.oktaCodeChallenge&&n.oktaCodeVerifier&&(0===n.oktaAccessToken.trim().length||n.authCode!==n.codeCheck)?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1):wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0);default:return wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0)}if("user"===e)return"Basic Authentication"===(n=o.getConnection(t.settings)).authType?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("password"===e)return"Basic Authentication"===(n=o.getConnection(t.settings)).authType?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("clientId"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("provider"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("clientSecret"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType&&"Snowflake"===n.provider?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("authCode"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("redirectURI"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("oktaTokenEndpoint"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType&&"Okta with PKCE"===n.provider?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("oktaCodeVerifier"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType&&"Okta with PKCE"===n.provider?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("oktaCodeChallenge"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType&&"Okta with PKCE"===n.provider?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("scope"===e)return"OAuth"===(n=o.getConnection(t.settings)).authType&&"Okta with PKCE"===n.provider?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("role"===e)return"Basic Authentication"===(n=o.getConnection(t.settings)).authType?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);if("loginTimeout"===e&&(n=o.getConnection(t.settings)).loginTimeout<0)return wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0).setError("SNOWFLAKE-1002","value for Login Timeout cannot be less than 0")},o.action=function(e,t){return"Connect"===e?o.connection(t.settings).switchMap(function(e){return o.isDuplicate(e,wi_contrib_1.WiContributionUtils.getUniqueId(t)).map(function(t){if(t)throw new Error("Connection with name "+e.name+" already exists");return e})}).switchMap(function(e){if("Basic Authentication"===e.authType||e.accessTokenExpiry>Date.now())return Observable_1.Observable.of({errString:"",conn:e});if("OAuth"===e.authType)switch(e.provider){case"Snowflake":if(e.refreshTokenExpiry<Date.now()){return Observable_1.Observable.of({errString:"Refresh Token has expired. Please provide a new authorization code and click on 'Generate Access Token'.",conn:e})}var n="https://"+e.account+".snowflakecomputing.com/oauth/token-request";return(i=new URLSearchParams).set("grant_type","refresh_token"),i.set("refresh_token",e.refreshToken),wi_contrib_1.WiProxyCORSUtils.createRequest(o.http,n).addMethod(wi_contrib_1.HTTP_METHOD.POST).addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Authorization","Basic "+btoa(e.clientId+":"+e.clientSecret)).addBody(i.toString()).send().map(function(n){if(!0===n.ok){for(var o=n.json(),i=Date.now(),a=0;a<t.settings.length;a++)if("accessToken"===t.settings[a].name&&(t.settings[a].value=o.access_token),"accessTokenExpiry"===t.settings[a].name){var r=i+1e3*o.expires_in;t.settings[a].value=r}return e.accessToken=o.access_token,e.accessTokenExpiry=i+1e3*o.expires_in,{errString:"",conn:e}}return{errString:"Error while generating access token. "+n.json(),conn:e}});case"Okta with PKCE":var i;return e.oktaAccessTokenExpiry<Date.now()?((i=new URLSearchParams).set("client_id",e.clientId),i.set("redirect_uri",e.redirectURI),i.set("code_verifier",e.oktaCodeVerifier),i.set("scope",e.scope),i.set("grant_type","refresh_token"),i.set("refresh_token",e.oktaRefreshToken),wi_contrib_1.WiProxyCORSUtils.createRequest(o.http,e.oktaTokenEndpoint).addMethod(wi_contrib_1.HTTP_METHOD.POST).addHeader("Content-Type","application/x-www-form-urlencoded").addBody(i.toString()).send().map(function(n){if(!0===n.ok){for(var o=n.json(),i=Date.now(),a=0;a<t.settings.length;a++){if("oktaAccessToken"===t.settings[a].name&&(t.settings[a].value=o.access_token),"oktaAccessTokenExpiry"===t.settings[a].name){var r=i+1e3*o.expires_in;t.settings[a].value=r}"oktaRefreshToken"===t.settings[a].name&&(t.settings[a].value=o.refresh_token)}return e.oktaAccessToken=o.access_token,e.oktaAccessTokenExpiry=i+1e3*o.expires_in,e.oktaRefreshToken=o.refresh_token,{errString:"",conn:e}}return{errString:"Error while generating access token from refresh token: "+n.json(),conn:e}})):Observable_1.Observable.of({errString:"",conn:e})}}).switchMap(function(e){return wi_contrib_1.WiContributionUtils.getAppConfig(o.http).switchMap(function(n){if(n.deployment===wi_contrib_1.APP_DEPLOYMENT.CLOUD){var i="",a="";if("Basic Authentication"===e.conn.authType)console.log("Basic Authentication"),i=e.conn.role.trim().length>0?e.conn.account+"/"+e.conn.database+"?warehouse="+e.conn.warehouse+"&schema="+e.conn.schema+"&loginTimeout="+e.conn.loginTimeout+"&role="+e.conn.role+"&application=TIBCO_FLOGO":e.conn.account+"/"+e.conn.database+"?warehouse="+e.conn.warehouse+"&schema="+e.conn.schema+"&loginTimeout="+e.conn.loginTimeout+"&application=TIBCO_FLOGO",a=btoa("Basic "+e.conn.user+":"+e.conn.password);else{console.log("OAuth");var r="";if("Snowflake"===e.conn.provider){if(0===e.conn.accessToken.trim().length)throw new Error("Access token not generated.");r=encodeURIComponent(e.conn.accessToken),a=btoa("Bearer "+r),i=e.conn.account+"/"+e.conn.database+"?warehouse="+e.conn.warehouse+"&schema="+e.conn.schema+"&loginTimeout="+e.conn.loginTimeout+"&authenticator=oauth&application=TIBCO_FLOGO"}else{if(0===e.conn.oktaAccessToken.trim().length)throw new Error("Access token not generated.");r=encodeURIComponent(e.conn.oktaAccessToken),a=btoa("Bearer "+r),i=e.conn.account+"/"+e.conn.database+"?warehouse="+e.conn.warehouse+"&schema="+e.conn.schema+"&loginTimeout="+e.conn.loginTimeout+"&authenticator=oauth&application=TIBCO_FLOGO"}}return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("GET").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("DatabaseUrl",i).addHeader("Authorization",a).addHeader("DatabaseType","snowflake").send().switchMap(function(e){var n=e.json();if(!0===n.error){var o="Authentication Failure, Error message "+n.errorMsg;throw new Error(o)}var i={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return console.log("cloud deploy"),Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setResult(i))})}var s,c,l,u,d,b,h,_,w=void 0,k=void 0;s=btoa("snowflake"),c=btoa(e.conn.account+".snowflakecomputing.com"),l=btoa(e.conn.database),u=btoa(e.conn.schema),d=btoa(e.conn.role.trim()),b=btoa(e.conn.warehouse),h=btoa("TIBCO_FLOGO"),_=btoa(e.conn.loginTimeout);var f=void 0;if("Basic Authentication"===e.conn.authType)console.log("Basic Authentication"),w=btoa("Basic"),f="Uid="+btoa(e.conn.user)+"&Pwd="+btoa(e.conn.password);else{if(console.log("OAuth"),w=btoa("oauth"),"Snowflake"===e.conn.provider){if(0===e.conn.accessToken.trim().length)throw new Error("Access token not generated.");k=btoa(e.conn.accessToken)}else{if(0===e.conn.oktaAccessToken.trim().length)throw new Error("Access token not generated.");k=btoa(e.conn.oktaAccessToken)}f="Token="+k}return console.log("post body ::","Driver="+s+"&Server="+c+"&Database="+l+"&Schema="+u+"&Role="+d+"&Warehouse="+b+"&Authenticator="+w+"&Application="+h+"&Login_timeout="+_+"&"+f),wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise","true").addHeader("DatabaseType","snowflake").addBody("Driver="+s+"&Server="+c+"&Database="+l+"&Schema="+u+"&Role="+d+"&Warehouse="+b+"&Authenticator="+w+"&Application="+h+"&Login_timeout="+_+"&"+f).send().switchMap(function(e){var n=e.json();if(!0===n.error){var o="Authentication Failure, Error message "+n.errorMsg;throw new Error(o)}var i={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return console.log("on premise"),Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setResult(i))})})}).catch(function(e){return"Bad Gateway"===e.statusText?Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1001","Test connection failed: Bad Gateway. Check status of 'DB Service' or if 'Accout Name' is correct"))):void 0===e.message?Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1001","Test connection failed: "+e.json().error.message))):Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1001","Test connection failed: "+e.message)))}):"Generate Access Token"===e?Observable_1.Observable.create(function(e){var n=o.getConnection(t.settings);if("Snowflake"!==n.provider)return(a=new URLSearchParams).set("client_id",n.clientId),a.set("redirect_uri",n.redirectURI),a.set("code",n.authCode),a.set("scope",n.scope),a.set("grant_type","authorization_code"),a.set("code_verifier",n.oktaCodeVerifier),wi_contrib_1.WiProxyCORSUtils.createRequest(o.http,n.oktaTokenEndpoint).addMethod(wi_contrib_1.HTTP_METHOD.POST).addHeader("Content-Type","application/x-www-form-urlencoded").addBody(a.toString()).send().subscribe(function(n){if(!0===n.ok)for(var o=n.json(),i=Date.now(),a=0;a<t.settings.length;a++){if("oktaAccessToken"===t.settings[a].name&&(t.settings[a].value=o.access_token),"oktaAccessTokenExpiry"===t.settings[a].name){var r=i+1e3*o.expires_in;t.settings[a].value=r}"oktaRefreshToken"===t.settings[a].name&&(t.settings[a].value=o.refresh_token)}var s={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(s))},function(t){var n;n=""+t._body,e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1004","Error while generating access token for Okta:"+t.statusText+". "+n)))});var i="https://"+n.account+".snowflakecomputing.com/oauth/token-request",a=new URLSearchParams;a.set("grant_type","authorization_code"),a.set("code",n.authCode),a.set("redirect_uri",n.redirectURI),wi_contrib_1.WiProxyCORSUtils.createRequest(o.http,i).addMethod(wi_contrib_1.HTTP_METHOD.POST).addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Authorization","Basic "+btoa(n.clientId+":"+n.clientSecret)).addBody(a.toString()).send().subscribe(function(n){if(!0===n.ok){for(var o=n.json(),i=Date.now(),a=0;a<t.settings.length;a++){if("accessToken"===t.settings[a].name&&(t.settings[a].value=o.access_token),"refreshToken"===t.settings[a].name&&(t.settings[a].value=o.refresh_token),"accessTokenExpiry"===t.settings[a].name){var r=i+1e3*o.expires_in;t.settings[a].value=r}if("refreshTokenExpiry"===t.settings[a].name){var s=i+1e3*o.refresh_token_expires_in;t.settings[a].value=s}}var c={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(c))}else{var l=void 0;l="invalid_grant"===n.json.error?"Error while generating access token. The given 'Authorization Code' is not valid.":"invalid_client"===n.json.error?"Error while generating access token. The 'Client ID' or 'Client Secret' is incorrect":"invalid_request"===n.json.error?"Error while generating access token. Please check if 'Redirect URI' is correct":""+n.json(),e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1003",l)))}},function(t){var n;n=-1!==(n=""+t._body).search("invalid_grant")?"The given 'Authorization Code' is not valid.":-1!==n.search("invalid_client")?"The 'Client ID' or 'Client Secret' is incorrect":-1!==n.search("invalid_request")?"Please check if 'Redirect URI' is correct":""+t._body,e.next(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1003","Error while generating access token. "+t.statusText+". "+n)))})}):void 0},o.connection=function(e){var t=new Connection;return Observable_1.Observable.from(e).reduce(function(e,t){return e[t.name]=t.value,e},t)},o.isDuplicate=function(e,t){return wi_contrib_1.WiContributionUtils.getConnections(o.http,o.category).mergeMap(function(e){return e}).map(function(e){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(e),ction:o.connection(e.settings)}}).filter(function(e){return e.id!==t}).mergeMap(function(e){return e.ction}).filter(function(t){return t.name===e.name}).reduce(function(e,t){return e.push(t),e},[]).map(function(e){return e.length>0})},o.getConnection=function(e){for(var t=new Connection,n=0,o=e;n<o.length;n++){var i=o[n];switch(i.name){case"name":t.name=i.value;break;case"account":t.account=i.value;break;case"warehouse":t.warehouse=i.value;break;case"database":t.database=i.value;break;case"schema":t.schema=i.value;break;case"authType":t.authType=i.value;break;case"provider":t.provider=i.value;break;case"user":t.user=i.value;break;case"password":t.password=i.value;break;case"clientId":t.clientId=i.value;break;case"clientSecret":t.clientSecret=i.value;break;case"authCode":t.authCode=i.value;break;case"redirectURI":t.redirectURI=i.value;break;case"scope":t.scope=i.value;break;case"oktaTokenEndpoint":t.oktaTokenEndpoint=i.value;break;case"accessToken":t.accessToken=i.value;break;case"oktaAccessToken":t.oktaAccessToken=i.value;break;case"refreshToken":t.refreshToken=i.value;break;case"oktaRefreshToken":t.oktaRefreshToken=i.value;break;case"oktaCodeVerifier":t.oktaCodeVerifier=i.value;break;case"oktaCodeChallenge":t.oktaCodeChallenge=i.value;break;case"role":t.role=i.value;break;case"loginTimeout":t.loginTimeout=i.value;break;case"accessTokenExpiry":t.accessTokenExpiry=i.value;break;case"oktaAccessTokenExpiry":t.oktaAccessTokenExpiry=i.value;break;case"refreshTokenExpiry":t.refreshTokenExpiry=i.value;break;case"codeCheck":t.codeCheck=i.value}}return t},o.category="Snowflake",o.dbserviceURL="/dbservicego/api/v2/dbtest",o}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);connectionHandler=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http])],connectionHandler),exports.connectionHandler=connectionHandler;
//# sourceMappingURL=connectionHandler.js.map
