"use strict";var __decorate=this&&this.__decorate||function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),activity_jsonschema_1=require("./activity.jsonschema"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions");require("rxjs/Rx");var NUMBER="NUMBER",FLOAT="FLOAT",TEXT="TEXT",BOOLEAN="BOOLEAN",DATE="DATE",TIME="TIME",Connection=function(){return function(){}}();exports.Connection=Connection;var QueryMetadata=function(){return function(e,t,r,n){this.ok=e,this.message=t,this.query=r,this.fields=n}}();exports.QueryMetadata=QueryMetadata;var Fields=function(){return function(e,t,r,n,i,s){this.FieldName=e,this.Type=t,this.Selected=r,this.Parameter=n,this.isEditable=i,this.Ordinal=s}}();exports.Fields=Fields;var DBSchemaServices_1,DBSchemaServices=DBSchemaServices_1=function(){function e(e){this.http=e,this.dbserviceURL="/dbservice/api/v2/schema",this.queries=[]}return e.toJsonType=function(e){var t={};switch(e.Type){case NUMBER:t=activity_jsonschema_1.JsonSchema.Types.integerType();break;case FLOAT:t=activity_jsonschema_1.JsonSchema.Types.numberType();break;case TEXT:t=activity_jsonschema_1.JsonSchema.Types.stringType();break;case BOOLEAN:t=activity_jsonschema_1.JsonSchema.Types.boolType();break;case DATE:case TIME:t=activity_jsonschema_1.JsonSchema.Types.dateType();break;default:t=activity_jsonschema_1.JsonSchema.Types.stringType()}return t},e.prototype.getConnection=function(e){var t=new Connection;return wi_contrib_1.WiContributionUtils.getConnection(this.http,e).mergeMap(function(e){return rxjs_extensions_1.Observable.from(e.settings).reduce(function(e,r){return t[r.name]=r.value,e},t)})},e.prototype.getInsertInputSchema=function(e){var t=activity_jsonschema_1.JsonSchema.Types.rootObject(),r=activity_jsonschema_1.JsonSchema.Types.valuesObject();t.properties.values=r.records;var n=activity_jsonschema_1.JsonSchema.Types.inputObject();return t.properties.parameters=n.parameters,rxjs_extensions_1.Observable.from(e).reduce(function(e,t){return!0!==t.Value&&"true"!==t.Value||(e.properties.values.items.properties[t.FieldName]=DBSchemaServices_1.toJsonType(t)),!0!==t.Parameter&&"true"!==t.Parameter||!0!==t.Value&&"true"!==t.Value&&(e.properties.parameters.properties[t.FieldName]=DBSchemaServices_1.toJsonType(t)),e},t).mergeMap(function(e){return rxjs_extensions_1.Observable.of(t)})},e.prototype.sortFields=function(e,t){return e.Ordinal-t.Ordinal},e.prototype.fetchQueryMetadata=function(e,t,r,n,i){var s=this;return rxjs_extensions_1.Observable.of(t).filter(function(e){return function(e){return!!e&&e.trim().length>0}(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")}).map(function(t){return Object.assign({queryString:t,queryURL:s.dbserviceURL,connection:e})}).mergeMap(function(e){return r(e)}).mergeMap(function(e){return s.createFields(t,e.Fields,n,i)})},e.prototype.createFields=function(e,t,r,n){var i=this,s=t;if(r&&void 0!==n&&""!==n&&(s=s.concat(JSON.parse(n))),null!=s){for(var a=[(s=s.filter(function(e){return null!=e}).sort(this.sortFields))[0]],o=1;o<s.length;o++){for(var c=!1,u=0;u<a.length;u++)if(o!==u&&s[o].FieldName===a[u].FieldName){void 0!==s[o].Value&&(a[u].Value=s[o].Value),c=!0;break}c||a.push(s[o])}s=a}return rxjs_extensions_1.Observable.from(s).reduce(function(e,t){if(t){var n={FieldName:t.FieldName,Type:t.Type,Selected:t.Selected,Parameter:t.Parameter,isEditable:r,Ordinal:t.Ordinal,Value:void 0!==t.Value&&t.Value};e.fields.push(n),e.fields.sort(i.sortFields)}return e},{ok:!0,query:e,fields:[]})},e.getOutputSchema=function(){var e=activity_jsonschema_1.JsonSchema.Types.rootObject(),t={};return t.rowsAffected=activity_jsonschema_1.JsonSchema.Types.numberType(),e.properties=t,rxjs_extensions_1.Observable.of(e)},e}();DBSchemaServices=DBSchemaServices_1=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[http_1.Http])],DBSchemaServices),exports.DBSchemaServices=DBSchemaServices;
//# sourceMappingURL=activity.schema.services.js.map
