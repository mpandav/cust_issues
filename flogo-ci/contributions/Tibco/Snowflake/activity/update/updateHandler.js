"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__decorate=this&&this.__decorate||function(e,t,n,o){var r,a=arguments.length,i=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,o);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(i=(a<3?r(i):a>3?r(t,n,i):r(t,n))||i);return a>3&&i&&Object.defineProperty(t,n,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),Observable_1=require("rxjs/Observable"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),activity_schema_services_1=require("./activity.schema.services"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),updateHandler=function(e){function t(t,n){var o=e.call(this,t,n)||this;return o.injector=t,o.http=n,o.dbserviceURL="/dbservicego/api/v2/schema",o.value=function(e,t){var n=function(e){return!!e&&e.trim().length>0},r=function(e){return n(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")},a=o.getContextVar(t,"Snowflake Connection"),i=o.getContextVar(t,"State"),c=o.getContextVar(t,"Query"),s=o.getContextVarBool(t,"manualmode"),u=o.getContextFetchData(t,"Fields"),l=s?u:c;s&&n(l)&&!l.endsWith(";")&&(l+=";");var d=wi_contrib_1.WiContributionUtils.getUniqueId(t),b=d+a+l,f=d+a;switch(o.validations[d]||(o.validations[d]={}),e){case"Snowflake Connection":return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(o.http,o.category).subscribe(function(n){n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})});case"manualmode":return o.validations[d].Fields=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!s).setFetchUI(s)),null;case"Fields":return Observable_1.Observable.of(b).switchMap(function(e){return e!==i&&""!==a&&r(l)?Observable_1.Observable.of(l):o.handleIncomplete(d,s)}).map(function(e){return{query:l,cname:a,uid:d}}).switchMap(function(n){return b!==i&&r(l)?o.fetchQueryMetadata(n,s,o.getContextVar(t,e)):o.getFields(n.query,o.getContextVar(t,e),s)}).map(function(e){return o.messaging.emit(f+"output",e),o.messaging.emit(f+"input",e),t.isQuery?{isSuccess:e.ok,error:e.message,value:e.ok?JSON.stringify(e.fields):JSON.stringify([])}:e.ok?JSON.stringify(e.fields):JSON.stringify([])});case"input":return""===a?Observable_1.Observable.of(null):Observable_1.Observable.create(function(e){o.messaging.on(f+"input",function(t){null!==t&&(o.messaging.off(f+"input"),e.next(t))})}).switchMap(function(e){return e.ok?o.schemaServices.getInputSchema(e.fields).map(function(e){return JSON.stringify(e)}):Observable_1.Observable.of({})});case"output":return""===a?Observable_1.Observable.of(null):Observable_1.Observable.create(function(e){o.messaging.on(f+"output",function(t){null!==t&&(o.messaging.off(f+"output"),e.next(t))})}).switchMap(function(e){return e.ok?activity_schema_services_1.DBSchemaServices.getOutputSchema().map(function(e){return JSON.stringify(e)}):Observable_1.Observable.of({})});case"State":return Observable_1.Observable.of(b);default:return null}},o.validate=function(e,t){var n=wi_contrib_1.WiContributionUtils.getUniqueId(t);return o.validations[n]||(o.validations[n]={}),o.validations[n][e]},o.action=function(e,t){return Observable_1.Observable.create(function(e){var t=wi_contrib_1.ActionResult.newActionResult();e.next(t)})},o.isValidSQLUpdateStatement=function(e){return!!e.trim().toUpperCase().startsWith("UPDATE")},o.handleIncomplete=function(e,t){return o.validations[e].Query=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),o.validations[e].Fields=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0).setReadOnly(!t).setFetchUI(t)),Observable_1.Observable.of(null)},o.fetchQueryMetadata=function(e,t,n){return Observable_1.Observable.of(e).switchMap(function(e){return o.schemaServices.getConnection(e.cname)}).switchMap(function(e){if("Basic Authentication"===e.authType||e.accessTokenExpiry>Date.now())return Observable_1.Observable.of({errString:"",conn:e});if("OAuth"===e.authType)switch(e.provider){case"Snowflake":if(e.refreshTokenExpiry<Date.now()){return Observable_1.Observable.of({errString:"Refresh Token has expired. Please navigate to connection, provide a new authorization code and click on 'Generate Access Token'.",conn:e})}var t="https://"+e.account+".snowflakecomputing.com/oauth/token-request";return(n=new URLSearchParams).set("grant_type","refresh_token"),n.set("refresh_token",e.refreshToken),wi_contrib_1.WiProxyCORSUtils.createRequest(o.http,t).addMethod(wi_contrib_1.HTTP_METHOD.POST).addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Authorization","Basic "+btoa(e.clientId+":"+e.clientSecret)).addBody(n.toString()).send().map(function(t){if(!0===t.ok){var n=t.json(),o=Date.now();return e.accessToken=n.access_token,e.accessTokenExpiry=o+1e3*n.expires_in,{errString:"",conn:e}}return{errString:"Error while generating access token. "+t.json(),conn:e}});case"Okta with PKCE":var n;return e.oktaAccessTokenExpiry<Date.now()?((n=new URLSearchParams).set("client_id",e.clientId),n.set("redirect_uri",e.redirectURI),n.set("code_verifier",e.oktaCodeVerifier),n.set("scope",e.scope),n.set("grant_type","refresh_token"),n.set("refresh_token",e.oktaRefreshToken),wi_contrib_1.WiProxyCORSUtils.createRequest(o.http,e.oktaTokenEndpoint).addMethod(wi_contrib_1.HTTP_METHOD.POST).addHeader("Content-Type","application/x-www-form-urlencoded").addBody(n.toString()).send().map(function(t){if(!0===t.ok){var n=t.json(),o=Date.now();return e.oktaAccessToken=n.access_token,e.oktaAccessTokenExpiry=o+1e3*n.expires_in,e.oktaRefreshToken=n.refresh_token,{errString:"",conn:e}}return{errString:"Error while generating access token from refresh token: "+t.json(),conn:e}})):Observable_1.Observable.of({errString:"",conn:e})}}).switchMap(function(e){if(""!==e.errString)throw Error(e.errString);return Observable_1.Observable.of(e.conn)}).switchMap(function(r){return o.schemaServices.fetchQueryMetadata(r,e.query,o.getSchema,t,n)}).map(function(t){return o.validations[e.uid].Query=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),o.validations[e.uid].Fields=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),t}).catch(function(n){var r=n instanceof http_1.Response?n.json().error.message:n.message;return t?o.validations[e.uid].Fields=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("SNOWFLAKE-UPDATE-MSG-1001",r)):o.validations[e.uid].Query=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("SNOWFLAKE-UPDATE-MSG-1002",r)),Observable_1.Observable.of({ok:!1,message:r,query:e.query})})},o.getFields=function(e,t,n){return o.schemaServices.createFields(e,""===t||void 0===t?JSON.parse("[]"):JSON.parse(t),n,null).map(function(e){return""===t&&(e.ok=!1),e})},o.getSchema=function(e){return wi_contrib_1.WiContributionUtils.getAppConfig(o.http).switchMap(function(t){if(t.deployment===wi_contrib_1.APP_DEPLOYMENT.CLOUD){var n="",r="";if("Basic Authentication"===e.connection.authType)console.log("Basic Authentication"),n=e.connection.role.trim().length>0?e.connection.account+"/"+e.connection.database+"?warehouse="+e.connection.warehouse+"&schema="+e.connection.schema+"&loginTimeout="+e.connection.loginTimeout+"&role="+e.connection.role+"&application=TIBCO_FLOGO":e.connection.account+"/"+e.connection.database+"?warehouse="+e.connection.warehouse+"&schema="+e.connection.schema+"&loginTimeout="+e.connection.loginTimeout+"&application=TIBCO_FLOGO",r=btoa("Basic "+e.connection.user+":"+e.connection.password);else{console.log("OAuth");var a="";a="Snowflake"===e.connection.provider?encodeURIComponent(e.connection.accessToken):encodeURIComponent(e.connection.oktaAccessToken),r=btoa("Bearer "+a),n=e.connection.account+"/"+e.connection.database+"?authenticator=oauth&schema="+e.connection.schema+"&warehouse="+e.connection.warehouse+"&loginTimeout="+e.connection.loginTimeout+"&application=TIBCO_FLOGO"}return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("GET").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("DatabaseUrl",n).addHeader("Authorization",r).addHeader("DatabaseType","snowflake").addQueryParams("query",e.queryString).send().map(function(e){console.log("on cloud");try{return e.json()}catch(e){throw{message:"connection failed. unable to access dbservice"}}})}var i,c,s,u,l,d,b,f,p=void 0,_=void 0;i=btoa("snowflake"),c=btoa(e.connection.account+".snowflakecomputing.com"),s=btoa(e.connection.database),u=btoa(e.connection.schema),l=btoa(e.connection.role.trim()),d=btoa(e.connection.warehouse),b=btoa("TIBCO_FLOGO"),f=btoa(e.connection.loginTimeout);var h=void 0;if("Basic Authentication"===e.connection.authType)console.log("Basic Authentication"),p=btoa("Basic"),h="Uid="+btoa(e.connection.user)+"&Pwd="+btoa(e.connection.password);else{if(console.log("OAuth"),p=btoa("oauth"),"Snowflake"===e.connection.provider){if(0===e.connection.accessToken.trim().length)throw new Error("Access token not generated.");_=btoa(e.connection.accessToken)}else{if(0===e.connection.oktaAccessToken.trim().length)throw new Error("Access token not generated.");_=btoa(e.connection.oktaAccessToken)}h="Token="+_}var v=encodeURIComponent(e.queryString);return console.log("post body ::","Driver="+i+"&Server="+c+"&query="+v+"&Database="+s+"&Schema="+u+"&Role="+l+"&Warehouse="+d+"&Authenticator="+p+"&Application="+b+"&Login_timeout="+f+"&"+h),wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise","true").addHeader("DatabaseType","snowflake").addBody("Driver="+i+"&Server="+c+"&query="+v+"&Database="+s+"&Schema="+u+"&Role="+l+"&Warehouse="+d+"&Authenticator="+p+"&Application="+b+"&Login_timeout="+f+"&"+h).send().map(function(e){console.log("on premise");try{return e.json()}catch(e){throw{message:"connection failed. unable to access dbservice"}}})})},o.messaging=new wi_contrib_1.WiContribMessaging,o.category="Snowflake",o.schemaServices=new activity_schema_services_1.DBSchemaServices(n),o.validations={},o}return __extends(t,e),t.prototype.getContextVar=function(e,t){return e.getField(t)?e.getField(t).value:""},t.prototype.getContextVarBool=function(e,t){var n=e.getField(t);return!(!n||!n.value)&&n.value},t.prototype.getContextFetchData=function(e,t){var n=e.getField(t);if(null!=n){var o=n.display.fetchQuery;if(o&&""!==o)return o}return""},t}(wi_contrib_1.WiServiceHandlerContribution);updateHandler=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http])],updateHandler),exports.updateHandler=updateHandler;
//# sourceMappingURL=updateHandler.js.map
