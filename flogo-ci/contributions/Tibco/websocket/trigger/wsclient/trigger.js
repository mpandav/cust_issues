"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),__decorate=this&&this.__decorate||function(e,t,r,a){var i,n=arguments.length,o=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,a);else for(var l=e.length-1;l>=0;l--)(i=e[l])&&(o=(n<3?i(o):n>3?i(t,r,o):i(t,r))||o);return n>3&&o&&Object.defineProperty(t,r,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var http_1=require("@angular/http"),core_1=require("@angular/core"),Observable_1=require("rxjs/Observable"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),validation_1=require("wi-studio/common/models/validation"),WSClientContribModule=function(e){function t(t,r,a){var i=e.call(this,t,r,a)||this;return i.injector=t,i.http=r,i.contribModelService=a,i.value=function(e,t){var r=i.getContextVar(t,"format"),a=i.getContextVar(t,"jsonSchema");switch(e){case"content":return Observable_1.Observable.of(i.getMessageSchemaString(r,a));case"queryParams":return Observable_1.Observable.create(function(e){var r={},a=t.getField("queryParamsConfig");if(void 0!==a.value&&""!==a.value.value)try{!a.value||null!==a.value&&void 0!==a.value&&""!==a.value||(e.next(""),e.complete());for(var i=JSON.parse(a.value),n=0,o=i;n<o.length;n++){var l=o[n];r[l.parameterName]=l.value}var s={type:"object"};s.properties=r,e.next(r),e.complete()}catch(t){e.next(null),e.complete()}});case"headers":return Observable_1.Observable.create(function(e){var r={},a=t.getField("headersConfig");if(void 0!==a.value&&""!==a.value.value)try{!a.value||null!==a.value&&void 0!==a.value&&""!==a.value||(e.next(""),e.complete());for(var i=JSON.parse(a.value),n=0,o=i;n<o.length;n++){var l=o[n];r[l.parameterName]=l.value}var s={type:"object"};s.properties=r,e.next(r),e.complete()}catch(t){e.next(null),e.complete()}});default:return null}},i.validate=function(e,t){var r=i.getContextVar(t,"format"),a=i.getContextVar(t,"url"),n=i.getContextVar(t,"allowInsecure"),o=a.indexOf("wss")>=0;switch(e){case"url":return/(^(ws)(s)?:\/\/[^\s$.?#].[^\s]*\b([-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))/gi.test(a)?validation_1.ValidationResult.newValidationResult().setValid(!0).setVisible(!0):validation_1.ValidationResult.newValidationResult().setValid(!1).setError("WebSocketSubscriber-00301","WebSocket URI is not in valid format").setVisible(!0);case"jsonSchema":return validation_1.ValidationResult.newValidationResult().setVisible("JSON"===r);case"allowInsecure":return validation_1.ValidationResult.newValidationResult().setVisible(o);case"caCert":return o?!n&&i.isFileVarVoid("caCert",t)?validation_1.ValidationResult.newValidationResult().setValid(!1).setError("WS-00203","TLS secure connection requires a CA Cert").setVisible(!0):validation_1.ValidationResult.newValidationResult().setValid(!0).setVisible(!n):validation_1.ValidationResult.newValidationResult().setValid(!0).setVisible(!1);case"queryParamsConfig":case"headersConfig":return i.validateParametersByName(e,t);default:return null}},i.category="websocket",i}return __extends(t,e),t.prototype.getContextVar=function(e,t){return e.getField(t)&&void 0!==e.getField(t).value?e.getField(t).value:null},t.prototype.getMessageSchemaString=function(e,t){return"JSON"===e?t:""},t.prototype.isFileVarVoid=function(e,t){var r=t.getField(e).value;if(null!==r){if(""===r.toString())return!0;if(""===r.content)return!0}return!1},t.prototype.validateParametersByName=function(e,t){return Observable_1.Observable.create(function(r){var a=validation_1.ValidationResult.newValidationResult(),i=t.getField(e),n=[],o="",l={};try{l=JSON.parse(i.value)}catch(e){}for(var s=0,u=l;s<u.length;s++){var c=u[s];if(!c.parameterName){o="Parameter Name should not be empty",a.setError("WebSocketSubscriber-1001",o),a.setValid(!1);break}for(var d=0,v=n;d<v.length;d++){if(v[d]===c.parameterName){o="Parameter Name '"+c.parameterName+"' already exists",a.setError("WebSocketSubscriber-1001",o),a.setValid(!1);break}}if(n.push(c.parameterName),!c.value||""===c.value.trim()){o="Parameter Value should not be empty",a.setError("WebSocketSubscriber-1002",o),a.setValid(!1);break}for(var b=0,p=c.value.split(",");b<p.length;b++){if(""===p[b].trim()){o="Parameter Value in Array should not be empty",a.setError("WebSocketSubscriber-1003",o),a.setValid(!1);break}}}r.next(a),r.complete()})},t}(wi_contrib_1.WiServiceHandlerContribution);WSClientContribModule=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],WSClientContribModule),exports.WSClientContribModule=WSClientContribModule;
//# sourceMappingURL=trigger.js.map
