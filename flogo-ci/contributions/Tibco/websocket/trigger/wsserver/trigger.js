"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,i,r){var a,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var l=e.length-1;l>=0;l--)(a=e[l])&&(o=(n<3?a(o):n>3?a(t,i,o):a(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions"),validation_1=require("wi-studio/common/models/validation"),contributionHelper_1=require("wi-studio/common/util/contributionHelper"),lodash=require("lodash"),contrib_2=require("wi-studio/common/models/contrib"),WSServerContribModule=function(e){function t(t,i,r){var a=e.call(this,t,i,r)||this;return a.injector=t,a.http=i,a.contribModelService=r,a.value=function(e,t){var i=a.getContextVar(t,"format"),r=a.getContextVar(t,"jsonSchema");if(e===contrib_2.METADATA.MANIFEST){for(var n=[],o={},l=a.getModelService().getApplication().getTriggerFlowModelMaps(),s=0;s<l.length;s++){l[s].getFlowModel();var u=l[s].getTriggerElement();"wsserver"===u.name&&void 0===o[u.getId()]&&(n.push(a.genActualEndpoint(u)),o[u.getId()]=u.getId())}return JSON.stringify(n)}if("pathParams"===e){var d=t.getField("path");return contributionHelper_1.ContributionHelper.extractJsonFromPath(d.value)}return"content"===e?rxjs_extensions_1.Observable.of(a.getPayloadSchemaString(i,r)):null},a.onprem=!1,a.validate=function(e,t){var i="true"===t.getField("enableTLS").value.toString(),r="true"===t.getField("enableClientAuth").value.toString(),n=a.getContextVar(t,"format"),o=a.getContextVar(t,"mode"),l=a.getContextVar(t,"path"),s=a.getContextVar(t,"port"),u=a.getContextVar(t,"method");switch(e){case"enableTLS":return rxjs_extensions_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getAppConfig(a.http).subscribe(function(t){t.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?(a.onprem=!0,e.next(validation_1.ValidationResult.newValidationResult().setVisible(!0))):e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(t){e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(){return e.complete()})});case"serverCert":return a.onprem&&i&&a.isFileVarVoid("serverCert",t)?validation_1.ValidationResult.newValidationResult().setValid(!1).setError("WSSR-00200","Configure the Server Cert file").setVisible(!0):validation_1.ValidationResult.newValidationResult().setValid(!0).setVisible(a.onprem&&i);case"serverKey":return a.onprem&&i&&a.isFileVarVoid("serverKey",t)?validation_1.ValidationResult.newValidationResult().setValid(!1).setError("WSSR-00201","Configure the Server Key file").setVisible(!0):validation_1.ValidationResult.newValidationResult().setValid(!0).setVisible(a.onprem&&i);case"trustStore":return r&&a.isFileVarVoid("trustStore",t)?validation_1.ValidationResult.newValidationResult().setValid(!1).setError("WSSR-00202","Configure the Trust Store with Client Cert").setVisible(!0):validation_1.ValidationResult.newValidationResult().setValid(!0).setVisible(r);case"format":return validation_1.ValidationResult.newValidationResult().setVisible("Data"===o);case"jsonSchema":return validation_1.ValidationResult.newValidationResult().setVisible("Data"===o&&"JSON"===n);case"content":return validation_1.ValidationResult.newValidationResult().setVisible("Data"===o);case"path":if(t.getMode()===contrib_2.MODE.WIZARD||t.getMode()===contrib_2.MODE.SERVERLESS_FLOW){var d=a.getModelService().getApplication(),c=a.formSettings(d);return a.verifyPathStartSlash(l)?a.isValid(u,c,l,s)?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setError("PATH_ERROR","Resource Path already exists or is invalid.").setVisible(!0):validation_1.ValidationResult.newValidationResult().setError("PATH_ERROR",'Path required and should start with "/" like "/pets/{id}"').setVisible(!0)}return validation_1.ValidationResult.newValidationResult().setVisible(!0);case"queryParams":case"headers":return a.validateParametersByName(e,t);case"Save":return i&&(a.isFileVarVoid("serverCert",t)||a.isFileVarVoid("serverKey",t))||r&&a.isFileVarVoid("trustStore",t)?validation_1.ValidationResult.newValidationResult().setValid(!1).setReadOnly(!0):validation_1.ValidationResult.newValidationResult().setValid(!1).setReadOnly(!1);default:return null}},a.action=function(e,t){for(var i=a.getModelService(),r=wi_contrib_1.CreateFlowActionResult.newActionResult(),n=i.createTriggerElement("websocket/wsserver"),o=t.getField("format").value,l=t.getField("jsonSchema").value,s=t.getField("wsconnection").value,u=t.getField("mode").value,d=t.getField("pathParams").value,c=t.getField("queryParams").value,p=t.getField("headers").value,g=0;g<n.handler.settings.length;g++)n.handler.settings[g].value=t.getField(n.handler.settings[g].name).value;for(var v=a.contribModelService.createMapping(),h=0;h<n.outputs.length;h++)"content"===n.outputs[h].name&&("JSON"===o&&(n.outputs[h].value=l),v.addMapping("$INPUT['content']",a.contribModelService.createMapExpression().setExpression("$trigger.content"))),"wsconnection"===n.outputs[h].name&&("Connection"===u&&(n.outputs[h].value=s),v.addMapping("$INPUT['wsconnection']",a.contribModelService.createMapExpression().setExpression("$trigger.wsconnection"))),"pathParams"===n.outputs[h].name&&(d&&d.value&&(n.outputs[h].value=d.value),v.addMapping("$INPUT['pathParams']",a.contribModelService.createMapExpression().setExpression("$trigger.pathParams"))),"queryParams"===n.outputs[h].name&&(c&&c.value&&(n.outputs[h].value=c.value),v.addMapping("$INPUT['queryParams']",a.contribModelService.createMapExpression().setExpression("$trigger.queryParams"))),"headers"===n.outputs[h].name&&(p&&p.value&&(n.outputs[h].value=p.value),v.addMapping("$INPUT['headers']",a.contribModelService.createMapExpression().setExpression("$trigger.headers"))),"format"===n.outputs[h].name&&(n.outputs[h].value=o),"jsonSchema"===n.outputs[h].name&&(n.outputs[h].value=l);n.inputMappings=v;var f=i.createFlow(t.getFlowName(),t.getFlowDescription());return r=r.addTriggerFlowMapping(lodash.cloneDeep(n),lodash.cloneDeep(f)),contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(r)},a.category="websocket",a}return __extends(t,e),t.prototype.isFileVarVoid=function(e,t){var i=t.getField(e).value;if(null!==i){if(""===i.toString())return!0;if(""===i.content)return!0}return!1},t.prototype.getContextVar=function(e,t){return e.getField(t)?void 0===e.getField(t).value?"":e.getField(t).value:""},t.prototype.getPayloadSchemaString=function(e,t){return"JSON"===e?t:""},t.prototype.validateParametersByName=function(e,t){return rxjs_extensions_1.Observable.create(function(i){var r=validation_1.ValidationResult.newValidationResult(),a=t.getField(e),n=[],o="",l={};try{l=JSON.parse(a.value)}catch(e){}for(var s=0,u=l;s<u.length;s++){var d=u[s];if(!d.parameterName){o="Parameter Name should not be empty",r.setError("WebSocketServerTrigger-1001",o),r.setValid(!1);break}for(var c=0,p=n;c<p.length;c++){if(p[c]===d.parameterName){o="Parameter Name '"+d.parameterName+"' already exists",r.setError("WebSocketServerTrigger-1001",o),r.setValid(!1);break}}n.push(d.parameterName)}i.next(r),i.complete()})},t.prototype.verifyPathStartSlash=function(e){if("/"===e)return!0;return/(?:(?:^\/){1}(?:(?:(?:[\{]{1})(?:[-a-zA-Z0-9_\:]+)(?:[\}]{1}))|(?:[-a-zA-Z0-9_]+))){1}(?:(?:(?:[\/]{1})(?:(?:(?:[\{]{1})(?:[-a-zA-Z0-9_\:]+)(?:[\}]{1}))|(?:[-a-zA-Z0-9_\:]+)))*)$/i.test(e)},t.prototype.genActualEndpoint=function(e){return{protocol:"http",port:this.genPort(e),name:e.title,type:"public"}},t.prototype.genPort=function(e){for(var t=e.settings,i=0;i<t.length;i++)if("port"===t[i].name)return String(t[i].value)},t.prototype.isValid=function(e,t,i,r){var a;for(a=0;a<t.length;a++){if(t[a].port===r)if(t[a].method===e){if(t[a].path===i)break;if(!this.pathValidation(t[a].path,i,!0))break}else if(t[a].path!==i&&!this.pathValidation(t[a].path,i,!1))break}return a===t.length},t.prototype.pathValidation=function(e,t,i){if(e&&t){var r=e.trim().split("/"),a=t.trim().split("/");if(""===r[r.length-1]&&r.splice(r.length-1,1),""===a[a.length-1]&&a.splice(a.length-1,1),r.length!==a.length)return!0;var n=void 0;for(n=0;n<r.length;n++)if(r[n]===r[n].replace(/.*\{|\}/gi,"")){if(a[n]!==a[n].replace(/.*\{|\}/gi,""))break;if(r[n]&&a[n]&&r[n]!==a[n])break}else{if(a[n]===a[n].replace(/.*\{|\}/gi,""))break;if(r[n]&&a[n]&&!i&&r[n]!==a[n])break}return n!==r.length}return!1},t.prototype.formSettings=function(e){for(var t=[],i=e.getTriggerFlowModelMaps(),r=0;r<i.length;r++){var a=i[r].getTriggerElement();if("wsserver"===a.name&&a.display&&"websocket"===a.display.category){for(var n={},o=0;o<a.handler.settings.length;o++)"method"===a.handler.settings[o].name.toLowerCase()?n.method=a.handler.settings[o].value:"path"===a.handler.settings[o].name.toLowerCase()&&(n.path=a.handler.settings[o].value);a.settings&&a.settings.length>0&&(n.port=a.settings[0].value),t.push(n)}}return t},t}(wi_contrib_1.WiServiceHandlerContribution);WSServerContribModule=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],WSServerContribModule),exports.WSServerContribModule=WSServerContribModule;
//# sourceMappingURL=trigger.js.map
