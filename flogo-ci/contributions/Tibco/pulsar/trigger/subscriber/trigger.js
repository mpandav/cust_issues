"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,i,r){var n,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(o<3?n(a):o>3?n(t,i,a):n(t,i))||a);return o>3&&a&&Object.defineProperty(t,i,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PulsarContribModule=void 0;var http_1=require("@angular/http"),core_1=require("@angular/core"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),PulsarContribModule=function(e){function t(t,i,r){var n=e.call(this,t,i,r)||this;return n.injector=t,n.http=i,n.contribModelService=r,n.msgSchema='{"key": "string", "properties": [{"name":"value"}],"message":"string"}',n.value=function(e,t){var i=n.getContextVar(t,"format"),r=(n.getContextVar(t,"propertiesSchema"),n.getContextVar(t,"jsonSchema"));switch(e){case"connection":return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(n.http,n.category).subscribe(function(i){i.forEach(function(e){for(var i=0;i<e.settings.length;i++)if("name"===e.settings[i].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[i].value});break}}),e.next(t)})});case"payload":return Observable_1.Observable.of(n.getPayloadSchemaString(i,r))}return null},n.validate=function(e,t){var i=n.getContextVar(t,"format"),r=n.getContextVar(t,"seek"),o=n.getContextVar(t,"subscriptionType");switch(e){case"jsonSchema":return wi_contrib_1.ValidationResult.newValidationResult().setVisible("JSON"===i);case"dlqTopic":case"dlqMaxDeliveries":return wi_contrib_1.ValidationResult.newValidationResult().setVisible("Shared"===o);case"seekTime":var a=n.getContextVar(t,"seekTime");return"Seek By Timestamp"===r?n.isValidRFC3339(a)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0).setError("Invalid Timestamp","Invalid timestamp, Please provide a timestamp in RFC 3339 format."):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);case"entryId":var s=n.getContextVar(t,"entryId");return"Seek By MessageID"===r?s<0?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0).setError("Invalid entryId","Invalid entryId, Entry ID shoud be a non negative integer"):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);case"ledgerId":var l=n.getContextVar(t,"ledgerId");return"Seek By MessageID"===r?l<0?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0).setError("Invalid ledgerId","Invalid ledgerId, Ledger ID shoud be a non negative integer"):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1);default:return null}},n.action=function(e,t){var i=n.getModelService(),r=wi_contrib_1.CreateFlowActionResult.newActionResult(),o=i.createTriggerElement("pulsar/pulsar-subscriber"),a=t.getField("connection"),s=t.getField("format").value,l=t.getField("jsonSchema").value,u=t.getField("properties");if(a&&a.value){for(var c=0;c<o.settings.length;c++)"connection"===o.settings[c].name&&(o.settings[c].value=a.value);for(var d=0;d<o.handler.settings.length;d++)o.handler.settings[d].value=t.getField(o.handler.settings[d].name).value;for(var p=n.contribModelService.createMapping(),g=0;g<o.outputs.length;g++)"payload"===o.outputs[g].name&&("JSON"===s&&(o.outputs[g].value=l),p.addMapping("$INPUT['payload']",n.contribModelService.createMapExpression().setExpression("$trigger.payload"))),"properties"===o.outputs[g].name&&(u&&u.value&&(o.outputs[g].value=u.value),p.addMapping("$INPUT['properties']",n.contribModelService.createMapExpression().setExpression("$trigger.properties"))),"topic"===o.outputs[g].name&&p.addMapping("$INPUT['topic']",n.contribModelService.createMapExpression().setExpression("$trigger.topic")),"msgid"===o.outputs[g].name&&p.addMapping("$INPUT['msgid']",n.contribModelService.createMapExpression().setExpression("$trigger.msgid")),"entryid"===o.outputs[g].name&&p.addMapping("$INPUT['entryid']",n.contribModelService.createMapExpression().setExpression("$trigger.entryid")),"ledgerid"===o.outputs[g].name&&p.addMapping("$INPUT['ledgerid']",n.contribModelService.createMapExpression().setExpression("$trigger.ledgerid")),"redeliveryCount"===o.outputs[g].name&&p.addMapping("$INPUT['redeliveryCount']",n.contribModelService.createMapExpression().setExpression("$trigger.redeliveryCount")),"format"===o.outputs[g].name&&(o.outputs[g].value=s),"jsonSchema"===o.outputs[g].name&&(o.outputs[g].value=l);o.inputMappings=p;var b=i.createFlow(t.getFlowName(),t.getFlowDescription());r=r.addTriggerFlowMapping(lodash.cloneDeep(o),lodash.cloneDeep(b))}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(r)},n.category="pulsar",n}return __extends(t,e),t.prototype.getPayloadSchemaString=function(e,t){return"JSON"===e?t:""},t.prototype.getContextVar=function(e,t){return e.getField(t)?void 0===e.getField(t).value?"":e.getField(t).value:""},t.prototype.getContextBooleanVar=function(e,t){return!!e.getField(t)&&(void 0!==e.getField(t).value&&"true"===e.getField(t).value)},t.prototype.isValidRFC3339=function(e){if(!new RegExp("^"+/[0-9]{4}/.source+"-"+/(0[1-9]|1[0-2])/.source+"-"+/([12][0-9]|0[1-9]|3[01])/.source+"T"+/([01][0-9]|2[0-3])/.source+":"+/[0-5][0-9]/.source+":"+/([0-5][0-9]|60)/.source+/(\.\d{1,3})?/.source+"("+/Z|([+-](0[0-9]|1[0-3]):([0-5][0-9]))/.source+")?$").test(e))return!1;var t=e.split("T"),i=t[0],r=(t[1],i.split("-").map(Number)),n=r[0],o=r[1],a=r[2],s=new Date(n,o,0).getDate();return!(a<1||a>s)},t=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.PulsarContribModule=PulsarContribModule;
//# sourceMappingURL=trigger.js.map
