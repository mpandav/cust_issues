"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var r,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(s=(a<3?r(s):a>3?r(t,n,s):r(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var RESTConnectorService_1,core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),validation_1=require("wi-studio/common/models/validation"),contrib_1=require("wi-studio/common/models/contrib"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),RESTConnectorService=RESTConnectorService_1=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.value=function(e,t){if("name"===e||"description"===e)return null;if("callbackURL"===e)return Observable_1.Observable.create(function(e){var n=t.getField("type");n&&"OAuth2"===n.value?wi_contrib_1.WiContributionUtils.getEnvironment(i.http,"OAUTH_REDIRECT_URL").subscribe(function(t){e.next(t.value),e.complete()}):(e.next(null),e.complete())});if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e){if("Client Credentials"===t.getField("grantType").value){for(var n=0,r=t.settings;n<r.length;n++){if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===(c=r[n]).name)return i.isBase64(c.value)?c.value:btoa(c.value)}return null}for(var a=function(e){if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e.name)try{var n=JSON.parse(e.value),r=RESTConnectorService_1.authCodeMap.has(wi_contrib_1.WiContributionUtils.getUniqueId(t))?RESTConnectorService_1.authCodeMap.get(wi_contrib_1.WiContributionUtils.getUniqueId(t)):"";if(n.code&&r!==n.code)return RESTConnectorService_1.authCodeMap.set(wi_contrib_1.WiContributionUtils.getUniqueId(t),n.code),{value:Observable_1.Observable.create(function(e){i.getOauthConfig(t).subscribe(function(r){var a=n.code;i.getAccessToken(t,a).subscribe(function(t){var n={client_id:r.client_id};n=lodash.assign(n,t);var i=btoa(JSON.stringify(n));e.next(i)},function(t){e.next("")})})})}}catch(e){return{value:null}}},s=0,o=t.settings;s<o.length;s++){var c,u=a(c=o[s]);if("object"==typeof u)return u.value}}return null},i.validate=function(e,t){var n=t.getField("type"),r=validation_1.ValidationResult.newValidationResult();if("userName"===e||"password"===e)return"Basic"===n.value?r.setVisible(!0):r.setVisible(!1),r;if("token"===e)return"Bearer Token"===n.value?r.setVisible(!0):r.setVisible(!1),r;if("authURL"===e||"callbackURL"===e||"authQueryParameters"===e)return"OAuth2"===n.value?("Client Credentials"===t.getField("grantType").value?r.setVisible(!1):r.setVisible(!0),r):(r.setVisible(!1),r);if("grantType"===e||"accessTokenURL"===e||"clientId"===e||"clientSecret"===e||"scope"===e||"clientAuthentication"===e||"token"===e||"audience"===e)return"OAuth2"===n.value?r.setVisible(!0):r.setVisible(!1),r;if("method"===e)return null;if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e){var a=t.getField("type");return a&&"OAuth2"!==a.value?(r.setVisible(!1),r):"Client Credentials"===t.getField("grantType").value?null:i.checkForTokens(t)}return"Save"===e?"Basic"===n.value||"Bearer Token"===n.value?(r.setVisible(!0),r):(r.setVisible(!1),r):"Login"===e?"OAuth2"===n.value?(r.setVisible(!0),r):(r.setVisible(!1),r):null},i.action=function(e,t){if("Login"===e||"Save"===e)return Observable_1.Observable.create(function(e){for(var n="",r="",a="Basic",s=0;s<t.settings.length;s++)"name"===t.settings[s].name&&(n=t.settings[s].value),"grantType"===t.settings[s].name&&(r=t.settings[s].value),"type"===t.settings[s].name&&(a=t.settings[s].value);if("Basic"===a||"Bearer Token"===a){var o={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return e.next(contrib_1.ActionResult.newActionResult().setResult(o)),void e.complete()}if("Client Credentials"!==r){var c=!1;wi_contrib_1.WiContributionUtils.getConnections(i.http,"General").subscribe(function(r){for(var a=0,s=r;a<s.length;a++)for(var o=s[a],u=0;u<o.settings.length;u++){if("name"===o.settings[u].name)if(o.settings[u].value===n&&wi_contrib_1.WiContributionUtils.getUniqueId(o)!==wi_contrib_1.WiContributionUtils.getUniqueId(t)){c=!0;break}}if(c)e.next(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("REST-1000","Connection name already exist !!!"))),e.complete();else{for(u=0;u<t.settings.length;u++)if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.settings[u].name){t.settings[u].value;break}i.checkForTokens(t).isValid(),i.getOauthConfig(t).subscribe(function(n){var r={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.OAUTH2,authData:{authLoginUrl:i.getAuthLoginUrl(t,n),authStateQueryParam:"state"}};e.next(contrib_1.ActionResult.newActionResult().setResult(r))})}})}else{var u="",l="",b="",_="",d="",v="";for(s=0;s<t.settings.length;s++)"accessTokenURL"===t.settings[s].name&&(u=t.settings[s].value),"clientId"===t.settings[s].name&&(b=t.settings[s].value),"clientSecret"===t.settings[s].name&&(_=t.settings[s].value),"clientAuthentication"===t.settings[s].name&&(l=t.settings[s].value),"scope"===t.settings[s].name&&(d=t.settings[s].value),"audience"===t.settings[s].name&&(v=t.settings[s].value);i.createAuthReuqest(l,u,"client_credentials",b,_,"","",d,v).excludeHeaders(["origin"]).send().subscribe(function(n){for(var i=n.json(),r=0;r<t.settings.length;r++)if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.settings[r].name){t.settings[r].value=JSON.stringify(i);break}var a={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};e.next(contrib_1.ActionResult.newActionResult().setResult(a)),e.complete()},function(t){console.log(t),e.next(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("REST-1001","Failed to get access token - "+t._body))),e.complete()},function(){})}})},i}return __extends(t,e),t.prototype.getAuthLoginUrl=function(e,t){var n=t.client_id,i=t.callback_url,r=t.authUrl,a=t.scope,s=t.authURLQueryParam,o=r+"?response_type=code&scope="+a+"&client_id="+n+"&redirect_uri="+i+"&audience="+t.audience+"&"+s;return encodeURI(o)},t.prototype.getAccessToken=function(e,t){var n=this;return Observable_1.Observable.create(function(i){n.getOauthConfig(e).subscribe(function(e){var r=n.createAuthReuqest("Body",e.accessTokenUrl,"authorization_code",e.client_id,e.client_secret,e.callback_url,t,"",e.audience);r.addHeader("Content-Type","application/x-www-form-urlencoded").excludeHeaders(["origin"]),r.send().subscribe(function(e){if(200===e.status){var t=e.json();i.next(t)}else i.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){console.log(e),i.error({code:e.status,message:"Failed to get access token",details:e.json()})})})})},t.prototype.getOauthConfig=function(e){var t=this;return Observable_1.Observable.create(function(n){wi_contrib_1.WiContributionUtils.getAppConfig(t.http).subscribe(function(i){Observable_1.Observable.zip(t.getScope(e),t.getAuthURL(e),t.getAccessTokenURL(e),t.getClientId(e),t.getClientSecret(e),t.getCallBackURL(e),t.getDeployment(i.deployment),t.getAUthURLQueryParamters(e),t.getClientAuth(e),t.getAudience(e),function(e,t,n,i,r,a,s,o,c,u){return{scope:e.value,authUrl:t.value,accessTokenUrl:n.value,client_id:i.value,client_secret:r.value,callback_url:a.value,deployEnv:s.value,authURLQueryParam:o.value,clientAuth:c.value,audience:u.value}}).subscribe(function(e){n.next(e)})},function(e){Observable_1.Observable.zip(wi_contrib_1.WiContributionUtils.getEnvironment(t.http,"WISTUDIO_SALESFORCE_CLIENT_ID"),wi_contrib_1.WiContributionUtils.getEnvironment(t.http,"OAUTH_REDIRECT_URL"),t.getDeployment(wi_contrib_1.APP_DEPLOYMENT.CLOUD),function(e,t,n){return{client_id:e.value,callback_url:t.value,deployEnv:n.value}}).subscribe(function(e){n.next(e)})})})},t.prototype.checkForTokens=function(e){for(var t=0,n=e.settings;t<n.length;t++){var i=n[t];if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===i.name){var r=validation_1.ValidationResult.newValidationResult().setReadOnly(!0);if(!i.value)return r.setValid(!1),r;try{var a=void 0;return(a=i.value.startsWith("{")?JSON.parse(i.value):JSON.parse(atob(i.value))).access_token?(a.refresh_token||r.setValid(!1),r.setVisible(!0)):(r.setValid(!1),r.setVisible(!0))}catch(e){return r.setValid(!1),r}}}},t.prototype.getDeployment=function(e){return Observable_1.Observable.create(function(t){t.next({value:e})})},t.prototype.getAUthURLQueryParamters=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("authQueryParameters"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getClientId=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("clientId"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getScope=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("scope"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getCallBackURL=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("callbackURL"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getClientSecret=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("clientSecret"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getClientAuth=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("clientAuthentication"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getAuthURL=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("authURL"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getAccessTokenURL=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("accessTokenURL"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.getAudience=function(e){return Observable_1.Observable.create(function(t){for(var n="",i=0;i<e.settings.length;i++)if("audience"===e.settings[i].name){n=e.settings[i].value;break}t.next({value:n})})},t.prototype.createAuthReuqest=function(e,t,n,i,r,a,s,o,c){if("Query"===e){var u=wi_contrib_1.WiProxyCORSUtils.createRequest(this.http,t).addMethod("GET").addQueryParams("grant_type",n).addQueryParams("client_id",i).addQueryParams("client_secret",r);return""!==s&&u.addQueryParams("code",decodeURIComponent(s)),""!==o&&u.addQueryParams("scope",o),""!==a&&u.addQueryParams("redirect_uri",a),""!==c&&u.addQueryParams("audience",c),u}if("Body"===e){u=wi_contrib_1.WiProxyCORSUtils.createRequest(this.http,t).addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded");return(l=new http_1.URLSearchParams).set("grant_type",n),""!==s&&(l.set("code",decodeURIComponent(s)),u.addAuthorization("Basic "+btoa(i+":"+r))),""!==o&&l.set("scope",o),l.set("client_id",i),l.set("client_secret",r),""!==a&&l.set("redirect_uri",a),""!==c&&l.set("audience",c),u.addBody(l.toString()),u}var l;if("Header"===e)return(l=new http_1.URLSearchParams).set("grant_type",n),""!==s&&l.set("code",decodeURIComponent(s)),""!==o&&l.set("scope",o),""!==a&&l.set("redirect_uri",a),""!==c&&l.set("audience",c),(u=wi_contrib_1.WiProxyCORSUtils.createRequest(this.http,t).addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded")).addBody(l.toString()),u.addAuthorization("Basic "+btoa(i+":"+r)),u},t.prototype.isBase64=function(e){try{return btoa(atob(e))===e}catch(e){return!1}},t}(wi_contrib_1.WiServiceHandlerContribution);RESTConnectorService.authCodeMap=new Map,RESTConnectorService=RESTConnectorService_1=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],RESTConnectorService),exports.RESTConnectorService=RESTConnectorService;
//# sourceMappingURL=connector.js.map
