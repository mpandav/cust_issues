"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),__decorate=this&&this.__decorate||function(e,t,i,a){var r,s=arguments.length,n=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,a);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(n=(s<3?r(n):s>3?r(t,i,n):r(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var http_1=require("@angular/http"),core_1=require("@angular/core"),schema=require("generate-schema"),rxjs_1=require("rxjs"),operators_1=require("rxjs/operators"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),flogo_flow_create_providers_1=require("@tibco/flogo-flow-create-providers"),flogo_contrib_sdk_1=require("@tibco/flogo-contrib-sdk"),SwaggerValidationService_1=require("./SwaggerValidationService"),contributionHelper_1=require("wi-studio/common/util/contributionHelper"),contrib_1=require("wi-studio/common/models/contrib"),validation_1=require("wi-studio/common/models/validation"),SPEC_PREFIX="spec://",ModelServiceFacade=function(){function e(e){this.modelService=e}return e.prototype.createTriggerElement=function(e){return this.modelService.createTriggerElement(e)},e.prototype.createFlow=function(e,t,i){return this.modelService.createFlow(e,t,i)},e.prototype.createFlowElement=function(e){return this.modelService.createFlowElement(e)},e}();exports.ModelServiceFacade=ModelServiceFacade;var _a,_b,_c,RestTriggerService=function(e){function t(t,i,a,r,s,n){var o=e.call(this,t,i,a)||this;return o.injector=t,o.http=i,o.contribModelService=a,o.parsingService=r,o.configurationService=s,o.appSpecsService=n,o.deRefMap={},o.encodedRESTPreviousSwagger={},o.schemaRegistry={},o.incrementSchemaId=0,o.APISpecsMap={},o.value=function(e,t){if(console.log(t.getMode()),e===contrib_1.METADATA.MANIFEST){for(var i=[],a=o.generateEndpoint(),r=Object.keys(a),s=r.length>1,n=0;n<r.length;n++){var l=a[r[n]];l.id=r[n],i.push(o.genActualEndpoint(l,s))}return JSON.stringify(i)}if("swaggerVersion"===e)return rxjs_1.Observable.create(function(e){var i=t.id;o.messaging.on(i+"version",function(i){if(null!=i&&!0===i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(a&&""!==a){var r="string"==typeof a&&a.startsWith(SPEC_PREFIX),s=void 0;if(r){var n=a.replace(SPEC_PREFIX,"");s=o.appSpecsService.getAppSpecById(n)}else s=rxjs_1.Observable.of(a);s.subscribe(function(i){if(i&&i.content){var s=r?a:a.filename;o.APISpecsMap[s+".version"]&&void 0!==o.APISpecsMap[s+".version"]?(o.messaging.off(t.id+"version"),e.next(o.APISpecsMap[s+".version"]),e.complete()):(o.messaging.off(t.id+"version"),e.next(null),e.complete())}else o.messaging.off(t.id+"version"),e.next(null),e.complete()})}else o.messaging.off(t.id+"version"),e.next(null),e.complete()}else null!=i&&!1===i&&(o.messaging.off(t.id+"version"),e.next(null),e.complete())})});if("apiVersion"===e)return rxjs_1.Observable.create(function(e){var i=t.id;o.messaging.on(i+"apiVersion",function(i){if(null!=i&&!0===i){console.log("data === true");var a=t.getField("swagger")?t.getField("swagger").value:null;if(a&&""!==a){var r="string"==typeof a&&a.startsWith(SPEC_PREFIX),s=void 0;if(r){var n=a.replace(SPEC_PREFIX,"");s=o.appSpecsService.getAppSpecById(n)}else s=rxjs_1.Observable.of(a);s.subscribe(function(i){if(i&&i.content){var s=r?a:a.filename;o.APISpecsMap[s+".apiVersion"]&&void 0!==o.APISpecsMap[s+".apiVersion"]?(o.messaging.off(t.id+"apiVersion"),e.next(o.APISpecsMap[s+".apiVersion"]),e.complete()):(o.messaging.off(t.id+"apiVersion"),e.next(null),e.complete())}else o.messaging.off(t.id+"apiVersion"),e.next(null),e.complete()})}else o.messaging.off(t.id+"apiVersion"),e.next(null),e.complete()}else null!=i&&!1===i&&(o.messaging.off(t.id+"apiVersion"),e.next(null),e.complete())})});if("queryParams"===e)return rxjs_1.Observable.create(function(e){var i=t.id;o.messaging.on(i+"query",function(i){if(null!=i&&!0===i)if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){var a=t.getField("queryParams").value,r=t.getField("swagger")?t.getField("swagger").value:null,s=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,n=t.getField("Method").value;if(r&&s&&n&&""!==r&&""!==s&&""!==n){var l="string"==typeof r&&r.startsWith(SPEC_PREFIX),p=void 0;if(l){var d=r.replace(SPEC_PREFIX,"");p=o.appSpecsService.getAppSpecById(d)}else p=rxjs_1.Observable.of(r);p.subscribe(function(i){if(i&&i.content){var p=l?r:r.filename;if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].queryUpdation)if(a&&o.APISpecsMap[p]&&"[]"!==a.value){var d=o.APISpecsMap[p][s][n.toLowerCase()].query;o.APISpecsMap[p][s][n.toLowerCase()].queryUpdation=!1,o.messaging.off(t.id+"query"),e.next(d)}else o.messaging.off(t.id+"query"),e.next("");else if((t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)&&(o.isPathChanged||o.isMethodChanged))if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].query!==a){var g=o.APISpecsMap[p][s][n.toLowerCase()].query;o.messaging.off(t.id+"query"),"[]"!==g&&0!==g.length||(g=""),e.next(g),e.complete()}else o.messaging.off(t.id+"query"),e.next(null),e.complete();else o.messaging.off(t.id+"query"),e.next(null),e.complete()}else o.messaging.off(t.id+"query"),e.next("")})}else o.messaging.off(t.id+"query"),e.next(null),e.complete()}else o.messaging.off(t.id+"query"),e.next(null),e.complete();else null!=i&&!1===i&&(o.messaging.off(t.id+"query"),e.next(null),e.complete())})});if("headers"===e)return rxjs_1.Observable.create(function(e){o.messaging.on(t.id+"header",function(i){if(null!=i&&!0===i)if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){var a=t.getField("headers").value,r=t.getField("swagger")?t.getField("swagger").value:null,s=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,n=t.getField("Method").value;if(r&&s&&n&&""!==r&&""!==s&&""!==n){var l="string"==typeof r&&r.startsWith(SPEC_PREFIX),p=void 0;if(l){var d=r.replace(SPEC_PREFIX,"");p=o.appSpecsService.getAppSpecById(d)}else p=rxjs_1.Observable.of(r);p.subscribe(function(i){if(i&&i.content){var p=l?r:r.filename;if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].headersUpdation)if(a&&o.APISpecsMap[p]&&"[]"!==a.value){var d=o.APISpecsMap[p][s][n.toLowerCase()].headers;d=d&&"[]"!==d?d.substring(0,d.indexOf("]"))+',{"parameterName":"Accept","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Charset","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Encoding","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Type","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Length","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Connection","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Cookie","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Pragma","type":"string","repeating":"false","required":"false","visible":false}]':'[{"parameterName":"Accept","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Charset","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Encoding","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Type","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Length","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Connection","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Cookie","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Pragma","type":"string","repeating":"false","required":"false","visible":false}]',o.APISpecsMap[p][s][n.toLowerCase()].headersUpdation=!1,o.messaging.off(t.id+"header"),e.next(d),e.complete()}else o.messaging.off(t.id+"header"),e.next(""),e.complete();else if((t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)&&(o.isPathChanged||o.isMethodChanged))if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].headers!==a){var g=o.APISpecsMap[p][s][n.toLowerCase()].headers;o.messaging.off(t.id+"header"),"[]"!==g&&0!==g.length||(g=""),e.next(g),e.complete()}else o.messaging.off(t.id+"header"),e.next(null),e.complete();else o.messaging.off(t.id+"header"),e.next(null),e.complete()}else o.messaging.off(t.id+"header"),e.next(""),e.complete()})}else o.messaging.off(t.id+"header"),e.next(null),e.complete()}else o.messaging.off(t.id+"header"),e.next(null),e.complete();else null!=i&&!1===i&&(o.messaging.off(t.id+"header"),e.next(null),e.complete())})});if("body"===e)return rxjs_1.Observable.create(function(e){o.messaging.on(t.id+"body",function(i){if(null!=i&&!0===i)if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){var a=t.getField("body").value,r=t.getField("swagger")?t.getField("swagger").value:null,s=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,n=t.getField("Method").value;if(r&&s&&n&&""!==r&&""!==s&&""!==n){var l="string"==typeof r&&r.startsWith(SPEC_PREFIX),p=void 0;if(l){var d=r.replace(SPEC_PREFIX,"");p=o.appSpecsService.getAppSpecById(d)}else p=rxjs_1.Observable.of(r);p.subscribe(function(i){if(i&&i.content){var p=l?r:r.filename;if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].inputSchemaUpdation)if(a&&o.APISpecsMap[p]&&"[]"!==a.value){var d=o.APISpecsMap[p][s][n.toLowerCase()].inputSchema;d&&""!==d?(o.APISpecsMap[p][s][n.toLowerCase()].inputSchemaUpdation=!1,o.messaging.off(t.id+"body"),e.next(d),e.complete()):(o.APISpecsMap[p][s][n.toLowerCase()].inputSchemaUpdation=!1,o.messaging.off(t.id+"body"),e.next(""),e.complete())}else o.messaging.off(t.id+"body"),e.next(""),e.complete();else if((t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)&&(o.isPathChanged||o.isMethodChanged))if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].inputSchema!==a){var g=o.APISpecsMap[p][s][n.toLowerCase()].inputSchema;o.messaging.off(t.id+"body"),e.next(g),e.complete()}else o.messaging.off(t.id+"body"),e.next(null),e.complete();else o.messaging.off(t.id+"body"),e.next(null),e.complete()}else o.messaging.off(t.id+"body"),e.next(""),e.complete()})}else o.messaging.off(t.id+"body"),e.next(null),e.complete()}else o.messaging.off(t.id+"body"),e.next(null),e.complete();else null!=i&&!1===i&&(o.messaging.off(t.id+"body"),e.next(null),e.complete())})});if("pathParams"===e){var p=t.getField("Path");return(t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)?rxjs_1.Observable.create(function(e){var i=t.id;o.messaging.on(i+"path",function(i){if(null!=i&&!0===i)if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){var a=t.getField("pathParams").value,r=t.getField("swagger")?t.getField("swagger").value:null,s=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,n=t.getField("Method").value;if(r&&s&&n&&""!==r&&""!==s&&""!==n){var l="string"==typeof r&&r.startsWith(SPEC_PREFIX),p=void 0;if(l){var d=r.replace(SPEC_PREFIX,"");p=o.appSpecsService.getAppSpecById(d)}else p=rxjs_1.Observable.of(r);p.subscribe(function(i){if(i&&i.content){var p=l?r:r.filename;if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].pathUpdation)if(a&&o.APISpecsMap[p]&&"[]"!==a.value){var d=o.APISpecsMap[p][s][n.toLowerCase()].path;o.APISpecsMap[p][s][n.toLowerCase()].pathUpdation=!1,o.messaging.off(t.id+"path"),e.next(d)}else o.messaging.off(t.id+"path"),e.next("");else if((t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)&&(o.isPathChanged||o.isMethodChanged))if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].path!==a){var g=o.APISpecsMap[p][s][n.toLowerCase()].path;o.messaging.off(t.id+"path"),"[]"!==g&&0!==g.length||(g=""),e.next(g),e.complete()}else o.messaging.off(t.id+"path"),e.next(null),e.complete();else o.messaging.off(t.id+"path"),e.next(null),e.complete()}else o.messaging.off(t.id+"path"),e.next("")})}else o.messaging.off(t.id+"path"),e.next(null),e.complete()}else o.messaging.off(t.id+"path"),e.next(null),e.complete();else null!=i&&!1===i&&(o.messaging.off(t.id+"path"),e.next(null),e.complete())})}):contributionHelper_1.ContributionHelper.extractJsonFromPath(p.value)}if("responseCodesSchema"===e)return rxjs_1.Observable.create(function(e){o.messaging.on(t.id+"codes",function(i){if(null!=i&&!0===i)if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){var a=t.getField("responseCodesSchema").value,r=t.getField("swagger")?t.getField("swagger").value:null,s=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,n=t.getField("Method").value;if(r&&s&&n&&""!==r&&""!==s&&""!==n){var l="string"==typeof r&&r.startsWith(SPEC_PREFIX),p=void 0;if(l){var d=r.replace(SPEC_PREFIX,"");p=o.appSpecsService.getAppSpecById(d)}else p=rxjs_1.Observable.of(r);p.subscribe(function(i){if(i&&i.content){var p=l?r:r.filename;if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].responseCodesUpdation)if(a&&o.APISpecsMap[p]&&"[]"!==a.value){var d=o.APISpecsMap[p][s][n.toLowerCase()].responseCodes;d&&"[]"!==d?(o.APISpecsMap[p][s][n.toLowerCase()].responseCodesUpdation=!1,o.messaging.off(t.id+"codes"),e.next(d),e.complete()):(o.messaging.off(t.id+"codes"),e.next(""),e.complete())}else o.messaging.off(t.id+"codes"),e.next(""),e.complete();else if((t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)&&(o.isPathChanged||o.isMethodChanged))if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].responseCodes!==a){var g=o.APISpecsMap[p][s][n.toLowerCase()].responseCodes;o.messaging.off(t.id+"codes"),e.next(g),e.complete()}else o.messaging.off(t.id+"codes"),e.next(null),e.complete();else o.messaging.off(t.id+"codes"),e.next(null),e.complete()}else o.messaging.off(t.id+"codes"),e.next(""),e.complete()})}else o.messaging.off(t.id+"codes"),e.next(null),e.complete()}else o.messaging.off(t.id+"codes"),e.next(null),e.complete();else null!=i&&!1===i&&(o.messaging.off(t.id+"codes"),e.next(null),e.complete())})});if("multipartForm"===e)return rxjs_1.Observable.create(function(e){o.messaging.on(t.id+"multipartData",function(i){if(null!=i&&!0===i)if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){var a=t.getField("multipartForm")?t.getField("multipartForm").value:null,r=t.getField("swagger")?t.getField("swagger").value:null,s=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,n=t.getField("Method").value;if(r&&s&&n&&""!==r&&""!==s&&""!==n){var l="string"==typeof r&&r.startsWith(SPEC_PREFIX),p=void 0;if(l){var d=r.replace(SPEC_PREFIX,"");p=o.appSpecsService.getAppSpecById(d)}else p=rxjs_1.Observable.of(r);p.subscribe(function(i){if(i&&i.content){var p=l?r:r.filename;if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].multipartDataUpdation)if(a&&o.APISpecsMap[p]&&"[]"!==a.value){var d=o.APISpecsMap[p][s][n.toLowerCase()].multipartData;d&&"[]"!==d?(o.APISpecsMap[p][s][n.toLowerCase()].multipartDataUpdation=!1,o.messaging.off(t.id+"multipartData"),e.next(d),e.complete()):(o.messaging.off(t.id+"multipartData"),e.next(""),e.complete())}else o.messaging.off(t.id+"multipartData"),e.next(""),e.complete();else if((t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)&&(o.isPathChanged||o.isMethodChanged))if(void 0!==o.APISpecsMap[p]&&void 0!==o.APISpecsMap[p][s]&&void 0!==o.APISpecsMap[p][s][n.toLowerCase()]&&o.APISpecsMap[p][s][n.toLowerCase()].multipartData!==a){var g=o.APISpecsMap[p][s][n.toLowerCase()].multipartData;o.messaging.off(t.id+"multipartData");try{for(var u=JSON.parse(g),c=0;c<u.length;c++)u[c].type&&"object"===u[c].type&&u[c].schema&&!("string"==typeof u[c].schema||u[c].schema instanceof String)&&(u[c].schema=JSON.stringify(u[c].schema));g=JSON.stringify(u)}catch(e){console.error("Failed to parse multiData:",e)}e.next(g),e.complete()}else o.messaging.off(t.id+"multipartData"),e.next(null),e.complete();else o.messaging.off(t.id+"multipartData"),e.next(null),e.complete()}else o.messaging.off(t.id+"multipartData"),e.next(""),e.complete()})}else o.messaging.off(t.id+"multipartData"),e.next(null),e.complete()}else o.messaging.off(t.id+"multipartData"),e.next(null),e.complete();else null!=i&&!1===i&&(o.messaging.off(t.id+"multipartData"),e.next(null),e.complete())})});if("multipartFormData"===e)return rxjs_1.Observable.create(function(e){var i=t.id;o.messaging.on(i+"multipartFormData",function(i){o.messaging.off(t.id+"multipartFormData");var a=t.getField("multipartForm"),r={};if(a&&a.value&&a.value.value){var s=JSON.parse(a.value.value),n={};s.forEach(function(e){if("filecontent"===e.type){var t=e.name;n[t]={type:"any"}}else if("string"===e.type){var i=e.name;n[i]={type:"string"}}else if("object"===e.type){var a=e.name;e.schema?n[a]=JSON.parse(e.schema):n[a]={}}}),r={type:"object",properties:n},e.next(JSON.stringify(r)),e.complete()}else e.next(""),e.complete()})});if("Method"===e){var d=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null;if(o.previousMethod!==t.getField("Method").value?(o.isMethodChanged=!0,o.previousMethod=t.getField("Method").value):o.isMethodChanged=!1,d){var g=t.getField("APISpecPath")?t.getField("APISpecPath").value:null;return g&&""!==g?rxjs_1.Observable.create(function(e){o.messaging.on(t.id+"method",function(i){if(null!=i&&!0===i){var a=t.getField("swagger")?t.getField("swagger").value:null,r="string"==typeof a&&a.startsWith(SPEC_PREFIX),s=void 0;if(r){var n=a.replace(SPEC_PREFIX,"");s=o.appSpecsService.getAppSpecById(n)}else s=rxjs_1.Observable.of(a);s.subscribe(function(i){if(i&&i.content){var s=r?a:a.filename;if(void 0!==o.APISpecsMap[s]&&o.APISpecsMap[s][g]){var n=Object.keys(o.APISpecsMap[s][g]);n.forEach(function(e,t){n[t]=e.toUpperCase()}),o.messaging.off(t.id+"method"),e.next(n),e.complete()}else o.messaging.off(t.id+"method"),e.next([]),e.complete()}else o.messaging.off(t.id+"method"),e.next([]),e.complete()})}else null!=i&&!1===i&&(o.messaging.off(t.id+"method"),e.next(null),e.complete())})}):[]}return["GET","POST","PUT","PATCH","DELETE"]}if("reqType"===e)return(d=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)?(S=t.getField("APISpecPath")?t.getField("APISpecPath").value:null)&&""!==S?rxjs_1.Observable.create(function(e){o.messaging.on(t.id+"reqType",function(i){if(null!=i&&!0===i)if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){var a=t.getField("swagger")?t.getField("swagger").value:null,r=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,s=t.getField("Method").value;if(a&&r&&s&&""!==a&&""!==r&&""!==s){var n="string"==typeof a&&a.startsWith(SPEC_PREFIX),l=void 0;if(n){var p=a.replace(SPEC_PREFIX,"");l=o.appSpecsService.getAppSpecById(p)}else l=rxjs_1.Observable.of(a);l.subscribe(function(i){if(i&&i.content){var l=n?a:a.filename;if("POST"!==s&&"PUT"!==s&&"PATCH"!==s&&"DELETE"!==s||void 0===o.APISpecsMap[l]||void 0===o.APISpecsMap[l][r]||void 0===o.APISpecsMap[l][r][s.toLowerCase()]||!o.APISpecsMap[l][r][s.toLowerCase()].multipartData)o.messaging.off(t.id+"reqType"),e.next(null),e.complete();else{var p=o.APISpecsMap[l][r][s.toLowerCase()].multipartData;!0===o.APISpecsMap[l][r][s.toLowerCase()].urlEncode?(o.messaging.off(t.id+"reqType"),e.next("application/x-www-form-urlencoded"),e.complete()):"[]"!==p&&0!==p.length?(o.messaging.off(t.id+"reqType"),e.next("multipart/form-data"),e.complete()):(o.messaging.off(t.id+"reqType"),e.next("application/json"),e.complete())}}else o.messaging.off(t.id+"reqType"),e.next(null),e.complete()})}else o.messaging.off(t.id+"reqType"),e.next(null),e.complete()}else o.messaging.off(t.id+"reqType"),e.next(null),e.complete();else null!=i&&!1===i&&(o.messaging.off(t.id+"reqType"),e.next(null),e.complete())})}):null:o.isDelete(t)?["application/json"]:["application/json","application/x-www-form-urlencoded","multipart/form-data"];if("APISpecPath"===e){d=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null;if(o.previousPath!==t.getField("APISpecPath").value?(o.isPathChanged=!0,o.previousPath=t.getField("APISpecPath").value):o.isPathChanged=!1,d){var u=t.getField("swagger")?t.getField("swagger").value:null,c=function(){return o.messaging.emit(t.id+"version",!1),o.messaging.emit(t.id+"apiVersion",!1),o.messaging.emit(t.id+"query",!1),o.messaging.emit(t.id+"path",!1),o.messaging.emit(t.id+"header",!1),o.messaging.emit(t.id+"body",!1),o.messaging.emit(t.id+"codes",!1),o.messaging.emit(t.id+"method",!1),o.messaging.emit(t.id+"reqType",!1),o.messaging.emit(t.id+"multipartData",!1),o.messaging.emit(t.id+"multipartFormData",!1),rxjs_1.Observable.of([])};if(u&&""!==u){var m="string"==typeof u&&u.startsWith(SPEC_PREFIX),f=void 0;if(m){var v=u.replace(SPEC_PREFIX,"");f=o.appSpecsService.getAppSpecById(v)}else f=rxjs_1.Observable.of(u);return f.switchMap(function(e){if(e&&e.content){var i=e.content,a=m?u:u.filename;if(t.getMode()!==contrib_1.MODE.WIZARD&&t.getMode()!==contrib_1.MODE.SERVERLESS_FLOW){if(void 0===o.encodedRESTPreviousSwagger[t.title]){o.encodedRESTPreviousSwagger[t.title]=i.slice(i.indexOf(",")+1);var r=t.id;return o.parseAPISpecFile(i,a,r,t)}if(o.encodedRESTPreviousSwagger[t.title]===i.slice(i.indexOf(",")+1)){if(void 0!==o.APISpecsMap[a])return rxjs_1.Observable.create(function(e){var i=Object.keys(o.APISpecsMap[a]),r=t.id;o.messaging.emit(r+"version",!0),o.messaging.emit(r+"apiVersion",!0),o.messaging.emit(r+"query",!0),o.messaging.emit(r+"path",!0),o.messaging.emit(r+"header",!0),o.messaging.emit(r+"body",!0),o.messaging.emit(r+"codes",!0),o.messaging.emit(r+"method",!0),o.messaging.emit(r+"reqType",!0),o.messaging.emit(r+"multipartData",!0),o.messaging.emit(r+"multipartFormData",!0),e.next(i),e.complete()});console.log("Switch from Spec tab to Browse spec");r=t.id;return o.parseAPISpecFile(i,a,r,t)}r=t.id;return o.encodedRESTPreviousSwagger[t.title]=i.slice(i.indexOf(",")+1),o.parseAPISpecFile(i,a,r,t)}r=t.id;return o.parseAPISpecFile(i,a,r,t)}return c()})}return c()}return o.messaging.emit(t.id+"version",!1),o.messaging.emit(t.id+"apiVersion",!1),o.messaging.emit(t.id+"query",!1),o.messaging.emit(t.id+"path",!1),o.messaging.emit(t.id+"header",!1),o.messaging.emit(t.id+"body",!1),o.messaging.emit(t.id+"codes",!1),o.messaging.emit(t.id+"method",!1),o.messaging.emit(t.id+"reqType",!1),o.messaging.emit(t.id+"multipartData",!1),o.messaging.emit(t.id+"multipartFormData",!1),rxjs_1.Observable.of(null)}if("Path"===e){var h=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null,S=t.getField("APISpecPath")?t.getField("APISpecPath").value:null;if(h){if(S&&""!==S)return S}else{var y=t.getField("Path").value;if(y!==S)return y;if(S&&""!==S)return S}}return null},o.validate=function(e,t){if(e&&"refresh api"===e.toLocaleLowerCase()&&t&&t.settings&&t.settings.length>0){var i=t.getField("swagger"),a=validation_1.ValidationResult.newValidationResult();return rxjs_1.Observable.create(function(t){if(i&&void 0!==i.action&&i.action.name===e)if(lodash.isUndefined(i.value)||lodash.isEmpty(i.value)||lodash.isUndefined(i.value.content))t.next(a.setVisible(!1)),t.complete();else try{var r=i.value.content,s=atob(r.slice(r.indexOf(",")+1)),n=JSON.parse(s),l=null!=n&&void 0!==n.apiId&&null!==n.apiId&&n.apiId.length>0;l?wi_contrib_1.WiContributionUtils.getOpenAPISpecById(o.http,n.apiId).subscribe(function(e){if(e&&e.value&&!lodash.isEmpty(e.value)){var i=JSON.stringify(e.value),r=JSON.parse(s);lodash.unset(r,"apiId");var n=JSON.stringify(r);l=!lodash.isEqual(n,i)}else l=!1;t.next(a.setVisible(l)),t.complete()}):(t.next(a.setVisible(l)),t.complete())}catch(e){t.next(a.setError("SCHEMA_ERROR","Unexpected string in JSON").setVisible(!0)),t.complete()}else t.next(a),t.complete()})}if("body"===e){var r=validation_1.ValidationResult.newValidationResult();if(o.isGet(t))return r.setVisible(!1);if(r=(h=t.getField("reqType"))&&"multipart/form-data"===h.value?r.setVisible(!1):r.setVisible(!0),t.getMode()===contrib_1.MODE.WIZARD||t.getMode()===contrib_1.MODE.SERVERLESS_FLOW){if(t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)return r.setVisible(!1);var s=t.getField("body"),n=void 0;if(s.value&&s.value.value)try{n=JSON.parse(s.value.value),n=JSON.stringify(n)}catch(e){return r.setError("SCHEMA_ERROR","Unexpected string in JSON").setVisible(!0)}return r.setVisible(!0)}return r}if("Path"===e){if(c=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null)return validation_1.ValidationResult.newValidationResult().setVisible(!1);if(t.getMode()===contrib_1.MODE.WIZARD||t.getMode()===contrib_1.MODE.SERVERLESS_FLOW){var l=t.getField("Path"),p=t.getField("Method"),d=t.getField("port"),g=o.getModelService().getApplication(),u=o.formSettings(g);return o.verifyPathStartSlash(l.value)?o.isValid(p.value,u,l.value,d.value)?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setError("PATH_ERROR","Resource Path already exists or is invalid.").setVisible(!0):validation_1.ValidationResult.newValidationResult().setError("PATH_ERROR",'Path required and should start with "/" like "/pets/{id}"').setVisible(!0)}return validation_1.ValidationResult.newValidationResult().setVisible(!0)}if("APISpecPath"===e){var c=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null,m=t.getField("APISpecPath")?t.getField("APISpecPath").value:null;return c?((f=validation_1.ValidationResult.newValidationResult()).setVisible(!0),m&&""!==m||f.setError("","Path is required"),f):validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("Method"===e){if(t.getMode()===contrib_1.MODE.WIZARD){var f=validation_1.ValidationResult.newValidationResult().setReadOnly(!1);p=t.getField("Method");return Array.isArray(p.value)&&p.value.length>0||(f=f.setError("METHOD_ERROR","Please select atleast one method to proceed")),f}if(t.getMode()===contrib_1.MODE.SERVERLESS_FLOW){f=validation_1.ValidationResult.newValidationResult().setReadOnly(!1),p=t.getField("Method");return Array.isArray(p.value)&&1!==p.value.length&&(f=f.setError("METHOD_ERROR","Please select one method to proceed")),f}return validation_1.ValidationResult.newValidationResult().setReadOnly(!1)}if("reqType"===e){var v=t.getField("Method");return"POST"===v.value||"PUT"===v.value||"PATCH"===v.value||"DELETE"===v.value?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("secureConnection"===e)return rxjs_1.Observable.create(function(e){o.configurationService.getAppConfig().subscribe(function(t){t.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?e.next(validation_1.ValidationResult.newValidationResult().setVisible(!0)):e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(t){e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(){return e.complete()})});if("queryParams"===e)return o.validateParametersByName(e,t);if("headers"===e)return o.validateParametersByName(e,t);if("multipartForm"===e){var h=t.getField("reqType");if(!o.isGetOrDelete(t)&&h&&"multipart/form-data"===h.value){(f=validation_1.ValidationResult.newValidationResult()).setVisible(!0);var S=t.getField("multipartForm")?t.getField("multipartForm"):null;if(S&&S.value&&S.value.value){var y=[],b="",P={};try{P=JSON.parse(S.value.value);for(var R=0,A=P;R<A.length;R++){var E=A[R];if(!E.name){b="Name should not be empty",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}if(!E.schema&&"object"===E.type){b="Schema should not be empty",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}for(var I=0,_=y;I<_.length;I++){if(_[I]===E.name){b="Name '"+E.name+"' already exists",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}}y.push(E.name)}return f}catch(e){return f}}return f}return validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("port"===e)return validation_1.ValidationResult.newValidationResult().setVisible(!0);if("apiVersion"===e){var M=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null;f=validation_1.ValidationResult.newValidationResult().setReadOnly(!0);return M?f.setVisible(!0):f.setVisible(!1)}if("swagger"===e){if(t.getMode()===contrib_1.MODE.UPLOAD){var O=o.getModelService().getApplication(),w=void 0;if("string"==typeof(x=t.getField("swagger")?t.getField("swagger").value:null)&&x.startsWith(SPEC_PREFIX)){var F=x.replace(SPEC_PREFIX,"");w=o.appSpecsService.getAppSpecById(F)}else w=rxjs_1.Observable.of(x);return w.switchMap(function(e){if(e&&e.content){var i=e.content,a=atob(i.slice(i.indexOf(",")+1)),r=JSON.parse(a);return rxjs_1.Observable.create(function(e){o.parsingService.parseSwaggerSpec(r).subscribe(function(i){if(!0===i.success){var a=i.swagger,r=wi_contrib_1.WiContributionUtils.getUniqueId(t)+":"+O.getName();o.deRefMap[r]=a,(new SwaggerValidationService_1.SwaggerValidationService).start(lodash.cloneDeep(a)).subscribe(function(t){if(t.errors.length>0){for(var i=validation_1.ValidationResult.newValidationResult(),a=[],s=t.errors.length-1;s>=0;s--){var n=t.errors[s].getErrorMessage(),l=n.substring(11,n.indexOf("=")),p=n.substring(n.indexOf("=")+1);if("FATAL_ERROR"===l){var d=p.substring(p.lastIndexOf("[")+1,p.lastIndexOf("]")).trim(),g=p.indexOf("method [");if(p.lastIndexOf("method [")-g==0){var u=d+"-"+(c=p.substring(p.lastIndexOf("method [")+9,p.lastIndexOf("] is not")).trim());a.includes(u)||""===d||a.push(u)}else for(var c,m=(c=p.substring(p.indexOf("method [")+9,p.lastIndexOf("] and")).trim()).split(","),f=0;f<m.length;f++){u=d+"-"+c;a.includes(u)||""===d||a.push(u)}i.setWarning("SWAGGER_WARNING",p),0!==s&&i.setWarning("SWAGGER_WARNING","")}else{var v=l.substring(0,l.indexOf(".")),h=l.substring(l.indexOf(".")+1).toUpperCase();u=v+"-"+h.toUpperCase();a.includes(u)||(p=(p=p.replace("PATH_NAME",v)).replace("METHOD_NAME",h),i.setWarning("SWAGGER_WARNING",p),0!==s&&i.setWarning("SWAGGER_WARNING",""))}}o.deRefMap[r+":paths"]=a,e.next(i)}else e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete()})}else if("Maximum call stack size exceeded"===i.error){e.next(validation_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR","Swagger Dereference Error: There might be Cyclic Redundancy or Embedded '$ref' in Definitions"))}else"[object Object] is not a valid Openapi API definition"===i.error?e.next(validation_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR","Uploaded API Spec is not a valid API definition")):e.next(validation_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR",i.error))},function(t){e.next(validation_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR",t))})})}})}if(M=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null){var x,V=validation_1.ValidationResult.newValidationResult();if(V.setVisible(!0),(x=t.getField("swagger").value)&&""!==x){w=void 0;if("string"==typeof x&&x.startsWith(SPEC_PREFIX)){F=x.replace(SPEC_PREFIX,"");w=o.appSpecsService.getAppSpecById(F)}else w=rxjs_1.Observable.of(x);return w.switchMap(function(e){if(!e||!e.content)return console.log("Spec file is deleted from tab"),rxjs_1.Observable.create(function(e){e.next(V.setError("","API spec file is deleted from Spec tab")),e.complete()});var t=e.content,i=atob(t.slice(t.indexOf(",")+1));try{var a=JSON.parse(i);return rxjs_1.Observable.create(function(e){o.parsingService.parseSwaggerSpec(a).subscribe(function(t){!0===t.success?(e.next(validation_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete()):"[object Object] is not a valid Openapi API definition"===t.error?e.next(validation_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR","Uploaded API Spec is not a valid API definition")):e.next(validation_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR",t.error))},function(t){e.next(validation_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR",t))})})}catch(e){V.setError("","Failed to parse JSON file, please upload a valid JSON file")}})}return V.setError("","Configure API spec"),V}return validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("message"===e){if(!0===t.getField("configureResponseCodes").value)return validation_1.ValidationResult.newValidationResult().setVisible(!1);var C=t.getField("data");return C&&!C.value||C.value&&""===C.value.value?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("serverKey"===e||"caCertificate"===e)return rxjs_1.Observable.create(function(e){o.configurationService.getAppConfig().subscribe(function(i){i.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?!0===t.getField("secureConnection").value?e.next(validation_1.ValidationResult.newValidationResult().setVisible(!0)):e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1)):e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(t){e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(){return e.complete()})});if("data"===e){if(!1===t.getField("configureResponseCodes").value){if(t.getMode()===contrib_1.MODE.WIZARD||t.getMode()===contrib_1.MODE.SERVERLESS_FLOW)if(c=t.getField("APISpecUpdate").value)return validation_1.ValidationResult.newValidationResult().setVisible(!1);return validation_1.ValidationResult.newValidationResult().setVisible(!0)}return validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("responseBody"===e)return!1===t.getField("configureResponseCodes").value?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0);if("responseCodesSchema"===e){if(!1===t.getField("configureResponseCodes").value)return validation_1.ValidationResult.newValidationResult().setVisible(!1);(f=validation_1.ValidationResult.newValidationResult()).setVisible(!0);var N=t.getField("responseCodesSchema");if(!N||void 0!==N.value&&void 0!==N.value.value&&""!==N.value.value){if(N&&N.value&&N.value.value){y=[],b="";var q={};try{q=JSON.parse(N.value.value);for(var T=0,D=q;T<D.length;T++){var L=D[T];if(!L.code){b="Response Code should not be empty",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}if(null!==L.code.match(/[^0-9]/)){b="Response Code should be numeric",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}if(3!==L.code.length){b="Response Code should be of length 3 for e.g 501,200 or 5xx,4xx",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}if(!L.responseSchema&&"object"===L.responseType){b="Response body should not be empty",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}for(var j=0,U=y;j<U.length;j++){if(U[j]===L.code){b="Response Code '"+L.code+"' already exists",f.setError("GENERAL-REST-ACTIVITY-1001",b),f.setValid(!1);break}}y.push(L.code)}return f}catch(e){return f}}}else f.setError("GENERAL-REST-ACTIVITY-1001","Response Code Table is Empty, Add new Codes");return f}if("multipartFormData"===e){if(o.isGetOrDelete(t))return validation_1.ValidationResult.newValidationResult().setVisible(!1);if("multipart/form-data"===(t.getField("reqType")?t.getField("reqType").value:null)){var J=t.getField("multipartForm")?t.getField("multipartForm").value:null;return J&&J.value?J.value==={}?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1)}return validation_1.ValidationResult.newValidationResult().setVisible(!1)}return null},o.action=function(e,t){var i=o.getModelService(),a=wi_contrib_1.CreateFlowActionResult.newActionResult();if(e&&"refresh api"===e.toLocaleLowerCase()&&t&&t.settings&&t.settings.length>0){var r,s=o,n="",l=t.getField("swagger");if(l&&void 0!==l.action&&l.action.name===e){var p=l.value.content,d=atob(p.slice(p.indexOf(",")+1)),g=JSON.parse(d);return g&&g.apiId&&(r=g.apiId,n=p.slice(0,p.indexOf(","))),rxjs_1.Observable.create(function(e){void 0!==r?wi_contrib_1.WiContributionUtils.getOpenAPISpecById(s.http,r).subscribe(function(t){if(t&&t.value&&!lodash.isEmpty(t.value)){lodash.set(t.value,"apiId",r);var i=n+","+btoa(JSON.stringify(t.value));l.value.content=i}e.next(l),e.complete()},function(t){e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(){return e.complete()}):(e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete())})}return rxjs_1.Observable.create(function(e){e.next(!1),e.complete()})}if(t.getMode()===contrib_1.MODE.WIZARD||t.getMode()===contrib_1.MODE.SERVERLESS_FLOW){if(t.handler&&t.handler.settings&&t.handler.settings.length>0){var u=t.getField("APISpecUpdate")?t.getField("APISpecUpdate").value:null,c=t.getField("APISpecPath")?t.getField("APISpecPath").value:null,m=t.getField("swagger"),f=t.getField("apiVersion"),v=t.getField("Method"),h=t.getField("port"),S=t.getField("Path"),y=t.getField("body"),b=t.getField("data"),P=m.value,R="string"==typeof P&&P.startsWith(SPEC_PREFIX);if(v&&v.value&&v.value.length>0){var A=i.createTriggerElement("General/tibco-wi-rest");if(A&&A.settings&&A.settings.length>0)if(u&&c&&""!==c&&v.value&&""!==v.value)for(var E=0;E<A.settings.length;E++)"swagger"===A.settings[E].name?A.settings[E].value=P:"APISpecUpdate"===A.settings[E].name?A.settings[E].value=!0:"apiVersion"===A.settings[E].name?A.settings[E].value=f:"port"===A.settings[E].name&&h&&0!==h.value&&(A.settings[E].value=h.value);else for(E=0;E<A.settings.length;E++)"port"===A.settings[E].name&&h&&0!==h.value&&(A.settings[E].value=h.value);if(A&&A.handler&&A.handler.settings&&A.handler.settings.length>0)if(u&&c&&""!==c&&v.value&&""!==v.value)for(E=0;E<A.handler.settings.length;E++)"Method"===A.handler.settings[E].name?A.handler.settings[E].value=v.value.toUpperCase():"APISpecPath"===A.handler.settings[E].name?A.handler.settings[E].value=c:"Path"===A.handler.settings[E].name&&(A.handler.settings[E].value=c);else for(E=0;E<A.handler.settings.length;E++)"Method"===A.handler.settings[E].name?A.handler.settings[E].value=v.value:"Path"===A.handler.settings[E].name&&(A.handler.settings[E].value=S.value);var I=o.contribModelService.createMapping();if(u&&c&&""!==c&&v.value&&""!==v.value){var _=R?P:P.filename;if(A&&A.outputs&&A.outputs.length>0){var M=o.APISpecsMap[_][c][v.value.toLowerCase()].path,O=o.APISpecsMap[_][c][v.value.toLowerCase()].query,w=o.APISpecsMap[_][c][v.value.toLowerCase()].inputSchema,F=o.APISpecsMap[_][c][v.value.toLowerCase()].headers,x=o.APISpecsMap[_][c][v.value.toLowerCase()].multipartData;for(E=0;E<A.outputs.length;E++)"body"===A.outputs[E].name?(A.outputs[E].value={},w&&""!==w&&(A.outputs[E].value.value=w,w!=={}&&I.addMapping("$INPUT['body']",o.contribModelService.createMapExpression().setExpression("$trigger.body")))):"queryparams"===A.outputs[E].name.toLowerCase()?(A.outputs[E].value={},O&&"[]"!==O&&0!==O.length&&(A.outputs[E].value.value=O,I.addMapping("$INPUT['queryParams']",o.contribModelService.createMapExpression().setExpression("$trigger.queryParams")))):"pathparams"===A.outputs[E].name.toLowerCase()?(A.outputs[E].value={},M&&"[]"!==M&&0!==M.length&&(A.outputs[E].value.value=M,I.addMapping("$INPUT['pathParams']",o.contribModelService.createMapExpression().setExpression("$trigger.pathParams")))):"headers"===A.outputs[E].name.toLowerCase()?(A.outputs[E].value={},F&&"[]"!==F&&0!==F.length&&(A.outputs[E].value.value=F,I.addMapping("$INPUT['headers']",o.contribModelService.createMapExpression().setExpression("$trigger.headers")))):"multipartform"===A.outputs[E].name.toLowerCase()&&(A.outputs[E].value={},x&&"[]"!==x&&(A.outputs[E].value.value=x,I.addMapping("$INPUT['multipartFormData']",o.contribModelService.createMapExpression().setExpression("$trigger.multipartFormData"))))}}else{if(A&&A.outputs&&A.outputs.length>0){for(E=0;E<A.outputs.length;E++)if("headers"!==A.outputs[E].name)A.outputs[E].value={};else{A.outputs[E].value.value='[{"parameterName":"Accept","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Charset","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Encoding","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Type","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Length","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Connection","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Cookie","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Pragma","type":"string","repeating":"false","required":"false","visible":false}]'}for(E=0;E<A.outputs.length;E++)if("body"===A.outputs[E].name){A.outputs[E].value=lodash.cloneDeep(y.value);break}}if(A&&b&&b.value&&A.reply&&A.reply.length>0)for(E=0;E<A.reply.length;E++)if("data"===A.reply[E].name){A.reply[E].value=lodash.cloneDeep(b.value);break}}var V=i.createFlow(t.getFlowName()+"_"+v.value,t.getFlowDescription(),!1);if(u&&c&&""!==c&&v.value&&""!==v.value){_=R?P:P.filename;var C=o.APISpecsMap[_][c][v.value.toLowerCase()].responseCodes;if(A&&A.reply&&A.reply.length>0)for(E=0;E<A.reply.length;E++)"responseCodesSchema"===A.reply[E].name?(A.reply[E].value={},C&&"[]"!==C&&(A.reply[E].value.value=C)):"configureResponseCodes"===A.reply[E].name&&(A.reply[E].value=!0);var N=o.contribModelService.createMapping();N.addMapping("$INPUT['code']",o.contribModelService.createMapExpression().setExpression("$flow.code")).addMapping("$INPUT['responseBody']",o.contribModelService.createMapExpression().setExpression("$flow.responseBody")),A.inputMappings=I,A.outputMappings=N,a=a.addTriggerFlowMapping(lodash.cloneDeep(A),lodash.cloneDeep(V))}else if(t.getMode()===contrib_1.MODE.SERVERLESS_FLOW){if(A&&A.reply&&A.reply.length>0){for(E=0;E<A.reply.length;E++)"responseBody"!==A.reply[E].name&&(A.reply[E].value={});for(E=0;E<A.reply.length;E++)if("configureResponseCodes"===A.reply[E].name&&(A.reply[E].value=!1),"message"===A.reply[E].name&&(A.reply[E].display={visible:!0,settings:!1}),b&&b.value&&"data"===A.reply[E].name){A.reply[E].value=lodash.cloneDeep(b.value);break}}a=a.addTriggerFlowMapping(lodash.cloneDeep(A),lodash.cloneDeep(V))}else{var q=i.createFlowElement("General/tibco-wi-reply");if(q&&q.inputs&&q.inputs.length>0)for(E=0;E<q.inputs.length;E++)if(b&&b.value&&"data"===q.inputs[E].name){q.inputs[E].value=lodash.cloneDeep(b.value);break}var T=V.addFlowElement(q);a=a.addTriggerFlowMapping(lodash.cloneDeep(A),lodash.cloneDeep(T))}}else console.log("Spec is deleted from tab")}}else if(t.getMode()===contrib_1.MODE.UPLOAD)return o.buildActionFromApiSpec(a,t);var D=wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(a);return console.log("Mode upload completed"),D},o.messaging=new wi_contrib_1.WiContribMessaging,o}return __extends(t,e),t.prototype.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},t.prototype.incrementId=function(){return++this.incrementSchemaId},t.prototype.genPort=function(e){for(var t=e.settings,i=0;i<t.length;i++)if("port"===t[i].name)return String(t[i].value)},t.prototype.OASParamConvert=function(e,t,i){var a={name:"",in:"",description:"",required:!1,schema:{type:"string"}};if(a.name=e.parameterName,a.in=t,a.description=e.description||"Request parameter",a.schema.type=e.type||"string","path"===t&&(e.required=!0),e.required)switch(typeof e.required){case"boolean":a.required=e.required;break;case"string":a.required="true"===e.required.toLowerCase();break;case"number":a.required=1===e.required}if(e.repeating&&"true"===e.repeating){var r={type:e.type||"string"};a.schema.type="array",a.schema.items=r}return a},t.prototype.paramConvert=function(e,t,i,a){var r={name:"",in:"",description:"",required:!1,type:"string"};if(r.name=e.parameterName,r.in=t,r.type=e.type||"string",r.description=e.description||"Request parameter","path"===t&&(e.required=!0),e.required)switch(typeof e.required){case"boolean":r.required=e.required;break;case"string":r.required="true"===e.required.toLowerCase();break;case"number":r.required=1===e.required}if(e.repeating&&"true"===e.repeating){var s={type:e.type||"string"};r.type="array",r.items=s,r.collectionFormat="multi"}return"body"===t&&(delete r.type,delete a.$schema,r.schema={$ref:"#/definitions/schema"+this.updateBodySchemaRef(a,i)}),r},t.prototype.updateBodySchemaRef=function(e,t){var i=[];null!=this.schemaRegistry[t]&&(i=Object.keys(this.schemaRegistry[t]));for(var a=0,r=i;a<r.length;a++){var s=r[a];if(void 0!==s&&s===JSON.stringify(e))return this.schemaRegistry[t][s]}var n=this.incrementId().toString();return void 0===this.schemaRegistry[t]&&(this.schemaRegistry[t]={}),i.push(JSON.stringify(e)),this.schemaRegistry[t][JSON.stringify(e)]=n,n},t.prototype.genPathParameter=function(e,t,i){for(var a=this,r=[],s=e.outputs,n=function(n){if("pathParams"===s[n].name||"PathParams"===s[n].name){var l="";if(void 0!==s[n].value&&(l=s[n].value.value),l&&""!==l){l="string"==typeof l?JSON.parse(l):JSON.parse(JSON.stringify(l));for(var p=0;p<l.length;p++)"v3"===i?r.push(o.OASParamConvert(l[p],"path",e.getId())):r.push(o.paramConvert(l[p],"path",e.getId()))}}else if("queryParams"===s[n].name||"QueryParams"===s[n].name){l="";if(void 0!==s[n].value&&(l=s[n].value.value),l&&""!==l){l="string"==typeof l?JSON.parse(l):JSON.parse(JSON.stringify(l));for(p=0;p<l.length;p++)"v3"===i?r.push(o.OASParamConvert(l[p],"query",e.getId())):r.push(o.paramConvert(l[p],"query",e.getId()))}}else if("headers"===s[n].name||"Headers"===s[n].name){if((l=s[n].value.value)&&""!==l){l="string"==typeof l?JSON.parse(l):JSON.parse(JSON.stringify(l));var d=["Accept","Accept-Charset","Accept-Encoding","Content-Type","Content-Length","Connection","Cookie","Pragma"];for(p=0;p<l.length;p++)d.includes(l[p].parameterName)||("v3"===i?r.push(o.OASParamConvert(l[p],"header",e.getId())):r.push(o.paramConvert(l[p],"header",e.getId())))}}else if("v3"===i||"body"!==s[n].name&&"Body"!==s[n].name){if(("v3"!==i&&"multipartFormData"===s[n].name||"MultipartFormData"===s[n].name)&&"GET"!==t&&"DELETE"!==t&&e.getField("reqType")&&"multipart/form-data"===e.getField("reqType").value&&void 0!==s[n].value){var g=JSON.parse(s[n].value);Object.keys(g.properties).forEach(function(t){var i={parameterName:t,required:!1,description:"Form Data Parameter"};"any"===g.properties[t].type?i.type="file":"string"===g.properties[t].type&&(i.type=g.properties[t].type),r.push(a.paramConvert(i,"formData",e.getId()))})}}else if("GET"!==t&&"DELETE"!==t)if(e.getField("reqType")&&"application/x-www-form-urlencoded"===e.getField("reqType").value){l="";if(void 0!==s[n].value&&(l=s[n].value.value),l&&""!==l){l="string"==typeof l?JSON.parse(l):JSON.parse(JSON.stringify(l)),o.isJson(JSON.stringify(l))&&(l=schema.json(l));var u=l;Object.keys(u.properties).forEach(function(t){var i={parameterName:t,required:!1,description:"Form Data Parameter"};i.type=u.properties[t].type,r.push(a.paramConvert(i,"formData",e.getId()))})}}else{l="";if(void 0!==s[n].value&&(l=s[n].value.value),l&&""!==l){l="string"==typeof l?JSON.parse(l):JSON.parse(JSON.stringify(l));var c={parameterName:"body",required:!0,description:"request body parameter"};o.isJson(JSON.stringify(l))?r.push(o.paramConvert(c,"body",e.getId(),schema.json(l))):r.push(o.paramConvert(c,"body",e.getId(),l))}}},o=this,l=0;l<s.length;l++)n(l);return r},t.prototype.genOASPathRequestBody=function(e,t){for(var i,a=e.getId(),r={description:"",required:!1,content:{"application/json":{schema:{$ref:""}}}},s=!0,n=!0,o=e.outputs,l=function(a){if("body"===o[a].name||"Body"===o[a].name){if("GET"!==t&&"DELETE"!==t){var r="";if(void 0!==o[a].value&&(r=o[a].value.value),r&&""!==r){s=!1,r="string"==typeof r?JSON.parse(r):JSON.parse(JSON.stringify(r));i=p.isJson(JSON.stringify(r))?schema.json(r):r}}}else if(("multipartFormData"===o[a].name||"MultipartFormData"===o[a].name)&&"GET"!==t&&"DELETE"!==t){var l=e.getField("reqType");if(l&&l.value&&"multipart/form-data"===l.value&&void 0!==o[a].value){n=!1;var d=JSON.parse(o[a].value);Object.keys(d.properties).forEach(function(e){"any"===d.properties[e].type&&(d.properties[e]={type:"string",format:"binary"})}),i=d}}},p=this,d=0;d<o.length;d++)l(d);if(s&&n)return{};if(i){delete i.$schema;var g=e.getField("reqType");if(g&&"application/x-www-form-urlencoded"===g.value)return{description:"",required:!1,content:{"application/x-www-form-urlencoded":{schema:{$ref:"#/components/schemas/schema"+this.updateBodySchemaRef(i,a)}}}};if(g&&"multipart/form-data"===g.value)return{description:"",required:!1,content:{"multipart/form-data":{schema:i}}};r.content["application/json"].schema.$ref="#/components/schemas/schema"+this.updateBodySchemaRef(i,a)}return r},t.prototype.isJson=function(e){try{e=JSON.parse(e)}catch(t){e={}}var t=!0;return e&&e.type&&"string"==typeof e.type&&(e.properties||e.items)&&(t=!1),e&&e.allOf&&e.allOf.length&&(t=!1),e&&e.oneOf&&e.oneOf.length&&(t=!1),e&&e.anyOf&&e.anyOf.length&&(t=!1),t},t.prototype.genPathResponses=function(e,t){for(var i,a,r,s=e.reply,n=!1,o=0;o<s.length;o++)"configureResponseCodes"===s[o].name?n=s[o].value:"data"===s[o].name?s[o].value&&s[o].value.value&&(i=JSON.parse(JSON.stringify(s[o].value.value))):"responseCodesSchema"===s[o].name?s[o].value&&s[o].value.value&&(r=s[o].value.value):"code"===s[o].name&&s[o].value&&(a=s[o].value);if(n){var l={},p=JSON.parse(JSON.stringify(r));if(p&&""!==p){p=JSON.parse(p);for(o=0;o<p.length;o++)if("object"===p[o].responseType)if(this.isJson(p[o].responseSchema)){var d={description:""},g=schema.json(JSON.parse(p[o].responseSchema));if(delete g.$schema,d.schema=g,p[o].responseHeaders&&""!==p[o].responseHeaders)if(this.isJson(p[o].responseHeaders))delete(u=schema.json(JSON.parse(p[o].responseHeaders))).$schema,u.properties&&(d.headers=u.properties);else(u=JSON.parse(p[o].responseHeaders)).properties&&(d.headers=u.properties);l[p[o].code]=d}else{if((d={description:""}).schema=JSON.parse(p[o].responseSchema),p[o].responseHeaders&&""!==p[o].responseHeaders)if(this.isJson(p[o].responseHeaders))delete(u=schema.json(JSON.parse(p[o].responseHeaders))).$schema,u.properties&&(d.headers=u.properties);else(u=JSON.parse(p[o].responseHeaders)).properties&&(d.headers=u.properties);l[p[o].code]=d}else{var u;if((d={description:""}).schema={type:"string"},p[o].responseHeaders&&""!==p[o].responseHeaders)if(this.isJson(p[o].responseHeaders))delete(u=schema.json(JSON.parse(p[o].responseHeaders))).$schema,u.properties&&(d.headers=u.properties);else(u=JSON.parse(p[o].responseHeaders)).properties&&(d.headers=u.properties);l[p[o].code]=d}}return this.updateResponseCodeSchemaRef(l,e.getId(),t)}var c={};if(i&&""!==i){var m={description:"Rest Response"};if(this.isJson(i)){var f=schema.json(JSON.parse(i));delete f.$schema,m.schema=f}else m.schema=JSON.parse(i);void 0===a?c[200]=m:"object"==typeof a?c[200]=m:c[String(a)]=m}else{m={description:"Rest Response",schema:{type:"string"}};c[200]=m}return this.updateResponseCodeSchemaRef(c,e.getId(),t)},t.prototype.updateResponseCodeSchemaRef=function(e,t,i){var a=[];null!=this.schemaRegistry[t]&&(a=Object.keys(this.schemaRegistry[t]));for(var r=0,s=Object.keys(e);r<s.length;r++){var n=s[r];if(void 0!==n){for(var o=e[n],l=!1,p=0,d=a;p<d.length;p++){var g=d[p];if(void 0!==g&&g===JSON.stringify(o.schema)){l=!0;break}}if(l){var u=this.schemaRegistry[t][JSON.stringify(o.schema)];e[n].schema="v3"===i?{$ref:"#/components/schemas/schema"+u}:{$ref:"#/definitions/schema"+u}}else if(JSON.stringify(o.schema)!==JSON.stringify({type:"string"})){u=this.incrementId();void 0===this.schemaRegistry[t]&&(this.schemaRegistry[t]={}),a.push(JSON.stringify(o.schema)),this.schemaRegistry[t][JSON.stringify(o.schema)]=u.toString(),e[n].schema="v3"===i?{$ref:"#/components/schemas/schema"+u.toString()}:{$ref:"#/definitions/schema"+u.toString()}}}}return"v3"===i?this.genOASResponse(e):e},t.prototype.genOASResponse=function(e){for(var t={},i=0,a=Object.keys(e);i<a.length;i++){var r=a[i];if(void 0!==r){var s=e[r];if(JSON.stringify(s.schema)!==JSON.stringify({type:"string"})){var n={description:"",content:{"application/json":{schema:s.schema}}};t[r]=n}else{n={description:"",content:{"text/plain":{schema:{type:"string"}}}};t[r]=n}if(s.headers){for(var o={},l=s.headers,p=0,d=Object.keys(s.headers);p<d.length;p++){var g=d[p];o[g]={schema:l[g]}}t[r].headers=o}}}return t},t.prototype.replaceAll=function(e,t,i){return e.split(t).join(i)},t.prototype.genPath=function(e,t,i){for(var a={summary:"",operationId:"",parameters:[],responses:{}},r=t.handler.settings,s="",n="",o=0;o<r.length;o++)"path"===r[o].name||"Path"===r[o].name?s=r[o].value:"method"!==r[o].name&&"Method"!==r[o].name||(n=r[o].value);a.summary=e.getName(),e.getDescription()&&(a.description=e.getDescription());var l=this.replaceAll(s,"/","_"),p=this.replaceAll(l,"{","");if(a.operationId=n.toLowerCase()+this.replaceAll(p,"}",""),a.parameters=this.genPathParameter(t,n,i),a.responses=this.genPathResponses(t,i),"v3"!==i||"POST"!==t.getField("Method").value&&"PUT"!==t.getField("Method").value&&"PATCH"!==t.getField("Method").value||(a.requestBody=this.genOASPathRequestBody(t,n)),"v3"!==i&&("POST"===t.getField("Method").value||"PUT"===t.getField("Method").value||"PATCH"===t.getField("Method").value)){var d=t.getField("reqType");d&&d.value&&(a.consumes=[t.getField("reqType").value])}return{path:s,method:n.toLowerCase(),content:a}},t.prototype.getPath=function(e,t,i){var a={},r={},s=this.genPath(e,t,i);return r[s.method]=s.content,a[s.path]=r,a},t.prototype.generateEndpoint=function(){for(var e={},t=this.getModelService().getApplication().getTriggerFlowModelMaps(),i=0;i<t.length;i++){var a=t[i].getFlowModel(),r=t[i].getTriggerElement(),s=r.getField("swaggerVersion")?r.getField("swaggerVersion").value:"v2";if("tibco-wi-rest"===r.name)if(void 0===e[r.getId()]){var n={};n.swaggerVersion=s,n.name=r.title,n.port=this.genPort(r),n.paths=this.getPath(a,r,s),n.description=r.description,e[r.getId()]=n}else{var o=e[r.getId()].paths,l=this.genPath(a,r,s);if(void 0===o[l.path]){var p=l.method,d=l.content,g={};g[p]=d,o[l.path]=g}else{var u=o[l.path];void 0===u[l.method]&&(u[l.method]=l.content,o[l.path]=u)}e[r.getId()].paths=o}}return e},t.prototype.genActualEndpoint=function(e,t){var i=e.swaggerVersion,a=this.getModelService().getApplication().getName(),r=a;t&&(r=a+"-"+e.name);var s={protocol:"http",port:e.port,spec:{name:a,version:"1.0.0"},title:e.name};return s.swagger="v3"===i?{openapi:"3.0.0",info:{title:r,version:"1.0.0",description:e.description},paths:e.paths,components:{schemas:this.genDefinitions(e.id)}}:{swagger:"2.0",info:{title:r,version:"1.0.0",description:e.description},paths:e.paths,definitions:this.genDefinitions(e.id)},s},t.prototype.genDefinitions=function(e){var t={};if(void 0!==this.schemaRegistry[e]){for(var i=this.schemaRegistry[e],a=0,r=Object.keys(i);a<r.length;a++){var s=r[a];void 0!==s&&(t["schema"+i[s]]=JSON.parse(s))}delete this.schemaRegistry[e]||console.log("Schema Cache Clearing failed, Please Refersh Manually")}return this.incrementSchemaId=0,t},t.prototype.updateSwaggerDictionary=function(e,t,i){var a=new flogo_flow_create_providers_1.Swagger(e),r=a.getPaths(),s="v2";a.isOAS3()&&(s="v3");var n;n=a.getAPIVersion(),this.APISpecsMap[i+".apiVersion"]=n,this.APISpecsMap[i+".version"]=s;for(var o={},l=0,p=r;l<p.length;l++)for(var d=p[l],g=a.getMethods(d),u={},c=function(e){var i={},r=d+"-"+e.toUpperCase();if(void 0===t||!t.includes(r)){if(["PUT","PATCH","POST","DELETE","GET"].includes(e.toUpperCase())){var s=a.getParameters(d,e),n=a.getResponse(d,e),l=void 0,p=[],g=[],c=[],m=[],f=[],v=!1;if(n!=={})for(var h=Object.keys(n),S=0;S<h.length;S++)try{var y=parseInt(h[S]),b={},P=n[y];if(P!=={}){var R=P.headers;if(void 0!==R&&Object.keys(R).length>0){var A={type:"object",properties:{}};for(var E in R){var I=R[E];A.properties[E]={type:I.type}}b.responseHeaders=JSON.stringify(A)}P.schema?"string"===P.schema.type?(b.code=y,b.responseType="string"):(b.code=y,b.responseType="object",b.responseSchema=JSON.stringify(P.schema)):(b.code=y,b.responseType="string")}else b.code=y,b.responseType="string";f.push(b)}catch(e){}if(s)for(var _=function(t){if("body"===t.in)l=t.schema;else if("path"===t.in){(i={}).parameterName=t.name,"integer"===t.type||"long"===t.type||"number"===t.type?i.type="number":"boolean"===t.type?i.type="boolean":i.type="string",i.required=t.required,g.push(i)}else if("query"===t.in){(i={}).parameterName=t.name,"array"===t.type?(i.repeating="true","integer"===t.items.type||"long"===t.items.type||"number"===t.items.type?i.type="number":"boolean"===t.items.type?i.type="boolean":i.type="string"):(i.repeating="false","integer"===t.type||"long"===t.type||"number"===t.type?i.type="number":"boolean"===t.type?i.type="boolean":i.type="string"),t.required?i.required="true":i.required="false",c.push(i)}else if("header"===t.in){var i;(i={}).parameterName=t.name,"array"===t.type?(i.repeating="true","integer"===t.items.type||"long"===t.items.type||"number"===t.items.type?i.type="number":"boolean"===t.items.type?i.type="boolean":i.type="string"):(i.repeating="false","integer"===t.type||"long"===t.type||"number"===t.type?i.type="number":"boolean"===t.type?i.type="boolean":i.type="string"),t.required?i.required="true":i.required="false",m.push(i)}else if("formData"===t.in)if(a.isOAS3())v=!0,l=t.schema;else if(a.getConsumes(d,e).includes("application/x-www-form-urlencoded"))v=!0,null!=l&&""!==l||(l={type:"object",properties:{},required:[]}),null!=l&&("array"===t.type?(l.properties[t.name]={type:"array"},!0===t.required&&l.required.push(t.name)):("integer"===t.type||"long"===t.type||"number"===t.type?l.properties[t.name]={type:"number"}:"boolean"===t.type?l.properties[t.name]={type:"boolean"}:l.properties[t.name]={type:"string"},!0===t.required&&l.required.push(t.name)));else{var r={};"file"===t.type||"array"===t.type?(r.name=t.name,r.type="filecontent",r.required=t.required):"object"===t.type?(r.name=t.name,r.type=t.type,r.required=t.required,r.schema=t.schema):(r.name=t.name,r.type="string",r.required=t.required),p.push(r)}else if("multpartFormData"===t.in){if(t.schema.properties&&void 0!==t.schema.properties)Object.keys(t.schema.properties).forEach(function(e){var i=t.schema.properties[e].type,a=t.schema.properties[e].format,r={};r.name=e,"string"===i?r.type="base64"===a||"binary"===a?"filecontent":"string":"object"===i?(r.type="object",r.schema=t.schema.properties[e]):r.type="string",p.push(r)})}},M=0,O=s;M<O.length;M++){_(O[M])}i.query=JSON.stringify(c),i.queryUpdation=!1,i.path=JSON.stringify(g),i.pathUpdation=!1,i.headers=JSON.stringify(m),i.headersUpdation=!1,i.responseCodes=JSON.stringify(f),i.responseCodesUpdation=!1,i.inputSchema=JSON.stringify(l),i.inputSchemaUpdation=!1,i.multipartData=JSON.stringify(p),i.multipartDataUpdation=!1,i.urlEncode=v,u[e]=i}o[d]=u}},m=0,f=g;m<f.length;m++){c(f[m])}this.compareTempMapWithExistingMap(i,o)},t.prototype.compareTempMapWithExistingMap=function(e,t){if(void 0===this.APISpecsMap[e])this.APISpecsMap[e]=t;else{for(var i=Object.keys(t),a=0;a<i.length;a++)if(void 0!==this.APISpecsMap[e][i[a]])for(var r=Object.keys(t[i[a]]),s=0;s<r.length;s++)if(void 0!==this.APISpecsMap[e][i[a]][r[s]]){var n=t[i[a]][r[s]],o=this.APISpecsMap[e][i[a]][r[s]];n.query!==o.query?n.queryUpdation=!0:n.queryUpdation=!1,n.path!==o.path?n.pathUpdation=!0:n.pathUpdation=!1,n.headers!==o.headers?n.headersUpdation=!0:n.headersUpdation=!1,n.responseCodes!==o.responseCodes?n.responseCodesUpdation=!0:n.responseCodesUpdation=!1,n.multipartData!==o.multipartData?n.multipartDataUpdation=!0:n.multipartDataUpdation=!1,n.inputSchema!==o.inputSchema?n.inputSchemaUpdation=!0:n.inputSchemaUpdation=!1}this.APISpecsMap[e]=t}},t.prototype.parseAPISpecFile=function(e,t,i,a){var r=this,s=atob(e.slice(e.indexOf(",")+1));try{var n=JSON.parse(s);return rxjs_1.Observable.create(function(e){r.parsingService.parseSwaggerSpec(n).subscribe(function(s){if(!0===s.success){var n=s.swagger;(new SwaggerValidationService_1.SwaggerValidationService).start(lodash.cloneDeep(n)).subscribe(function(a){var s=[];if(a.errors.length>0){for(var o=a.errors.length-1;o>=0;o--){var l=a.errors[o].getErrorMessage(),p=l.substring(11,l.indexOf("=")),d=l.substring(l.indexOf("=")+1);if("FATAL_ERROR"===p){var g=d.substring(d.lastIndexOf("[")+1,d.lastIndexOf("]")).trim(),u=g+"-"+d.substring(d.lastIndexOf("method [")+9,d.lastIndexOf("] is not")).trim();s.includes(u)||""===g||s.push(u)}else{var c=p.substring(0,p.indexOf(".")),m=p.substring(p.indexOf(".")+1).toUpperCase();u=c+"-"+m.toUpperCase();s.includes(u)||(d=(d=d.replace("PATH_NAME",c)).replace("METHOD_NAME",m))}}if(r.updateSwaggerDictionary(n,s,t),r.APISpecsMap[t]){var f=Object.keys(r.APISpecsMap[t]);r.messaging.emit(i+"version",!0),r.messaging.emit(i+"apiVersion",!0),r.messaging.emit(i+"query",!0),r.messaging.emit(i+"path",!0),r.messaging.emit(i+"header",!0),r.messaging.emit(i+"body",!0),r.messaging.emit(i+"codes",!0),r.messaging.emit(i+"method",!0),r.messaging.emit(i+"reqType",!0),r.messaging.emit(i+"multipartData",!0),r.messaging.emit(i+"multipartFormData",!0),e.next(f)}e.complete()}else{if(r.updateSwaggerDictionary(n,s,t),r.APISpecsMap[t]){f=Object.keys(r.APISpecsMap[t]);r.messaging.emit(i+"version",!0),r.messaging.emit(i+"apiVersion",!0),r.messaging.emit(i+"query",!0),r.messaging.emit(i+"path",!0),r.messaging.emit(i+"header",!0),r.messaging.emit(i+"body",!0),r.messaging.emit(i+"codes",!0),r.messaging.emit(i+"method",!0),r.messaging.emit(i+"reqType",!0),r.messaging.emit(i+"multipartData",!0),r.messaging.emit(i+"multipartFormData",!0),e.next(f)}e.complete()}})}else r.messaging.emit(i+"version",!1),r.messaging.emit(i+"apiVersion",!1),r.messaging.emit(i+"query",!1),r.messaging.emit(i+"path",!1),r.messaging.emit(i+"header",!1),r.messaging.emit(i+"body",!1),r.messaging.emit(i+"codes",!1),r.messaging.emit(i+"method",!1),r.messaging.emit(i+"reqType",!1),r.messaging.emit(i+"multipartData",!1),r.messaging.emit(i+"multipartFormData",!1),delete r.encodedRESTPreviousSwagger[a.title],e.next([]),e.complete()},function(t){r.messaging.emit(i+"version",!1),r.messaging.emit(i+"apiVersion",!1),r.messaging.emit(i+"query",!1),r.messaging.emit(i+"path",!1),r.messaging.emit(i+"header",!1),r.messaging.emit(i+"body",!1),r.messaging.emit(i+"codes",!1),r.messaging.emit(i+"method",!1),r.messaging.emit(i+"reqType",!1),r.messaging.emit(i+"multipartData",!1),r.messaging.emit(i+"multipartFormData",!1),delete r.encodedRESTPreviousSwagger[a.title],e.next([]),e.complete()})})}catch(e){return rxjs_1.Observable.create(function(e){r.messaging.emit(i+"version",!1),r.messaging.emit(i+"apiVersion",!1),r.messaging.emit(i+"query",!1),r.messaging.emit(i+"path",!1),r.messaging.emit(i+"header",!1),r.messaging.emit(i+"body",!1),r.messaging.emit(i+"codes",!1),r.messaging.emit(i+"method",!1),r.messaging.emit(i+"reqType",!1),r.messaging.emit(i+"multipartData",!1),r.messaging.emit(i+"multipartFormData",!1),delete r.encodedRESTPreviousSwagger[a.title],e.next([]),e.complete()})}},t.prototype.buildActionFromApiSpec=function(e,t){var i,a,r=this.getModelService(),s=r.getApplication(),n=wi_contrib_1.WiContributionUtils.getUniqueId(t)+":"+s.getName(),o=t.getField("swagger").value,l=t.getField("apiVersion"),p=this.deRefMap[n+":paths"];if("string"==typeof o&&o.startsWith(SPEC_PREFIX)){var d=o.replace(SPEC_PREFIX,"");a=this.appSpecsService.getAppSpecById(d)}else a=rxjs_1.Observable.of(o);a.subscribe(function(e){e&&e.content?i=e.content:console.log("Spec is deleted from tab")});var g={modelService:new ModelServiceFacade(r),triggerData:{errorPaths:p,apiVersion:l,filecontent:this.deRefMap[n]},originalFile:i};return flogo_flow_create_providers_1.convertApiSpecToActionResult(g).pipe(operators_1.map(function(e){return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(e)}),operators_1.catchError(function(t){return console.log(t),rxjs_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(e))}))},t.prototype.generateInput=function(e,t){return"_"+e+"_"+t},t.prototype.isGetOrDelete=function(e){var t=e.getField("Method");return"GET"===t.value||"DELETE"===t.value},t.prototype.isDelete=function(e){return"DELETE"===e.getField("Method").value},t.prototype.isGet=function(e){return"GET"===e.getField("Method").value},t.prototype.formSettings=function(e){for(var t=[],i=e.getTriggerFlowModelMaps(),a=0;a<i.length;a++){var r=i[a].getTriggerElement();if("tibco-wi-rest"===r.name&&r.display&&"General"===r.display.category){for(var s={},n=0;n<r.handler.settings.length;n++)"method"===r.handler.settings[n].name.toLowerCase()?s.method=r.handler.settings[n].value:"path"===r.handler.settings[n].name.toLowerCase()&&(s.path=r.handler.settings[n].value);r.settings&&r.settings.length>0&&(s.port=r.settings[0].value),t.push(s)}}return t},t.prototype.isValid=function(e,t,i,a){var r;for(r=0;r<t.length;r++){if(t[r].port===a)if(t[r].method===e){if(t[r].path===i)break;if(!this.pathValidation(t[r].path,i,!0))break}else if(t[r].path!==i&&!this.pathValidation(t[r].path,i,!1))break}return r===t.length},t.prototype.pathValidation=function(e,t,i){if(e&&t){var a=e.trim().split("/"),r=t.trim().split("/");if(""===a[a.length-1]&&a.splice(a.length-1,1),""===r[r.length-1]&&r.splice(r.length-1,1),a.length!==r.length)return!0;var s=void 0;for(s=0;s<a.length;s++)if(a[s]===a[s].replace(/.*\{|\}/gi,"")){if(r[s]!==r[s].replace(/.*\{|\}/gi,""))break;if(a[s]&&r[s]&&a[s]!==r[s])break}else{if(r[s]===r[s].replace(/.*\{|\}/gi,""))break;if(a[s]&&r[s]&&!i&&a[s]!==r[s])break}return s!==a.length}return!1},t.prototype.verifyPathStartSlash=function(e){if("/"===e)return!0;return/(?:(?:^\/){1}(?:(?:(?:[\{]{1})(?:[-a-zA-Z0-9_*\:]+)(?:[\}]{1}))|(?:[-a-zA-Z0-9_]+))){1}(?:(?:(?:[\/]{1})(?:(?:(?:[\{]{1})(?:[-a-zA-Z0-9_*\:]+)(?:[\}]{1}))|(?:[-a-zA-Z0-9_\:]+)))*)$/i.test(e)},t.prototype.validateParametersByName=function(e,t){return rxjs_1.Observable.create(function(i){var a=validation_1.ValidationResult.newValidationResult(),r=t.getField(e),s=[],n="",o={};try{o=JSON.parse(r.value.value)}catch(e){}for(var l=0,p=o;l<p.length;l++){var d=p[l];if(!d.parameterName){n="Parameter Name should not be empty",a.setError("GENERAL-REST-TRIGGER-1001",n),a.setValid(!1);break}for(var g=0,u=s;g<u.length;g++){if(u[g]===d.parameterName){n="Parameter Name '"+d.parameterName+"' already exists",a.setError("GENERAL-REST-TRIGGER-1001",n),a.setValid(!1);break}}s.push(d.parameterName)}i.next(a),i.complete()})},t}(wi_contrib_1.WiServiceHandlerContribution);RestTriggerService=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService,"function"==typeof(_a=void 0!==flogo_contrib_sdk_1.ParsingService&&flogo_contrib_sdk_1.ParsingService)&&_a||Object,"function"==typeof(_b=void 0!==flogo_contrib_sdk_1.ConfigurationService&&flogo_contrib_sdk_1.ConfigurationService)&&_b||Object,"function"==typeof(_c=void 0!==flogo_contrib_sdk_1.AppSpecsService&&flogo_contrib_sdk_1.AppSpecsService)&&_c||Object])],RestTriggerService),exports.RestTriggerService=RestTriggerService;
//# sourceMappingURL=trigger.js.map
