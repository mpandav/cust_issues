"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),__decorate=this&&this.__decorate||function(e,t,i,a){var r,s=arguments.length,n=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,a);else for(var l=e.length-1;l>=0;l--)(r=e[l])&&(n=(s<3?r(n):s>3?r(t,i,n):r(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(i,a){t(i,a,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var _a,_b,_c,rxjs_1=require("rxjs"),schema=require("generate-schema"),http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contributionHelper_1=require("wi-studio/common/util/contributionHelper"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),contrib_1=require("wi-studio/common/models/contrib"),flogo_flow_create_providers_1=require("@tibco/flogo-flow-create-providers"),flogo_contrib_sdk_1=require("@tibco/flogo-contrib-sdk"),NAME_VALUE_SCHEMA={$schema:"http://json-schema.org/draft-07/schema#",items:{properties:{name:{type:"string"},value:{type:"string"}},type:"object"},type:"array"},DATA_SCHEMA={$schema:"http://json-schema.org/draft-07/schema#",properties:{data:{type:"string"}},type:"object"},SPEC_PREFIX="spec://",RestInvokeCustomerActivityContribution=function(e){function t(t,i,a,r,s,n){var l=e.call(this,t,i,a)||this;return l.http=i,l.contribModelService=a,l.parsingService=r,l.configurationService=s,l.appSpecsService=n,l.value=function(e,t){if("METADATA:ICON"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(t){t?(e.next("icons/ic-tibco-wi-mesh.png"),e.complete()):(e.next("icons/ic-tibco-wi-restinvoke.png"),e.complete())})});if("enableASR"===e)return rxjs_1.Observable.create(function(e){l.configurationService.getAppConfig().subscribe(function(t){t.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?(e.next(!1),e.complete()):(e.next(null),e.complete())})});if("authorizationConn"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(t){if(t)e.next(null),e.complete();else{var i=[];wi_contrib_1.WiContributionUtils.getConnections(l.http,"General").subscribe(function(t){t.forEach(function(e){for(var t=0;t<e.settings.length;t++)if("name"===e.settings[t].name){i.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[t].value});break}}),e.next(i),e.complete()})}})});if("asrDialog"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){if(i){var a=t.getField("serviceName");if(a&&a.value){var r=t.getField("serviceMetadata");if(r&&r.value){var s={},n=JSON.parse(r.value);s.service=n,s.operation=t.getField("Method").value,s.path=t.getField("resourcePath").value,e.next(s),e.complete()}else e.next(null),e.complete()}else e.next(null),e.complete()}else e.next(null),e.complete()})});if("serviceName"===e)return rxjs_1.Observable.create(function(e){l.isAsrDialogSelected(t)?l.isAsrDialogSelected(t)?(e.next(""),e.complete()):(e.next(null),e.complete()):l.asrEnabled1(t).subscribe(function(t){if(t){wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(l.http,"synergy/gsbc-services/v2","privateRegistry").addMethod("GET").send().subscribe(function(t){if(200===t.status){for(var i=[],a=0,r=t.json().internal;a<r.length;a++){var s=r[a];i.push({unique_id:s.serviceId,name:s.title})}e.next(i),e.complete()}else e.error({code:t.status,message:"Failed to get service namea using Endpoint!",details:t.json()}),e.complete()},function(t){e.error("Could not retrieve serice list."),e.complete()})}else e.next(null),e.complete()})});if("serviceMetadata"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i){var r=t.getField("asrDialog"),s=t.getField("serviceName");if(r&&r.value){var n=r.value;l.parsingService.parseSwaggerSpec(n.service.apiSpec).subscribe(function(i){var a=t.id;if(!0===i.success){var r=i.swagger;n.service.apiSpec=r,n.service.asrPath=n.path,n.service.asrOperation=n.operation,l.messaging.emit(a+"requestType",n.service),l.messaging.emit(a+"headers",n.service),l.messaging.emit(a+"queryParams",n.service),l.messaging.emit(a+"pathParams",n.service),l.messaging.emit(a+"body",n.service),l.messaging.emit(a+"multipartForm",n.service),l.messaging.emit(a+"multipartFormData",n.service),l.messaging.emit(a+"responseCodes",n.service),l.messaging.emit(a+"responseCodesSchema",n.service),e.next(JSON.stringify(n.service)),e.complete()}else console.error("dereference swagger object err:",i.error),l.messaging.emit(a+"requestType",!1),l.messaging.emit(a+"headers",!1),l.messaging.emit(a+"queryParams",!1),l.messaging.emit(a+"pathParams",!1),l.messaging.emit(a+"body",!1),l.messaging.emit(a+"multipartForm",!1),l.messaging.emit(a+"multipartFormData",!1),l.messaging.emit(a+"responseCodes",!1),l.messaging.emit(a+"responseCodesSchema",!1),e.next(null),e.complete()})}else if(s.value){var o="synergy/gsbc-services/v2/"+s.value;wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(l.http,o,"privateRegistry").addMethod("GET").addHeader("Content-Type","application/json").send().subscribe(function(i){if(200===i.status){var a=i.json();l.parsingService.parseSwaggerSpec(a.apiSpec).subscribe(function(i){var r=t.id;if(!0===i.success){var s=i.swagger;a.apiSpec=s,l.messaging.emit(r+"resourcePath",a),l.messaging.emit(r+"url",a),l.messaging.emit(r+"requestType",a),l.messaging.emit(r+"headers",a),l.messaging.emit(r+"queryParams",a),l.messaging.emit(r+"pathParams",a),l.messaging.emit(r+"body",a),l.messaging.emit(r+"multipartForm",a),l.messaging.emit(r+"multipartFormData",a),l.messaging.emit(r+"responseCodes",a),l.messaging.emit(r+"responseCodesSchema",a),e.next(JSON.stringify(a)),e.complete()}else console.error("dereference swagger object err:",i.error),l.messaging.emit(r+"resourcePath",!1),l.messaging.emit(r+"url",!1),l.messaging.emit(r+"requestType",!1),l.messaging.emit(r+"headers",!1),l.messaging.emit(r+"queryParams",!1),l.messaging.emit(r+"pathParams",!1),l.messaging.emit(r+"body",!1),l.messaging.emit(r+"multipartForm",!1),l.messaging.emit(r+"multipartFormData",!1),l.messaging.emit(r+"responseCodes",!1),l.messaging.emit(r+"responseCodesSchema",!1),e.next(null),e.complete()})}else{var r=t.id;l.messaging.emit(r+"resourcePath",!1),l.messaging.emit(r+"url",!1),l.messaging.emit(r+"requestType",!1),l.messaging.emit(r+"headers",!1),l.messaging.emit(r+"queryParams",!1),l.messaging.emit(r+"pathParams",!1),l.messaging.emit(r+"body",!1),l.messaging.emit(r+"multipartForm",!1),l.messaging.emit(r+"multipartFormData",!1),l.messaging.emit(r+"responseCodes",!1),l.messaging.emit(r+"responseCodesSchema",!1),e.error({code:i.status,message:"Failed to get input schema using Endpoint!",details:i.json()}),e.complete()}},function(i){var a=t.id;l.messaging.emit(a+"resourcePath",!1),l.messaging.emit(a+"url",!1),l.messaging.emit(a+"requestType",!1),l.messaging.emit(a+"headers",!1),l.messaging.emit(a+"queryParams",!1),l.messaging.emit(a+"pathParams",!1),l.messaging.emit(a+"body",!1),l.messaging.emit(a+"multipartForm",!1),l.messaging.emit(a+"multipartFormData",!1),l.messaging.emit(a+"responseCodes",!1),l.messaging.emit(a+"responseCodesSchema",!1),e.error("Could not retrieve service metadata."),e.complete()})}else e.next(null),e.complete()}else if(a&&""!==a){var p="string"==typeof a&&a.startsWith(SPEC_PREFIX),u=void 0;if(p){var c=a.replace(SPEC_PREFIX,"");u=l.appSpecsService.getAppSpecById(c)}else u=rxjs_1.Observable.of(a);u.subscribe(function(i){var a=t.id;if(i&&i.content){p?i.name:i.filename;var r=i.content;if(r&&""!==r)try{var s=atob(r.slice(r.indexOf(",")+1)),n=JSON.parse(s);l.parsingService.parseSwaggerSpec(n).subscribe(function(t){if(!0===t.success){var i=t.swagger;l.messaging.emit(a+"resourcePath",i),e.next(JSON.stringify(i)),e.complete()}else l.messaging.emit(a+"resourcePath",!1),e.next(null),e.complete()})}catch(t){l.messaging.emit(a+"resourcePath",!1),e.next(null),e.complete()}else l.messaging.emit(a+"resourcePath",!1),e.next(null),e.complete()}else l.messaging.emit(a+"resourcePath",!1),e.next(null),e.complete()})}else e.next(""),e.complete()})});if("resourcePath"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i)if(l.isAsrDialogSelected(t)){var r=t.getField("asrDialog");r.value?(e.next([r.value.path]),e.complete()):(e.next(null),e.complete())}else{if(t.getField("serviceName").value){var s=t.id;l.messaging.on(s+"resourcePath",function(i){if(null!==i&&!1!==i){var a=new flogo_flow_create_providers_1.Swagger(i.apiSpec);l.messaging.off(t.id+"resourcePath"),e.next(a.getPaths()),e.complete()}else null!==i&&!1===i?(l.messaging.off(t.id+"resourcePath"),e.next(null),e.complete()):(e.next(null),e.complete())})}else e.next(null),e.complete()}else if(a&&""!==a){l.checkForAPISpecPathChange(t);var n=a.content;if("string"==typeof a&&a.startsWith(SPEC_PREFIX)||n&&""!==n){var o=t.id;l.messaging.on(o+"resourcePath",function(t){if(null!==t&&!1!==t){var i=new flogo_flow_create_providers_1.Swagger(t);l.messaging.off(o+"resourcePath"),l.messaging.emit(o+"url",!0),e.next(i.getPaths()),e.complete()}else null!==t&&!1===t&&(l.messaging.off(o+"resourcePath"),l.messaging.emit(o+"url",!1),e.next(null),e.complete())})}else e.next(""),e.complete()}else e.next(""),e.complete()})});if("Uri"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i){var r=t.getField("serviceName"),s=t.getField("asrDialog");l.isAsrDialogSelected(t)&&s.value?(e.next(s.value.service.path),e.complete()):r.value?l.messaging.on(t.id+"url",function(i){null!==i&&!1!==i?(l.messaging.off(t.id+"url"),e.next(i.path),e.complete()):null!==i&&!1===i?(l.messaging.off(t.id+"url"),e.next(null),e.complete()):(e.next(null),e.complete())}):(e.next(null),e.complete())}else if(a&&""!==a){var n=a.content;"string"==typeof a&&a.startsWith(SPEC_PREFIX)||n&&""!==n?l.messaging.on(t.id+"url",function(i){if(null!==i&&!0===i){l.messaging.off(t.id+"url");var a=t.getField("resourcePath"),r=t.getField("serviceMetadata");if(r.value&&a.value){var s=JSON.parse(r.value),n=new flogo_flow_create_providers_1.Swagger(s);if(l.isPathChanged||l.previousPath===a.value){var o=l.createURLFromAPISpec(n,a.value);l.messaging.off(t.id+"url"),""===o?(e.next(null),e.complete()):(e.next(o),e.complete())}else l.messaging.off(t.id+"url"),e.next(null),e.complete()}else l.messaging.off(t.id+"url"),e.next(null),e.complete()}else null!==i&&!1===i&&(l.messaging.off(t.id+"url"),e.next(null),e.complete())}):(e.next(""),e.complete())}else e.next(null),e.complete()})});if("Method"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i)if(l.isAsrDialogSelected(t)){var r=t.getField("asrDialog");r.value?(e.next([r.value.operation.toUpperCase()]),e.complete()):(e.next(null),e.complete())}else{var s=t.getField("resourcePath");(o=t.getField("serviceMetadata")).value&&s.value?(e.next(l.getMethodsFromMetadaObject(o.value,s.value,!0)),e.complete()):(e.next(null),e.complete())}else if(a&&""!==a){l.checkForAPISpecMethodChange(t);var n=a.content;if("string"==typeof a&&a.startsWith(SPEC_PREFIX)||n&&""!==n){var o;s=t.getField("resourcePath");(o=t.getField("serviceMetadata")).value&&s.value?(e.next(l.getMethodsFromMetadaObject(o.value,s.value,!1)),e.complete()):(e.next(null),e.complete())}else e.next(["GET","POST","PUT","DELETE","PATCH"]),e.complete()}else e.next(["GET","POST","PUT","DELETE","PATCH"]),e.complete()})});if("requestType"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i){var r=t.getField("Method");if(r.value){var s=r.value.toLowerCase();if(s)if("POST"===s.toUpperCase()||"PUT"===s.toUpperCase()||"PATCH"===s.toUpperCase()||"DELETE"===s.toUpperCase())if(l.isAsrDialogSelected(t)){var n=t.id;l.messaging.on(n+"requestType",function(i){if(null!==i&&!1!==i){var a=JSON.stringify(i);l.messaging.off(t.id+"requestType"),a&&i.asrPath&&r.value?(e.next(l.getConsumesForRequestType(a,i.asrPath,s,!0)),e.complete()):(e.next(null),e.complete())}else null!==i&&!1===i?(l.messaging.off(t.id+"requestType"),e.next(null),e.complete()):(e.next(null),e.complete())})}else{var o=t.getField("resourcePath");(c=t.getField("serviceMetadata")).value&&o.value&&r.value?(e.next(l.getConsumesForRequestType(c.value,o.value,s,!0)),e.complete()):(e.next(null),e.complete())}else e.next(null),e.complete();else e.next(null),e.complete()}else e.next(null),e.complete()}else if(a&&""!==a){l.checkForAPISpecRequestTypeChange(t);var p=a.content;if("string"==typeof a&&a.startsWith(SPEC_PREFIX)||p&&""!==p){var u=t.getField("Method");if(""!==(o=t.getField("resourcePath")).value&&""!==u.value&&(l.isPathChanged||l.isMethodChanged))if(u.value){var c,g=u.value.toLowerCase();if(g)if("POST"===g.toUpperCase()||"PUT"===g.toUpperCase()||"PATCH"===g.toUpperCase()||"DELETE"===g.toUpperCase())if((c=t.getField("serviceMetadata")).value&&o.value&&u.value){var m=l.getConsumesForRequestType(c.value,o.value,g,!1);e.next(m),e.complete()}else e.next(null),e.complete();else e.next(null),e.complete();else e.next(null),e.complete()}else e.next(null),e.complete();else e.next(null),e.complete()}else e.next(null),e.complete()}else l.isDelete(t)?(e.next(["application/json"]),e.complete()):(e.next(["text/plain","application/json","application/x-www-form-urlencoded","multipart/form-data"]),e.complete())})});if("responseType"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){if(i){var a=t.getField("Method"),r=t.getField("resourcePath"),s=t.getField("serviceMetadata");if(s.value&&r.value&&a.value){var n=a.value.toLowerCase(),l=JSON.parse(s.value),o=new flogo_flow_create_providers_1.Swagger(l.apiSpec),p=r.value,u=[];(u=o.paths[p]&&o.paths[p][n]&&"string"!=typeof o.paths[p][n]?o.paths[p][n].produces:o.produces)&&u.length>0?(e.next(u),e.complete()):(u?u.push("application/json"):u=["application/json"],e.next(u),e.complete())}else e.next(null),e.complete()}else e.next(["application/json","application/xml","text/plain","other"]),e.complete()})});if("pathParams"===e||"queryParams"===e||"multipartForm"===e||"multipartFormData"===e||"body"===e)return rxjs_1.Observable.create(function(i){l.asrEnabled1(t).subscribe(function(a){var r=t.getField("swagger")?t.getField("swagger").value:null;if(a)if(l.isAsrDialogSelected(t)){var s=t.id;l.messaging.on(s+e,function(a){if(null!==a&&!1!==a){l.messaging.off(t.id+e);var r=JSON.stringify(a),s=a.asrPath,n=a.asrOperation,o=t.getField("requestType"),p=void 0,u={},c=[],g=[],m=[];if(r&&s&&n){var d=l.parseParams(s,n,r,o,!0,l.isTCIASRService(t));if(p=d.bodySchema,u=d.urlEncodedSchemaResponse,c=d.pathParam,g=d.queryParams,m=d.multipart,"queryParams"===e)i.next(JSON.stringify(g)),i.complete();else if("pathParams"===e)i.next(JSON.stringify(c)),i.complete();else if("body"===e)o&&o.value&&"application/x-www-form-urlencoded"===o.value?i.next(JSON.stringify(u)):i.next(JSON.stringify(p)),i.complete();else if("multipartForm"===e)o&&o.value&&"multipart/form-data"===o.value?i.next(JSON.stringify(m)):i.next(null),i.complete();else if("multipartFormData"===e){var f=t.getField("multipartForm").value,v={};if(f&&f.value){var b=JSON.parse(f.value),h={};b.forEach(function(e){if("filecontent"===e.type){var t=e.name;h[t]={type:"any"}}else if("string"===e.type){var i=e.name;h[i]={type:"string"}}else if("object"===e.type){var a=e.name;e.schema?h[a]=JSON.parse(e.schema):h[a]={}}}),v={type:"object",properties:h},i.next(JSON.stringify(v)),i.complete()}else i.next(""),i.complete()}else i.next(null),i.complete()}else i.next(null),i.complete()}else null!==a&&!1===a&&(l.messaging.off(t.id+e),i.next(null),i.complete())})}else{var n=t.getField("resourcePath"),o=t.getField("Method"),p=t.getField("serviceMetadata"),u=t.getField("requestType"),c=void 0,g={},m=[],d=[],f=[];if(p.value&&n.value&&o.value)if(c=(_=l.parseParams(n.value,o.value,p.value,u,!0,l.isTCIASRService(t))).bodySchema,g=_.urlEncodedSchemaResponse,m=_.pathParam,d=_.queryParams,f=_.multipart,"queryParams"===e)i.next(JSON.stringify(d)),i.complete();else if("pathParams"===e)i.next(JSON.stringify(m)),i.complete();else if("body"===e)u&&u.value&&("application/x-www-form-urlencoded"===u.value||"multipart/form-data"===u.value)?i.next(JSON.stringify(g)):i.next(JSON.stringify(c)),i.complete();else if("multipartForm"===e)u&&u.value&&"multipart/form-data"===u.value?i.next(JSON.stringify(f)):i.next(null),i.complete();else if("multipartFormData"===e){var v={};if((E=t.getField("multipartForm").value)&&E.value){var b=JSON.parse(E.value),h={};b.forEach(function(e){if("filecontent"===e.type){var t=e.name;h[t]={type:"any"}}else if("string"===e.type){var i=e.name;h[i]={type:"string"}}else if("object"===e.type){var a=e.name;e.schema?h[a]=JSON.parse(e.schema):h[a]={}}}),v={type:"object",properties:h},i.next(JSON.stringify(v)),i.complete()}else i.next(""),i.complete()}else i.next(null),i.complete();else i.next(null),i.complete()}else if(r&&""!==r){var y=r.content;if("string"==typeof r&&r.startsWith(SPEC_PREFIX)||y&&""!==y){var _;o=t.getField("Method"),n=t.getField("resourcePath"),p=t.getField("serviceMetadata"),u=t.getField("requestType"),c=void 0,g={},m=[],f=[],d=[];if(p.value&&n.value&&o.value)c=(_=l.parseParams(n.value,o.value,p.value,u,!1,!1)).bodySchema,g=_.urlEncodedSchemaResponse,_.urlEncodedScheama,_.urlEncodedScheamaRequiresField,m=_.pathParam,d=_.queryParams,f=_.multipart;else i.next(null),i.complete();if("queryParams"===e)""!==n.value&&""!==o.value&&(l.isPathChanged||l.isMethodChanged)?d.length>0?(i.next(JSON.stringify(d)),i.complete()):(i.next(""),i.complete()):(i.next(null),i.complete());else if("pathParams"===e)""!==n.value&&""!==o.value&&(l.isPathChanged||l.isMethodChanged)?m.length>0?(i.next(JSON.stringify(m)),i.complete()):(i.next(""),i.complete()):(i.next(null),i.complete());else if("body"===e)""!==n.value&&""!==o.value&&(l.isPathChanged||l.isMethodChanged||l.isReqTypeChanged)?(u&&u.value&&"application/x-www-form-urlencoded"===u.value?i.next(JSON.stringify(g)):i.next(JSON.stringify(c)),i.complete()):(i.next(null),i.complete());else if("multipartForm"===e)""!==n.value&&""!==o.value&&(l.isPathChanged||l.isMethodChanged||l.isReqTypeChanged)?(u&&u.value&&"multipart/form-data"===u.value?i.next(JSON.stringify(f)):i.next(null),i.complete()):(i.next(null),i.complete());else if("multipartFormData"===e){v={};if((E=t.getField("multipartForm").value)&&E.value){b=JSON.parse(E.value);var x={};b.forEach(function(e){if("filecontent"===e.type){var t=e.name;x[t]={type:"any"}}else if("string"===e.type){var i=e.name;x[i]={type:"string"}}else if("object"===e.type){var a=e.name;e.schema?x[a]=JSON.parse(e.schema):x[a]={}}}),v={type:"object",properties:x},i.next(JSON.stringify(v)),i.complete()}else i.next(""),i.complete()}else i.next(null),i.complete()}else i.next(null),i.complete()}else if("pathParams"===e){var S=t.getField("Uri");i.next(contributionHelper_1.ContributionHelper.extractJsonFromPath(S.value)),i.complete()}else if("body"===e){var R=t.getField("requestType");if("application/json"===R.value)i.next(null),i.complete();else if("application/x-www-form-urlencoded"===R.value){var w=t.getField("body");w.value.value&&w.value.value.length>0?i.next(null):i.next(JSON.stringify(NAME_VALUE_SCHEMA,null,2)),i.complete()}else i.next(JSON.stringify(DATA_SCHEMA,null,2)),i.complete()}else if("multipartFormData"===e){var E;v={};if((E=t.getField("multipartForm").value)&&E.value){b=JSON.parse(E.value);var O={};b.forEach(function(e){if("filecontent"===e.type){var t=e.name;O[t]={type:"any"}}else if("file"===e.type){var i=e.name;O[i]={type:"object",properties:{content:{type:"any"},filename:{type:"string"},"content-type":{type:"string"}}}}else if("files"===e.type){var a=e.name;O[a]={type:"array",items:{type:"object",properties:{content:{type:"any"},filename:{type:"string"},"content-type":{type:"string"}}}}}else if("string"===e.type){var r=e.name;O[r]={type:"string"}}else if("object"===e.type){var s=e.name;e.schema?O[s]=JSON.parse(e.schema):O[s]={}}}),v={type:"object",properties:O},i.next(JSON.stringify(v)),i.complete()}else i.next(""),i.complete()}else i.next(null),i.complete()})});if("headers"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i)if(l.isAsrDialogSelected(t)){var r=t.id;l.messaging.on(r+"headers",function(i){if(null!==i&&!1!==i){l.messaging.off(t.id+"headers");var a=JSON.stringify(i),r=i.asrPath,s=i.asrOperation,n=[],o=[];if(a&&r&&s){var p=l.parseHeaders(r,s,a,!0);n=p.headers,o=p.responseHeadersSchema,t.getSection("headers")===contrib_1.MODEL_SECTIONS.INPUTS?(e.next(JSON.stringify(n)),e.complete()):o&&o.length>0?(e.next(JSON.stringify(n)),e.complete()):(e.next(null),e.complete())}else e.next(null),e.complete()}else null!==i&&!1===i&&(l.messaging.off(t.id+"headers"),e.next(null),e.complete())})}else{var s=t.getField("Method"),n=t.getField("resourcePath"),o=[],p=[];if((c=t.getField("serviceMetadata")).value&&n.value&&s.value)o=(g=l.parseHeaders(n.value,s.value,c.value,!0)).headers,p=g.responseHeadersSchema,t.getSection("headers")===contrib_1.MODEL_SECTIONS.INPUTS?(e.next(JSON.stringify(o)),e.complete()):p&&p.length>0?(e.next(JSON.stringify(o)),e.complete()):(e.next(null),e.complete());else e.next(null),e.complete()}else if(a&&""!==a){var u=a.content;if("string"==typeof a&&a.startsWith(SPEC_PREFIX)||u&&""!==u){var c,g;s=t.getField("Method"),n=t.getField("resourcePath"),o=[],p=[];if((c=t.getField("serviceMetadata")).value&&n.value&&s.value)o=(g=l.parseHeaders(n.value,s.value,c.value,!1)).headers,p=g.responseHeadersSchema;else e.next(null),e.complete();if(""!==n.value&&""!==s.value&&(l.isPathChanged||l.isMethodChanged))if(t.getSection("headers")===contrib_1.MODEL_SECTIONS.INPUTS)if(o.length>0){d=(d=JSON.stringify(o)).substring(0,d.indexOf("]"))+',{"parameterName":"Accept","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Charset","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Encoding","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Authorization","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Type","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Length","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Connection","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Cookie","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Pragma","type":"string","repeating":"false","required":"false","visible":false}]',e.next(d),e.complete()}else{var m='[{"parameterName":"Accept","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Charset","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Encoding","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Authorization","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Type","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Length","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Connection","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Cookie","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Pragma","type":"string","repeating":"false","required":"false","visible":false}]';e.next(m),e.complete()}else if(p&&p.length>0)if(o.length>0){var d;d=(d=JSON.stringify(o)).substring(0,d.indexOf("]"))+',{"parameterName":"Accept","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Charset","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Encoding","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Type","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Length","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Connection","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Cookie","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Pragma","type":"string","repeating":"false","required":"false","visible":false}]',e.next(d),e.complete()}else{m='[{"parameterName":"Accept","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Charset","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Accept-Encoding","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Type","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Content-Length","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Connection","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Cookie","type":"string","repeating":"false","required":"false","visible":false},{"parameterName":"Pragma","type":"string","repeating":"false","required":"false","visible":false}]';e.next(m),e.complete()}else e.next(null),e.complete();else e.next(null),e.complete()}else e.next(null),e.complete()}else e.next(null),e.complete()})});if("responseBody"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){if(i)e.next(null),e.complete();else if(!1===t.getField("configureResponseCodes").value){var a=t.getField("responseType"),r=t.getField("responseOutput");"application/json"===a.value?(e.next(null),e.complete()):"application/xml"===a.value&&"JSON Object"===r.value?(e.next(null),e.complete()):"application/xml"===a.value&&"XML String"===r.value?(e.next(JSON.stringify(DATA_SCHEMA,null,2)),e.complete()):(a.value,e.next(JSON.stringify(DATA_SCHEMA,null,2)),e.complete())}else e.next(null),e.complete()})});if("configureResponseCodes"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i)e.next(!0),e.complete();else if(a&&""!==a){var r=a.content;"string"==typeof a&&a.startsWith(SPEC_PREFIX)||r&&""!==r?(e.next(!0),e.complete()):(e.next(null),e.complete())}else e.next(null),e.complete()})});if("responseCodesSchema"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i)if(l.isAsrDialogSelected(t)){var r=t.id;l.messaging.on(r+"responseCodesSchema",function(i){if(null!==i&&!1!==i){l.messaging.off(t.id+"responseCodesSchema");var a=JSON.stringify(i),r=i.asrPath,s=i.asrOperation,n=[];a&&r&&s?(n=l.parseResponseCodeSchema(a,r,s,!0),e.next(JSON.stringify(n)),e.complete()):(e.next(null),e.complete())}else null!==i&&!1===i&&(l.messaging.off(t.id+"responseCodesSchema"),e.next(null),e.complete())})}else{var s=t.getField("Method"),n=t.getField("resourcePath"),o=[];(u=t.getField("serviceMetadata")).value&&n.value&&s.value?(o=l.parseResponseCodeSchema(u.value,n.value,s.value,!0),e.next(JSON.stringify(o)),e.complete()):(e.next(null),e.complete())}else if(a&&""!==a){var p=a.content;if("string"==typeof a&&a.startsWith(SPEC_PREFIX)||p&&""!==p){var u;s=t.getField("Method"),n=t.getField("resourcePath"),o=[];(u=t.getField("serviceMetadata")).value&&n.value&&s.value?(o=l.parseResponseCodeSchema(u.value,n.value,s.value,!1),""!==n.value&&""!==s.value&&(l.isPathChanged||l.isMethodChanged)?(e.next(JSON.stringify(o)),e.complete()):(e.next(null),e.complete())):(e.next(null),e.complete())}else e.next(null),e.complete()}else e.next(null),e.complete()})});if("responseCodes"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=t.getField("swagger")?t.getField("swagger").value:null;if(i)if(l.isAsrDialogSelected(t)){var r=t.id;l.messaging.on(r+"responseCodes",function(i){if(null!==i&&!1!==i){l.messaging.off(t.id+"responseCodes");var a=JSON.stringify(i),r=i.asrPath,s=i.asrOperation,n=t.getField("responseType").value;if(a&&r&&s){var o=s.toLowerCase(),p=JSON.parse(a),u=new flogo_flow_create_providers_1.Swagger(p.apiSpec),c={},g=u.getResponse(r,o);if(g){Object.keys(g).forEach(function(e){if(n&&"application/xml"===n)c[e]={type:"string"};else{var t=g[e];if(t.schema)if("string"===t.schema.type)c[e]={type:"string"};else if(t.schema.$ref){var i=u.resolveRefs(t.schema.$ref);c[e]=i}else c[e]=t.schema;else c[e]={type:"string"};if(void 0!==t.headers&&t.headers!=={}){for(var a=Object.keys(t.headers),r={},s=0;s<a.length;s++)r[a[s]]="";c[e+"_headers"]=schema.json(JSON.parse(JSON.stringify(r)))}}});var m={type:"object"};m.properties=c,e.next(JSON.stringify(m)),e.complete()}else e.next(null),e.complete()}else e.next(null),e.complete()}else null!==i&&!1===i&&(l.messaging.off(t.id+"responseCodes"),e.next(null),e.complete())})}else{var s=t.getField("Method"),n=t.getField("resourcePath"),o=t.getField("serviceMetadata"),p=t.getField("responseType").value;if(o.value&&n.value&&s.value){var u=s.value.toLowerCase(),c=JSON.parse(o.value),g=new flogo_flow_create_providers_1.Swagger(c.apiSpec),m={},d=g.getResponse(n.value,u);if(d)Object.keys(d).forEach(function(e){if(p&&"application/xml"===p)m[e]={type:"string"};else{var t=d[e];if(t.schema)if("string"===t.schema.type)m[e]={type:"string"};else if(t.schema.$ref){var i=g.resolveRefs(t.schema.$ref);m[e]=i}else m[e]=t.schema;else m[e]={type:"string"};if(void 0!==t.headers&&t.headers!=={}){for(var a=Object.keys(t.headers),r={},s=0;s<a.length;s++)r[a[s]]="";m[e+"_headers"]=schema.json(JSON.parse(JSON.stringify(r)))}}}),(S={type:"object"}).properties=m,e.next(JSON.stringify(S)),e.complete();else e.next(null),e.complete()}else e.next(null),e.complete()}else if(a&&""!==a){var f=a.content;if("string"==typeof a&&a.startsWith(SPEC_PREFIX)||f&&""!==f){s=t.getField("Method"),n=t.getField("resourcePath"),o=t.getField("serviceMetadata");var v=t.getField("responseType").value;if(o.value&&n.value&&s.value){u=s.value.toLowerCase(),c=JSON.parse(o.value);var b=new flogo_flow_create_providers_1.Swagger(c),h={},y=b.getResponse(n.value,u),_=t.getField("responseCodesSchema").value;if(_&&""!==_.value&&"[]"!==_.value){_=JSON.parse(_.value);for(var x=0;x<_.length;x++)"string"===_[x].responseType?h[_[x].code]={type:"string"}:l.isJson(_[x].responseSchema)?h[_[x].code]=schema.json(JSON.parse(_[x].responseSchema)):h[_[x].code]=JSON.parse(_[x].responseSchema),void 0!==_[x].responseHeaders&&""!==_[x].responseHeaders&&l.isJson(_[x].responseHeaders)&&(h[_[x].code+"_headers"]=schema.json(JSON.parse(_[x].responseHeaders)));(S={type:"object"}).properties=h,e.next(JSON.stringify(S)),e.complete()}else{var S;if(y)Object.keys(y).forEach(function(e){if(v&&"application/xml"===v)h[e]={type:"string"};else{var t=y[e];if(t.schema)if("string"===t.schema.type)h[e]={type:"string"};else if(t.schema.$ref){var i=b.resolveRefs(t.schema.$ref);h[e]=i}else h[e]=t.schema;else h[e]={type:"string"};if(void 0!==t.headers&&t.headers!=={}){for(var a=Object.keys(t.headers),r={},s=0;s<a.length;s++)r[a[s]]="";h[e+"_headers"]=schema.json(JSON.parse(JSON.stringify(r)))}}}),(S={type:"object"}).properties=h,""!==n.value&&""!==s.value&&(l.isPathChanged||l.isMethodChanged)?(e.next(JSON.stringify(S)),e.complete()):(e.next(null),e.complete());else e.next(null),e.complete()}}else e.next(null),e.complete()}else e.next(null),e.complete()}else{if(!0===t.getField("configureResponseCodes").value){var R={},w=t.getField("responseCodesSchema");if(void 0!==w.value&&""!==w.value.value)try{!w.value||null!==w.value.value&&void 0!==w.value.value&&""!==w.value.value||(e.next(""),e.complete());for(var E=JSON.parse(w.value.value),O=[],C=[],F=!1,V=0,N=E;V<N.length;V++){var P=N[V];("number"==typeof P.code&&P.code>0||P.code.length>0)&&("object"===P.responseType?(l.isJson(P.responseSchema)?O.push(P.code):F=!0,R[P.code]=JSON.parse(P.responseSchema)):(C.push(P.code),R[P.code]={type:"string"}),""!==P.responseHeaders&&(l.isJson(P.responseHeaders),R[P.code+"_headers"]=JSON.parse(P.responseHeaders)))}if(F){for(x=0;x<O.length;x++)R[O[x]]=schema.json(R[O[x]]),R[O[x]+"_headers"]&&l.isJson(R[O[x]+"_headers"])&&(R[O[x]+"_headers"]=schema.json(R[O[x]+"_headers"]));for(var T=0;T<C.length;T++)R[C[T]+"_headers"]&&l.isJson(JSON.stringify(R[C[T]+"_headers"]))&&(R[C[T]+"_headers"]=schema.json(R[C[T]+"_headers"]));(A={type:"object"}).properties=R,e.next(JSON.stringify(A)),e.complete()}else{for(x=0;x<O.length;x++)R[O[x]]=schema.json(R[O[x]]),R[O[x]+"_headers"]&&l.isJson(R[O[x]+"_headers"])&&(R[O[x]+"_headers"]=schema.json(R[O[x]+"_headers"]));for(T=0;T<C.length;T++)R[C[T]+"_headers"]&&l.isJson(JSON.stringify(R[C[T]+"_headers"]))&&(R[C[T]+"_headers"]=schema.json(R[C[T]+"_headers"]));var A;(A={type:"object"}).properties=R,e.next(JSON.stringify(A)),e.complete()}}catch(t){e.next(null),e.complete()}else e.next(null),e.complete()}else e.next(null),e.complete()}})});if("swagger"===e){var i=t.getField("swagger")?t.getField("swagger").value:null;if(i&&""!==i){var a=i.content;return!("string"==typeof i&&i.startsWith(SPEC_PREFIX))&&null==a||""===a?(console.log("Swagger content is empty"),""):(console.log("Swagger content is not empty"),null)}return null}return null},l.validate=function(e,t){if("swagger"===e)return rxjs_1.Observable.create(function(e){l.configurationService.getAppConfig().subscribe(function(i){l.asrEnabled1(t).subscribe(function(i){if(i)e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete();else{var a=t.getField("swagger")?t.getField("swagger").value:null;if(a&&""!==a){var r=void 0;if("string"==typeof a&&a.startsWith(SPEC_PREFIX)){var s=a.replace(SPEC_PREFIX,"");r=l.appSpecsService.getAppSpecById(s)}else r=rxjs_1.Observable.of(a);r.subscribe(function(t){if(t&&t.content){var i=t.content;if(i&&""!==i){var a=atob(i.slice(i.indexOf(",")+1));try{var r=JSON.parse(a);l.parsingService.parseSwaggerSpec(r).subscribe(function(t){if(!0===t.success)e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete();else{if("Maximum call stack size exceeded"===t.error){e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR","Swagger Dereference Error: There might be Cyclic Redundancy or Embedded '$ref' in Definitions"))}else"[object Object] is not a valid Openapi API definition"===t.error?e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR","Uploaded API Spec is not a valid API definition")):e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR",t.error));e.complete()}},function(t){e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR",t)),e.complete()})}catch(t){e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("SWAGGER_ERROR","Failed to parse JSON file, please upload a valid JSON file")),e.complete()}}else e.next(wi_contrib_1.ValidationResult.newValidationResult()),e.complete()}else e.next(wi_contrib_1.ValidationResult.newValidationResult()),e.complete()})}else e.next(wi_contrib_1.ValidationResult.newValidationResult()),e.complete()}})})});if("responseOutput"===e){var i=t.getField("responseType"),a=t.getField("configureResponseCodes");return"application/xml"===i.value&&!1===a.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}if("enableASR"===e)return rxjs_1.Observable.create(function(e){l.configurationService.getAppConfig().subscribe(function(t){t.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)):e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete()})});if("asrDialog"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){if(i){var a=wi_contrib_1.ValidationResult.newValidationResult(),r=t.getField("asrDialog").value;if(r){var s={serviceId:r.service.serviceId,gsbc:r.gsbc,path:r.path,operation:r.path,id:t.getId(),swaggerChecksum:r.service.swaggerChecksum},n=s.swaggerChecksum;wi_contrib_1.WiContributionUtils.getASRService(s,l.inject).subscribe(function(t){t.swaggerChecksum!==n&&a.setError("GENERAL-REST-ACTIVITY-1002","Service has been updated in TIBCO Cloud Mesh, please reconfigure this activity."),a.setVisible(!0),e.next(a),e.complete()},function(t){console.log("Get service from Cloud Mesh error:"+t),a.setVisible(!0),a.setError("GENERAL-REST-ACTIVITY-1002","Service not found in TIBCO Cloud Mesh, please make sure service is up and running"),e.next(a),e.complete()})}else e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete()}else e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete()})});if("authorization"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(t){t?(e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete()):(e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete())})});if("authorizationConn"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){if(i)e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete();else{var a=wi_contrib_1.ValidationResult.newValidationResult(),r=t.getField("authorization");r&&!0===r.value?(a.setVisible(!0),e.next(a),e.complete()):(e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete())}})});if("serviceName"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){if(i){var a=t.getField("serviceName");if(!l.isAsrDialogSelected(t)&&a.value){var r=t.getField("serviceMetadata");if(r.value){var s=JSON.parse(r.value).swaggerChecksum,n="synergy/gsbc-services/v2/"+a.value;wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(l.http,n,"privateRegistry").addMethod("GET").addHeader("Content-Type","application/json").send().subscribe(function(t){200===t.status?t.json().swaggerChecksum!==s?(e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("GENERAL-REST-ACTIVITY-1002","Service has been updated in TIBCO Cloud Mesh, please reconfigure this activity.")),e.complete()):(e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete()):(console.log({code:t.status,message:"Failed to get service metadata using Endpoint!",details:t.json()}),e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete())},function(t){console.log("Could not retrieve application list."),e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete()})}else e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0)),e.complete()}else e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete()}else e.next(wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)),e.complete()})});if("resourcePath"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult(),r=t.getField("swagger")?t.getField("swagger").value:null;if(i)a.setVisible(!0);else if(r&&""!==r){var s=r.content;"string"==typeof r&&r.startsWith(SPEC_PREFIX)||s&&""!==s?a.setVisible(!0):a.setVisible(!1)}else a.setVisible(!1);e.next(a),e.complete()})});if("Method"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){wi_contrib_1.ValidationResult.newValidationResult();if(i){var a=t.getField("Method"),r=t.getField("resourcePath"),s=t.getField("serviceMetadata");if(s.value&&r.value&&a.value){var n=a.value.toLowerCase(),l=JSON.parse(s.value),o=new flogo_flow_create_providers_1.Swagger(l.apiSpec),p=r.value,u=[];(u=o.paths[p]&&o.paths[p][n]&&"string"!=typeof o.paths[p][n]?o.paths[p][n].produces:o.produces)&&u.length>0?(1===u.length&&u[0],e.next(null),e.complete()):(e.next(null),e.complete())}else e.next(null),e.complete()}else e.next(null),e.complete()})});if("host"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(t){var i=wi_contrib_1.ValidationResult.newValidationResult();t?i.setVisible(!1):i.setVisible(!0),e.next(i),e.complete()})});if("Timeout"===e){if(t.getField("Timeout").value<0)return wi_contrib_1.ValidationResult.newValidationResult().setError("GENERAL-REST-ACTIVITY-1002","Timeout value should be a positive integer")}else{if("proxy"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setVisible(!1);else{var r=t.getField("proxy");r.value&&""!==r.value&&null==r.value.match(/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:\/?#[\]@!\$&'\(\)\*\+,;=.]+$/)&&a.setError("GENERAL-REST-ACTIVITY-1000","Invalid Proxy URL")}e.next(a),e.complete()})});if("Server Certificate"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setVisible(!1);else{var r=t.getField("Uri"),s=t.getField("Use certificate for verification");r.value&&r.value.length>0&&0===r.value.toLowerCase().indexOf("https")&&("true"===s.value||!0===s.value)?a.setVisible(!0):a.setVisible(!1)}e.next(a),e.complete()})});if("Client Certificate"===e||"Client Key"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setVisible(!1);else{var r=t.getField("mutualAuth"),s=t.getField("Use certificate for verification");!s||"true"!==s.value&&!0!==s.value||!r||"true"!==r.value&&!0!==r.value?a.setVisible(!1):a.setVisible(!0)}e.next(a),e.complete()})});if("Use certificate for verification"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setVisible(!1);else{var r=t.getField("Uri");r.value&&r.value.length>0&&0===r.value.toLowerCase().indexOf("https")?a.setVisible(!0):a.setVisible(!1)}e.next(a),e.complete()})});if("mutualAuth"===e||"disableSSLVerification"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setVisible(!1);else{var r=t.getField("Use certificate for verification");"true"===r.value||!0===r.value?a.setVisible(!0):a.setVisible(!1)}e.next(a),e.complete()})});if("body"===e)return l.isGet(t)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):l.isApplicationJsonTypeForRequestType(t)?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1).setVisible(!0):l.isURLEncodedForRequestType(t)?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1).setVisible(!0):l.isMultipleFormRequestType(t)?wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!1).setVisible(!1):wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0).setVisible(!0);if("responseBody"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setVisible(!1);else if(!0===t.getField("configureResponseCodes").value)a.setVisible(!1);else if(a.setVisible(!0),l.isApplicationJsonTypeForResponseType(t))a.setReadOnly(!1);else if(l.isApplicationXmlTypeForResponseType(t)){"XML String"===t.getField("responseOutput").value?a.setReadOnly(!0):a.setReadOnly(!1)}else a.setReadOnly(!0);e.next(a),e.complete()})});if("responseCodes"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();i?a.setVisible(!0):!0===t.getField("configureResponseCodes").value?a.setVisible(!0):a.setVisible(!1);e.next(a),e.complete()})});if("requestType"===e)return l.isGet(t)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1):((r=wi_contrib_1.ValidationResult.newValidationResult()).setVisible(!0),l.isApplicationXMLTypeForRequestType(t)&&r.setError("GENERAL-REST-ACTIVITY-1002","application/xml is not supported now"),r);if("Uri"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setVisible(!1);else{a.setVisible(!0);var r=t.getField("Uri");if(r.value)!1===new RegExp("^((https?)://|(www\\.))[a-zA-Z0-9]+(([\\-]{1,}|[\\.]{1})[a-zA-Z0-9]+)*.[a-zA-Z0-9]{1,5}?(:[0-9]{1,5})?(\\/[\\w]*([\\%\\-\\.\\#:]{1}[\\w\\*]+)*|\\/\\{[\\w-]+\\})*(\\?.*)?$","i").test(r.value)&&a.setError("GENERAL-REST-ACTIVITY-1000","Invalid HTTP URL")}e.next(a),e.complete()})});if("responseType"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();i?a.setVisible(!1):!1===t.getField("configureResponseCodes").value?a.setVisible(!0):a.setVisible(!1);e.next(a),e.complete()})});if("queryParams"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setReadOnly(!0);else{var r=t.getField("queryParams");if(a.setReadOnly(!1),r.value&&r.value.value){var s=[],n="",l={};try{l=JSON.parse(r.value.value)}catch(e){return null}for(var o=0,p=l;o<p.length;o++){var u=p[o];if(!u.parameterName){n="Parameter Name should not be empty",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}for(var c=0,g=s;c<g.length;c++){if(g[c]===u.parameterName){n="Parameter Name '"+u.parameterName+"' already exists",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}}s.push(u.parameterName)}}}e.next(a),e.complete()})});if("headers"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setReadOnly(!0);else{a.setReadOnly(!1);var r=t.getField("headers");if(r&&r.value&&r.value.value){a=wi_contrib_1.ValidationResult.newValidationResult();var s=[],n="",l={};try{l=JSON.parse(r.value.value);for(var o=0,p=l;o<p.length;o++){var u=p[o];if(!u.parameterName){n="Parameter Name should not be empty",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}for(var c=0,g=s;c<g.length;c++){if(g[c]===u.parameterName){n="Parameter Name '"+u.parameterName+"' already exists",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}}s.push(u.parameterName)}}catch(e){}}}e.next(a),e.complete()})});if("responseCodesSchema"===e)return rxjs_1.Observable.create(function(e){l.asrEnabled1(t).subscribe(function(i){var a=wi_contrib_1.ValidationResult.newValidationResult();if(i)a.setReadOnly(!0);else if(!1===t.getField("configureResponseCodes").value)a.setVisible(!1);else{a.setReadOnly(!1);var r=t.getField("responseCodesSchema");if(r&&r.value&&r.value.value){a=wi_contrib_1.ValidationResult.newValidationResult();var s=[],n="",l={};try{l=JSON.parse(r.value.value);for(var o=0,p=l;o<p.length;o++){var u=p[o];if(!u.code){n="Response Code should not be empty",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}if(null!=u.code.match(/[^0-9]/)){if(3!==u.code.length){n="Response Code should be of length 3 for e.g 501,200 or 5xx,4xx",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}if(null==u.code.match(/[1-9]xx/)){n="Response Code should be of valid type e.g. 5xx or 501",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}for(var c=0,g=s;c<g.length;c++){if(g[c]===u.code){n="Response Code '"+u.code+"' already exists",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}}s.push(u.code)}else{if(3!==u.code.length){n="Response Code should be of length 3 for e.g 501,200 or 5xx,4xx",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}if(!u.responseSchema&&"object"===u.responseType){n="Response body should not be empty",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}for(var m=0,d=s;m<d.length;m++){if(d[m]===u.code){n="Response Code '"+u.code+"' already exists",a.setError("GENERAL-REST-ACTIVITY-1001",n),a.setValid(!1);break}}s.push(u.code)}}}catch(e){}}}e.next(a),e.complete()})});if("pathParams"===e||"configureResponseCodes"===e)return rxjs_1.Observable.create(function(i){l.asrEnabled1(t).subscribe(function(t){var a=wi_contrib_1.ValidationResult.newValidationResult();t?a.setReadOnly(!0):"pathParams"===e?a.setReadOnly(!0):a.setReadOnly(!1),i.next(a),i.complete()})});if("multipartForm"===e){if(!l.isGetOrDelete(t)&&l.isMultipleFormRequestType(t)){var r;(r=wi_contrib_1.ValidationResult.newValidationResult()).setVisible(!0);var s=t.getField("multipartForm");if(s&&s.value&&s.value.value){var n=[],o="",p={};try{p=JSON.parse(s.value.value);for(var u=0,c=p;u<c.length;u++){var g=c[u];if(!g.name){o="Name should not be empty",r.setError("GENERAL-REST-ACTIVITY-1001",o),r.setValid(!1);break}if(!g.schema&&"object"===g.type){o="Schema should not be empty",r.setError("GENERAL-REST-ACTIVITY-1001",o),r.setValid(!1);break}for(var m=0,d=n;m<d.length;m++){if(d[m]===g.name){o="Name '"+g.name+"' already exists",r.setError("GENERAL-REST-ACTIVITY-1001",o),r.setValid(!1);break}}n.push(g.name)}return r}catch(e){return r}}return r}return wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}if("multipartFormData"===e)return!l.isGetOrDelete(t)&&l.isMultipleFormRequestType(t)?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}return null},l.messaging=new wi_contrib_1.WiContribMessaging,l.inject=t,l}return __extends(t,e),t.prototype.checkForAPISpecPathChange=function(e){try{this.previousPath!==e.getField("resourcePath").value?(this.isPathChanged=!0,this.previousPath=e.getField("resourcePath").value):this.isPathChanged=!1}catch(e){}},t.prototype.checkForAPISpecRequestTypeChange=function(e){try{this.previousRequestType!==e.getField("requestType").value?(this.isReqTypeChanged=!0,this.previousRequestType=e.getField("requestType").value):this.isReqTypeChanged=!1}catch(e){}},t.prototype.checkForAPISpecMethodChange=function(e){try{this.previousMethod!==e.getField("Method").value?(this.isMethodChanged=!0,this.previousMethod=e.getField("Method").value):this.isMethodChanged=!1}catch(e){}},t.prototype.createURLFromAPISpec=function(e,t){try{if(e.isOAS3())return e.getServerURLs();var i=e.host,a=e.basePath,r=e.schemes,s="";return""!==i&&(s+=i,""!==a&&("/"!==a[0]?s=s+"/"+a:s+=a),s=r.includes("https")?"https://"+s:"http://"+s),s}catch(e){return""}},t.prototype.getMethodsFromMetadaObject=function(e,t,i){var a=JSON.parse(e),r=(i?new flogo_flow_create_providers_1.Swagger(a.apiSpec):new flogo_flow_create_providers_1.Swagger(a)).getMethods(t),s=[];if(r&&r.length>0)for(var n=0,l=r;n<l.length;n++){var o=l[n];s.push(o.toUpperCase())}return s},t.prototype.getConsumesForRequestType=function(e,t,i,a){var r,s,n=JSON.parse(e),l=t;(r=a?new flogo_flow_create_providers_1.Swagger(n.apiSpec):new flogo_flow_create_providers_1.Swagger(n)).isOAS3()?s=r.getRequestTypes(t,i):(s=r.consumes,r.paths[l]&&r.paths[l][i]&&"string"!=typeof r.paths[l][i]&&r.paths[l][i].consumes&&r.paths[l][i].consumes.length>0&&(s=r.paths[l][i].consumes));var o=[];return s&&s.length>0?(o=s).length<=0&&o.push("application/json"):o.push("application/json"),o},t.prototype.securityParsing=function(e,t,i){var a,r=[];if(e.paths[t]&&e.paths[t][i]&&e.paths[t][i].security)for(var s=e.paths[t][i].security.length,n=0;n<s;n++)r=r.concat(Object.keys(e.paths[t][i].security[n]));return e.isOAS3()?e.components&&e.components.securitySchemes&&(a=Object.keys(e.components.securitySchemes)):e.securityDefinitions&&(a=Object.keys(e.securityDefinitions)),{security:r,sDef:a}},t.prototype.parseParams=function(e,t,i,a,r,s){var n,l,o={},p={},u=[],c=[],g=[],m=[],d=e,f=t.toLowerCase(),v=JSON.parse(i);if(l=r?new flogo_flow_create_providers_1.Swagger(v.apiSpec):new flogo_flow_create_providers_1.Swagger(v),r&&s){var b={parameterName:"serviceAppId",type:"string",required:!1};c.push(b)}var h=l.getParameters(d,f);if(h)for(var y=function(e){if("formData"===e.in){if(a&&a.value)if("application/x-www-form-urlencoded"===a.value)if(l.isOAS3()){var t={type:"object",properties:e.schema.properties};o=t}else if(e.required&&u.push(e.name),"array"===e.type){var i=e.items.type;p[e.name]={type:"array",items:{type:i}}}else p[e.name]={type:e.type};else if("multipart/form-data"===a.value){var r={};"file"===e.type||"array"===e.type?(r.name=e.name,r.type="filecontent",r.required=e.required):"object"===e.type?(r.name=e.name,r.type=e.type,r.required=e.required,r.schema=e.schema):(r.name=e.name,r.type="string",r.required=e.required),m.push(r)}}else if("body"===e.in)n=e.schema;else if("path"===e.in){(s={}).parameterName=e.name,s.type="string","integer"===e.type||"long"===e.type||"number"===e.type?s.type="number":"boolean"===e.type?s.type="boolean":s.type="string",s.required=e.required,c.push(s)}else if("query"===e.in){var s;(s={}).parameterName=e.name,"array"===e.type?(s.repeating="true","integer"===e.items.type||"long"===e.items.type||"number"===e.items.type?s.type="number":"boolean"===e.items.type?s.type="boolean":"object"===e.items.type?s.type="object":s.type="string"):(s.repeating="false","integer"===e.type||"long"===e.type||"number"===e.type?s.type="number":"boolean"===e.type?s.type="boolean":"object"===e.type?s.type="object":s.type="string"),e.required?s.required="true":s.required="false",g.push(s)}else if("multpartFormData"===e.in){if(e.schema.properties&&void 0!==e.schema.properties)Object.keys(e.schema.properties).forEach(function(t){var i=e.schema.properties[t].type,a=e.schema.properties[t].format,r={};r.name=t,"string"===i?r.type="base64"===a||"binary"===a?"filecontent":"string":"object"===i?(r.type="object",r.schema=e.schema.properties[t]):r.type="string",m.push(r)})}},_=0,x=h;_<x.length;_++){y(x[_])}for(var S=this.securityParsing(l,d,f),R=S.security,w=S.sDef,E=0;E<R.length;E++)if(w.includes(R[E])){var O=void 0;if("query"===(O=l.isOAS3()?l.components.securitySchemes[R[E]]:l.securityDefinitions[R[E]]).in)if("apiKey"===O.type)(b={}).parameterName=O.name,O.required?b.required="true":b.required="false",b.type="string",g.push(b)}return l.isOAS3()||(o.type="object",o.properties=p,o.required=u),{bodySchema:n,urlEncodedSchemaResponse:o,urlEncodedScheama:p,urlEncodedScheamaRequiresField:u,pathParam:c,queryParams:g,multipart:m}},t.prototype.parseHeaders=function(e,t,i,a){var r,s=[],n=[],l=t.toLowerCase(),o=JSON.parse(i),p=(r=a?new flogo_flow_create_providers_1.Swagger(o.apiSpec):new flogo_flow_create_providers_1.Swagger(o)).getParameters(e,l);if(p)for(var u=0,c=p;u<c.length;u++){var g=c[u];if("header"===g.in)(_={}).parameterName=g.name,"array"===g.type?(_.repeating="true","integer"===g.items.type||"long"===g.items.type||"number"===g.items.type?_.type="number":"boolean"===g.items.type?_.type="boolean":_.type="string"):(_.repeating="false","integer"===g.type||"long"===g.type||"number"===g.type?_.type="number":"boolean"===g.type?_.type="boolean":_.type="string"),g.required?_.required="true":_.required="false",s.push(_)}for(var m=this.securityParsing(r,e,l),d=m.security,f=m.sDef,v=0;v<d.length;v++)if(f.includes(d[v])){var b=void 0;if(b=r.isOAS3()?r.components.securitySchemes[d[v]]:r.securityDefinitions[d[v]],r.isOAS3())if("http"!==b.type||"basic"!==b.scheme&&"bearer"!==b.scheme){if("header"===b.in&&"apiKey"===b.type){(_={}).parameterName=b.name,b.required?_.required="true":_.required="false",_.type="string",s.push(_)}else if("cookie"===b.in&&"apiKey"===b.type){_={parameterName:"cookie"};b.required?_.required="true":_.required="false",_.type="string";for(var h=!1,y=0;y<s.length;y++)if("cookie"===s[y].parameterName){h=!0;break}h||s.push(_)}}else{var _={parameterName:"Authorization"};b.required?_.required="true":_.required="false",_.type="string",s.push(_)}else if("basic"===b.type){_={parameterName:"Authorization"};b.required?_.required="true":_.required="false",_.type="string",s.push(_)}else if("header"===b.in&&"apiKey"===b.type){(_={}).parameterName=b.name,b.required?_.required="true":_.required="false",_.type="string",s.push(_)}}var x=r.getResponse(e,l);if(x&&x!=={}){var S=Object.keys(x);for(v=0;v<S.length;v++)try{var R=parseInt(S[v]),w=x[R];if(w!=={}){var E=w.headers;if(E&&void 0!==E&&Object.keys(E).length>0)for(var O in E){(_={}).parameterName=O;var C=E[O];"array"===C.type?(_.repeating="true","integer"===C.items.type||"long"===C.items.type||"number"===C.items.type?_.type="number":"boolean"===C.items.type?_.type="boolean":_.type="string"):(_.repeating="false","integer"===C.type||"long"===C.type||"number"===C.type?_.type="number":"boolean"===C.type?_.type="boolean":_.type="string"),n.push(_)}}}catch(e){}}return{headers:s,responseHeadersSchema:n}},t.prototype.parseResponseCodeSchema=function(e,t,i,a){var r=[],s=i.toLowerCase(),n=JSON.parse(e),l=(a?new flogo_flow_create_providers_1.Swagger(n.apiSpec):new flogo_flow_create_providers_1.Swagger(n)).getResponse(t,s);if(l!=={})for(var o=Object.keys(l),p=0;p<o.length;p++)try{var u=parseInt(o[p]),c={},g=l[u];if(g!=={}){if(g.schema?"string"===g.schema.type?(c.code=u,c.responseType="string"):(c.code=u,c.responseType="object",c.responseSchema=JSON.stringify(g.schema)):(c.code=u,c.responseType="string"),g.headers){for(var m=Object.keys(g.headers),d={},f=0;f<m.length;f++)d[m[f]]="";c.responseHeaders=JSON.stringify(d)}}else c.code=u,c.responseType="string";r.push(c)}catch(e){}return r},t.prototype.isAsrDialogSelected=function(e){return!!e.getField("asrDialog")},t.prototype.isFromAsrDialog=function(e){return!!(e&&e.gsbc&&e.service)},t.prototype.isGetOrDelete=function(e){var t=e.getField("Method");return"GET"===t.value||"DELETE"===t.value},t.prototype.isDelete=function(e){return"DELETE"===e.getField("Method").value},t.prototype.isGet=function(e){return"GET"===e.getField("Method").value},t.prototype.isApplicationJsonTypeForRequestType=function(e){return"application/json"===e.getField("requestType").value},t.prototype.isApplicationXMLTypeForRequestType=function(e){var t=e.getField("requestType");return"application/xml"===t.value||"application/xml"===t.value.toLowerCase()},t.prototype.isMultipleFormRequestType=function(e){var t=e.getField("requestType");return"multipart/form-data"===t.value||"multipart/form-data"===t.value.toLowerCase()},t.prototype.isURLEncodedForRequestType=function(e){return"application/x-www-form-urlencoded"===e.getField("requestType").value},t.prototype.isApplicationJsonTypeForResponseType=function(e){return"application/json"===e.getField("responseType").value},t.prototype.isApplicationXmlTypeForResponseType=function(e){return"application/xml"===e.getField("responseType").value},t.prototype.isTCIASRService=function(e){var t=e.getField("Uri");return t.value.includes("gsbc")&&t.value.includes("tci")},t.prototype.isJson=function(e){try{e=JSON.parse(e)}catch(t){e={}}var t=!0;return e&&e.type&&"string"==typeof e.type&&(e.properties||e.items)&&(t=!1),e&&e.allOf&&e.allOf.length&&(t=!1),e&&e.oneOf&&e.oneOf.length&&(t=!1),e&&e.anyOf&&e.anyOf.length&&(t=!1),t},t.prototype.asrEnabled1=function(e){var t=this;return rxjs_1.Observable.create(function(i){t.isFE().subscribe(function(t){var a=!1;if(!t){var r=e.getField("enableASR");r&&r.value&&!0===r.value&&(a=!0)}i.next(a),i.complete()})})},t.prototype.isFE=function(){var e=this;return rxjs_1.Observable.create(function(t){e.configurationService.getAppConfig().subscribe(function(e){e.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?t.next(!0):t.next(!1),t.complete()})})},t}(wi_contrib_1.WiServiceHandlerContribution);RestInvokeCustomerActivityContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http,wi_contrib_1.WiContribModelService,"function"==typeof(_a=void 0!==flogo_contrib_sdk_1.ParsingService&&flogo_contrib_sdk_1.ParsingService)&&_a||Object,"function"==typeof(_b=void 0!==flogo_contrib_sdk_1.ConfigurationService&&flogo_contrib_sdk_1.ConfigurationService)&&_b||Object,"function"==typeof(_c=void 0!==flogo_contrib_sdk_1.AppSpecsService&&flogo_contrib_sdk_1.AppSpecsService)&&_c||Object])],RestInvokeCustomerActivityContribution),exports.RestInvokeCustomerActivityContribution=RestInvokeCustomerActivityContribution;
//# sourceMappingURL=activity.js.map
