"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function s(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(s.prototype=r.prototype,new s)}}(),__decorate=this&&this.__decorate||function(e,t,r,s){var o,a=arguments.length,n=a<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,s);else for(var i=e.length-1;i>=0;i--)(o=e[i])&&(n=(a<3?o(n):a>3?o(t,r,n):o(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(r,s){t(r,s,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),http_1=require("@angular/http"),core_1=require("@angular/core"),protobufjs=require("protobufjs"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),protobuf2jsonActivityContribution=function(e){function t(t,r){var s=e.call(this,t,r)||this;return s.http=r,s.value=function(e,t){switch(e){case"protoFile":var r=t.getField("protoFile").value;r&&""===r.content&&(s.messageTypeNames=[],s.mapKeyMessage=new Map,s.outputSchema={},s.result=null);break;case"messageTypeName":return Observable_1.Observable.create(function(e){var r=t.getField("protoFile").value;if(r&&""!==r.content){var o=r.content;s.mapKeyMessage=new Map,s.outputSchema={},s.result=s.parseProtoFile(o)}s.result&&s.result.messageTypeNames&&s.result.messageTypeNames.length>0?e.next(s.result.messageTypeNames):e.next([]),e.complete()});case"jsonMessage":return Observable_1.Observable.create(function(e){var r=t.getField("messageTypeName").value;if(r){var o=s.mapKeyMessage.get(r);o&&(s.outputSchema=s.getOutputSchema(o),e.next(JSON.stringify(s.outputSchema.schema)))}else e.next(JSON.stringify({}));e.complete()})}return null},s.validate=function(e,t){switch(e){case"protoFile":return Observable_1.Observable.create(function(e){t.getField("protoFile").value&&s.result&&!s.result.success&&e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("protoFileError: ",s.result.error)),e.complete()});case"messageTypeName":return Observable_1.Observable.create(function(e){t.getField("messageTypeName").value&&s.outputSchema&&!s.outputSchema.success&&e.next(wi_contrib_1.ValidationResult.newValidationResult().setError("Error: ",s.outputSchema.error)),e.complete()})}return null},s.messageTypeNames=[],s.mapKeyMessage=new Map,s.outputSchema={},s}return __extends(t,e),t.prototype.parseProtoFile=function(e){var t={};this.messageTypeNames=[];var r=e.split(",")[1],s=atob(r);try{var o=protobufjs.parse(s,{keepCase:!0});if(o&&"proto3"===o.syntax){var a=o.root.nested;if(a)for(var n=0,i=Object.keys(a);n<i.length;n++){var c=i[n],u=a[c];this.messageTypeNames.concat(this.parseNested(c,u))}0===this.messageTypeNames.length?(t.success=!1,t.error="Error: Could not find any message types in proto file"):(t.success=!0,t.messageTypeNames=this.messageTypeNames)}else t.success=!1,t.error="Error: Only proto3 syntax is supported"}catch(e){t.success=!1,t.error=e+""}return t},t.prototype.parseNested=function(e,t){if(t.nested)for(var r=t.nested,s=0,o=Object.keys(r);s<o.length;s++){var a=r[o[s]],n=e+"."+a.name;a.nested&&this.parseNested(n,a),a.hasOwnProperty("fields")&&(this.mapKeyMessage.set(n,a),this.messageTypeNames.push(n))}else console.log("protobuf2json: No nested elements found in parent:",t);return this.messageTypeNames},t.prototype.getOutputSchema=function(e){var t={},r=e.fieldsArray;t.success=!0,t.schema={};for(var s=0;s<r.length;s++)try{if(r[s].resolved||(r[s]=r[s].resolve()),r[s].long||r[s].bytes)t.schema[r[s].name]="";else if(r[s].resolvedType){var o=r[s].resolvedType;if(o.fields){var a=this.getOutputSchema(o);t.schema[r[s].name]=a.success?a.schema:{}}else t.schema[r[s].name]=""}else t.schema[r[s].name]=r[s].defaultValue}catch(e){t.success=!1,t.error='Unable to read schema for field "'+r[s].name+'" Error: '+e.message,t.schema={},console.error("protobuf2json: unable to read schema for field: ",r[s].name," error: ",e)}return t},t}(wi_contrib_1.WiServiceHandlerContribution);protobuf2jsonActivityContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],protobuf2jsonActivityContribution),exports.protobuf2jsonActivityContribution=protobuf2jsonActivityContribution;
//# sourceMappingURL=activity.js.map
