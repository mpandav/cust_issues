"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var r,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(o<3?r(a):o>3?r(t,n,a):r(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DocuSignConnectorContribution=void 0;var core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),Observable_1=require("rxjs/Observable"),http_1=require("@angular/http"),validation_1=require("wi-studio/common/models/validation"),lodash=require("lodash"),DocuSignConnectorContribution=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.value=function(e,t){if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e)try{var n=i.getSetting(t,"WI_STUDIO_OAUTH_CONNECTOR_INFO");if(n){var r=JSON.parse(n.value);if(r.code&&!i.checkJWT(t))return Observable_1.Observable.create(function(e){i.getOauthConfig(t).subscribe(function(n){var o=r.code;i.getAccessToken(o,t).subscribe(function(t){var i={client_id:n.clientId,client_secret:n.clientSecret,env:n.env};i=lodash.assign(i,t);var r=btoa(JSON.stringify(i));e.next(r)},function(e){return Observable_1.Observable.throw(e)})})})}}catch(e){return null}return null},i.validate=function(e,t){if("Login"===e){for(var n=void 0,r=void 0,o=void 0,a=0,s=t.settings;a<s.length;a++){var c=s[a];"name"===c.name?n=c:"integratorKey"===c.name?r=c:"secretKey"===c.name&&(o=c)}return n&&n.value&&r&&r.value&&o&&o.value?validation_1.ValidationResult.newValidationResult().setReadOnly(!1):validation_1.ValidationResult.newValidationResult().setReadOnly(!0)}var u=i.checkJWT(t);return"userId"===e||"privateKey"===e?u?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"WI_STUDIO_OAUTH_CONNECTOR_INFO"===e?u?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0).setReadOnly(!0):null},i.action=function(e,t){if("Login"===e)return Observable_1.Observable.create(function(e){for(var n="",r="",o="",a=!1,s=0,c=t.settings;s<c.length;s++){var u=c[s];"name"===u.name?n=u.value:"integratorKey"===u.name?r=u.value:"environment"===u.name?o=!1===u.value?"account-d":"account":"authenticationType"===u.name&&(a=i.checkJWT(t))}var l=!1;wi_contrib_1.WiContributionUtils.getConnections(i.http,"Docusign").subscribe(function(s){for(var c=0,u=s;c<u.length;c++){for(var _=u[c],d="",v=!1,b=0,f=_.settings;b<f.length;b++){var g=f[b];if("name"===g.name&&(d=g.value),"authenticationType"===g.name)v="JWT Grant"===g.value}if(d===n&&v===a&&wi_contrib_1.WiContributionUtils.getUniqueId(_)!==wi_contrib_1.WiContributionUtils.getUniqueId(t)){l=!0;break}}if(l)e.next(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("DOCUSIGN-CONNECTOR-001","Connection name already exists"))),e.complete();else{var p="",h=i.getSetting(t,"WI_STUDIO_OAUTH_CONNECTOR_INFO");if(h&&h.value&&(p=h.value),i.checkTokens(t).isValid()){for(var O=JSON.parse(p),y=0;y<=t.settings.length;y++)if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.settings[y].name){t.settings[y].value=JSON.stringify(O);break}var T={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};e.next(contrib_1.ActionResult.newActionResult().setResult(T))}else i.getOauthConfig(t).subscribe(function(n){var s="";if(s=a?i.getAuthLoginUrlWithJWT(o,r,n.redirectUri):i.getAuthLoginUrl(o,r,n.redirectUri)){var c={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.OAUTH2,authData:{authLoginUrl:s,authStateQueryParam:"state"}};e.next(contrib_1.ActionResult.newActionResult().setResult(c))}})}})}).catch(function(e){return void 0===e.message?Observable_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("DUSN-1001","test connection failed: "+e.json().error.message))):Observable_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("DUSN-1002","test connection failed: "+e.message)))})},i}return __extends(t,e),t.prototype.getAuthLoginUrlWithJWT=function(e,t,n){return"https://"+e+".docusign.com/oauth/auth?client_id="+t+"&response_type=code&scope=api%20impersonation&redirect_uri="+n},t.prototype.checkJWT=function(e){return"JWT Grant"===this.getSetting(e,"authenticationType").value},t.prototype.getAccessToken=function(e,t){for(var n=this,i="",r="",o="account-d",a=0,s=t.settings;a<s.length;a++){var c=s[a];"integratorKey"===c.name?i=c.value:"secretKey"===c.name?r=c.value:"environment"===c.name&&(o=!1===c.value?"account-d":"account")}return Observable_1.Observable.create(function(a){n.getOauthConfig(t).subscribe(function(t){var s=new URLSearchParams;s.set("grant_type","authorization_code"),s.set("code",e),s.set("redirect_uri",t.redirectUri);var c=btoa(i+":"+r);wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,n.getTokenUrl(o)).addBody(s.toString()).addMethod(contrib_1.HTTP_METHOD.POST).addHeader("Authorization","Basic "+c).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){if(200===e.status){var t=e.json();a.next(t)}else a.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){a.error({code:e.status,message:"Failed to get access token",details:e.json()})})})})},t.prototype.getAuthLoginUrl=function(e,t,n){return"https://"+e+".docusign.com/oauth/auth?client_id="+t+"&response_type=code&scope=extended%20signature&redirect_uri="+n},t.prototype.getTokenUrl=function(e){return"https://"+e+".docusign.com/oauth/token"},t.prototype.getOauthConfig=function(e){return Observable_1.Observable.zip(this.getClientId(e),this.getClientSecret(e),this.getEnv(e),wi_contrib_1.WiContributionUtils.getEnvironment(this.http,"OAUTH_REDIRECT_URL"),function(e,t,n,i){return{clientId:e.value,clientSecret:t.value,env:n.value,redirectUri:i.value}})},t.prototype.getClientId=function(e){var t=this;return Observable_1.Observable.create(function(n){var i=t.getSetting(e,"integratorKey");n.next({value:i.value})})},t.prototype.getClientSecret=function(e){var t=this;return Observable_1.Observable.create(function(n){var i=t.getSetting(e,"secretKey");n.next({value:i.value})})},t.prototype.getEnv=function(e){var t=this;return Observable_1.Observable.create(function(n){var i="account-d";t.getSetting(e,"environment").value&&(i="account"),n.next({value:i})})},t.prototype.getSetting=function(e,t){for(var n=0,i=e.settings;n<i.length;n++){var r=i[n];if(r.name===t)return r}return null},t.prototype.checkTokens=function(e){var t=validation_1.ValidationResult.newValidationResult().setVisible(!1),n=this.getSetting(e,"WI_STUDIO_OAUTH_CONNECTOR_INFO"),i=this.checkJWT(e);if(!n||!n.value)return t.setValid(!1),t;if(i)try{return(r=JSON.parse(n.value)).code||t.setValid(!1),t}catch(e){return t.setValid(!1),t}else try{var r;return(r=JSON.parse(n.value)).access_token||r.refresh_token||t.setValid(!1),t}catch(e){return t.setValid(!1),t}},t=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.DocuSignConnectorContribution=DocuSignConnectorContribution;
//# sourceMappingURL=connector.js.map
