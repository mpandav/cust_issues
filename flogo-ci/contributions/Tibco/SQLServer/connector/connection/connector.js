"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(r<3?o(a):r>3?o(t,n,a):o(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions"),validation_1=require("wi-studio/common/models/validation"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),Result=function(){return function(e,t,n){}}(),Connection=function(){return function(){}}();exports.Connection=Connection;var TibcoSqlServerLConnectorContribution=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.value=function(e,t){return null},i.connection=function(e){var t=new Connection;return rxjs_extensions_1.Observable.from(e).reduce(function(e,n){return t[n.name]=n.value,e},t)},i.validate=function(e,t){var n=function(e){return!!e};new Connection;if("Connect"===e){var o=new Connection;return rxjs_extensions_1.Observable.from(t.settings).reduce(function(e,t){return o[t.name]=t.value,e},o).switchMap(function(e){return n(e.host)&&n(e.port)&&n(e.databaseName)&&n(e.user)&&n(e.password)?rxjs_extensions_1.Observable.of(validation_1.ValidationResult.newValidationResult().setReadOnly(!1)):rxjs_extensions_1.Observable.of(validation_1.ValidationResult.newValidationResult().setReadOnly(!0))})}if("onprem"===e)return rxjs_extensions_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getAppConfig(i.http).subscribe(function(t){t.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1)):e.next(validation_1.ValidationResult.newValidationResult().setVisible(!0))},function(t){e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(){return e.complete()})});if("cacert"===e||"validatecert"===e){var r=t.getField("tlsparam");return r&&r.value?void 0===r.value||null===r.value||!1===r.value?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("maxconnectattempts"===e){var a=t.getField("maxconnectattempts");if(a&&a.value&&a.value<0)return validation_1.ValidationResult.newValidationResult().setError("MSSQL-1003","Maximum Connection Retry Attempt must be a non-negative number")}else if("connectionretrydelay"===e){var s=t.getField("connectionretrydelay");if(s&&s.value&&s.value<0)return validation_1.ValidationResult.newValidationResult().setError("MSSQL-1004","Connection Retry Delay must be a non-negative number")}else if("connectiontimeout"===e){if(t.getField("connectiontimeout").value.value<0)return validation_1.ValidationResult.newValidationResult().setError("MSSQL-1005","Connection Timeout must be a non-negative number")}return null},i.isDuplicate=function(e,t){return wi_contrib_1.WiContributionUtils.getConnections(i.http,i.category).mergeMap(function(e){return e}).map(function(e){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(e),ction:i.connection(e.settings)}}).filter(function(e){return e.id!==t}).mergeMap(function(e){return e.ction}).filter(function(t){return t.name===e.name}).reduce(function(e,t){return e.push(t),e},[]).map(function(e){return e.length>0})},i.action=function(e,t){if("Connect"===e){var n="";return i.connection(t.settings).switchMap(function(e){return i.isDuplicate(e,wi_contrib_1.WiContributionUtils.getUniqueId(t)).map(function(t){if(t)throw new Error("Connection with name "+e.name+" already exists");return e})}).switchMap(function(e){if(null!=e.tlsparam&&!0===e.tlsparam){var o={},r=e.cacert.content,a=e.cacert.filename.split(".").pop();null!=r&&""!==r&&(o.ServerCertificate={type:"file",extension:a,value:r}),!1===e.validatecert?o.TrustServerCertificate={type:"string",value:"YES"}:!0===e.validatecert&&(o.HostnameInCertificate={type:"string",value:e.host},o.TrustServerCertificate={type:"string",value:"NO"}),n=btoa(JSON.stringify(o))}var s,c,l,u,d,_,f,b;return s=btoa("mssql"),c=btoa(e.host),l=btoa(e.port.toString()),u=btoa(e.databaseName),d=btoa(e.user),_=btoa(e.password),b=e.tlsparam?btoa(e.tlsparam):btoa("false"),f=btoa(e.name),wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(i.http,i.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===e.onprem?"false":e.onprem.toString()).addHeader("DatabaseType","mssql").addBody("Driver="+s+"&Server="+c+"&Port="+l+"&Database="+u+"&Uid="+d+"&Pwd="+_+"&SSLMode="+b+"&ConnectionID="+f+"&SSLData="+n).send().switchMap(function(e){var n=e.json();if(!0===n.error)return console.log("Authentication Failure, Error message %s",n.errorMsg),rxjs_extensions_1.Observable.throw(n.errorMsg);var i={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(i))})}).catch(function(e){if(void 0!==e.message)return console.log("test connection failed: "+e.message),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("MSSQL-1002","test connection failed: "+e.message)));try{return console.log("test connection failed: "+e.json().error.message),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("MSSQL-1001","test connection failed: "+e.json().error.message)))}catch(t){return console.log("test connection failed: "+e),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("MSSQL-1002","test connection failed: "+e)))}})}},i.dbserviceURL="/dbservicego/api/v2/dbtest",i.category="SQLServer",i}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);TibcoSqlServerLConnectorContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],TibcoSqlServerLConnectorContribution),exports.TibcoSqlServerLConnectorContribution=TibcoSqlServerLConnectorContribution;
//# sourceMappingURL=connector.js.map
