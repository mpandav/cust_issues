"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__decorate=this&&this.__decorate||function(e,t,n,o){var r,i=arguments.length,a=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(i<3?r(a):i>3?r(t,n,a):r(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),validation_1=require("wi-studio/common/models/validation"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),CryptoJS=require("crypto-js"),AWS=require("aws-sdk"),LambdaFunctionTriggerService=function(e){function t(t,n,o){var r=e.call(this,t,n,o)||this;return r.injector=t,r.http=n,r.contribModelService=o,r.value=function(e,t){if("ConnectionName"===e)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(r.http,"AWS").subscribe(function(n){console.log("connection ref response: ",n),n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})});if("ExecutionRole_NOTCALLED"===e){var n=t.getField("ConnectionName").value;return n?Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnection(r.http,n).map(function(e){return e}).subscribe(function(e){for(var t="",n="",o="",i=0;i<e.settings.length;i++)"accessKey"===e.settings[i].name&&(t=e.settings[i].value),"secretKey"===e.settings[i].name&&(n=e.settings[i].value),"region"===e.settings[i].name&&(o=e.settings[i].value);var a=new Date,s=r.getCurrentTime(a),l=r.getCurrentYMD(a),c="GET\n/\nAction=ListRoles&Version=2010-05-08\nhost:iam.amazonaws.com\nx-amz-date:"+s+"\n\nhost;x-amz-date\ne3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";console.log("\n==== canonicalRequest:\n"+c);var u=CryptoJS.SHA256(c);console.log("\n==== hased req:\n"+u);var g="AWS4-HMAC-SHA256\n"+s+"\n"+l+"/"+o+"/iam/aws4_request\n"+u;console.log("\n==== string to sign:\n"+g);var d=r.getSignatureKey(n,l,o,"iam"),f=CryptoJS.enc.Hex.stringify(CryptoJS.HmacSHA256(g,d));console.log("\n==== signature:\n"+f);var m="AWS4-HMAC-SHA256 Credential="+t+"/"+l+"/"+o+"/iam/aws4_request, SignedHeaders=host;x-amz-date, Signature="+f;wi_contrib_1.WiProxyCORSUtils.createRequest(r.http,"https://iam.amazonaws.com/?Action=ListRoles&Version=2010-05-08").addMethod("GET").addHeader("Host","iam.amazonaws.com").addHeader("X-Amz-Date",s).addHeader("Authorization",m).send().subscribe(function(e){console.log("ppppp result roles: "+e.json())},function(e){console.log(e)})})}):null}return null},r.validate=function(e,t){if("ConnectionName"===e)return Observable_1.Observable.create(function(e){console.log("Validating AWS Connection...");var n=t.getField("ConnectionName").value,o=validation_1.ValidationResult.newValidationResult();wi_contrib_1.WiContributionUtils.getConnection(r.http,n).map(function(e){return e}).subscribe(function(t){for(var n="",r="",i="",a=!1,s="",l="",c="",u="",g=3600,d=0;d<t.settings.length;d++)switch(t.settings[d].name){case"accessKey":n=t.settings[d].value;break;case"secretKey":r=t.settings[d].value;break;case"region":i=t.settings[d].value;break;case"assumeRole":a=t.settings[d].value;break;case"roleArn":s=t.settings[d].value;break;case"roleSessionName":l=t.settings[d].value;break;case"externalId":c=t.settings[d].value;break;case"expirationDuration":g=t.settings[d].value;break;case"sessionToken":u=t.settings[d].value}var f={accessKeyId:n,secretAccessKey:r,region:i,sessionToken:u};if(1==a){console.log("Assume Role is set to True");var m,v=new AWS.STS(f);c.length>0?(console.log("External ID is set"),m={RoleArn:s,RoleSessionName:l,ExternalId:c,DurationSeconds:g}):(console.log("External ID is NOT set"),m={RoleArn:s,RoleSessionName:l,DurationSeconds:g}),console.log("Assuming role with params: ",m),v.assumeRole(m,function(t,n){if(t)console.log("Unable to assume the role: ",t),o.setError("Assume Role Error","AWS Assume Role failed:"+t.message),e.next(o),e.complete();else{console.log("Assume role successful"),f.accessKeyId=n.Credentials.AccessKeyId,f.secretAccessKey=n.Credentials.SecretAccessKey,f.sessionToken=n.Credentials.SessionToken;new AWS.Lambda(f).listFunctions({MaxItems:10},function(t,n){t&&(console.log("error occured..........."),o.setError("Test Connection Error","AWS test connection failed, please check your AWS connection to make sure you have access")),console.log("call observer next"),e.next(o),e.complete()})}})}else{new AWS.Lambda(f).listFunctions({MaxItems:10},function(t,n){t&&(console.log("Unable to list lambda functions in your account: ",t),o.setError("Test Connection Error","AWS test connection failed, please check your AWS connection to make sure you have access")),e.next(o),e.complete()})}},function(t){o.setError("Test Connection Error","Fetching connection failed"),e.next(o),e.complete()})});if("EventPayload"===e){if(console.log("Validating EventPayload..."),t.getMode()!==contrib_1.MODE.WIZARD)return validation_1.ValidationResult.newValidationResult().setVisible(!0);var n=void 0;if((o=t.getField("EventPayload")).value)try{n=JSON.parse(o.value),n=JSON.stringify(n)}catch(e){return validation_1.ValidationResult.newValidationResult().setError("SCHEMA_ERROR","Unexpected string in JSON")}}if("ReplyData"===e){if(t.getMode()!==contrib_1.MODE.WIZARD)return validation_1.ValidationResult.newValidationResult().setVisible(!0);var o;n=void 0;if((o=t.getField("ReplyData")).value)try{n=JSON.parse(o.value),n=JSON.stringify(n)}catch(e){return validation_1.ValidationResult.newValidationResult().setError("SCHEMA_ERROR","Unexpected string in JSON")}}if("ExecutionRoleName"===e){var i=t.getField("ExecutionRoleName").value;if(""===i.trim())return null;if(0===i.toLowerCase().indexOf("arn:"))return null;if(!/^[A-Za-z0-9_+=,.@-]+$/.test(i))return validation_1.ValidationResult.newValidationResult().setError("ROLE_NAME_ERROR","Name can contain alphanumeric characters, or any of the following: _+=,.@-");if(i.length>64)return validation_1.ValidationResult.newValidationResult().setError("ROLE_NAME_ERROR","The maximum lenth is 64 characters")}return null},r.action=function(e,t){var n=r.getModelService(),o=wi_contrib_1.CreateFlowActionResult.newActionResult();if(t.settings&&t.settings.length>0){var i=n.createTriggerElement("Lambda/flogo-lambda-function");if(i.settings.length>0)for(var a=t.getField("ConnectionName"),s=0;s<i.settings.length;s++)"ConnectionName"===i.settings[s].name&&(i.settings[s].value=a.value,i.settings[s].allowed=a.allowed);if(i&&i.outputs&&i.outputs.length>0){var l=t.getField("EventPayload");for(s=0;s<i.outputs.length;s++)"EventPayload"===i.outputs[s].name&&(i.outputs[s].value=l.value)}var c=n.createFlow(t.getFlowName(),t.getFlowDescription());o=o.addTriggerFlowMapping(lodash.cloneDeep(i),lodash.cloneDeep(c))}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(o)},r}return __extends(t,e),t.prototype.formSettings=function(e){for(var t=e.getTriggerFlowModelMaps(),n=0;n<t.length;n++){var o=t[n].getTriggerElement();"flogo-lambda-function"===o.name&&o.display&&o.display.category}return[]},t.prototype.getSignatureKey=function(e,t,n,o){var r=CryptoJS.HmacSHA256(t,"AWS4"+e),i=CryptoJS.HmacSHA256(n,r),a=CryptoJS.HmacSHA256(o,i);return CryptoJS.HmacSHA256("aws4_request",a)},t.prototype.getCurrentTime=function(e){var t=e.getUTCMonth()+1,n=e.getUTCDate(),o=e.getUTCHours(),r=e.getUTCMinutes(),i=e.getUTCSeconds(),a=t.toString(),s=n.toString(),l=o.toString(),c=r.toString(),u=i.toString();t<10&&(a="0"+t.toString()),n<10&&(s="0"+n.toString()),o<10&&(l="0"+o.toString()),r<10&&(c="0"+r.toString()),i<10&&(u="0"+i.toString());var g=e.getUTCFullYear().toString()+a+s+"T"+l+c+u+"Z";return console.log("==== current time format: "+g),g},t.prototype.getCurrentYMD=function(e){var t=e.getUTCMonth()+1,n=e.getUTCDate(),o=t.toString(),r=n.toString();t<10&&(o="0"+t.toString()),n<10&&(r="0"+n.toString());var i=e.getUTCFullYear().toString()+o+r;return console.log("==== current YMD: "+i),i},t}(wi_contrib_1.WiServiceHandlerContribution);LambdaFunctionTriggerService=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],LambdaFunctionTriggerService),exports.LambdaFunctionTriggerService=LambdaFunctionTriggerService;
//# sourceMappingURL=trigger.js.map
