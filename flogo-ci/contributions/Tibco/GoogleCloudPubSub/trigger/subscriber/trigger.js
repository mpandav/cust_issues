"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__decorate=this&&this.__decorate||function(e,t,i,n){var r,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(o=(a<3?r(o):a>3?r(t,i,o):r(t,i))||o);return a>3&&o&&Object.defineProperty(t,i,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),http_1=require("@angular/http"),core_1=require("@angular/core"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),PubSubMsgSubscriberTriggerContribution=function(e){function t(t,i,n){var r=e.call(this,t,i,n)||this;return r.injector=t,r.http=i,r.contribModelService=n,r.value=function(e,t){if("googleConnection"===e)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(r.http,"GoogleCloudPubSub").subscribe(function(i){i.forEach(function(e){for(var i=0;i<e.settings.length;i++)if("name"===e.settings[i].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[i].value});break}}),e.next(t)})});if("metadata"===e){var i={messageAttributes:{}},n=t.getField("messageAttributes");if(n&&n.value){for(var a={},o=JSON.parse(n.value),s=0;s<o.length;s++)a[o[s].parameterName]="";i.messageAttributes=a}return i.messageId="",i.deliveryAttempt=0,JSON.stringify(i)}if("message"===e){var u=t.getField("messageDataFormat");return u&&u.value&&"JSON"===u.value?(i=t.getField("jsonSchema"))&&i.value?i.value:{}:""}return null},r.validate=function(e,t){if("googleConnection"===e){if(null===t.getField("googleConnection").value)return wi_contrib_1.ValidationResult.newValidationResult().setError("GPUBSUB-RECV-MSG-1000","Google Connection must be configured")}else if("subscriptionId"===e){if(null===t.getField("subscriptionId").value)return wi_contrib_1.ValidationResult.newValidationResult().setError("GPUBSUB-RECV-MSG-1001","Subscription must be configured")}else if("jsonSchema"===e){var i=t.getField("messageDataFormat");return i&&"JSON"===i.value?wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0):wi_contrib_1.ValidationResult.newValidationResult().setVisible(!1)}return null},r.action=function(e,t){var i=r.getModelService(),n=wi_contrib_1.CreateFlowActionResult.newActionResult();if(t.handler&&t.handler.settings&&t.handler.settings.length>0){var a=t.getField("googleConnection"),o=t.getField("subscriptionId"),s=t.getField("flowControlMode"),u=t.getField("maxOutstandingMessages"),l=t.getField("messageAttributes"),g=t.getField("messageDataFormat"),c=t.getField("jsonSchema");if(a&&a.value){var d=i.createTriggerElement("GoogleCloudPubSub/gcp-pubsub-message-subscriber");if(d&&d.settings&&d.settings.length>0)for(var b=0;b<d.settings.length;b++)"googleConnection"===d.settings[b].name&&(d.settings[b].value=a.value);if(d&&d.handler&&d.handler.settings&&d.handler.settings.length>0)for(b=0;b<d.handler.settings.length;b++)"subscriptionId"===d.handler.settings[b].name&&o&&o.value?d.handler.settings[b].value=o.value:"flowControlMode"===d.handler.settings[b].name&&s&&s.value?d.handler.settings[b].value=s.value:"messageDataFormat"===d.handler.settings[b].name&&g&&g.value?d.handler.settings[b].value=g.value:"maxOutstandingMessages"===d.handler.settings[b].name&&u&&u.value&&(d.handler.settings[b].value=u.value);if(d&&d.outputs&&d.outputs.length>0){for(b=0;b<d.outputs.length;b++){if("messageAttributes"===d.outputs[b].name&&l&&l.value){d.outputs[b].value=l.value;break}"jsonSchema"===d.outputs[b].name&&c&&c.value&&(d.outputs[b].value=c.value)}r.doTriggerMapping(d)}var p=i.createFlow(t.getFlowName(),t.getFlowDescription());n=n.addTriggerFlowMapping(lodash.cloneDeep(d),lodash.cloneDeep(p))}}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(n)},r}return __extends(t,e),t.prototype.doTriggerMapping=function(e){var t=this.contribModelService.createMapping();t.addMapping("$INPUT['message']",this.contribModelService.createMapExpression().setExpression("$trigger.message")),t.addMapping("$INPUT['metadata']",this.contribModelService.createMapExpression().setExpression("$trigger.metadata")),e.inputMappings=t},t}(wi_contrib_1.WiServiceHandlerContribution);PubSubMsgSubscriberTriggerContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],PubSubMsgSubscriberTriggerContribution),exports.PubSubMsgSubscriberTriggerContribution=PubSubMsgSubscriberTriggerContribution;
//# sourceMappingURL=trigger.js.map
