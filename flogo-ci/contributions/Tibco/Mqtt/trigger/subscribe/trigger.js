"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var l,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(l=e[o])&&(a=(r<3?l(a):r>3?l(t,n,a):l(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var http_1=require("@angular/http"),core_1=require("@angular/core"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),MqttContribModule=function(e){function t(t,n,i){var l=e.call(this,t,n,i)||this;return l.injector=t,l.http=n,l.contribModelService=i,l.value=function(e,t){switch(e){case"mqttConnection":return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(l.http,l.category).subscribe(function(n){n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})})}return null},l.validate=function(e,t){var n=t.getField("valueType").value.toString(),i=t.getField("showwill").value;switch(e){case"stringValue":return wi_contrib_1.ValidationResult.newValidationResult().setVisible("String"===n||"Base64"===n);case"jsonValue":return wi_contrib_1.ValidationResult.newValidationResult().setVisible("JSON"===n);case"will":case"willtopic":case"willqos":case"willretain":return wi_contrib_1.ValidationResult.newValidationResult().setVisible(i);default:return null}},l.action=function(e,t){var n=l.getModelService(),i=wi_contrib_1.CreateFlowActionResult.newActionResult();if(t.handler&&t.handler.settings&&t.handler.settings.length>0){var r=t.getField("mqttConnection");if(r&&r.value){var a=n.createTriggerElement("Mqtt/mqtt-trigger");if(a&&a.handler&&a.handler.settings&&a.handler.settings.length>0)for(var o=0;o<a.settings.length;o++)if("mqttConnection"===a.settings[o].name){a.settings[o].value=r.value;break}for(o=0;o<a.handler.settings.length;o++){"topic"===a.handler.settings[o].name?a.handler.settings[o].value=t.getField("topic").value:"valueType"===a.handler.settings[o].name?a.handler.settings[o].value=t.getField("valueType").value:"showwill"===a.handler.settings[o].name?a.handler.settings[o].value=t.getField("showwill").value:"will"===a.handler.settings[o].name?a.handler.settings[o].value=t.getField("will").value:"willtopic"===a.handler.settings[o].name?a.handler.settings[o].value=t.getField("willtopic").value:"willqos"===a.handler.settings[o].name?a.handler.settings[o].value=t.getField("willqos").value:"willretain"===a.handler.settings[o].name&&(a.handler.settings[o].value=t.getField("willretain").value);for(var s=0;s<a.outputs.length;s++)"jsonValue"===a.outputs[s].name&&(a.outputs[s].value=t.getField("jsonValue").value)}var u=n.createFlow(t.getFlowName(),t.getFlowDescription());i=i.addTriggerFlowMapping(lodash.cloneDeep(a),lodash.cloneDeep(u))}}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(i)},l.category="Mqtt",l}return __extends(t,e),t.prototype.getContextVar=function(e,t){return e.getField(t)?void 0===e.getField(t).value?"":e.getField(t).value:""},t}(wi_contrib_1.WiServiceHandlerContribution);MqttContribModule=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],MqttContribModule),exports.MqttContribModule=MqttContribModule;
//# sourceMappingURL=trigger.js.map
