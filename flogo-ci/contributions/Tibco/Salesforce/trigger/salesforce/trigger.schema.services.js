"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SFSchemaServices=void 0;var http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),Observable_1=require("rxjs/Observable"),trigger_jsonschema_1=require("./trigger.jsonschema"),lodash=require("lodash"),jose=require("jose"),BOOLEAN="xsd:boolean",STRING="xsd:string",DOUBLE="xsd:double",INT="xsd:int",DATE="xsd:date",DATETIME="xsd:dateTime",ID="tns:ID",LOCATION="urn:location",ADDRESS="urn:address",TOKEN_ENDPOINT="https://login.salesforce.com/services/oauth2/token",SANDBOX_TOKEN_ENDPOINT="https://test.salesforce.com/services/oauth2/token",SFSchemaServices=function(){function e(){}return e.getObjects=function(t,r,s,o,n){var a=r.instance_url+"/services/data/"+r.api_version+"/sobjects";return Observable_1.Observable.create(function(i){e.sfGetRequest(t,a,r,s,o,n).subscribe(function(e){if(200===e.status){var t=e.json();i.next(t.sobjects)}else console.log("Failed to list SF objects: "+e),i.error(new Error("Failed to list SF objects"+e))},function(e){console.log("Failed to list SF objects : "+e),i.error(e)})})},e.describeObject=function(t,r,s,o,n,a,i,c,p){var u=r.api_version,d=r.instance_url+"/services/data/"+u+"/sobjects/"+s+"/describe";return Observable_1.Observable.create(function(u){e.sfGetRequest(t,d,r,i,c,p).subscribe(function(t){if(200===t.status){var r=t.json();u.next(e.toJsonSchema(s,r,o,n,a))}else console.log("Failed to describe schema for object: "+s),u.error(new Error("Failed to describe schema"+t))},function(e){console.log("Failed to describe schema for object: "+e),u.error(e)})})},e.sfGetRequest=function(t,r,s,o,n,a){return Observable_1.Observable.create(function(i){var c=new http_1.Headers;c.set("Authorization","Bearer "+s.access_token);wi_contrib_1.WiProxyCORSUtils.createRequest(t,r).addMethod("GET").addHeader("Authorization","Bearer "+s.access_token).send().subscribe(function(e){e.status,i.next(e)},function(c){var p;401===c.status?("OAuth 2.0 JWT Bearer Flow"===n?a?e.getJSONWebToken(s,o).subscribe(function(n){s.jwt=n,(p=e.refreshAccessTokenUsingJWT(t,s,o)).subscribe(function(n){var a=lodash.assign(s,n.json());s=a,e.sfGetRequestWithoutRefresh(t,r,s,o).subscribe(function(e){i.next(e)})},function(e){console.log("Error - ",e),i.error(e)})},function(e){console.log("Failed to generate new JWT token.",e)}):p=e.refreshAccessTokenUsingJWT(t,s,o):p=e.refreshAccessToken(t,s,o),"OAuth 2.0 JWT Bearer Flow"===n&&a||p.subscribe(function(n){var a=lodash.assign(s,n.json());s=a,e.sfGetRequestWithoutRefresh(t,r,s,o).subscribe(function(e){i.next(e)})},function(e){i.error(e)})):(console.log("Unkown error for SF request: "+c),i.next(c))})})},e.sfGetRequestWithoutRefresh=function(e,t,r,s){return Observable_1.Observable.create(function(s){var o=new http_1.Headers;o.set("Authorization","Bearer "+r.access_token);wi_contrib_1.WiProxyCORSUtils.createRequest(e,t).addMethod("GET").addHeader("Authorization","Bearer "+r.access_token).send().subscribe(function(e){e.status,s.next(e)},function(e){401===e?console.log("error, SF second time 401, token itself might be problem "):console.log("Unkown error for SF request: "+e),s.next(e)})})},e.refreshAccessToken=function(e,t,r){return Observable_1.Observable.create(function(s){var o=new http_1.URLSearchParams;o.set("grant_type","refresh_token"),o.set("client_id",t.client_id),t.customOAuth2Credentials&&!0===t.customOAuth2Credentials?o.set("client_secret",t.client_secret):o.set("client_secret","SALESFORCE_CLIENT_SECRET"),o.set("refresh_token",t.refresh_token);var n=TOKEN_ENDPOINT;"Sandbox"===r&&(n=SANDBOX_TOKEN_ENDPOINT),t.customOAuth2Credentials&&!0===t.customOAuth2Credentials?wi_contrib_1.WiProxyCORSUtils.createRequest(e,n).addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?s.next(e):s.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){s.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(){return s.complete()}):wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(e,n,"SALESFORCE").addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?s.next(e):s.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){s.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(){return s.complete()})})},e.refreshAccessTokenUsingJWT=function(e,t,r){var s="Production"===r?TOKEN_ENDPOINT:SANDBOX_TOKEN_ENDPOINT,o=new http_1.URLSearchParams;return o.set("grant_type","urn:ietf:params:oauth:grant-type:jwt-bearer"),o.set("assertion",t.jwt),Observable_1.Observable.create(function(t){wi_contrib_1.WiProxyCORSUtils.createRequest(e,s).addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?t.next(e):t.error({code:e.status,message:"Failed to get access token using jwt",details:e.json()})},function(e){console.log(e),t.error({code:e.status,message:"Failed to get access token using jwt.",details:e.json()})})})},e.getJSONWebToken=function(e,t){var r="Production"===t?"https://login.salesforce.com":"https://test.salesforce.com",s={iss:e.client_id,aud:r,sub:e.subject,exp:Math.floor(Date.now()/1e3)+60*e.jwtExpiry};return Observable_1.Observable.from(jose.importPKCS8(e.clientPrivateKey,"RS256")).switchMap(function(e){var t=new jose.SignJWT(s).setProtectedHeader({alg:"RS256"});return Observable_1.Observable.from(t.sign(e))})},e.toJsonSchema=function(t,r,s,o,n){for(var a=trigger_jsonschema_1.JsonSchema.Types.objectType(),i=0,c=r.fields;i<c.length;i++){var p=c[i],u=p.soapType,d=p.name,l={};switch(u){case BOOLEAN:l.type=trigger_jsonschema_1.JsonSchema.BOOLEAN,a.properties[d]=l;break;case STRING:case ID:l.type=trigger_jsonschema_1.JsonSchema.STRING,"email"===p.type&&(l.format=trigger_jsonschema_1.JsonSchema.FORMAT_EMAIL),p.length>0&&(l.maxLength=p.length),a.properties[d]=l;break;case DOUBLE:l.type=trigger_jsonschema_1.JsonSchema.NUMBER,a.properties[d]=l;break;case INT:l.type=trigger_jsonschema_1.JsonSchema.INTEGER,a.properties[d]=l;break;case DATE:l.type=trigger_jsonschema_1.JsonSchema.STRING,l.format=trigger_jsonschema_1.JsonSchema.FORMAT_DATE,a.properties[d]=l;break;case DATETIME:l.type=trigger_jsonschema_1.JsonSchema.STRING,l.format=trigger_jsonschema_1.JsonSchema.FORMAT_DATETIME,a.properties[d]=l;break;case LOCATION:a.properties[d]=e.locationType();break;case ADDRESS:a.properties[d]=e.addressType();break;default:l.type=trigger_jsonschema_1.JsonSchema.STRING,a.properties[d]=l}}var g=trigger_jsonschema_1.JsonSchema.Types.rootObject();if(!o||""!==n&&"PushTopic"!==n)if(o&&"Change Data Capture"===n){var h=e.changeDataCaptureResponseSchema();delete a.properties.ChangeEventHeader,Object.assign(h.properties.data.properties.payload.properties,a.properties),g=h}else if(o&&"Platform Event"===n){var b=e.platformEventResponseSchema();Object.assign(b.properties.data.properties.payload,a),g=b}else{var m=trigger_jsonschema_1.JsonSchema.Types.objectType(),y=trigger_jsonschema_1.JsonSchema.Types.arrayType();y.items=a,m.properties.records=y,s&&(m.properties.done=trigger_jsonschema_1.JsonSchema.Types.boolType(),m.properties.totalSize=trigger_jsonschema_1.JsonSchema.Types.numberType()),g.properties[t]=m}else{g.properties.channel=trigger_jsonschema_1.JsonSchema.Types.stringType();var _=trigger_jsonschema_1.JsonSchema.Types.objectType();_.properties.type=trigger_jsonschema_1.JsonSchema.Types.stringType(),_.properties.createDate=trigger_jsonschema_1.JsonSchema.Types.stringType(),_.properties.replayId=trigger_jsonschema_1.JsonSchema.Types.numberType(),g.properties.event=_,g.properties.sobject=a}return g},e.changeDataCaptureResponseSchema=function(){return{$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{data:{type:"object",properties:{schema:{type:"string"},payload:{type:"object",properties:{ChangeEventHeader:{type:"object",properties:{commitNumber:{type:"integer"},commitUser:{type:"string"},sequenceNumber:{type:"integer"},entityName:{type:"string"},changeType:{type:"string"},changedFields:{type:"array",items:[{type:"string"}]},changeOrigin:{type:"string"},transactionKey:{type:"string"},commitTimestamp:{type:"integer"},recordIds:{type:"array",items:[{type:"string"}]}}}}},event:{type:"object",properties:{replayId:{type:"integer"}}}}},channel:{type:"string"}}}},e.platformEventResponseSchema=function(){return{$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{data:{type:"object",properties:{schema:{type:"string"},payload:{type:"object"},event:{type:"object",properties:{EventUuid:{type:"string"},replayId:{type:"integer"}}}}},channel:{type:"string"}}}},e.locationType=function(){return{type:"object",properties:{latitude:{type:"string"},longitude:{type:"string"}}}},e.addressType=function(){return{type:"object",properties:{city:{type:"string"},country:{type:"string"},countryCode:{type:"string"},geocodeAccuracy:{type:"string"},postalCode:{type:"string"},state:{type:"string"},stateCode:{type:"string"},street:{type:"string"},latitude:{type:"string"},longitude:{type:"string"}}}},e}();exports.SFSchemaServices=SFSchemaServices;
//# sourceMappingURL=trigger.schema.services.js.map
