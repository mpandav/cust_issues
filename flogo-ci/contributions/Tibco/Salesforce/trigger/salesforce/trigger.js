"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__decorate=this&&this.__decorate||function(e,t,i,n){var a,s=arguments.length,l=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,i,n);else for(var r=e.length-1;r>=0;r--)(a=e[r])&&(l=(s<3?a(l):s>3?a(t,i,l):a(t,i))||l);return s>3&&l&&Object.defineProperty(t,i,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SalesforceTriggerService=void 0;var http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),validation_1=require("wi-studio/common/models/validation"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),trigger_schema_services_1=require("./trigger.schema.services"),SalesforceTriggerService=function(e){function t(t,i,n){var a=e.call(this,t,i,n)||this;return a.injector=t,a.http=i,a.contribModelService=n,a.value=function(e,t){switch(e){case"Connection Name":return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(a.http,"Salesforce").subscribe(function(i){i.forEach(function(e){for(var i=0;i<e.settings.length;i++)if("name"===e.settings[i].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[i].value});break}}),e.next(t)})});case"Object Name":var i=t.getField("Connection Name").value;return i?Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnection(a.http,i).map(function(e){return e}).subscribe(function(i){for(var n={},s="",l="",r="Production",o="",u="",c=!1,g=!1,d="",v="",b=3,_="",h=0;h<i.settings.length;h++)"authType"===i.settings[h].name&&(l=i.settings[h].value),"WI_STUDIO_OAUTH_CONNECTOR_INFO"===i.settings[h].name&&(n=i.settings[h].value.startsWith("{")?JSON.parse(i.settings[h].value):JSON.parse(atob(i.settings[h].value))),"apiVersion"===i.settings[h].name&&(s=i.settings[h].value),"environment"===i.settings[h].name&&(r=i.settings[h].value),"clientSecret"===i.settings[h].name&&(o=i.settings[h].value),"jwt"===i.settings[h].name&&(u=i.settings[h].value),"customOAuth2Credentials"===i.settings[h].name&&(c=i.settings[h].value),"clientId"===i.settings[h].name&&(d=i.settings[h].value),"generateJwt"===i.settings[h].name&&(g=i.settings[h].value),"subject"===i.settings[h].name&&(v=i.settings[h].value),"jwtExpiry"===i.settings[h].name&&(b=i.settings[h].value),"clientKey"===i.settings[h].name&&""!==i.settings[h].value&&(_=i.settings[h].value.content,_=atob(_.split("base64,")[1]));wi_contrib_1.WiContributionUtils.getAppConfig(a.http).subscribe(function(e){e.deployment===contrib_1.APP_DEPLOYMENT.ON_PREMISE&&(c=!0)}),n.api_version=s,n.client_secret=o,n.jwt=u,n.customOAuth2Credentials=c,n.client_id=d,n.subject=v,n.jwtExpiry=b,n.clientPrivateKey=_,"OAuth 2.0 JWT Bearer Flow"===l||c&&""!==n.client_secret&&void 0!==n.client_id||!c?trigger_schema_services_1.SFSchemaServices.getObjects(a.http,n,r,l,g).subscribe(function(i){i.forEach(function(e){t.push(e.name)}),e.next(t)},function(t){e.error("Failed to get SF objects due to: "+JSON.stringify(t))},function(){e.complete()}):e.next(null)})}):null;case"output":var n=t.getField("Connection Name").value,s=t.getField("Object Name").value,l=t.getField("subscriberType").value;return n&&s?Observable_1.Observable.create(function(e){null!=s&&wi_contrib_1.WiContributionUtils.getConnection(a.http,n).map(function(e){return e}).subscribe(function(t){for(var i={},n="",r="",o="Production",u="",c="",g=!1,d=!1,v="",b="",_=3,h="",p=0;p<t.settings.length;p++)"authType"===t.settings[p].name&&(r=t.settings[p].value),"WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.settings[p].name&&(i=t.settings[p].value.startsWith("{")?JSON.parse(t.settings[p].value):JSON.parse(atob(t.settings[p].value))),"apiVersion"===t.settings[p].name&&(n=t.settings[p].value),"environment"===t.settings[p].name&&(o=t.settings[p].value),"clientSecret"===t.settings[p].name&&(u=t.settings[p].value),"jwt"===t.settings[p].name&&(c=t.settings[p].value),"customOAuth2Credentials"===t.settings[p].name&&(g=t.settings[p].value),"clientId"===t.settings[p].name&&(v=t.settings[p].value),"generateJwt"===t.settings[p].name&&(d=t.settings[p].value),"subject"===t.settings[p].name&&(b=t.settings[p].value),"jwtExpiry"===t.settings[p].name&&(_=t.settings[p].value),"clientKey"===t.settings[p].name&&""!==t.settings[p].value&&(h=t.settings[p].value.content,h=atob(h.split("base64,")[1]));wi_contrib_1.WiContributionUtils.getAppConfig(a.http).subscribe(function(e){e.deployment===contrib_1.APP_DEPLOYMENT.ON_PREMISE&&(g=!0)}),i.api_version=n,i.client_secret=u,i.jwt=c,i.customOAuth2Credentials=g,i.client_id=v,i.subject=b,i.jwtExpiry=_,i.clientPrivateKey=h,"OAuth 2.0 JWT Bearer Flow"===r||g&&""!==i.client_secret&&void 0!==i.client_id||!g?trigger_schema_services_1.SFSchemaServices.describeObject(a.http,i,s,!0,!0,l,o,r,d).subscribe(function(t){e.next(JSON.stringify(t))},function(t){e.error("Failed to get schema due to: "+JSON.stringify(t))},function(){e.complete()}):e.next(null)})}):null;default:return null}},a.validate=function(e,t){if("Query"===e){var i=t.getField("subscriberType"),n=t.getField("autoCreatePushTopic");return""===i.value||"PushTopic"===i.value&&!0===n.value?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("replayID"===e){i=t.getField("subscriberType"),n=t.getField("autoCreatePushTopic");return"PushTopic"===i.value&&!1===n.value||"Change Data Capture"===i.value||"Platform Event"===i.value?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1)}if("channelName"===e){i=t.getField("subscriberType"),n=t.getField("autoCreatePushTopic");if("PushTopic"===i.value&&!1===n.value){var a=t.getField("channelName");return!1===new RegExp("^/topic/[a-zA-Z]","i").test(a.value)?validation_1.ValidationResult.newValidationResult().setVisible(!0).setError("SALESFORCE-SUBSCRIBER-TRIGGER-1000","Channel Name is invalid"):validation_1.ValidationResult.newValidationResult().setVisible(!0)}if("Change Data Capture"===i.value){a=t.getField("channelName");return!1===new RegExp("^/data/[a-zA-Z]","i").test(a.value)?validation_1.ValidationResult.newValidationResult().setVisible(!0).setError("SALESFORCE-SUBSCRIBER-TRIGGER-1000","Channel Name is invalid"):validation_1.ValidationResult.newValidationResult().setVisible(!0)}if("Platform Event"===i.value){a=t.getField("channelName");return!1===new RegExp("^/event/[a-zA-Z]","i").test(a.value)?validation_1.ValidationResult.newValidationResult().setVisible(!0).setError("SALESFORCE-SUBSCRIBER-TRIGGER-1000","Channel Name is invalid"):validation_1.ValidationResult.newValidationResult().setVisible(!0)}return validation_1.ValidationResult.newValidationResult().setVisible(!1)}return"autoCreatePushTopic"===e?"PushTopic"===(i=t.getField("subscriberType")).value?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):null},a.action=function(e,t){var i=a.getModelService(),n=wi_contrib_1.CreateFlowActionResult.newActionResult();if(t.handler&&t.handler.settings&&t.handler.settings.length>0){var s=t.getField("Connection Name"),l=t.getField("Object Name"),r=t.getField("subscriberType"),o=t.getField("channelName"),u=t.getField("autoCreatePushTopic"),c=t.getField("replayID"),g=t.getField("Query");if(s&&s.value){var d=i.createTriggerElement("Salesforce/salesforce-trigger");if(d&&d.handler&&d.handler.settings&&d.handler.settings.length>0)for(var v=0;v<d.handler.settings.length;v++)"Connection Name"===d.handler.settings[v].name?(d.handler.settings[v].value=s.value,d.handler.settings[v].allowed=s.allowed):"Object Name"===d.handler.settings[v].name?(d.handler.settings[v].value=l.value,d.handler.settings[v].allowed=l.allowed):"subscriberType"===d.handler.settings[v].name?(d.handler.settings[v].value=r.value,d.handler.settings[v].allowed=r.allowed):"autoCreatePushTopic"===d.handler.settings[v].name?d.handler.settings[v].value=u.value:"channelName"===d.handler.settings[v].name?d.handler.settings[v].value=o.value:"replayID"===d.handler.settings[v].name?d.handler.settings[v].value=c.value:"Query"===d.handler.settings[v].name&&(d.handler.settings[v].value=g.value);var b=i.createFlow(t.getFlowName(),t.getFlowDescription());n=n.addTriggerFlowMapping(lodash.cloneDeep(d),lodash.cloneDeep(b))}}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(n)},a}return __extends(t,e),t=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.SalesforceTriggerService=SalesforceTriggerService;
//# sourceMappingURL=trigger.js.map
