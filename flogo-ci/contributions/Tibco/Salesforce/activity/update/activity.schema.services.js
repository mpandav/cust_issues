"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SFSchemaServices=void 0;var http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),Observable_1=require("rxjs/Observable"),activity_jsonschema_1=require("./activity.jsonschema"),lodash=require("lodash"),jose=require("jose"),BOOLEAN="xsd:boolean",STRING="xsd:string",DOUBLE="xsd:double",INT="xsd:int",DATE="xsd:date",DATETIME="xsd:dateTime",ID="tns:ID",LOCATION="urn:location",ADDRESS="urn:address",TOKEN_ENDPOINT="https://login.salesforce.com/services/oauth2/token",SANDBOX_TOKEN_ENDPOINT="https://test.salesforce.com/services/oauth2/token",SFSchemaServices=function(){function e(){}return e.getObjects=function(t,s,r,o,n){var a=s.instance_url+"/services/data/"+s.api_version+"/sobjects";return Observable_1.Observable.create(function(i){e.sfGetRequest(t,a,s,r,o,n).subscribe(function(e){if(200===e.status){var t=e.json();i.next(t.sobjects)}else console.log("Failed to list SF objects: "+e),i.error(new Error("Failed to list SF objects"+e))},function(e){console.log("Failed to list SF objects : "+e),i.error(e)})})},e.describeObject=function(t,s,r,o,n,a,i,c){var u=s.api_version,d=s.instance_url+"/services/data/"+u+"/sobjects/"+r+"/describe";return Observable_1.Observable.create(function(u){e.sfGetRequest(t,d,s,a,i,c).subscribe(function(t){if(200===t.status){var s=t.json();u.next(e.toJsonSchema(r,s,o,n))}else console.log("Failed to describe schema for object: "+r),u.error(new Error("Failed to describe schema"+t))},function(e){console.log("Failed to describe schema for object: "+e),u.error(e)})})},e.sfGetRequest=function(t,s,r,o,n,a){return Observable_1.Observable.create(function(i){var c=new http_1.Headers;c.set("Authorization","Bearer "+r.access_token);wi_contrib_1.WiProxyCORSUtils.createRequest(t,s).addMethod("GET").addHeader("Authorization","Bearer "+r.access_token).send().subscribe(function(e){e.status,i.next(e)},function(c){var u;401===c.status&&("OAuth 2.0 JWT Bearer Flow"===n?a?e.getJSONWebToken(r,o).subscribe(function(n){r.jwt=n,(u=e.refreshAccessTokenUsingJWT(t,r,o)).subscribe(function(n){var a=lodash.assign(r,n.json());r=a,e.sfGetRequestWithoutRefresh(t,s,r,o).subscribe(function(e){i.next(e)})},function(e){console.log("Error - ",e),i.error(e)})},function(e){console.log("Failed to generate new JWT token.",e)}):u=e.refreshAccessTokenUsingJWT(t,r,o):u=e.refreshAccessToken(t,r,o),"OAuth 2.0 JWT Bearer Flow"===n&&a?(console.log("Unkown error for SF request: "+c),i.next(c)):u.subscribe(function(n){var a=lodash.assign(r,n.json());r=a,e.sfGetRequestWithoutRefresh(t,s,r,o).subscribe(function(e){i.next(e)})},function(e){i.error(e)}))})})},e.sfGetRequestWithoutRefresh=function(e,t,s,r){return Observable_1.Observable.create(function(r){var o=new http_1.Headers;o.set("Authorization","Bearer "+s.access_token);wi_contrib_1.WiProxyCORSUtils.createRequest(e,t).addMethod("GET").addHeader("Authorization","Bearer "+s.access_token).send().subscribe(function(e){e.status,r.next(e)},function(e){401===e?console.log("error, SF second time 401, token itself might be problem "):console.log("Unkown error for SF request: "+e),r.next(e)})})},e.refreshAccessToken=function(e,t,s){return Observable_1.Observable.create(function(r){var o=new http_1.URLSearchParams;o.set("grant_type","refresh_token"),o.set("client_id",t.client_id),t.customOAuth2Credentials&&!0===t.customOAuth2Credentials?o.set("client_secret",t.client_secret):o.set("client_secret","SALESFORCE_CLIENT_SECRET"),o.set("refresh_token",t.refresh_token);var n=TOKEN_ENDPOINT;"Sandbox"===s&&(n=SANDBOX_TOKEN_ENDPOINT),t.customOAuth2Credentials&&!0===t.customOAuth2Credentials?wi_contrib_1.WiProxyCORSUtils.createRequest(e,n).addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?r.next(e):r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(){return r.complete()}):wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(e,n,"SALESFORCE").addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?r.next(e):r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(){return r.complete()})})},e.refreshAccessTokenUsingJWT=function(e,t,s){var r="Production"===s?TOKEN_ENDPOINT:SANDBOX_TOKEN_ENDPOINT,o=new http_1.URLSearchParams;return o.set("grant_type","urn:ietf:params:oauth:grant-type:jwt-bearer"),o.set("assertion",t.jwt),Observable_1.Observable.create(function(t){wi_contrib_1.WiProxyCORSUtils.createRequest(e,r).addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?t.next(e):t.error({code:e.status,message:"Failed to get access token using jwt",details:e.json()})},function(e){console.log(e),t.error({code:e.status,message:"Failed to get access token using jwt.",details:e.json()})})})},e.getJSONWebToken=function(e,t){var s="Production"===t?"https://login.salesforce.com":"https://test.salesforce.com",r={iss:e.client_id,aud:s,sub:e.subject,exp:Math.floor(Date.now()/1e3)+60*e.jwtExpiry};return Observable_1.Observable.from(jose.importPKCS8(e.clientPrivateKey,"RS256")).switchMap(function(e){var t=new jose.SignJWT(r).setProtectedHeader({alg:"RS256"});return Observable_1.Observable.from(t.sign(e))})},e.toJsonSchema=function(t,s,r,o){for(var n=activity_jsonschema_1.JsonSchema.Types.objectType(),a=0,i=s.fields;a<i.length;a++){var c=i[a],u=c.soapType,d=c.name,l={};switch(u){case BOOLEAN:l.type=activity_jsonschema_1.JsonSchema.BOOLEAN,n.properties[d]=l;break;case STRING:case ID:l.type=activity_jsonschema_1.JsonSchema.STRING,"email"===c.type&&(l.format=activity_jsonschema_1.JsonSchema.FORMAT_EMAIL),c.length>0&&(l.maxLength=c.length),n.properties[d]=l;break;case DOUBLE:l.type=activity_jsonschema_1.JsonSchema.NUMBER,n.properties[d]=l;break;case INT:l.type=activity_jsonschema_1.JsonSchema.INTEGER,n.properties[d]=l;break;case DATE:l.type=activity_jsonschema_1.JsonSchema.STRING,l.format=activity_jsonschema_1.JsonSchema.FORMAT_DATE,n.properties[d]=l;break;case DATETIME:l.type=activity_jsonschema_1.JsonSchema.STRING,l.format=activity_jsonschema_1.JsonSchema.FORMAT_DATETIME,n.properties[d]=l;break;case LOCATION:n.properties[d]=e.locationType();break;case ADDRESS:n.properties[d]=e.addressType();break;default:l.type=activity_jsonschema_1.JsonSchema.STRING,n.properties[d]=l}}var p=activity_jsonschema_1.JsonSchema.Types.rootObject();if(o){p.properties.channel=activity_jsonschema_1.JsonSchema.Types.stringType();var b=activity_jsonschema_1.JsonSchema.Types.objectType();b.properties.type=activity_jsonschema_1.JsonSchema.Types.stringType(),b.properties.createDate=activity_jsonschema_1.JsonSchema.Types.stringType(),p.properties.event=b,p.properties.sobject=n}else{var h=activity_jsonschema_1.JsonSchema.Types.objectType(),_=activity_jsonschema_1.JsonSchema.Types.arrayType();_.items=n,h.properties.records=_,r&&(h.properties.done=activity_jsonschema_1.JsonSchema.Types.boolType(),h.properties.totalSize=activity_jsonschema_1.JsonSchema.Types.numberType()),p.properties[t]=h}return p},e.locationType=function(){return{type:"object",properties:{latitude:{type:"string"},longitude:{type:"string"}}}},e.addressType=function(){return{type:"object",properties:{city:{type:"string"},country:{type:"string"},countryCode:{type:"string"},geocodeAccuracy:{type:"string"},postalCode:{type:"string"},state:{type:"string"},stateCode:{type:"string"},street:{type:"string"},latitude:{type:"string"},longitude:{type:"string"}}}},e}();exports.SFSchemaServices=SFSchemaServices;
//# sourceMappingURL=activity.schema.services.js.map
