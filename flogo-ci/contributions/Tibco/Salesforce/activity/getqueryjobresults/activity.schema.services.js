"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SFSchemaServices=void 0;var http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),Observable_1=require("rxjs/Observable"),activity_jsonschema_1=require("./activity.jsonschema"),lodash=require("lodash"),jose=require("jose"),BOOLEAN="xsd:boolean",STRING="xsd:string",DOUBLE="xsd:double",INT="xsd:int",DATE="xsd:date",DATETIME="xsd:dateTime",ID="tns:ID",LOCATION="urn:location",ADDRESS="urn:address",TOKEN_ENDPOINT="https://login.salesforce.com/services/oauth2/token",SANDBOX_TOKEN_ENDPOINT="https://test.salesforce.com/services/oauth2/token",SFSchemaServices=function(){function e(){}return e.getObjects=function(t,s,r,o,n){var a=s.instance_url+"/services/data/"+s.api_version+"/sobjects";return Observable_1.Observable.create(function(c){e.sfGetRequest(t,a,s,r,o,n).subscribe(function(e){if(200===e.status){var t=e.json();c.next(t.sobjects)}else console.log("Failed to list SF objects: "+e),c.error(new Error("Failed to list SF objects"+e))},function(e){console.log("Failed to list SF objects : "+e),c.error(e)})})},e.describeObject=function(t,s,r,o,n,a,c,i){var u=s.api_version,l=s.instance_url+"/services/data/"+u+"/sobjects/"+r+"/describe";return Observable_1.Observable.create(function(u){e.sfGetRequest(t,l,s,a,c,i).subscribe(function(t){if(200===t.status){var s=t.json();u.next(e.toJsonSchema(r,s,o,n))}else console.log("Failed to describe schema for object: "+r),u.error(new Error("Failed to describe schema"+t))},function(e){console.log("Failed to describe schema for object: "+e),u.error(e)})})},e.sfGetRequest=function(t,s,r,o,n,a){return Observable_1.Observable.create(function(c){var i=new http_1.Headers;i.set("Authorization","Bearer "+r.access_token);wi_contrib_1.WiProxyCORSUtils.createRequest(t,s).addMethod("GET").addHeader("Authorization","Bearer "+r.access_token).send().subscribe(function(e){e.status,c.next(e)},function(i){var u;401===i.status?("OAuth 2.0 JWT Bearer Flow"===n?a?e.getJSONWebToken(r,o).subscribe(function(n){r.jwt=n,(u=e.refreshAccessTokenUsingJWT(t,r,o)).subscribe(function(n){var a=lodash.assign(r,n.json());r=a,e.sfGetRequestWithoutRefresh(t,s,r,o).subscribe(function(e){c.next(e)})},function(e){console.log("Error - ",e),c.error(e)})},function(e){console.log("Failed to generate new JWT token.",e)}):u=e.refreshAccessTokenUsingJWT(t,r,o):u=e.refreshAccessToken(t,r,o),"OAuth 2.0 JWT Bearer Flow"===n&&a||u.subscribe(function(n){var a=lodash.assign(r,n.json());r=a,e.sfGetRequestWithoutRefresh(t,s,r,o).subscribe(function(e){c.next(e)})},function(e){c.error(e)})):(console.log("Unkown error for SF request: "+i),c.next(i))})})},e.sfGetRequestWithoutRefresh=function(e,t,s,r){return Observable_1.Observable.create(function(r){var o=new http_1.Headers;o.set("Authorization","Bearer "+s.access_token);wi_contrib_1.WiProxyCORSUtils.createRequest(e,t).addMethod("GET").addHeader("Authorization","Bearer "+s.access_token).send().subscribe(function(e){e.status,r.next(e)},function(e){401===e?console.log("error, SF second time 401, token itself might be problem "):console.log("Unkown error for SF request: "+e),r.next(e)})})},e.refreshAccessToken=function(e,t,s){return Observable_1.Observable.create(function(r){var o=new http_1.URLSearchParams;o.set("grant_type","refresh_token"),o.set("client_id",t.client_id),t.customOAuth2Credentials&&!0===t.customOAuth2Credentials?o.set("client_secret",t.client_secret):o.set("client_secret","SALESFORCE_CLIENT_SECRET"),o.set("refresh_token",t.refresh_token);var n=TOKEN_ENDPOINT;"Sandbox"===s&&(n=SANDBOX_TOKEN_ENDPOINT),t.customOAuth2Credentials&&!0===t.customOAuth2Credentials?wi_contrib_1.WiProxyCORSUtils.createRequest(e,n).addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?r.next(e):r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(){return r.complete()}):wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(e,n,"SALESFORCE").addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?r.next(e):r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(e){r.error({code:e.status,message:"Failed to get access token",details:e.json()})},function(){return r.complete()})})},e.refreshAccessTokenUsingJWT=function(e,t,s){var r="Production"===s?TOKEN_ENDPOINT:SANDBOX_TOKEN_ENDPOINT,o=new http_1.URLSearchParams;return o.set("grant_type","urn:ietf:params:oauth:grant-type:jwt-bearer"),o.set("assertion",t.jwt),Observable_1.Observable.create(function(t){wi_contrib_1.WiProxyCORSUtils.createRequest(e,r).addMethod("POST").addBody(o.toString()).addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(e){200===e.status?t.next(e):t.error({code:e.status,message:"Failed to get access token using jwt",details:e.json()})},function(e){console.log(e),t.error({code:e.status,message:"Failed to get access token using jwt.",details:e.json()})})})},e.getJSONWebToken=function(e,t){var s="Production"===t?"https://login.salesforce.com":"https://test.salesforce.com",r={iss:e.client_id,aud:s,sub:e.subject,exp:Math.floor(Date.now()/1e3)+60*e.jwtExpiry};return Observable_1.Observable.from(jose.importPKCS8(e.clientPrivateKey,"RS256")).switchMap(function(e){var t=new jose.SignJWT(r).setProtectedHeader({alg:"RS256"});return Observable_1.Observable.from(t.sign(e))})},e.toJsonSchema=function(e,t,s,r){for(var o=activity_jsonschema_1.JsonSchema.Types.objectType(),n=0,a=t.fields;n<a.length;n++){var c=a[n],i=c.soapType,u=c.name,l={};switch(i){case BOOLEAN:l.type=activity_jsonschema_1.JsonSchema.BOOLEAN,o.properties[u]=l;break;case STRING:case ID:l.type=activity_jsonschema_1.JsonSchema.STRING,"email"===c.type&&(l.format=activity_jsonschema_1.JsonSchema.FORMAT_EMAIL),c.length>0&&(l.maxLength=c.length),o.properties[u]=l;break;case DOUBLE:l.type=activity_jsonschema_1.JsonSchema.NUMBER,o.properties[u]=l;break;case INT:l.type=activity_jsonschema_1.JsonSchema.INTEGER,o.properties[u]=l;break;case DATE:l.type=activity_jsonschema_1.JsonSchema.STRING,l.format=activity_jsonschema_1.JsonSchema.FORMAT_DATE,o.properties[u]=l;break;case DATETIME:l.type=activity_jsonschema_1.JsonSchema.STRING,l.format=activity_jsonschema_1.JsonSchema.FORMAT_DATETIME,o.properties[u]=l;break;case LOCATION:case ADDRESS:break;default:l.type=activity_jsonschema_1.JsonSchema.STRING,o.properties[u]=l}}var d=activity_jsonschema_1.JsonSchema.Types.rootObject();if(r){d.properties.channel=activity_jsonschema_1.JsonSchema.Types.stringType();var b=activity_jsonschema_1.JsonSchema.Types.objectType();b.properties.type=activity_jsonschema_1.JsonSchema.Types.stringType(),b.properties.createDate=activity_jsonschema_1.JsonSchema.Types.stringType(),d.properties.event=b,d.properties.sobject=o}else{var h=activity_jsonschema_1.JsonSchema.Types.objectType(),_=activity_jsonschema_1.JsonSchema.Types.arrayType();_.items=o,h.properties.records=_,s&&(h.properties.locator=activity_jsonschema_1.JsonSchema.Types.stringType(),h.properties.maxRecords=activity_jsonschema_1.JsonSchema.Types.numberType()),d.properties[e]=h}return d},e}();exports.SFSchemaServices=SFSchemaServices;
//# sourceMappingURL=activity.schema.services.js.map
