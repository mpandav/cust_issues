"use strict";var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(t,e,n,i){var r,o=arguments.length,a=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,i);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(a=(o<3?r(a):o>3?r(e,n,a):r(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(t,e){return function(n,i){e(n,i,t)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MailchimpConnectorService=void 0;var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),validation_1=require("wi-studio/common/models/validation"),contrib_1=require("wi-studio/common/models/contrib"),Observable_1=require("rxjs/Observable"),lodash=require("lodash"),AUTH_ENDPOINT="https://login.mailchimp.com/oauth2/authorize",TOKEN_ENDPOINT="https://login.mailchimp.com/oauth2/token",AUTH_METADATA_ENDPOINT="https://login.mailchimp.com/oauth2/metadata",CLIENT_ID="440725332451",CLIENT_SECRET="f92a3536c3dba5b55790bc87ba26e4dd2ede84ca2b0e0aec12",MailchimpConnectorService=function(t){function e(e,n){var i=t.call(this,e,n)||this;return i.http=n,i.value=function(t,e){if("name"===t||"description"===t)return null;if("authType"===t)return"OAUTH2";if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===t)for(var n=function(t){if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.name)try{var n=JSON.parse(t.value);if(n.code)return{value:Observable_1.Observable.create(function(t){i.getOauthConfig(e).subscribe(function(r){var o=n.code;i.getAccessToken(e,o).subscribe(function(e){var n={client_id:r.client_id,client_secret:r.client_secret};n=lodash.assign(n,e),t.next(JSON.stringify(n))},function(e){t.next("")})})})}}catch(t){return{value:null}}},r=0,o=e.settings;r<o.length;r++){var a=n(o[r]);if("object"==typeof a)return a.value}return null},i.validate=function(t,e){return"WI_STUDIO_OAUTH_CONNECTOR_INFO"===t?i.checkForTokens(e):null},i.action=function(t,e){if("Login"===t)return Observable_1.Observable.create(function(t){for(var n="",r=0;r<e.settings.length;r++)if("name"===e.settings[r].name){n=e.settings[r].value;break}var o=!1;wi_contrib_1.WiContributionUtils.getConnections(i.http,"Mailchimp").subscribe(function(r){for(var a=0,c=r;a<c.length;a++)for(var s=c[a],u=0;u<s.settings.length;u++){if("name"===s.settings[u].name)if(s.settings[u].value===n&&wi_contrib_1.WiContributionUtils.getUniqueId(s)!==wi_contrib_1.WiContributionUtils.getUniqueId(e)){o=!0;break}}if(o)t.next(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("SALESFORCE-1000","Connection name already exist !!!"))),t.complete();else{var l="";for(u=0;u<e.settings.length;u++)if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e.settings[u].name){l=e.settings[u].value;break}if(i.checkForTokens(e).isValid()){var _=JSON.parse(l);for(u=0;u<e.settings.length;u++)if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===e.settings[u].name){e.settings[u].value=JSON.stringify(_);break}var b={context:e,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};t.next(contrib_1.ActionResult.newActionResult().setResult(b))}else i.getOauthConfig(e).subscribe(function(n){var r={context:e,authType:wi_contrib_1.AUTHENTICATION_TYPE.OAUTH2,authData:{authLoginUrl:i.getAuthLoginUrl(n),authStateQueryParam:"state"}};t.next(contrib_1.ActionResult.newActionResult().setResult(r))})}})})},i}return __extends(e,t),e.prototype.getAuthLoginUrl=function(t){var e=t.client_id,n=(t.client_secret,t.callback_url);return encodeURI(AUTH_ENDPOINT+"?response_type=code&client_id="+e+"&redirect_uri="+n)},e.prototype.getAccessToken=function(t,e){var n=this;return Observable_1.Observable.create(function(i){n.getOauthConfig(t).subscribe(function(t){var r=new http_1.URLSearchParams;r.set("grant_type","authorization_code"),r.set("code",decodeURIComponent(e)),r.set("client_id",t.client_id),r.set("client_secret",t.client_secret),r.set("redirect_uri",t.callback_url);new http_1.RequestOptions({url:TOKEN_ENDPOINT,method:"POST",headers:new http_1.Headers({"Content-Type":"application/x-www-form-urlencoded"}),body:r.toString()});wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,TOKEN_ENDPOINT).addBody(r.toString()).addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").send().subscribe(function(t){if(200===t.status){var e=t.json();n.getAuthMetadata(e).subscribe(function(t){i.next(t)},function(t){i.error(t)})}else i.error({code:t.status,message:"Failed to get access token",details:t.json()})})})})},e.prototype.getAuthMetadata=function(t){var e=this;return Observable_1.Observable.create(function(n){var i=t.access_token;wi_contrib_1.WiProxyCORSUtils.createRequest(e.http,AUTH_METADATA_ENDPOINT).addMethod("GET").addHeader("Authorization","OAuth "+i).send().subscribe(function(e){if(200===e.status){var i=lodash.assign(t,e.json());n.next(i)}else n.error({code:e.status,message:"Failed to get auth metadata",details:e.json()})})})},e.prototype.getOauthConfig=function(t){return Observable_1.Observable.zip(this.getClientId(t),this.getClientSecret(t),this.getRedirectUrl(t),function(t,e,n){return{client_id:t.value,client_secret:e.value,callback_url:n.value}})},e.prototype.getRedirectUrl=function(t){var e=this;return Observable_1.Observable.create(function(t){wi_contrib_1.WiContributionUtils.getEnvironment(e.http,"WI_FLOGO_ENTERPRISE").subscribe(function(n){n.value&&"true"===n.value.toString().toLowerCase()?wi_contrib_1.WiContributionUtils.getEnvironment(e.http,"OAUTH_REDIRECT_URL").subscribe(function(e){var n=e.value;n=n.replace("localhost","127.0.0.1"),t.next({value:n})}):wi_contrib_1.WiContributionUtils.getEnvironment(e.http,"OAUTH_REDIRECT_URL").subscribe(function(e){t.next(e)})},function(n){wi_contrib_1.WiContributionUtils.getEnvironment(e.http,"OAUTH_REDIRECT_URL").subscribe(function(e){t.next(e)})})})},e.prototype.getClientId=function(t){return Observable_1.Observable.create(function(e){for(var n="",i=0;i<t.settings.length;i++)if("clientId"===t.settings[i].name){n=t.settings[i].value;break}e.next({value:n})})},e.prototype.getClientSecret=function(t){return Observable_1.Observable.create(function(e){for(var n="",i=0;i<t.settings.length;i++)if("clientSecret"===t.settings[i].name){n=t.settings[i].value;break}e.next({value:n})})},e.prototype.checkForTokens=function(t){for(var e=0,n=t.settings;e<n.length;e++){var i=n[e];if("WI_STUDIO_OAUTH_CONNECTOR_INFO"===i.name){var r=validation_1.ValidationResult.newValidationResult().setVisible(!1);if(!i.value)return r.setValid(!1),r;try{return JSON.parse(i.value).access_token?r.setValid(!0):r.setValid(!1),r}catch(t){return r.setValid(!1),r}}}},e=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],e)}(wi_contrib_1.WiServiceHandlerContribution);exports.MailchimpConnectorService=MailchimpConnectorService;
//# sourceMappingURL=connector.js.map
