"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__decorate=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(o<3?i(s):o>3?i(e,n,s):i(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(t,e){return function(n,r){e(n,r,t)}};Object.defineProperty(exports,"__esModule",{value:!0});var http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions");require("wi-studio/common/rxjs-extensions");var validation_1=require("wi-studio/common/models/validation");require("rxjs/add/observable/zip");var Result=function(){return function(t,e,n){}}(),Connection=function(){function t(t){this.http=t,this.REDIRECT_URI=wi_contrib_1.WiContributionUtils.getEnvironment(this.http,"OAUTH_REDIRECT_URL"),this.SCOPE="User.Read Files.ReadWrite.All Sites.ReadWrite.All",this.RESPONSE_TYPE="code",this.PROMPT="consent",this.TOKEN_ENDPOINT="https://login.microsoftonline.com/",this.LOGIN_ENDPOINT="https://login.microsoftonline.com/cde6fa59-abb3-4971-be01-2443c417cbda/oauth2/v2.0/authorize"}return t.getConnection=function(e,n){var r=new t(n);return rxjs_extensions_1.Observable.from(e).reduce(function(t,e){return t[e.name]=e.value,t},r)},t}();Connection.httpRegex=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)/,exports.Connection=Connection;var TibcoAzureADConnectorContribution=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.http=n,r.clientSecretField="clientSecret",r.value=function(t,e){return r.validations[e.title]&&r.validations[e.title][t]&&delete r.validations[e.title][t],r.validations[e.title]||(r.validations[e.title]={}),null},r.validate=function(t,e){if(r.validations[e.title]||(r.validations[e.title]={}),"WI_STUDIO_OAUTH_CONNECTOR_INFO"===t){var n=r.validations[e.title][t];if(n&&n.value){var i=JSON.parse(JSON.stringify(n.value)).errors[0],o=validation_1.ValidationResult.newValidationResult().setVisible(!1).setError(i.errorCode,i.errorMsg).setValid(!1);return rxjs_extensions_1.Observable.of(o)}o=validation_1.ValidationResult.newValidationResult().setVisible(!1).setValid(!0);return rxjs_extensions_1.Observable.of(o)}return null},r.connection=function(t){var e=new Connection(r.http);return rxjs_extensions_1.Observable.from(t).reduce(function(t,e){return t[e.name]=e.value,t},e)},r.isDuplicate=function(t,e){return wi_contrib_1.WiContributionUtils.getConnections(r.http,r.category).mergeMap(function(t){return t}).map(function(t){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(t),ction:r.connection(t.settings)}}).filter(function(t){return t.id!==e}).mergeMap(function(t){return t.ction}).filter(function(e){return e.name===t.name}).reduce(function(t,e){return t.push(e),t},[]).map(function(t){return t.length>0})},r.defaultResult=function(t){var e={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(e))},r.action=function(t,e){if("Login"===t)return r.connection(e.settings).switchMap(function(t){return r.isDuplicate(t,wi_contrib_1.WiContributionUtils.getUniqueId(e)).map(function(e){if(e)throw new Error("Connection with name "+t.name+" already exists");return t})}).switchMap(function(t){if(!(null!==t.name&&t.name.trim().length>0))throw new Error("Please enter the Connection Name!");if(""===t.tenantId)throw new Error("Please enter the Tenant ID!");if(""===t.clientID)throw new Error("Please enter the Client ID!");if(""===t.userName)throw new Error("Please enter the UserName!");if(""===t.password)throw new Error("Please enter the Password!");if(""===t.resourceURL)throw new Error("Please enter the Resource URL!");if(!Connection.httpRegex.test(t.resourceURL))throw new Error("Please enter the Resource URL in a valid format!");var n;n=t.TOKEN_ENDPOINT+t.tenantId+"/oauth2/token";var i=new http_1.URLSearchParams;return i.set("resource",t.resourceURL),i.set("client_id",t.clientID),i.set("grant_type",t.grantType),i.set("username",t.userName),i.set("password",t.password),i.set("scope","openid"),wi_contrib_1.WiProxyCORSUtils.createRequest(r.http,n).addHeader("Content-Type","application/json").addHeader("Content-Type","application/x-www-form-urlencoded").excludeHeaders(["Origin","origin"]).addMethod("POST").addBody(i.toString()).send().switchMap(function(t){if(t.status>=500||t.status>=400)return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZADCONN-1002","Connection Authentication error: "+t.statusText+": Check your connection parameters")));for(var n=0;n<e.settings.length;n++)switch(e.settings[n].name){case"DocsMetadata":e.settings[n].value="JsonSchema.Types.schemaDoc()";case"WI_STUDIO_OAUTH_CONNECTOR_INFO":e.settings[n].value=JSON.stringify(t.json())}var r={context:e,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(r))}).catch(function(t){return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZADCONN-1002","Connection Authentication error: "+t.status+" "+JSON.parse(t._body).error+" "+JSON.parse(t._body).error_description)))})}).catch(function(t){return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZADCONN-1002","Connection Authentication error: "+t)))})},r.validations={},r.messaging=new wi_contrib_1.WiContribMessaging,r.category="AzureAD",r}return __extends(e,t),e}(wi_contrib_1.WiServiceHandlerContribution);TibcoAzureADConnectorContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],TibcoAzureADConnectorContribution),exports.TibcoAzureADConnectorContribution=TibcoAzureADConnectorContribution;
//# sourceMappingURL=connector.js.map
