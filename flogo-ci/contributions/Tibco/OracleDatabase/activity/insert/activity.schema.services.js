"use strict";var __decorate=this&&this.__decorate||function(e,t,r,s){var n,a=arguments.length,i=a<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,s);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(i=(a<3?n(i):a>3?n(t,r,i):n(t,r))||i);return a>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),activity_jsonschema_1=require("./activity.jsonschema"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions");require("rxjs/Rx");var CHAR="CHAR",VARCHAR="VARCHAR",VARCHAR2="VARCHAR2",NCHAR="NCHAR",NVARCHAR="NVARCHAR",LONG="LONG",INTERVAL_YEAR_TO_MONTH="INTERVAL YEAR TO MONTH",INTERVAL_DAY_TO_SECOND="INTERVAL DAY TO SECOND",NUMBER="NUMBER",BINARY_FLOAT="BINARY_FLOAT",BINARY_DOUBLE="BINARY_DOUBLE",FLOAT="FLOAT",DATE="DATE",TIMESTAMP="TIMESTAMP",TIMESTAMP_WITH_TIME_ZONE="TIMESTAMP WITH TIME ZONE",TIMESTAMP_WITH_LOCAL_TIME_ZONE="TIMESTAMP WITH LOCAL TIME ZONE",Connection=function(){return function(){}}();exports.Connection=Connection;var QueryMetadata=function(){return function(e,t,r,s){this.ok=e,this.message=t,this.query=r,this.fields=s}}();exports.QueryMetadata=QueryMetadata;var Fields=function(){return function(e,t,r,s,n,a){this.FieldName=e,this.Type=t,this.Selected=r,this.Parameter=s,this.isEditable=n,this.Ordinal=a}}();exports.Fields=Fields;var DBSchemaServices_1,DBSchemaServices=DBSchemaServices_1=function(){function e(e){this.http=e,this.dbserviceURL="/dbservice/api/v2/schema",this.queries=[]}return e.toJsonType=function(e){var t={};switch(e.Type){case NUMBER:t=activity_jsonschema_1.JsonSchema.Types.integerType();break;case BINARY_FLOAT:case BINARY_DOUBLE:case FLOAT:t=activity_jsonschema_1.JsonSchema.Types.numberType();break;case VARCHAR:case CHAR:case VARCHAR2:case NCHAR:case NVARCHAR:case LONG:case INTERVAL_DAY_TO_SECOND:case INTERVAL_YEAR_TO_MONTH:t=activity_jsonschema_1.JsonSchema.Types.stringType();break;case DATE:t=activity_jsonschema_1.JsonSchema.Types.dateType();break;case TIMESTAMP:case TIMESTAMP_WITH_TIME_ZONE:case TIMESTAMP_WITH_LOCAL_TIME_ZONE:t=activity_jsonschema_1.JsonSchema.Types.datetimeType();break;default:t=activity_jsonschema_1.JsonSchema.Types.stringType()}return t},e.sortFields=function(e,t){return e.Ordinal-t.Ordinal},e.prototype.getConnection=function(e){var t=new Connection;return wi_contrib_1.WiContributionUtils.getConnection(this.http,e).mergeMap(function(e){return rxjs_extensions_1.Observable.from(e.settings).reduce(function(e,r){return t[r.name]=r.value,e},t)})},e.prototype.getInsertInputSchema=function(e,t){var r=activity_jsonschema_1.JsonSchema.Types.rootObject();if(!t){var s=activity_jsonschema_1.JsonSchema.Types.valuesObject();r.properties.values=s.records}var n=activity_jsonschema_1.JsonSchema.Types.inputObject();return r.properties.parameters=n.parameters,rxjs_extensions_1.Observable.from(e).reduce(function(e,r){return t||!0!==r.Value&&"true"!==r.Value||(e.properties.values.items.properties[r.FieldName]=DBSchemaServices_1.toJsonType(r)),!0!==r.Parameter&&"true"!==r.Parameter||(t?e.properties.parameters.properties[r.FieldName]=DBSchemaServices_1.toJsonType(r):!0!==r.Value&&"true"!==r.Value&&(e.properties.parameters.properties[r.FieldName]=DBSchemaServices_1.toJsonType(r))),e},r).mergeMap(function(e){return rxjs_extensions_1.Observable.of(r)})},e.prototype.fetchQueryMetadata=function(e,t,r,s){var n=this;return e?rxjs_extensions_1.Observable.of(r).map(function(e){return Object.assign({queryString:e,queryURL:n.dbserviceURL,connection:t})}).mergeMap(function(e){return s(e)}).mergeMap(function(t){return n.createFields(e,r,t.Fields)}):rxjs_extensions_1.Observable.of(r).filter(function(e){return function(e){return!!e&&e.trim().length>0}(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")}).map(function(e){return Object.assign({queryString:e,queryURL:n.dbserviceURL,connection:t})}).mergeMap(function(e){return s(e)}).mergeMap(function(t){return n.createFields(e,r,t.Fields)})},e.prototype.createFields=function(e,t,r){return rxjs_extensions_1.Observable.from(r).reduce(function(t,r){var s={FieldName:r.FieldName,Type:r.Type,Selected:r.Selected,Parameter:r.Parameter,isEditable:e,Ordinal:r.Ordinal};return r.Value?s.Value=r.Value:s.Value=!1,t.fields.push(s),t.fields.sort(DBSchemaServices_1.sortFields),t},{ok:!0,query:t,fields:[]})},e.getOutputSchema=function(){var e=activity_jsonschema_1.JsonSchema.Types.rootObject(),t={};return t.rowsAffected=activity_jsonschema_1.JsonSchema.Types.numberType(),e.properties=t,rxjs_extensions_1.Observable.of(e)},e}();DBSchemaServices=DBSchemaServices_1=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[http_1.Http])],DBSchemaServices),exports.DBSchemaServices=DBSchemaServices;
//# sourceMappingURL=activity.schema.services.js.map
