"use strict";var __decorate=this&&this.__decorate||function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),activity_jsonschema_1=require("./activity.jsonschema"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions");require("rxjs/Rx");var CHAR="CHAR",VARCHAR="VARCHAR",VARCHAR2="VARCHAR2",NCHAR="NCHAR",NVARCHAR="NVARCHAR",LONG="LONG",INTERVAL_YEAR_TO_MONTH="INTERVAL YEAR TO MONTH",INTERVAL_DAY_TO_SECOND="INTERVAL DAY TO SECOND",NUMBER="NUMBER",BINARY_FLOAT="BINARY_FLOAT",BINARY_DOUBLE="BINARY_DOUBLE",FLOAT="FLOAT",DATE="DATE",TIMESTAMP="TIMESTAMP",TIMESTAMP_WITH_TIME_ZONE="TIMESTAMP WITH TIME ZONE",TIMESTAMP_WITH_LOCAL_TIME_ZONE="TIMESTAMP WITH LOCAL TIME ZONE",Connection=function(){return function(){}}();exports.Connection=Connection;var QueryMetadata=function(){return function(e,t,r,n){this.ok=e,this.message=t,this.query=r,this.fields=n}}();exports.QueryMetadata=QueryMetadata;var Fields=function(){return function(e,t,r,n,i){this.FieldName=e,this.Type=t,this.Direction=r,this.isEditable=n,this.Ordinal=i}}();exports.Fields=Fields;var DBSchemaServices_1,DBSchemaServices=DBSchemaServices_1=function(){function e(e){this.http=e,this.dbserviceURL="/dbservice/api/v2/schema",this.queries=[]}return e.toJsonType=function(e){var t={};switch(e.Type){case NUMBER:t=activity_jsonschema_1.JsonSchema.Types.integerType();break;case BINARY_FLOAT:case BINARY_DOUBLE:case FLOAT:t=activity_jsonschema_1.JsonSchema.Types.numberType();break;case VARCHAR:case CHAR:case VARCHAR2:case NCHAR:case NVARCHAR:case LONG:case INTERVAL_DAY_TO_SECOND:case INTERVAL_YEAR_TO_MONTH:t=activity_jsonschema_1.JsonSchema.Types.stringType();break;case DATE:t=activity_jsonschema_1.JsonSchema.Types.dateType();break;case TIMESTAMP:case TIMESTAMP_WITH_TIME_ZONE:case TIMESTAMP_WITH_LOCAL_TIME_ZONE:t=activity_jsonschema_1.JsonSchema.Types.datetimeType();break;default:t=activity_jsonschema_1.JsonSchema.Types.stringType()}return t},e.sortFields=function(e,t){return e.Ordinal-t.Ordinal},e.prototype.getConnection=function(e){var t=new Connection;return wi_contrib_1.WiContributionUtils.getConnection(this.http,e).mergeMap(function(e){return rxjs_extensions_1.Observable.from(e.settings).reduce(function(e,r){return t[r.name]=r.value,e},t)})},e.prototype.getOutputSchema=function(e){var t=activity_jsonschema_1.JsonSchema.Types.rootObject(),r=t.properties;return rxjs_extensions_1.Observable.from(e).filter(function(e){return"OUT"===e.Direction||"INOUT"===e.Direction}).reduce(function(e,t){return e[t.FieldName]=DBSchemaServices_1.toJsonType(t),e},r).mergeMap(function(e){return rxjs_extensions_1.Observable.of(t)})},e.prototype.getInputSchema=function(e){var t=activity_jsonschema_1.JsonSchema.Types.rootObject(),r=activity_jsonschema_1.JsonSchema.Types.inputObject();t.properties.parameters=r.parameters;var n=t.properties.parameters.properties;return rxjs_extensions_1.Observable.from(e).filter(function(e){return"IN"===e.Direction||"INOUT"===e.Direction}).reduce(function(e,t){return e[t.FieldName]=DBSchemaServices_1.toJsonType(t),e},n).mergeMap(function(e){return rxjs_extensions_1.Observable.of(t)})},e.prototype.fetchQueryMetadata=function(e,t,r,n){var i=this;return e?rxjs_extensions_1.Observable.of(r).map(function(e){return Object.assign({queryString:e,queryURL:i.dbserviceURL,connection:t})}).mergeMap(function(e){return n(e)}).mergeMap(function(t){return i.createFields(e,r,t.Fields)}):rxjs_extensions_1.Observable.of(r).filter(function(e){return function(e){return!!e&&e.trim().length>0}(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")}).map(function(e){return Object.assign({queryString:e,queryURL:i.dbserviceURL,connection:t})}).mergeMap(function(e){return n(e)}).mergeMap(function(t){return i.createFields(e,r,t.Fields)})},e.prototype.createFields=function(e,t,r){return rxjs_extensions_1.Observable.from(r).reduce(function(t,r){void 0===r.Direction&&(r.Direction="IN");var n={FieldName:r.FieldName,Type:r.Type,Direction:r.Direction,isEditable:e,Ordinal:r.Ordinal};return r.Value&&(n.Value=r.Value),t.fields.push(n),t.fields.sort(DBSchemaServices_1.sortFields),t},{ok:!0,query:t,fields:[]})},e}();DBSchemaServices=DBSchemaServices_1=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[http_1.Http])],DBSchemaServices),exports.DBSchemaServices=DBSchemaServices;
//# sourceMappingURL=activity.schema.services.js.map
