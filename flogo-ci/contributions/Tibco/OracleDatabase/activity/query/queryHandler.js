"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function a(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(a.prototype=n.prototype,new a)}}(),__decorate=this&&this.__decorate||function(e,t,n,a){var r,i=arguments.length,o=i<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,n):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,a);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(o=(i<3?r(o):i>3?r(t,n,o):r(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),Observable_1=require("rxjs/Observable"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),activity_schema_services_1=require("./activity.schema.services"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),queryHandler=function(e){function t(t,n){var a=e.call(this,t,n)||this;return a.injector=t,a.http=n,a.dbserviceURL="/dbservicego/api/v2/schema",a.tablesColsServiceURL="/dbservicego/dbservice/tablesandcolumns",a.fetchTableColMetaData=function(e,t){var n,r,i,o,s,c,l;return console.log("In fetchTableColMetaData function"),n=btoa("oracle"),r=btoa(e.host),i=btoa(e.port.toString()),o=btoa(e.user),s=btoa(e.password),l=btoa(e.SID),c="Service Name"===e.database?"ServiceName="+l:"SID="+l,wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(a.http,a.tablesColsServiceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise","true").addHeader("DatabaseType","oracle").addBody("Driver="+n+"&Server="+r+"&Port="+i+"&Uid="+o+"&Pwd="+s+"&schema="+t+"&"+c).send().map(function(e){try{return e.json()}catch(e){throw{message:"connection failed; unable to access dbservice"}}})},a.metadata=function(e,t){console.log("In metadata function");var n=a.getContextVar(t,"Oracle Database Connection"),r=wi_contrib_1.WiContributionUtils.getUniqueId(t),i=a.getContextVar(t,"Schema");return""===n||""===i?Observable_1.Observable.of(null):Observable_1.Observable.of({cname:n,uid:r}).switchMap(function(e){return a.schemaServices.getConnection(e.cname)}).switchMap(function(e){return a.fetchTableColMetaData(e,i)}).map(function(e){try{return e}catch(e){throw{message:"fetching metadata failed;"}}})},a.value=function(e,t){var n=function(e){return function(e){return!!e&&e.trim().length>0}(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")},r=a.getContextVar(t,"Oracle Database Connection"),i=a.getContextVar(t,"State"),o=a.getContextVar(t,"Query"),s=a.getFetchQuery(t),c=a.getContextVar(t,"manualmode");""===c&&(c=!1);var l=wi_contrib_1.WiContributionUtils.getUniqueId(t),u=l+o,b=l+r;switch(a.validations[l]||(a.validations[l]={}),e){case"Oracle Database Connection":return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(a.http,a.category).subscribe(function(n){n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})});case"manualmode":return a.validations[l].Fields=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!c).setFetchUI(c)),null;case"Fields":return c?Observable_1.Observable.of(s).switchMap(function(e){return""===r||""===e.trim()?a.handleIncomplete(l,c):Observable_1.Observable.of(s)}).map(function(e){return{query:s,cname:r}}).switchMap(function(n){return t.isQuery?a.fetchQueryMetadata(c,n,l,"Fields"):a.getFields(c,n.query,a.getContextVar(t,e))}).map(function(e){return a.messaging.emit(b+"output",e),a.messaging.emit(b+"input",e),t.isQuery?e.ok?{isSuccess:!0,value:JSON.stringify(e.fields)}:{isSuccess:!1,error:e.message}:e.ok?JSON.stringify(e.fields):JSON.stringify([])}):Observable_1.Observable.of(u).switchMap(function(e){return e!==i&&""!==r&&n(o)?Observable_1.Observable.of(o):a.handleIncomplete(l,c)}).map(function(e){return{query:o,cname:r}}).switchMap(function(r){return n(o)?a.fetchQueryMetadata(c,r,l,"Query"):a.getFields(c,r.query,a.getContextVar(t,e))}).map(function(e){return a.messaging.emit(b+"output",e),a.messaging.emit(b+"input",e),e.ok?JSON.stringify(e.fields):JSON.stringify([])});case"input":return""===r?Observable_1.Observable.of(null):Observable_1.Observable.create(function(e){a.messaging.on(b+"input",function(t){null!==t&&(a.messaging.off(b+"input"),e.next(t))})}).switchMap(function(e){return e.ok?a.schemaServices.getInputSchema(e.fields).map(function(e){return JSON.stringify(e)}):Observable_1.Observable.of(null)});case"Output":return""===r?Observable_1.Observable.of(null):Observable_1.Observable.create(function(e){a.messaging.on(b+"output",function(t){null!==t&&(a.messaging.off(b+"output"),e.next(t))})}).switchMap(function(e){return e.ok?a.schemaServices.getOutputSchema(e.fields).map(function(e){return JSON.stringify(e)}):Observable_1.Observable.of(null)});case"State":return Observable_1.Observable.of(u);default:return null}},a.validate=function(e,t){var n=wi_contrib_1.WiContributionUtils.getUniqueId(t);return a.validations[n]||(a.validations[n]={}),a.validations[n][e]},a.action=function(e,t){return Observable_1.Observable.create(function(e){var t=wi_contrib_1.ActionResult.newActionResult();e.next(t)})},a.handleIncomplete=function(e,t){return a.validations[e].Query=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),a.validations[e].Fields=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0).setReadOnly(!t).setFetchUI(t)),Observable_1.Observable.of(null)},a.getFields=function(e,t,n){return a.schemaServices.createFields(e,t,""===n?JSON.parse("[]"):JSON.parse(n)).map(function(e){return""===n&&(e.ok=!1),e})},a.fetchQueryMetadata=function(e,t,n,r){return Observable_1.Observable.of(t).switchMap(function(e){return a.schemaServices.getConnection(e.cname)}).switchMap(function(n){return a.schemaServices.fetchQueryMetadata(e,n,t.query,a.getSchema)}).map(function(e){return a.validations[n][r]=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),e}).catch(function(e){var i=e instanceof http_1.Response?e.json().error.message:e.message;return a.validations[n][r]=Observable_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("ORACLEDATABASE-INSERT-MSG-1000",i)),Observable_1.Observable.of({ok:!1,message:i,query:t.qdata})})},a.getSchema=function(e){var t,n,r,i,o,s,c;console.log("In getSchema function"),t=btoa("oracle"),n=btoa(e.connection.host),r=btoa(e.connection.port.toString()),i=btoa(e.connection.user),o=btoa(e.connection.password),c=btoa(e.connection.SID),s="Service Name"===e.connection.database?"ServiceName="+c:"SID="+c;var l=encodeURIComponent(e.queryString);return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(a.http,a.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise","true").addHeader("DatabaseType","oracle").addBody("Driver="+t+"&Server="+n+"&Port="+r+"&Uid="+i+"&Pwd="+o+"&query="+l+"&"+s).send().map(function(e){try{return console.log("data from getSchema: ",e.json()),e.json()}catch(e){throw{message:"connection failed. unable to access dbservice"}}})},a.isValidSQLQueryStatement=function(e){return!!e.trim().toUpperCase().startsWith("SELECT")},a.messaging=new wi_contrib_1.WiContribMessaging,a.cachedFields={},a.schemaServices=new activity_schema_services_1.DBSchemaServices(n),a.validations={},a.category="OracleDatabase",a}return __extends(t,e),t.prototype.getContextVar=function(e,t){var n=e.getField(t);return n&&n.value?n.value:""},t.prototype.getFetchQuery=function(e){var t=e.getField("Fields");return t&&t.display.fetchQuery?t.display.fetchQuery:""},t}(wi_contrib_1.WiServiceHandlerContribution);queryHandler=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http])],queryHandler),exports.queryHandler=queryHandler;
//# sourceMappingURL=queryHandler.js.map
