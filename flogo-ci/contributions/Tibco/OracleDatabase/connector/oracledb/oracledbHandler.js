"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,n,r){var o,a=arguments.length,i=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(i=(a<3?o(i):a>3?o(t,n,i):o(t,n))||i);return a>3&&i&&Object.defineProperty(t,n,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),Observable_1=require("rxjs/Observable"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),Connection=function(){return function(){}}();exports.Connection=Connection;var oracledbHandler=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.injector=t,r.http=n,r.value=function(e,t){return null},r.validate=function(e,t){if("port"===e&&r.getConnection(t.settings).port<0)return wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0).setError("ORACLEDATABASE-1002","value for port cannot be less than 0");if(["SetMaxOpenConns","SetMaxIdleConns","SetConnMaxLifetime"].includes(e)&&r.getConnection(t.settings)[e]<0)return wi_contrib_1.ValidationResult.newValidationResult().setVisible(!0).setError("ORACLEDATABASE-1003",e+" cannot be less than 0");return Observable_1.Observable.create(function(e){var t=wi_contrib_1.ValidationResult.newValidationResult();e.next(t)})},r.action=function(e,t){if("Connect"===e)return r.connection(t.settings).switchMap(function(e){return r.isDuplicate(e,wi_contrib_1.WiContributionUtils.getUniqueId(t)).map(function(t){if(t)throw new Error("Connection with name "+e.name+" already exists");return e})}).switchMap(function(e){var n,o,a,i,c,s,u;return n=btoa("oracle"),o=btoa(e.host),a=btoa(e.port.toString()),i=btoa(e.user),c=btoa(e.password),u=btoa(e.SID),s="Service Name"===e.database?"ServiceName="+u:"SID="+u,wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(r.http,r.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise","true").addHeader("DatabaseType","oracle").addBody("Driver="+n+"&Server="+o+"&Port="+a+"&Uid="+i+"&Pwd="+c+"&"+s+"&SetMaxOpenConns="+e.SetMaxOpenConns+"&SetMaxIdleConns="+e.SetMaxIdleConns+"&SetConnMaxLifetime="+e.SetConnMaxLifetime).send().switchMap(function(e){var n=e.json();if(!0===n.error)return console.log("Authentication Failure, Error message %s",n.errorMsg),Observable_1.Observable.throw(n.errorMsg);var r={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setResult(r))})}).catch(function(e){return"Bad Gateway"===e.statusText?Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1001","Test connection failed: Bad Gateway. Check status of 'DB Service'"))):void 0===e.message?Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1001","Test connection failed: "+e.json().error.message))):Observable_1.Observable.of(wi_contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new wi_contrib_1.ValidationError("SNOWFLAKE-1001","Test connection failed: "+e.message)))})},r.connection=function(e){var t=new Connection;return Observable_1.Observable.from(e).reduce(function(e,t){return e[t.name]=t.value,e},t)},r.isDuplicate=function(e,t){return wi_contrib_1.WiContributionUtils.getConnections(r.http,r.category).mergeMap(function(e){return e}).map(function(e){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(e),ction:r.connection(e.settings)}}).filter(function(e){return e.id!==t}).mergeMap(function(e){return e.ction}).filter(function(t){return t.name===e.name}).reduce(function(e,t){return e.push(t),e},[]).map(function(e){return e.length>0})},r.getConnection=function(e){for(var t=new Connection,n=0,r=e;n<r.length;n++){var o=r[n];switch(o.name){case"name":t.name=o.value;break;case"host":t.host=o.value;case"port":t.port=o.value;case"user":t.user=o.value;break;case"password":t.password=o.value;break;case"database":t.database=o.value;break;case"SID":t.SID=o.value;break;case"SetMaxOpenConns":t.SetMaxOpenConns=o.value;break;case"SetMaxIdleConns":t.SetMaxIdleConns=o.value;break;case"SetConnMaxLifetime":t.SetConnMaxLifetime=o.value}}return t},r.category="OracleDatabase",r.dbserviceURL="/dbservicego/api/v2/dbtest",r}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);oracledbHandler=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http])],oracledbHandler),exports.oracledbHandler=oracledbHandler;
//# sourceMappingURL=oracledbHandler.js.map
