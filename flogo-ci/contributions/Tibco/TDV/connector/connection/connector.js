"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(t,e,n,i){var o,r=arguments.length,a=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,i);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(r<3?o(a):r>3?o(e,n,a):o(e,n))||a);return r>3&&a&&Object.defineProperty(e,n,a),a},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(t,e){return function(n,i){e(n,i,t)}};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions"),validation_1=require("wi-studio/common/models/validation"),Result=function(){return function(t,e,n){}}(),Connection=function(){return function(){}}();exports.Connection=Connection;var TibcoTDVConnectorContribution=function(t){function e(e,n){var i=t.call(this,e,n)||this;return i.http=n,i.value=function(t,e){return null},i.connection=function(t){var e=new Connection;return rxjs_extensions_1.Observable.from(t).reduce(function(t,e){return t[e.name]=e.value,t},e)},i.validate=function(t,e){if("onprem"===t)return wi_contrib_1.WiContributionUtils.getAppConfig(i.http).map(function(t){return t.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0)}).catch(function(t){return rxjs_extensions_1.Observable.of(validation_1.ValidationResult.newValidationResult().setVisible(!1))});if("maxconnectattempts"===t&&e.getField("maxconnectattempts").value<0)return validation_1.ValidationResult.newValidationResult().setError("TDV-1003","Maximum Connection Retry Attempt must be a non-negative number");if("connectionretrydelay"===t&&e.getField("connectionretrydelay").value<0)return validation_1.ValidationResult.newValidationResult().setError("TDV-1004","Connection Retry Delay must be a non-negative number");if("connectiontimeout"===t&&e.getField("connectiontimeout").value<0)return validation_1.ValidationResult.newValidationResult().setError("TDV-1005","Connection Timeout must be a non-negative number");if("sessionTimeout"===t&&e.getField("sessionTimeout").value<0)return validation_1.ValidationResult.newValidationResult().setError("TDV-1006","Session Timeout must be a non-negative number");if("requestTimeout"===t&&e.getField("requestTimeout").value<0)return validation_1.ValidationResult.newValidationResult().setError("TDV-1007","Request Timeout must be a non-negative number");var n=e.getField("tlsparam").value.toString(),o=e.getField("tlsconfig");switch(t){case"tlsparam":return void 0===o.value||null===o.value||!1===o.value?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0);case"cacert":return validation_1.ValidationResult.newValidationResult().setVisible(i.fileBrowseOptionSetVisible(o.value,n));default:return null}},i.isDuplicate=function(t,e){return wi_contrib_1.WiContributionUtils.getConnections(i.http,i.category).mergeMap(function(t){return t}).map(function(t){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(t),ction:i.connection(t.settings)}}).filter(function(t){return t.id!==e}).mergeMap(function(t){return t.ction}).filter(function(e){return e.name===t.name}).reduce(function(t,e){return t.push(e),t},[]).map(function(t){return t.length>0})},i.action=function(t,e){if("Connect"===t)return i.connection(e.settings).switchMap(function(t){return i.isDuplicate(t,wi_contrib_1.WiContributionUtils.getUniqueId(e)).map(function(e){if(e)throw new Error("Connection with name "+t.name+" already exists");return t})}).switchMap(function(t){var n,o,r,a,s,u,c,l,d,_="";if(n=btoa("tdv"),o=btoa(t.server),r=btoa(t.port.toString()),d=btoa(t.sessionTimeout.toString()),a=btoa(t.datasource),s=btoa(t.domain),u=btoa(t.user),c=btoa(t.password),btoa(t.tlsparam),l=btoa(t.name),null!=t.tlsconfig&&!0===t.tlsconfig){var b={encrypt:{type:"string",value:"true"},validateRemoteCert:{type:"string",value:"true"}},f=t.cacert.content;null!=f&&""!==f&&(b.sslCACert={type:"file",extension:"pem",value:f}),_=btoa(JSON.stringify(b))}return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(i.http,i.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===t.onprem?"false":t.onprem.toString()).addHeader("DatabaseType","tdv").addBody("Driver="+n+"&Server="+o+"&Port="+r+"&Domain="+s+"&DataSource="+a+"&sessionTimeout="+d+"&Uid="+u+"&Pwd="+c+"&ConnectionID="+l+"&SSLData="+_).send().switchMap(function(t){try{var n=t.json();if(!0===n.error)return rxjs_extensions_1.Observable.throw(n.errorMsg);var i={context:e,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(i))}catch(t){return rxjs_extensions_1.Observable.throw({message:"connection failed; unable to access dbservice"})}})}).catch(function(t){return void 0===t.message?rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("TDV-1001","test connection failed: "+t.json().error.message))):rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("TDV-1002","test connection failed: "+t.message)))})},i.dbserviceURL="/dbservicego/api/v2/dbtest",i.category="TDV",i}return __extends(e,t),e.prototype.fileBrowseOptionSetVisible=function(t,e){return!0===t&&"VerifyCA"===e},e}(wi_contrib_1.WiServiceHandlerContribution);TibcoTDVConnectorContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],TibcoTDVConnectorContribution),exports.TibcoTDVConnectorContribution=TibcoTDVConnectorContribution;
//# sourceMappingURL=connector.js.map
