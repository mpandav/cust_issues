"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var activity_jsonschema_1=require("./activity.jsonschema"),Rx_1=require("rxjs/Rx");require("rxjs/Rx");var SMALLINT="SMALLINT",INTEGER="INTEGER",BIGINT="BIGINT",INT="INT",INT2="INT2",INT4="INT4",INT8="INT8",BIT="BIT",TINYINT="TINYINT",NUMERIC="NUMERIC",DECIMAL="DECIMAL",REAL="REAL",FLOAT="FLOAT",FLOAT4="FLOAT4",FLOAT8="FLOAT8",DOUBLE="DOUBLE",BOOLEAN="BOOLEAN",CHAR="CHAR",BPCHAR="BPCHAR",NCHAR="NCHAR",CHARACTER="CHARACTER",VARCHAR="VARCHAR",TEXT="TEXT",MEDIUMTEXT="MEDIUMTEXT",LONGTEXT="LONGTEXT",DATE="DATE",TIMESTAMP="TIMESTAMP",TIMESTAMPTZ="TIMESTAMPTZ",POINT="POINT",ANYENUM="ANYENUM",QueryMetadata=function(){return function(e,t,r,a){this.ok=e,this.message=t,this.query=r,this.fields=a}}();exports.QueryMetadata=QueryMetadata;var Fields=function(){return function(e,t,r,a,s,n){this.FieldName=e,this.Type=t,this.Selected=r,this.Parameter=a,this.isEditable=s,this.Ordinal=n,this.isEditable=!1}}();exports.Fields=Fields;var Connection=function(){function e(){this.dbserviceURL="/dbservicego/api/v2/schema",this.queries=[]}return e.toJsonSchema=function(e){var t={};switch(e.Type){case SMALLINT:case INTEGER:case BIGINT:case INT:case INT2:case INT4:case INT8:case TINYINT:t=activity_jsonschema_1.JsonSchema.Types.integerType();break;case DOUBLE:case DECIMAL:case NUMERIC:case FLOAT:case FLOAT4:case FLOAT8:case REAL:t=activity_jsonschema_1.JsonSchema.Types.numberType();break;case BIT:case BOOLEAN:t=activity_jsonschema_1.JsonSchema.Types.boolType();break;case VARCHAR:case TEXT:case MEDIUMTEXT:case LONGTEXT:case CHAR:case BPCHAR:case ANYENUM:case POINT:case NCHAR:case CHARACTER:t=activity_jsonschema_1.JsonSchema.Types.stringType();break;case DATE:case TIMESTAMPTZ:t=activity_jsonschema_1.JsonSchema.Types.dateType();break;case TIMESTAMP:t=activity_jsonschema_1.JsonSchema.Types.timeType();break;default:t=activity_jsonschema_1.JsonSchema.Types.stringType()}return t},e.prototype.fetchQueryMetadata=function(t,r,a,s){var n=this;return Rx_1.Observable.of(t).filter(function(e){return function(e){return!!e&&e.trim().length>0}(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")}).map(function(e){return Object.assign({queryString:e,queryURL:n.dbserviceURL,connection:n})}).mergeMap(function(e){return a(r,e)}).mergeMap(function(r){return e.createFields(t,r.Fields,s)})},e.sortFields=function(e,t){return e.Ordinal-t.Ordinal},e.createFields=function(t,r,a){var s=r;if(null!=s){for(var n=[(s=s.filter(function(e){return null!=e}).sort(e.sortFields))[0]],i=1;i<s.length;i++){for(var c=!1,o=0;o<n.length;o++)if(i!==o&&s[i].FieldName===n[o].FieldName){void 0!==s[i].Value&&(n[o].Value=s[i].Value),c=!0;break}c||n.push(s[i])}s=n}return Rx_1.Observable.from(s).reduce(function(t,r){if(r){var a={FieldName:r.FieldName,Type:r.Type,Selected:r.Selected,Parameter:r.Parameter,isEditable:!1,Ordinal:r.Ordinal};r.Value&&(a.Value=r.Value),t.fields.push(a),t.fields.sort(e.sortFields)}return t},{ok:!0,query:t,fields:[]})},e.getConnection=function(t){var r=new e;return Rx_1.Observable.from(t).reduce(function(e,t){return e[t.name]=t.value,e},r)},e.getOutputSchema=function(t){var r=this,a=activity_jsonschema_1.JsonSchema.Types.rootObject(),s=activity_jsonschema_1.JsonSchema.Types.outputObject();a.properties.records=s.records;var n=a.properties.records.items.properties;return Rx_1.Observable.from(t).filter(function(e){return r.getBoolean(e.Selected)}).reduce(function(t,r){return t[r.FieldName]=e.toJsonSchema(r),t},n).mergeMap(function(e){return Rx_1.Observable.of(a)})},e.getBoolean=function(e){switch(e){case!0:case"true":case 1:case"1":case"on":case"yes":return!0;default:return!1}},e.getInsertInputSchema=function(t){var r=activity_jsonschema_1.JsonSchema.Types.rootObject(),a=activity_jsonschema_1.JsonSchema.Types.valuesObject();r.properties.values=a.records;var s=activity_jsonschema_1.JsonSchema.Types.inputObject();return r.properties.parameters=s.parameters,Rx_1.Observable.from(t).reduce(function(t,r){return!0===r.Value&&(t.properties.values.items.properties[r.FieldName]=e.toJsonSchema(r)),!0===r.Parameter&&!1===r.Value&&(t.properties.parameters.properties[r.FieldName]=e.toJsonSchema(r)),t},r).mergeMap(function(e){return Rx_1.Observable.of(r)})},e.getInputSchema=function(t){var r=this,a=activity_jsonschema_1.JsonSchema.Types.rootObject(),s=activity_jsonschema_1.JsonSchema.Types.inputObject();a.properties.parameters=s.parameters;var n=a.properties.parameters.properties;return Rx_1.Observable.from(t).filter(function(e){return r.getBoolean(e.Parameter)}).reduce(function(t,r){return t[r.FieldName]=e.toJsonSchema(r),t},n).mergeMap(function(e){return Rx_1.Observable.of(a)})},e}();exports.Connection=Connection;
//# sourceMappingURL=connection.js.map
