"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__decorate=this&&this.__decorate||function(t,e,n,o){var r,a=arguments.length,i=a<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,o);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(i=(a<3?r(i):a>3?r(e,n,i):r(e,n))||i);return a>3&&i&&Object.defineProperty(e,n,i),i},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(t,e){return function(n,o){e(n,o,t)}};Object.defineProperty(exports,"__esModule",{value:!0});var Rx_1=require("rxjs/Rx"),http_1=require("@angular/http"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),connection_1=require("./connection"),TDVProcedureActivityContribution=function(t){function e(e,n){var o=t.call(this,e,n)||this;return o.http=n,o.procedureColumnsURL="/dbservicego/dbservice/procedurecolumns",o.procedureListURL="/dbservicego/dbservice/procedures",o.catalogListURL="/dbservicego/dbservice/catalogs",o.schemaListURL="/dbservicego/dbservice/schemas",o.value=function(t,e){var n=function(t){return function(t){return!!t&&t.trim().length>0}(t)},r=o.getContextVar(e,"Connection"),a=o.getContextVar(e,"ConnectionState"),i=o.getContextVar(e,"CatalogState"),c=o.getContextVar(e,"SchemaState"),s=o.getContextVar(e,"State"),u=o.getContextVar(e,"Catalog"),l=o.getContextVar(e,"Schema"),d=o.getContextVar(e,"Procedure"),f=(o.getContextFetchData(e,"Fields"),wi_contrib_1.WiContributionUtils.getUniqueId(e)),p=f+r,b=f+r+u,_=f+r+u+l,g=f+r+u+l+d,v=f+r+u+l+d;switch(o.validations[f]||(o.validations[f]={}),t){case"Connection":return wi_contrib_1.WiContributionUtils.getConnections(o.http,o.category).mergeMap(function(t){return t}).mergeMap(function(t){return Rx_1.Observable.from(t.settings).filter(function(t){return"name"===t.name}).map(function(e){return{unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(t),name:e.value}})}).reduce(function(t,e){return t.push(e),t},[]);case"Catalog":return""===r?Rx_1.Observable.of(null):Rx_1.Observable.of(p).switchMap(function(t){return t===a?Rx_1.Observable.of(null):Rx_1.Observable.of({cname:r}).switchMap(function(t){return wi_contrib_1.WiContributionUtils.getConnection(o.http,t.cname)}).switchMap(function(t){return connection_1.Connection.getConnection(t.settings)}).switchMap(function(t){return o.fetchCatalogList(t)}).map(function(t){try{return t}catch(t){throw{message:"fetchCatalogList failed; unable to access dbservice"}}})});case"Schema":return""===r?Rx_1.Observable.of(null):Rx_1.Observable.of(b).switchMap(function(t){return t===i?Rx_1.Observable.of(null):Rx_1.Observable.of({cname:r}).switchMap(function(t){return wi_contrib_1.WiContributionUtils.getConnection(o.http,t.cname)}).switchMap(function(t){return connection_1.Connection.getConnection(t.settings)}).switchMap(function(t){return o.fetchSchemaList(t,u)}).map(function(t){try{return t}catch(t){throw{message:"fetchSchemaList failed; unable to access dbservice"}}})});case"Procedure":return""===r?Rx_1.Observable.of(null):Rx_1.Observable.of(_).switchMap(function(t){return t===c?Rx_1.Observable.of(null):Rx_1.Observable.of({cname:r}).switchMap(function(t){return wi_contrib_1.WiContributionUtils.getConnection(o.http,t.cname)}).switchMap(function(t){return connection_1.Connection.getConnection(t.settings)}).switchMap(function(t){return o.fetchProcedureList(t,u,l)}).map(function(t){try{return t}catch(t){throw{message:"fetchProcedure failed; unable to access dbservice"}}})});case"Fields":return""!==r&&""!==u&&""!==l&&""!==d&&n(d)?Rx_1.Observable.of(g).switchMap(function(t){return t===s?o.handleIncomplete(f):Rx_1.Observable.of(d)}).map(function(t){return{query:d,catalogName:u,schemaName:l,cname:r,uid:f}}).switchMap(function(r){return g!==s&&n(d)?o.fetchQueryMetadata(r,o.getContextVar(e,t),u,l):o.getFields(r.query,o.getContextVar(e,t))}).map(function(t){return o.validations[f].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!0)),o.messaging.emit(v+"output",t),o.messaging.emit(v+"input",t),t.ok?JSON.stringify(t.fields):null}):JSON.stringify(JSON.parse("[]"));case"input":return""===r||""===u||""===l||""===d?Rx_1.Observable.of(null):Rx_1.Observable.create(function(t){o.messaging.on(v+"input",function(e){null!==e&&(o.messaging.off(v+"input"),t.next(e))})}).switchMap(function(t){return t.ok?connection_1.Connection.getInputSchema(t.fields).map(function(t){return JSON.stringify(t)}):Rx_1.Observable.of(null)});case"Output":return""===r||""===u||""===l||""===d?Rx_1.Observable.of(null):Rx_1.Observable.create(function(t){o.messaging.on(v+"output",function(e){null!==e&&(o.messaging.off(v+"output"),t.next(e))})}).switchMap(function(t){return t.ok?connection_1.Connection.getOutputSchema(t.fields).map(function(t){return JSON.stringify(t)}):Rx_1.Observable.of(null)});case"ConnectionState":return Rx_1.Observable.of(p);case"CatalogState":return Rx_1.Observable.of(b);case"SchemaState":return Rx_1.Observable.of(_);case"State":return Rx_1.Observable.of(g);default:return null}},o.getFields=function(t,e){return connection_1.Connection.createFields(t,""===e?JSON.parse("[]"):JSON.parse(e),null).map(function(t){return""===e&&(t.ok=!1),t})},o.fetchQueryMetadata=function(t,e,n,r){return Rx_1.Observable.of(t).switchMap(function(t){return wi_contrib_1.WiContributionUtils.getConnection(o.http,t.cname)}).switchMap(function(t){return connection_1.Connection.getConnection(t.settings)}).switchMap(function(a){return a.fetchQueryMetadata(t.query,n,r,o.procedureColumnsURL,o.getSchema,e)}).map(function(e){return o.validations[t.uid].Procedure=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),o.validations[t.uid].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),e}).catch(function(e){var n=e instanceof http_1.Response?e.json().error.message:e.message;return o.validations[t.uid].Procedure=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("TDV-QRY-MSG-1300",n)),Rx_1.Observable.of({ok:!1,message:n,query:t.qdata})})},o.handleIncomplete=function(t){return o.validations[t].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0).setReadOnly(!0).setFetchUI(!1)),Rx_1.Observable.of(null)},o.validate=function(t,e){var n=wi_contrib_1.WiContributionUtils.getUniqueId(e);return o.validations[n]||(o.validations[n]={}),o.validations[n][t]},o.getCatalog=function(t){return Rx_1.Observable.of(t).switchMap(function(t){return wi_contrib_1.WiContributionUtils.getConnection(o.http,t.cname)}).switchMap(function(t){return connection_1.Connection.getConnection(t.settings)}).switchMap(function(t){return o.fetchCatalogList(t)}).map(function(t){try{return t}catch(t){throw{message:"fetchCatalogList failed; unable to access dbservice"}}})},o.fetchCatalogList=function(t){var e,n,r,a,i,c,s,u,l="";if(e=btoa("tdv"),n=btoa(t.server),r=btoa(t.port.toString()),a=btoa(t.datasource),c=btoa(t.user),i=btoa(t.domain),s=btoa(t.password),btoa(t.tlsparam),u=btoa(t.name),null!=t.tlsconfig&&!0===t.tlsconfig){var d={encrypt:{type:"string",value:"true"},validateRemoteCert:{type:"string",value:"true"}},f=t.cacert.content;null!=f&&""!==f&&(d.sslCACert={type:"file",extension:"pem",value:f}),l=btoa(JSON.stringify(d))}return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.catalogListURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===t.onprem?"false":t.onprem.toString()).addHeader("DatabaseType","tdv").addBody("Driver="+e+"&Server="+n+"&Port="+r+"&DataSource="+a+"&Domain="+i+"&Uid="+c+"&Pwd="+s+"&ConnectionID="+u+"&SSLData="+l).send().map(function(t){try{var e=JSON.parse(JSON.stringify(t.json().data));return e.unshift("All"),e}catch(t){throw{message:"connection failed: unable to access dbservice"}}})},o.fetchSchemaList=function(t,e){"All"===e&&(e="");var n,r,a,i,c,s,u,l,d="";if(n=btoa("tdv"),r=btoa(t.server),a=btoa(t.port.toString()),i=btoa(t.datasource),s=btoa(t.user),c=btoa(t.domain),u=btoa(t.password),btoa(t.tlsparam),l=btoa(t.name),null!=t.tlsconfig&&!0===t.tlsconfig){var f={encrypt:{type:"string",value:"true"},validateRemoteCert:{type:"string",value:"true"}},p=t.cacert.content;null!=p&&""!==p&&(f.sslCACert={type:"file",extension:"pem",value:p}),d=btoa(JSON.stringify(f))}return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.schemaListURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===t.onprem?"false":t.onprem.toString()).addHeader("DatabaseType","tdv").addBody("Driver="+n+"&Server="+r+"&Port="+a+"&DataSource="+i+"&Domain="+c+"&Uid="+s+"&Pwd="+u+"&ConnectionID="+l+"&SSLData="+d+"&catalog="+e).send().map(function(t){try{var n=JSON.parse(JSON.stringify(t.json().data));return""===e&&n.unshift("Public"),n}catch(t){throw{message:"connection failed: unable to access dbservice"}}})},o.fetchProcedureList=function(t,e,n){(new Date).getTime();"All"===e&&(e=""),"Public"===n&&(n="");var r,a,i,c,s,u,l,d,f="";if(r=btoa("tdv"),a=btoa(t.server),i=btoa(t.port.toString()),c=btoa(t.datasource),u=btoa(t.user),s=btoa(t.domain),l=btoa(t.password),btoa(t.tlsparam),d=btoa(t.name),null!=t.tlsconfig&&!0===t.tlsconfig){var p={encrypt:{type:"string",value:"true"},validateRemoteCert:{type:"string",value:"true"}},b=t.cacert.content;null!=b&&""!==b&&(p.sslCACert={type:"file",extension:"pem",value:b}),f=btoa(JSON.stringify(p))}return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.procedureListURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===t.onprem?"false":t.onprem.toString()).addHeader("DatabaseType","tdv").addBody("Driver="+r+"&Server="+a+"&Port="+i+"&DataSource="+c+"&Domain="+s+"&Uid="+u+"&Pwd="+l+"&ConnectionID="+d+"&SSLData="+f+"&catalog="+e+"&schema="+n).send().map(function(t){try{return JSON.parse(JSON.stringify(t.json().data))}catch(t){throw{message:"connection failed: unable to access dbservice"}}})},o.getSchema=function(t,e,n,r){"All"===n&&(n=""),"Public"===r&&(r="");var a,i,c,s,u,l,d,f,p,b,_="";if(i=(b=r)&&b.trim().length>0?r:"",a=btoa("tdv"),c=btoa(e.connection.server),s=btoa(e.connection.port.toString()),u=btoa(e.connection.datasource),d=btoa(e.connection.user),l=btoa(e.connection.domain),f=btoa(e.connection.password),btoa(e.connection.tlsparam),p=btoa(e.connection.name),null!=e.connection.tlsconfig&&!0===e.connection.tlsconfig){var g={encrypt:{type:"string",value:"true"},validateRemoteCert:{type:"string",value:"true"}},v=e.connection.cacert.content;null!=v&&""!==v&&(g.sslCACert={type:"file",extension:"pem",value:v}),_=btoa(JSON.stringify(g))}var m=e.queryString;return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(o.http,o.procedureColumnsURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===e.connection.onprem?"false":e.connection.onprem.toString()).addHeader("DatabaseType","tdv").addBody("Driver="+a+"&Server="+c+"&Port="+s+"&DataSource="+u+"&Domain="+l+"&Uid="+d+"&Pwd="+f+"&ConnectionID="+p+"&procedure="+m+"&SSLData="+_+"&catalog="+n+"&schema="+i).send().map(function(t){try{return t.json()}catch(t){throw{message:"connection failed; unable to access dbservice"}}})},o.messaging=new wi_contrib_1.WiContribMessaging,o.validations={},o.category="TDV",o}return __extends(e,t),e.prototype.getContextVar=function(t,e){var n=t.getField(e);return n&&n.value?n.value:""},e.prototype.getContextFetchData=function(t,e){var n=t.getField(e);if(null!=n){var o=n.display.fetchQuery;if(o&&""!==o)return o}return""},e.prototype.getContextVarBool=function(t,e){var n=t.getField(e);return!(!n||!n.value)&&n.value},e}(wi_contrib_1.WiServiceHandlerContribution);TDVProcedureActivityContribution=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],TDVProcedureActivityContribution),exports.TDVProcedureActivityContribution=TDVProcedureActivityContribution;var SQLQueryEncoder=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.encodeKey=function(t){return encodeURIComponent(t)},e.prototype.encodeValue=function(t){return encodeURIComponent(t)},e}(http_1.QueryEncoder);
//# sourceMappingURL=activity.js.map
