"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var o,a=arguments.length,r=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(r=(a<3?o(r):a>3?o(t,n,r):o(t,n))||r);return a>3&&r&&Object.defineProperty(t,n,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions"),validation_1=require("wi-studio/common/models/validation"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),Result=function(){return function(e,t,n){}}(),Connection=function(){return function(){}}();exports.Connection=Connection;var TibcoMySQLConnectorContribution=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.http=n,i.value=function(e,t){return null},i.connection=function(e){var t=new Connection;return rxjs_extensions_1.Observable.from(e).reduce(function(e,t){return e[t.name]=t.value,e},t)},i.validate=function(e,t){var n,o;switch(e){case"tlsparam":return n=t.getField("tlsparam").value.toString(),(o=t.getField("tlsconfig"))&&o.value?void 0===o.value||null===o.value||!1===o.value?validation_1.ValidationResult.newValidationResult().setVisible(!1):validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1);case"validatecert":n=t.getField("tlsparam").value.toString(),o=t.getField("tlsconfig");var a=validation_1.ValidationResult.newValidationResult();return o&&o.value&&!0===o.value&&"VerifyCA"===n?a.setVisible(!0):a.setVisible(!1),a;case"cacert":case"clientcert":case"clientkey":return n=t.getField("tlsparam").value.toString(),(o=t.getField("tlsconfig"))&&o.value&&n?validation_1.ValidationResult.newValidationResult().setVisible(i.fileBrowseOptionSetVisible(o.value,n)):validation_1.ValidationResult.newValidationResult().setVisible(!1);case"onprem":return rxjs_extensions_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getAppConfig(i.http).subscribe(function(t){t.deployment===wi_contrib_1.APP_DEPLOYMENT.ON_PREMISE?(i.onPremise=!0,e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))):(i.onPremise=!1,e.next(validation_1.ValidationResult.newValidationResult().setVisible(!0)))},function(t){i.onPremise=!0,e.next(validation_1.ValidationResult.newValidationResult().setVisible(!1))},function(){return e.complete()})});case"maxconnectattempts":var r=t.getField("maxconnectattempts");if(r&&r.value&&r.value<0)return validation_1.ValidationResult.newValidationResult().setError("MYSQL-1001","Maximum Connection Retry Attempt must be a non-negative number");case"connectionretrydelay":var s=t.getField("connectionretrydelay");if(s&&s.value&&s.value<0)return validation_1.ValidationResult.newValidationResult().setError("MYSQL-1002","Connection Retry Delay must be a non-negative number");case"connectiontimeout":if(t.getField("connectiontimeout").value<0)return validation_1.ValidationResult.newValidationResult().setError("MYSQL-1003","Connection Timeout must be a non-negative number");default:return null}},i.isDuplicate=function(e,t){return wi_contrib_1.WiContributionUtils.getConnections(i.http,i.category).mergeMap(function(e){return e}).map(function(e){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(e),ction:i.connection(e.settings)}}).filter(function(e){return e.id!==t}).mergeMap(function(e){return e.ction}).filter(function(t){return t.name===e.name}).reduce(function(e,t){return e.push(t),e},[]).map(function(e){return e.length>0})},i.action=function(e,t){var n="";if("Connect"===e)return i.connection(t.settings).switchMap(function(e){return i.isDuplicate(e,wi_contrib_1.WiContributionUtils.getUniqueId(t)).map(function(t){if(t)throw new Error("Connection with name "+e.name+" already exists");return e})}).switchMap(function(e){var o,a,r,s,l,c,u,d="";if(o=btoa("mysql"),a=btoa(e.host),r=btoa(e.port.toString()),s=btoa(e.databaseName),l=btoa(e.user),c=btoa(e.password),e.tlsparam&&(d=btoa(e.tlsparam)),u=btoa(e.name),null!=e.tlsconfig&&!0===e.tlsconfig){var _={},f=e.cacert.filename.split(".").pop(),b=e.cacert.content;null!=b&&""!==b&&(_.SSLCA={type:"file",extension:f,value:b});var p=e.clientcert.filename.split(".").pop(),v=e.clientcert.content;null!=v&&""!==v&&(_.SSLCERT={type:"file",extension:p,value:v});var m=e.clientkey.filename.split(".").pop(),w=e.clientkey.content;null!=w&&""!==w&&(_.SSLKEY={type:"file",extension:m,value:w}),"VerifyIdentity"===e.tlsparam||"VerifyCA"===e.tlsparam&&!0===e.validatecert?_.SSLVERIFY={type:"string",value:"1"}:_.SSLVERIFY={type:"string",value:"0"},n=btoa(JSON.stringify(_))}return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(i.http,i.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===e.onprem?"false":e.onprem.toString()).addHeader("DatabaseType","mysql").addBody("Driver="+o+"&Server="+a+"&Port="+r+"&Database="+s+"&Uid="+l+"&Pwd="+c+"&SSLMode="+d+"&ConnectionID="+u+"&SSLData="+n).send().switchMap(function(e){try{e.json();if("SUCCESS"===e.json().status){var n={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(n))}}catch(e){console.log("connection failed; unable to access dbservice");return rxjs_extensions_1.Observable.throw({message:"connection failed; unable to access dbservice"})}})}).catch(function(e){if(void 0!==e.message)return console.log("test connection failed: "+e.message),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("MYSQL-1002","test connection failed: "+e.message)));try{return console.log("test connection failed: "+e.json().error.message),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("MYSQL-1001","test connection failed: "+e.json().error.message)))}catch(t){return console.log("test connection failed: "+e),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("MYSQL-1002","test connection failed: "+e)))}})},i.dbserviceURL="/dbservicego/api/v2/dbtest",i.category="MySQL",i}return __extends(t,e),t.prototype.fileBrowseOptionSetVisible=function(e,t){return!0===e&&null!=t},t}(wi_contrib_1.WiServiceHandlerContribution);TibcoMySQLConnectorContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],TibcoMySQLConnectorContribution),exports.TibcoMySQLConnectorContribution=TibcoMySQLConnectorContribution;
//# sourceMappingURL=connector.js.map
