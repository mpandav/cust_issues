"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var activity_jsonschema_1=require("./activity.jsonschema"),Rx_1=require("rxjs/Rx");require("rxjs/Rx");var SMALLINT="SMALLINT",INTEGER="INTEGER",BIGINT="BIGINT",INT="INT",INT2="INT2",INT4="INT4",INT8="INT8",NUMERIC="NUMERIC",DECIMAL="DECIMAL",REAL="REAL",FLOAT="FLOAT",FLOAT4="FLOAT4",FLOAT8="FLOAT8",DOUBLE="DOUBLE",BOOLEAN="BOOLEAN",CHAR="CHAR",BPCHAR="BPCHAR",NCHAR="NCHAR",CHARACTER="CHARACTER",VARCHAR="VARCHAR",TEXT="TEXT",MEDIUMTEXT="MEDIUMTEXT",LONGTEXT="LONGTEXT",DATE="DATE",TIMESTAMP="TIMESTAMP",TIMESTAMPTZ="TIMESTAMPTZ",BLOB="BLOB",TINYBLOB="TINYBLOB",MEDIUMBLOB="MEDIUMBLOB",LONGBLOB="LONGBLOB",QueryMetadata=function(){return function(e,t,a,r){this.ok=e,this.message=t,this.query=a,this.fields=r}}();exports.QueryMetadata=QueryMetadata;var Fields=function(){return function(e,t,a,r,s,n){this.FieldName=e,this.Type=t,this.Selected=a,this.Parameter=r,this.isEditable=s,this.Ordinal=n,this.isEditable=!1}}();exports.Fields=Fields;var Connection=function(){function e(){this.dbserviceURL="/dbservice/api/v2/schema",this.queries=[]}return e.toJsonType=function(e){var t={};switch(e.Type){case SMALLINT:case INTEGER:case BIGINT:case INT:case INT2:case INT4:case INT8:t=activity_jsonschema_1.JsonSchema.Types.integerType();break;case DOUBLE:case DECIMAL:case NUMERIC:case FLOAT:case FLOAT4:case FLOAT8:case REAL:t=activity_jsonschema_1.JsonSchema.Types.numberType();break;case BOOLEAN:t=activity_jsonschema_1.JsonSchema.Types.boolType();break;case VARCHAR:case TEXT:case MEDIUMTEXT:case LONGTEXT:case CHAR:case BPCHAR:case NCHAR:case CHARACTER:t=activity_jsonschema_1.JsonSchema.Types.stringType();break;case DATE:case TIMESTAMPTZ:t=activity_jsonschema_1.JsonSchema.Types.dateType();break;case TIMESTAMP:t=activity_jsonschema_1.JsonSchema.Types.timeType();break;default:t=activity_jsonschema_1.JsonSchema.Types.stringType()}return t},e.prototype.fetchQueryMetadata=function(t,a,r,s,n){var i=this;return Rx_1.Observable.of(t).filter(function(e){return function(e){return!!e&&e.trim().length>0}(e)&&e.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")}).map(function(e){return Object.assign({queryString:e,queryURL:i.dbserviceURL,connection:i})}).mergeMap(function(e){return r(a,e)}).mergeMap(function(a){return e.createFields(t,a.Fields,s,n)})},e.sortFields=function(e,t){return e.Ordinal-t.Ordinal},e.createFields=function(t,a,r,s){var n=a;if(r&&void 0!==s&&""!==s&&(n=n.concat(JSON.parse(s))),null!=n){for(var i=[(n=n.filter(function(e){return null!=e}).sort(e.sortFields))[0]],c=1;c<n.length;c++){for(var T=!1,o=0;o<i.length;o++)if(c!==o&&n[c].FieldName===i[o].FieldName){void 0!==n[c].Value&&(i[o].Value=n[c].Value),T=!0;break}T||i.push(n[c])}n=i}return Rx_1.Observable.from(n).reduce(function(t,a){if(a){var s={FieldName:a.FieldName,Type:a.Type,Selected:a.Selected,Parameter:a.Parameter,isEditable:r,Ordinal:a.Ordinal};a.Value&&(s.Value=a.Value),t.fields.push(s),t.fields.sort(e.sortFields)}return t},{ok:!0,query:t,fields:[]})},e.getConnection=function(t){var a=new e;return Rx_1.Observable.from(t).reduce(function(e,t){return e[t.name]=t.value,e},a)},e.getUpdateInputSchema=function(t){var a=activity_jsonschema_1.JsonSchema.Types.rootObject(),r=activity_jsonschema_1.JsonSchema.Types.inputObject();return a.properties.parameters=r.parameters,Rx_1.Observable.from(t).reduce(function(t,a){return!0!==a.Parameter&&"true"!==a.Parameter||(t.properties.parameters.properties[a.FieldName]=e.toJsonType(a)),t},a).mergeMap(function(e){return Rx_1.Observable.of(a)})},e}();exports.Connection=Connection;
//# sourceMappingURL=connection.js.map
