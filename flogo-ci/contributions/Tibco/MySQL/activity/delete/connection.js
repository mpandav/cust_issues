"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var activity_jsonschema_1=require("./activity.jsonschema"),Rx_1=require("rxjs/Rx");require("rxjs/Rx");var SMALLINT="SMALLINT",INTEGER="INTEGER",BIGINT="BIGINT",INT="INT",INT2="INT2",INT4="INT4",INT8="INT8",NUMERIC="NUMERIC",DECIMAL="DECIMAL",REAL="REAL",FLOAT="FLOAT",FLOAT4="FLOAT4",FLOAT8="FLOAT8",DOUBLE="DOUBLE",BOOLEAN="BOOLEAN",CHAR="CHAR",BPCHAR="BPCHAR",NCHAR="NCHAR",CHARACTER="CHARACTER",VARCHAR="VARCHAR",TEXT="TEXT",MEDIUMTEXT="MEDIUMTEXT",LONGTEXT="LONGTEXT",DATE="DATE",TIMESTAMP="TIMESTAMP",TIMESTAMPTZ="TIMESTAMPTZ",QueryMetadata=function(){return function(e,r,t,a){this.ok=e,this.message=r,this.query=t,this.fields=a}}();exports.QueryMetadata=QueryMetadata;var Fields=function(){return function(e,r,t,a,s,n){this.FieldName=e,this.Type=r,this.Selected=t,this.Parameter=a,this.isEditable=s,this.Ordinal=n,this.isEditable=!1}}();exports.Fields=Fields;var Connection=function(){function e(){this.dbserviceURL="/dbservice/api/v2/schema",this.queries=[]}return e.toJsonType=function(e){var r={};switch(e.Type){case SMALLINT:case INTEGER:case BIGINT:case INT:case INT2:case INT4:case INT8:r=activity_jsonschema_1.JsonSchema.Types.integerType();break;case DOUBLE:case DECIMAL:case NUMERIC:case FLOAT:case FLOAT4:case FLOAT8:case REAL:r=activity_jsonschema_1.JsonSchema.Types.numberType();break;case BOOLEAN:r=activity_jsonschema_1.JsonSchema.Types.boolType();break;case VARCHAR:case TEXT:case MEDIUMTEXT:case LONGTEXT:case CHAR:case BPCHAR:case NCHAR:case CHARACTER:r=activity_jsonschema_1.JsonSchema.Types.stringType();break;case DATE:case TIMESTAMPTZ:r=activity_jsonschema_1.JsonSchema.Types.dateType();break;case TIMESTAMP:r=activity_jsonschema_1.JsonSchema.Types.timeType();break;default:r=activity_jsonschema_1.JsonSchema.Types.stringType()}return r},e.prototype.fetchQueryMetadata=function(r,t,a,s,n){var i=this;return Rx_1.Observable.of(r).map(function(e){return Object.assign({queryString:e,queryURL:i.dbserviceURL,connection:i})}).mergeMap(function(e){return a(t,e)}).mergeMap(function(t){return e.createFields(r,t.Fields,s,n)})},e.sortFields=function(e,r){return e.Ordinal-r.Ordinal},e.createFields=function(r,t,a,s){var n=t;if(a&&void 0!==s&&""!==s&&(n=n.concat(JSON.parse(s))),null!=n){for(var i=[(n=n.filter(function(e){return null!=e}).sort(e.sortFields))[0]],c=1;c<n.length;c++){for(var o=!1,T=0;T<i.length;T++)if(c!==T&&n[c].FieldName===i[T].FieldName){o=!0;break}o||i.push(n[c])}n=i}return Rx_1.Observable.from(n).reduce(function(r,t){if(t){var s={FieldName:t.FieldName,Type:t.Type,Selected:t.Selected,Parameter:t.Parameter,isEditable:a,Ordinal:t.Ordinal};t.Value&&(s.Value=t.Value),r.fields.push(s),r.fields.sort(e.sortFields)}return r},{ok:!0,query:r,fields:[]})},e.getConnection=function(r){var t=new e;return Rx_1.Observable.from(r).reduce(function(e,r){return e[r.name]=r.value,e},t)},e.getOutputSchema=function(r){var t=activity_jsonschema_1.JsonSchema.Types.rootObject(),a=activity_jsonschema_1.JsonSchema.Types.outputObject();t.properties.records=a.records;var s=t.properties.records.items.properties;return Rx_1.Observable.from(r).filter(function(e){return!0===e.Selected||"true"===e.Parameter}).reduce(function(r,t){return r[t.FieldName]=e.toJsonType(t),r},s).mergeMap(function(e){return Rx_1.Observable.of(t)})},e.getInputSchema=function(r){var t=activity_jsonschema_1.JsonSchema.Types.rootObject(),a=activity_jsonschema_1.JsonSchema.Types.inputObject();t.properties.parameters=a.parameters;var s=t.properties.parameters.properties;return Rx_1.Observable.from(r).filter(function(e){return!0===e.Parameter||"true"===e.Parameter}).reduce(function(r,t){return r[t.FieldName]=e.toJsonType(t),r},s).mergeMap(function(e){return Rx_1.Observable.of(t)})},e}();exports.Connection=Connection;
//# sourceMappingURL=connection.js.map
