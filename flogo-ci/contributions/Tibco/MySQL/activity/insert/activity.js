"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(t,e,n,i){var r,o=arguments.length,a=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,i);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(a=(o<3?r(a):o>3?r(e,n,a):r(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(t,e){return function(n,i){e(n,i,t)}};Object.defineProperty(exports,"__esModule",{value:!0});var Rx_1=require("rxjs/Rx"),http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),connection_1=require("./connection"),wi_contrib_internal_1=require("wi-studio/app/contrib/wi-contrib-internal"),MySQLInsertActivityContribution=function(t){function e(e,n){var i=t.call(this,e,n)||this;return i.http=n,i.dbserviceURL="/dbservicego/api/v2/schema",i.value=function(t,e){var n=function(t){return!!t&&t.trim().length>0},r=function(t){return n(t)&&t.replace(/(\r\n|\n|\r)/gm,"").endsWith(";")},o=i.getContextVar(e,"Connection"),a=i.getContextVar(e,"State"),c=i.getContextVar(e,"InsertStatement"),s=i.getContextVarBool(e,"manualmode"),u=i.getContextFetchData(e,"Fields"),l=wi_contrib_1.WiContributionUtils.getUniqueId(e),d=s?u:c;s&&n(d)&&!d.endsWith(";")&&(d+=";");var f=l+d,p=l+o;switch(i.validations[l]||(i.validations[l]={}),t){case"Connection":return wi_contrib_1.WiContributionUtils.getConnections(i.http,i.category).mergeMap(function(t){return t}).mergeMap(function(t){return Rx_1.Observable.from(t.settings).filter(function(t){return"name"===t.name}).map(function(e){return{unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(t),name:e.value}})}).reduce(function(t,e){return t.push(e),t},[]);case"Fields":return Rx_1.Observable.of(f).switchMap(function(t){return t!==a&&""!==o&&r(d)?Rx_1.Observable.of(d):i.handleIncomplete(l,s)}).map(function(t){return{query:d,cname:o,uid:l}}).switchMap(function(n){return f!==a&&r(d)?i.fetchQueryMetadata(n,s,i.getContextVar(e,t)):i.getFields(n.query,i.getContextVar(e,t),s)}).map(function(t){return i.messaging.emit(p+"output",t),i.messaging.emit(p+"input",t),e.isQuery?{isSuccess:t.ok,error:t.message,value:t.ok?JSON.stringify(t.fields):null}:t.ok?JSON.stringify(t.fields):null});case"manualmode":return i.validations[l].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setReadOnly(!s).setFetchUI(s)),null;case"input":return""===o?Rx_1.Observable.of(null):Rx_1.Observable.create(function(t){i.messaging.on(p+"input",function(e){null!==e&&(i.messaging.off(p+"input"),t.next(e))})}).switchMap(function(t){return t.ok?connection_1.Connection.getInsertInputSchema(t.fields).map(function(t){return JSON.stringify(t)}):Rx_1.Observable.of(null)});case"Output":var _;return Rx_1.Observable.create(function(t){_={type:"object",properties:{rowsAffected:{type:"int"},lastInsertId:{type:"int"}}},t.next(JSON.stringify(_))});case"State":return Rx_1.Observable.of(f);default:return null}},i.getFields=function(t,e,n){return connection_1.Connection.createFields(t,""===e?JSON.parse("[]"):JSON.parse(e),n,null).map(function(t){return""===e&&(t.ok=!1),t})},i.fetchQueryMetadata=function(t,e,n){return Rx_1.Observable.of(t).switchMap(function(t){return wi_contrib_1.WiContributionUtils.getConnection(i.http,t.cname)}).switchMap(function(t){return connection_1.Connection.getConnection(t.settings)}).switchMap(function(r){return r.fetchQueryMetadata(t.query,i.dbserviceURL,i.getSchema,e,n)}).map(function(e){return i.validations[t.uid].InsertStatement=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),i.validations[t.uid].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),e}).catch(function(n){var r=n instanceof http_1.Response?n.json().error.message:n.message;return e?i.validations[t.uid].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("MYSQL-QRY-MSG-1200",r)):i.validations[t.uid].InsertStatement=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setError("MYSQL-QRY-MSG-1200",r)),Rx_1.Observable.of({ok:!1,message:r,query:t.qdata})})},i.handleIncomplete=function(t,e){return i.validations[t].InsertStatement=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0)),i.validations[t].Fields=Rx_1.Observable.of(wi_contrib_1.ValidationResult.newValidationResult().setValid(!0).setReadOnly(!e).setFetchUI(e)),Rx_1.Observable.of(null)},i.validate=function(t,e){var n=wi_contrib_1.WiContributionUtils.getUniqueId(e);return i.validations[n]||(i.validations[n]={}),i.validations[n][t]},i.getSchema=function(t,e){var n,r,o,a,c,s,u,l="";e.queryString=e.queryString.replace(/%/g,"%25"),e.queryString=e.queryString.replace(/(\n)/g," "),e.queryString=e.queryString.replace(/(GROUP_CONCAT *\()(.*?)(SEPARATOR *[\'‘’].*?[\'‘’])/gi,"$1$2");var d="";if(n=btoa("mysql"),r=btoa(e.connection.host),o=btoa(e.connection.port.toString()),a=btoa(e.connection.databaseName),c=btoa(e.connection.user),s=btoa(e.connection.password),e.connection.tlsparam&&(d=btoa(e.connection.tlsparam)),u=btoa(e.connection.name),null!=e.connection.tlsconfig&&!0===e.connection.tlsconfig){var f={},p=e.connection.cacert.filename.split(".").pop(),_=e.connection.cacert.content;null!=_&&""!==_&&(f.SSLCA={type:"file",extension:p,value:_});var b=e.connection.clientcert.filename.split(".").pop(),v=e.connection.clientcert.content;null!=v&&""!==v&&(f.SSLCERT={type:"file",extension:b,value:v});var g=e.connection.clientkey.filename.split(".").pop(),y=e.connection.clientkey.content;null!=y&&""!==y&&(f.SSLKEY={type:"file",extension:g,value:y}),"VerifyIdentity"===e.connection.tlsparam||"VerifyCA"===e.connection.tlsparam&&!0===e.connection.validatecert?f.SSLVERIFY={type:"string",value:"1"}:f.SSLVERIFY={type:"string",value:"0"},l=btoa(JSON.stringify(f))}var m=encodeURIComponent(e.queryString);return wi_contrib_internal_1.WiInternalProxyCORSUtils.createRequest(i.http,i.dbserviceURL.slice(1),"TCI_DBSERVICE").addMethod("POST").addHeader("Content-Type","application/x-www-form-urlencoded").addHeader("Accept","application/json").addHeader("onpremise",void 0===e.connection.onprem?"false":e.connection.onprem.toString()).addHeader("DatabaseType","mysql").addBody("Driver="+n+"&Server="+r+"&Port="+o+"&Database="+a+"&Uid="+c+"&Pwd="+s+"&query="+m+"&SSLMode="+d+"&ConnectionID="+u+"&SSLData="+l).send().map(function(t){try{return t.json()}catch(t){throw{message:"connection failed; unable to access dbservice"}}})},i.messaging=new wi_contrib_1.WiContribMessaging,i.validations={},i.category="MySQL",i}return __extends(e,t),e.prototype.getContextVar=function(t,e){var n=t.getField(e);return n&&n.value?n.value:""},e.prototype.getContextVarBool=function(t,e){var n=t.getField(e);return!(!n||!n.value)&&n.value},e.prototype.getContextFetchData=function(t,e){var n=t.getField(e);if(null!=n){var i=n.display.fetchQuery;if(i&&""!==i)return i}return""},e}(wi_contrib_1.WiServiceHandlerContribution);MySQLInsertActivityContribution=__decorate([core_1.Injectable(),wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],MySQLInsertActivityContribution),exports.MySQLInsertActivityContribution=MySQLInsertActivityContribution;var SQLQueryEncoder=function(){return function(){this.encodeKey=function(t){return encodeURIComponent(t)},this.encodeValue=function(t){return encodeURIComponent(t)}}}();
//# sourceMappingURL=activity.js.map
