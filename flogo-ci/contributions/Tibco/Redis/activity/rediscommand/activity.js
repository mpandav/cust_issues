"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var u=e.length-1;u>=0;u--)(i=e[u])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),RedisCommandActivityContribution=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.http=n,r.value=function(e,t){var n=t.getField("Connection").value;t.title;if("Connection"===e)return Observable_1.Observable.create(function(e){var t=[];wi_contrib_1.WiContributionUtils.getConnections(r.http,"Redis").subscribe(function(n){n.forEach(function(e){for(var n=0;n<e.settings.length;n++)if("Name"===e.settings[n].name){t.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[n].value});break}}),e.next(t)})});if("input"===e){var i=t.getField("Connection"),o=t.getField("Group"),a=t.getField("Command");if(i.value&&o.value&&a.value)return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnection(r.http,i.value).map(function(e){return e}).subscribe(function(t){for(var n,r="",i=0,u=t.settings;i<u.length;i++){var s=u[i];"DocsMetadata"===s.name&&(r=s.value)}""!==r&&(n=JSON.parse(r));var c="/"+o.value+"/"+a.value,l=n.commands[c].schema.parameters;l.properties.DatabaseIndex={required:!1,type:"integer"},console.log(l.properties),e.next(JSON.stringify(l))})})}else if("Output"===e){var u=t.getField("Connection"),s=t.getField("Group"),c=t.getField("Command");if(u.value&&s.value&&c.value)return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnection(r.http,u.value).map(function(e){return e}).subscribe(function(t){for(var n,r="",i=0,o=t.settings;i<o.length;i++){var a=o[i];"DocsMetadata"===a.name&&(r=a.value)}""!==r&&(n=JSON.parse(r));var u="/"+s.value+"/"+c.value,l=n.commands[u].schema.output;e.next(l)},function(t){console.log("Failed to get schema due to error",t),e.next("{}")})}).map(function(e){var t,n=c.value+"Response";return JSON.stringify({$schema:"http://json-schema.org/draft-04/schema#",type:"object",definitions:{},properties:(t={},t[n]=e.properties.result?e.properties.result:e,t)})})}else if("Group"===e){var l=t.getField("Connection");if(l.value)return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnection(r.http,l.value).map(function(e){return e}).subscribe(function(t){for(var n,r="",i=0,o=t.settings;i<o.length;i++){var a=o[i];"DocsMetadata"===a.name&&(r=a.value)}""!==r&&(n=JSON.parse(r)),e.next(n.command_groups.sort())})})}else if("Command"===e){var b=t.getField("Connection"),f=t.getField("Group");if(b.value&&f.value)return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnection(r.http,b.value).map(function(e){return e}).subscribe(function(t){for(var n,r="",i=0,o=t.settings;i<o.length;i++){var a=o[i];"DocsMetadata"===a.name&&(r=a.value)}""!==r&&(n=JSON.parse(r));for(var u=new Set,s=Object.keys(n.commands),c=0;c<s.length;c++){var l=s[c];l.includes("/"+f.value)&&(l=l.substr(l.lastIndexOf("/")+1),u.add(l))}var b=[];u.forEach(function(e){return b.push(e)}),e.next(b.sort())})})}return null},r.validate=function(e,t){return null},r.messaging=new wi_contrib_1.WiContribMessaging,r}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);RedisCommandActivityContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],RedisCommandActivityContribution),exports.RedisCommandActivityContribution=RedisCommandActivityContribution;
//# sourceMappingURL=activity.js.map
